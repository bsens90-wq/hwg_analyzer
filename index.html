<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OCR ë³´ì¥ë¶„ì„ì§€ ë³€í™˜ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
  <style>
    :root{
      --hanwha:#ff7f00;
      --hanwha-dark:#e67100;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding-top: 70px;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    
    .header-fixed {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--bg);
      border-bottom: 2px solid #ccc;
      padding: 8px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-left {
      flex: 1;
    }
    
    .header-center {
      flex: 1;
      text-align: center;
    }
    
    .header-right {
      flex: 1;
      text-align: right;
    }
    
    .logo-container {
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
    }
    
    .logo-container:hover {
      transform: scale(1.05);
    }
    
    .logo-main {
      font-size: 32px;
      font-weight: 900;
      color: var(--hanwha);
      letter-spacing: 3px;
      text-shadow: 0 2px 4px rgba(255,127,0,0.2);
      margin: 0;
      line-height: 1;
    }
    
    .logo-sub {
      font-size: 11px;
      color: var(--muted);
      font-weight: 400;
      margin-top: 2px;
      letter-spacing: 1px;
      opacity: 0.8;
    }
    
    .logo-container:hover .logo-main {
      color: var(--hanwha-dark);
      text-shadow: 0 4px 8px rgba(255,127,0,0.3);
    }
    
    .logo-container:hover .logo-sub {
      opacity: 1;
    }
    
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem 1rem;
    }
    .app-title{
      font-size:24px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:20px;
    }
    .card.wide{
      max-width:1200px;
    }
    h2{margin:0 0 .75rem 0}
    .row{margin-bottom:.75rem}
    input, select, textarea{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--hanwha)}
    button{
      width:100%;
      padding:12px 14px;
      background:var(--hanwha);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
    }
    button:hover{background:var(--hanwha-dark)}
    button.secondary{
      background:#6c757d;
      margin-bottom:0;
    }
    button.secondary:hover{background:#545b62}
    button.small{
      width:auto;
      padding:6px 10px;
      font-size:12px;
      margin:2px;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:.25rem}
    .error{color:#d93025; font-size:14px; margin-top:.5rem}
    .success{color:#28a745; font-size:14px; margin-top:.5rem}
    
    /* ì´ë¯¸ì§€ ì—…ë¡œë“œ/ë¯¸ë¦¬ë³´ê¸° */
    .image-upload-area {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      background: #fafafa;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .image-upload-area:hover {
      border-color: var(--hanwha);
      background: #fff5f0;
    }
    
    .image-upload-area.drag-over {
      border-color: var(--hanwha);
      background: #fff5f0;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    /* ë°ì´í„° ì…ë ¥ í…Œì´ë¸” */
    .input-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    
    .input-table th,
    .input-table td {
      border: 1px solid var(--border);
      padding: 8px 12px;
      text-align: left;
      vertical-align: top;
    }
    
    .input-table th {
      background: var(--bg);
      font-weight: 600;
      width: 60%;
    }
    
    .input-table .unit-column {
      width: 40%;
      position: relative;
    }
    
    .input-table input {
      width: calc(100% - 50px);
      padding: 6px 8px;
      margin: 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      display: inline-block;
    }
    
    .unit-text {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: var(--muted);
      pointer-events: none;
    }
    
    .section-header {
      background: var(--hanwha);
      color: white;
      font-weight: 700;
      text-align: center;
    }
    
    /* ê°„ë³‘ì¸ ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .radio-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .radio-group input[type="radio"] {
      width: auto;
      margin: 0;
    }
    
    /* ì €ì¥ëœ ë°ì´í„° ëª©ë¡ */
    .saved-item {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .saved-item:hover {
      background: #f8f9fa;
      border-color: var(--hanwha);
    }
    
    .saved-item-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .saved-item-date {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* ê°€ë¡œí˜• ì¶œë ¥ìš© ìŠ¤íƒ€ì¼ - ë¯¸ë¦¬ë³´ê¸°ì™€ ì¸ì‡„ìš© í†µí•© */
    .print-preview {
      background: white;
      border: 1px solid #ccc;
      margin: 20px 0;
      padding: 15px;
      font-size: 9px;
      min-height: 600px;
      width: 100%;
      max-width: 1200px;
    }
    
    .print-header {
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--hanwha);
    }
    
    .sections-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .section {
      flex: 1;
      border: 1px solid #333;
      padding: 10px;
      min-height: 300px;
    }
    
    .section-title {
      text-align: center;
      font-weight: 700;
      font-size: 12px;
      margin-bottom: 10px;
      background: var(--hanwha);
      color: white;
      margin: -10px -10px 10px -10px;
      padding: 8px;
    }
    
    .coverage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 4px 0;
      padding: 2px 0;
      border-bottom: 1px dotted #ccc;
      font-size: 8px;
      line-height: 1.2;
    }
    
    .coverage-name {
      flex: 1;
      padding-right: 8px;
      font-size: 8px;
    }
    
    .coverage-value {
      font-weight: 600;
      color: var(--hanwha);
      min-width: 45px;
      text-align: right;
      font-size: 8px;
    }
    
    /* 5ëŒ€ í•„ìˆ˜ë³´í—˜ ì„œë¸Œì„¹ì…˜ */
    .subsection {
      margin-bottom: 12px;
      border: 1px solid #ddd;
      padding: 8px;
    }
    
    .subsection-title {
      font-weight: 600;
      font-size: 8px;
      margin-bottom: 6px;
      text-align: center;
      background: #f8f9fa;
      padding: 4px;
      border: 1px solid #ddd;
      margin: -8px -8px 6px -8px;
    }
    
    /* ì¶œë ¥ìš© ì§„í–‰ë¥  ë°” ìŠ¤íƒ€ì¼ */
    .coverage-progress {
      margin: 1px 6px;
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      overflow: hidden;
      position: relative;
      min-width: 25px;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .progress-green {
      background: #28a745;
    }
    
    .progress-yellow {
      background: #ffc107;
    }
    
    .progress-red {
      background: #dc3545;
    }
    
    .no-coverage-x {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #dc3545;
      font-weight: 900;
      font-size: 8px;
      line-height: 1;
    }
    
    .coverage-name.no-coverage {
      color: #dc3545;
    }
    
    .coverage-value.full-coverage {
      color: #28a745;
      font-weight: 700;
    }
    
    .coverage-value.insufficient-coverage {
      color: #dc3545;
    }
    
    .examples-container {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    
    .example-section {
      flex: 1;
      border: 1px solid #333;
      padding: 8px;
    }
    
    .example-title {
      font-weight: 700;
      font-size: 9px;
      margin-bottom: 8px;
      text-align: center;
      padding: 4px;
      background: #f0f0f0;
      border: 1px solid #333;
      margin: -8px -8px 8px -8px;
    }
    
    .example-item {
      display: flex;
      justify-content: space-between;
      margin: 3px 0;
      font-size: 8px;
      padding: 2px 0;
      border-bottom: 1px dotted #ccc;
      line-height: 1.2;
    }
    
    .example-name {
      flex: 1;
      font-size: 8px;
    }
    
    .example-value {
      font-weight: 600;
      color: var(--hanwha);
      font-size: 8px;
    }
    
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--hanwha);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .card {
        max-width: 100%;
        margin: 0 10px;
      }
      
      .input-table th,
      .input-table td {
        padding: 6px 8px;
        font-size: 14px;
      }
      
      .sections-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .examples-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .print-preview {
        font-size: 9px;
      }
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header-fixed">
    <div class="header-left"></div>
    <div class="header-center">
      <div class="logo-container" onclick="goHome()">
        <div class="logo-main">ë³´ì¥ë¶„ì„</div>
        <div class="logo-sub">OCR ë³€í™˜ê¸°</div>
      </div>
    </div>
    <div class="header-right"></div>
  </div>

  <!-- ë©”ë‰´ í™”ë©´ -->
  <section id="menuScreen" class="screen">
    <div class="app-title">ë³´ì¥ë¶„ì„ì§€ OCR ë³€í™˜ê¸°</div>
    <div class="card">
      <h2 style="margin-bottom:1.5rem; text-align:center;">ë©”ë‰´ ì„ íƒ</h2>
      
      <button id="inputMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">ì…ë ¥í•˜ê¸°</span>
        <span style="font-size:14px; opacity:0.8;">ì´ë¯¸ì§€ ì´¬ì˜/ì—…ë¡œë“œ â†’ OCR ì¸ì‹ â†’ ë°ì´í„° ì…ë ¥</span>
      </button>
      
      <button id="loadMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">ë¶ˆëŸ¬ì˜¤ê¸°</span>
        <span style="font-size:14px; opacity:0.8;">ì €ì¥ëœ ë³´ì¥ë¶„ì„ì§€ ëª©ë¡ì—ì„œ ì„ íƒ</span>
      </button>
      
      <div class="meta" style="margin-top:2rem; text-align:center;">
        Google Vision APIë¥¼ í™œìš©í•œ í•œê¸€ OCR ì„œë¹„ìŠ¤
      </div>
    </div>
  </section>

  <!-- ì…ë ¥ í™”ë©´ -->
  <section id="inputScreen" class="screen hidden">
    <div class="app-title">ë³´ì¥ë¶„ì„ì§€ ì…ë ¥í•˜ê¸°</div>
    <div class="card wide">
      <div class="row">
        <div class="image-upload-area" id="imageUploadArea">
          <div id="uploadText">
            ğŸ“¸ ë³´ì¥ë¶„ì„ì§€ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ê±°ë‚˜<br>
            ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”
          </div>
          <img id="imagePreview" class="image-preview hidden" alt="ë¯¸ë¦¬ë³´ê¸°">
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
        </div>
      </div>
      
      <div class="row">
        <button id="ocrProcessBtn" disabled>OCR ì¸ì‹ ì‹œì‘</button>
        <div id="ocrStatus" class="hint"></div>
      </div>
      
      <!-- ê³ ê° ê¸°ë³¸ ì •ë³´ -->
      <div class="row">
        <h3>ê³ ê° ê¸°ë³¸ ì •ë³´</h3>
        <table class="input-table">
          <tr>
            <th>ê³ ê°ëª…</th>
            <td><input type="text" id="customerName" placeholder="ê³ ê°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></td>
          </tr>
          <tr>
            <th>ìƒë…„ì›”ì¼</th>
            <td><input type="text" id="birthDate" placeholder="YYYY.MM.DD"></td>
          </tr>
        </table>
      </div>
      
      <!-- ì•” ê´€ë ¨ ë‹´ë³´ -->
      <div class="row">
        <h3>ì•” ê´€ë ¨ ë‹´ë³´</h3>
        <table class="input-table" id="cancerTable">
          <tr class="section-header">
            <th colspan="2">ì•” ê´€ë ¨ ë‹´ë³´</th>
          </tr>
        </table>
      </div>
      
      <!-- 2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜ -->
      <div class="row">
        <h3>2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜</h3>
        <table class="input-table" id="majorDiseaseTable">
          <tr class="section-header">
            <th colspan="2">2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜</th>
          </tr>
        </table>
      </div>
      
      <!-- 5ëŒ€ í•„ìˆ˜ë³´í—˜ -->
      <div class="row">
        <h3>5ëŒ€ í•„ìˆ˜ë³´í—˜</h3>
        
        <!-- ì‹¤ì†ì˜ë£Œë¹„ -->
        <table class="input-table">
          <tr class="section-header">
            <th colspan="2">ì‹¤ì†ì˜ë£Œë¹„</th>
          </tr>
          <tr>
            <th>(ì§ˆë³‘)ì…ì›í•œë„</th>
            <td class="unit-column">
              <input type="text" id="diseaseHospitalization" placeholder="0">
              <span class="unit-text">ë§Œì›/ì¼</span>
            </td>
          </tr>
          <tr>
            <th>(ìƒí•´)ì…ì›í•œë„</th>
            <td class="unit-column">
              <input type="text" id="injuryHospitalization" placeholder="0">
              <span class="unit-text">ë§Œì›/ì¼</span>
            </td>
          </tr>
        </table>
        
        <!-- ìš´ì „ì -->
        <table class="input-table">
          <tr class="section-header">
            <th colspan="2">ìš´ì „ì</th>
          </tr>
          <tr>
            <th>í˜•ì‚¬í•©ì˜ê¸ˆ</th>
            <td class="unit-column">
              <input type="text" id="criminalSettlement" placeholder="0">
              <span class="unit-text">ë§Œì›</span>
            </td>
          </tr>
          <tr>
            <th>ë³€í˜¸ì‚¬ì„ ì„ë¹„</th>
            <td class="unit-column">
              <input type="text" id="lawyerAppointment" placeholder="0">
              <span class="unit-text">ë§Œì›</span>
            </td>
          </tr>
        </table>
        
        <!-- ê°„ë³‘ì¸ì¼ë‹¹ -->
        <table class="input-table">
          <tr class="section-header">
            <th colspan="2">ê°„ë³‘ì¸ì¼ë‹¹</th>
          </tr>
          <tr>
            <th>ê°„ë³‘ì¸ ì˜µì…˜</th>
            <td>
              <div class="radio-group">
                <label>
                  <input type="radio" name="caregiverOption" value="use" id="caregiverUse" checked>
                  ì‚¬ìš©
                </label>
                <label>
                  <input type="radio" name="caregiverOption" value="support" id="caregiverSupport">
                  ì§€ì›
                </label>
              </div>
            </td>
          </tr>
          <tr id="caregiverDetails">
            <td colspan="2">
              <table style="width:100%; margin:0;">
                <tr>
                  <th style="width:60%;">ìš”ì–‘ë³‘ì› ì™¸</th>
                  <td class="unit-column">
                    <input type="text" id="nursingHospitalOut" placeholder="0">
                    <span class="unit-text">ë§Œì›/ì¼</span>
                  </td>
                </tr>
                <tr>
                  <th>ìš”ì–‘ë³‘ì›</th>
                  <td class="unit-column">
                    <input type="text" id="nursingHospitalIn" placeholder="0">
                    <span class="unit-text">ë§Œì›/ì¼</span>
                  </td>
                </tr>
                <tr>
                  <th>ê°„í˜¸ê°„ë³‘í†µí•©</th>
                  <td class="unit-column">
                    <input type="text" id="nursingCareIntegrated" placeholder="0">
                    <span class="unit-text">ë§Œì›/ì¼</span>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        
        <!-- ì¼ìƒìƒí™œë°°ìƒì±…ì„ -->
        <table class="input-table">
          <tr class="section-header">
            <th colspan="2">ì¼ìƒìƒí™œë°°ìƒì±…ì„</th>
          </tr>
          <tr>
            <th>ì¼ìƒìƒí™œë°°ìƒì±…ì„</th>
            <td class="unit-column">
              <input type="text" id="dailyLifeLiability" placeholder="0">
              <span class="unit-text">ë§Œì›</span>
            </td>
          </tr>
        </table>
        
        <!-- í™”ì¬ë²Œê¸ˆ -->
        <table class="input-table">
          <tr class="section-header">
            <th colspan="2">í™”ì¬ë²Œê¸ˆ</th>
          </tr>
          <tr>
            <th>í™”ì¬ë²Œê¸ˆ</th>
            <td class="unit-column">
              <input type="text" id="fireFine" placeholder="0">
              <span class="unit-text">ë§Œì›</span>
            </td>
          </tr>
        </table>
      </div>
      
      <div class="row" style="margin-top: 2rem;">
        <button id="saveDataBtn">ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
        <button id="backToMenuBtn" class="secondary">ë’¤ë¡œê°€ê¸°</button>
      </div>
    </div>
  </section>

  <!-- ë¶ˆëŸ¬ì˜¤ê¸° í™”ë©´ -->
  <section id="loadScreen" class="screen hidden">
    <div class="app-title">ì €ì¥ëœ ë³´ì¥ë¶„ì„ì§€ ë¶ˆëŸ¬ì˜¤ê¸°</div>
    <div class="card">
      <div class="row">
        <input type="text" id="searchInput" placeholder="ê³ ê°ëª…ìœ¼ë¡œ ê²€ìƒ‰...">
      </div>
      
      <div id="savedList">
        <!-- ì €ì¥ëœ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
      
      <div class="row" style="margin-top: 2rem;">
        <button id="backToMenuFromLoadBtn" class="secondary">ë’¤ë¡œê°€ê¸°</button>
      </div>
    </div>
  </section>

  <!-- ë¯¸ë¦¬ë³´ê¸°/ì¶œë ¥ í™”ë©´ -->
  <section id="previewScreen" class="screen hidden">
    <div class="app-title">ë³´ì¥ë¶„ì„ì§€ ë¯¸ë¦¬ë³´ê¸°</div>
    <div class="card wide">
      <div id="printPreview" class="print-preview">
        <!-- ì¶œë ¥ìš© ë³´ì¥ë¶„ì„ì§€ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
      </div>
      
      <div class="row">
        <button id="downloadImageBtn">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
        <button id="editDataBtn" class="secondary">ìˆ˜ì •í•˜ê¸°</button>
        <button id="backToMenuFromPreviewBtn" class="secondary">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </section>

<script>
// ì „ì—­ ë³€ìˆ˜
let currentData = {};
let savedDataList = [];

// ë‹´ë³´ í•­ëª© ì •ì˜ ë° í‘œì¤€ê¸ˆì•¡ ì„¤ì •
const COVERAGE_ITEMS = {
  cancer: [
    { key: 'generalCancer', name: 'ì¼ë°˜ì•”ì§„ë‹¨ë¹„', standardAmount: 1000 },
    { key: 'totalCancer', name: 'í†µí•©ì•”ì§„ë‹¨ë¹„', standardAmount: 1000 },
    { key: 'metastasisCancer', name: 'ì „ì´ì•”ì§„ë‹¨ë¹„', standardAmount: 1000 },
    { key: 'cancerSpecificTreatment', name: 'ì•”íŠ¹ì •ì¹˜ë£Œë¹„', standardAmount: 1000 },
    { key: 'cancerNonCoveredTreatment', name: 'ì•”íŠ¹ì •ì¹˜ë£Œë¹„(ë¹„ê¸‰ì—¬)', standardAmount: 1000 },
    { key: 'targetTherapy', name: 'í‘œì í•­ì•”ì¹˜ë£Œë¹„', standardAmount: 1000 },
    { key: 'heavyIonTherapy', name: 'ì¤‘ì…ìì¹˜ë£Œë¹„', standardAmount: 1000 },
    { key: 'cancerSurgery', name: 'ì•”ìˆ˜ìˆ ë¹„', standardAmount: 1000 },
    { key: 'daVinciSurgery', name: 'ë‹¤ë¹ˆì¹˜ë¡œë´‡ìˆ˜ìˆ ë¹„', standardAmount: 1000 },
    { key: 'surgery5Type', name: '1-5ì¢…ìˆ˜ìˆ ë¹„(5ì¢…)', standardAmount: 1000 }
  ],
  majorDisease: [
    { key: 'cerebrovascularDiagnosis', name: 'ë‡Œí˜ˆê´€ì§ˆí™˜ì§„ë‹¨ë¹„', standardAmount: 1000 },
    { key: 'strokeDiagnosis', name: 'ë‡Œì¡¸ì¤‘ì§„ë‹¨ë¹„', standardAmount: 1000 },
    { key: 'ischemicHeartDiagnosis', name: 'í—ˆí˜ˆì„±ì‹¬ì¥ì§ˆí™˜ì§„ë‹¨ë¹„', standardAmount: 1000 },
    { key: 'myocardialInfarctionDiagnosis', name: 'ì‹¬ê·¼ê²½ìƒ‰ì§„ë‹¨ë¹„', standardAmount: 1000 },
    { key: 'cerebrovascularSurgery', name: 'ë‡Œí˜ˆê´€ì§ˆí™˜ìˆ˜ìˆ ë¹„', standardAmount: 1000 },
    { key: 'strokeSurgery', name: 'ë‡Œì¡¸ì¤‘ìˆ˜ìˆ ë¹„', standardAmount: 1000 },
    { key: 'ischemicHeartSurgery', name: 'í—ˆí˜ˆì„±ì‹¬ì¥ì§ˆí™˜ìˆ˜ìˆ ë¹„', standardAmount: 1000 },
    { key: 'myocardialInfarctionSurgery', name: 'ì‹¬ê·¼ê²½ìƒ‰ìˆ˜ìˆ ë¹„', standardAmount: 1000 },
    { key: 'strokeThrombolysis', name: 'ë‡Œì¡¸ì¤‘í˜ˆì „ìš©í•´', standardAmount: 1000 },
    { key: 'myocardialInfarctionThrombolysis', name: 'ì‹¬ê·¼ê²½ìƒ‰í˜ˆì „ìš©í•´', standardAmount: 1000 },
    { key: 'twoMajorTreatment', name: '2ëŒ€íŠ¹ì •ì¹˜ë£Œë¹„', standardAmount: 1000 },
    { key: 'majorCirculatorySurgery', name: 'ì£¼ìš”ìˆœí™˜ê³„(ìˆ˜ìˆ )', standardAmount: 1000 },
    { key: 'majorCirculatoryThrombectomy', name: 'ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ì œê±°)', standardAmount: 1000 },
    { key: 'majorCirculatoryThrombolysis', name: 'ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ìš©í•´)', standardAmount: 1000 },
    { key: 'majorCirculatoryICU', name: 'ì£¼ìš”ìˆœí™˜ê³„(ì¤‘í™˜ìì‹¤)', standardAmount: 1000 },
    { key: 'thrombectomyTreatment', name: 'í˜ˆì „ì œê±°ì¹˜ë£Œë¹„', standardAmount: 1000 },
    { key: 'surgery3Type', name: '1-5ì¢…ìˆ˜ìˆ ë¹„(3ì¢…)', standardAmount: 1000 },
    { key: 'surgery5Type2', name: '1-5ì¢…ìˆ˜ìˆ ë¹„(5ì¢…)', standardAmount: 1000 },
    { key: 'disease124Surgery', name: '124ëŒ€ì§ˆë³‘ìˆ˜ìˆ ë¹„(íŠ¹ì •10ëŒ€)', standardAmount: 1000 },
    { key: 'sevenOrganSurgery', name: '7ëŒ€ê¸°ê´€ìˆ˜ìˆ ë¹„(ë‡Œ/ì‹¬) ê´€í˜ˆ', standardAmount: 1000 }
  ]
};

// 5ëŒ€ í•„ìˆ˜ë³´í—˜ í‘œì¤€ê¸ˆì•¡ ì„¤ì • (ì§ˆë³‘í†µì›, ìƒí•´í†µì› ì œê±°)
const ESSENTIAL_ITEMS = [
  { key: 'diseaseHospitalization', name: '(ì§ˆë³‘)ì…ì›í•œë„', standardAmount: 1000 },
  { key: 'injuryHospitalization', name: '(ìƒí•´)ì…ì›í•œë„', standardAmount: 1000 },
  { key: 'criminalSettlement', name: 'í˜•ì‚¬í•©ì˜ê¸ˆ', standardAmount: 1000 },
  { key: 'lawyerAppointment', name: 'ë³€í˜¸ì‚¬ì„ ì„ë¹„', standardAmount: 1000 },
  { key: 'nursingHospitalOut', name: 'ìš”ì–‘ë³‘ì› ì™¸', standardAmount: 1000 },
  { key: 'nursingHospitalIn', name: 'ìš”ì–‘ë³‘ì›', standardAmount: 1000 },
  { key: 'nursingCareIntegrated', name: 'ê°„í˜¸ê°„ë³‘í†µí•©', standardAmount: 1000 },
  { key: 'dailyLifeLiability', name: 'ì¼ìƒìƒí™œë°°ìƒì±…ì„', standardAmount: 1000 },
  { key: 'fireFine', name: 'í™”ì¬ë²Œê¸ˆ', standardAmount: 1000 }
];

// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  loadSavedData();
  setupEventListeners();
});

// ì•± ì´ˆê¸°í™”
function initializeApp() {
  showScreen('menu');
  createInputTables();
}

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
  // ë©”ë‰´ ë²„íŠ¼ë“¤
  document.getElementById('inputMenuBtn').addEventListener('click', () => showScreen('input'));
  document.getElementById('loadMenuBtn').addEventListener('click', () => {
    showScreen('load');
    displaySavedList();
  });
  
  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ë“¤
  document.getElementById('backToMenuBtn').addEventListener('click', () => showScreen('menu'));
  document.getElementById('backToMenuFromLoadBtn').addEventListener('click', () => showScreen('menu'));
  document.getElementById('backToMenuFromPreviewBtn').addEventListener('click', () => showScreen('menu'));
  document.getElementById('editDataBtn').addEventListener('click', () => {
    loadCurrentDataToForm();
    showScreen('input');
  });
  
  // ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨
  const imageUploadArea = document.getElementById('imageUploadArea');
  const imageInput = document.getElementById('imageInput');
  const imagePreview = document.getElementById('imagePreview');
  
  imageUploadArea.addEventListener('click', () => imageInput.click());
  imageInput.addEventListener('change', handleImageUpload);
  
  // ë“œë˜ê·¸ ì•¤ ë“œë¡­
  imageUploadArea.addEventListener('dragover', handleDragOver);
  imageUploadArea.addEventListener('drop', handleDrop);
  imageUploadArea.addEventListener('dragenter', (e) => {
    e.preventDefault();
    imageUploadArea.classList.add('drag-over');
  });
  imageUploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    imageUploadArea.classList.remove('drag-over');
  });
  
  // OCR ì²˜ë¦¬ ë²„íŠ¼
  document.getElementById('ocrProcessBtn').addEventListener('click', processOCR);
  
  // ì €ì¥ ë²„íŠ¼
  document.getElementById('saveDataBtn').addEventListener('click', saveAndPreview);
  
  // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
  document.getElementById('downloadImageBtn').addEventListener('click', downloadImage);
  
  // ê²€ìƒ‰ ê¸°ëŠ¥
  document.getElementById('searchInput').addEventListener('input', filterSavedList);
  
  // ê°„ë³‘ì¸ ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.querySelectorAll('input[name="caregiverOption"]').forEach(radio => {
    radio.addEventListener('change', handleCaregiverOptionChange);
  });
  
  // ì£¼ìš”ìˆœí™˜ê³„ ìˆ˜ìˆ  ì…ë ¥ ì´ë²¤íŠ¸ (ìë™ ê³„ì‚°)
  document.addEventListener('input', function(e) {
    if (e.target.id === 'majorCirculatorySurgery') {
      handleMajorCirculatoryCalculation();
    }
  });
}

// í™”ë©´ ì „í™˜
function showScreen(screenName) {
  const screens = ['menu', 'input', 'load', 'preview'];
  screens.forEach(name => {
    document.getElementById(name + 'Screen').classList.toggle('hidden', name !== screenName);
  });
  
  if (screenName === 'input' && !currentData.customerName) {
    resetInputForm();
  }
}

// í™ˆìœ¼ë¡œ ì´ë™
function goHome() {
  showScreen('menu');
}

// ì…ë ¥ í…Œì´ë¸” ìƒì„±
function createInputTables() {
  // ì•” ê´€ë ¨ ë‹´ë³´ í…Œì´ë¸”
  const cancerTable = document.getElementById('cancerTable');
  COVERAGE_ITEMS.cancer.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <th>${item.name}</th>
      <td class="unit-column">
        <input type="text" id="${item.key}" placeholder="0">
        <span class="unit-text">ë§Œì›</span>
      </td>
    `;
    cancerTable.appendChild(row);
  });
  
  // 2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜ í…Œì´ë¸”
  const majorDiseaseTable = document.getElementById('majorDiseaseTable');
  COVERAGE_ITEMS.majorDisease.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <th>${item.name}</th>
      <td class="unit-column">
        <input type="text" id="${item.key}" placeholder="0">
        <span class="unit-text">ë§Œì›</span>
      </td>
    `;
    majorDiseaseTable.appendChild(row);
  });
}

// ì…ë ¥ í¼ ì´ˆê¸°í™”
function resetInputForm() {
  document.getElementById('customerName').value = '';
  document.getElementById('birthDate').value = '';
  
  // ëª¨ë“  ë‹´ë³´ í•­ëª© ì´ˆê¸°í™”
  Object.values(COVERAGE_ITEMS).flat().forEach(item => {
    const input = document.getElementById(item.key);
    if (input) input.value = '';
  });
  
  // 5ëŒ€ í•„ìˆ˜ë³´í—˜ í•­ëª©ë“¤ ì´ˆê¸°í™” (ì§ˆë³‘í†µì›, ìƒí•´í†µì› ì œê±°)
  const essentialInputs = [
    'diseaseHospitalization', 'injuryHospitalization',
    'criminalSettlement', 'lawyerAppointment',
    'nursingHospitalOut', 'nursingHospitalIn', 'nursingCareIntegrated',
    'dailyLifeLiability', 'fireFine'
  ];
  
  essentialInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) input.value = '';
  });
  
  // ê°„ë³‘ì¸ ì˜µì…˜ ì´ˆê¸°í™”
  document.getElementById('caregiverUse').checked = true;
  handleCaregiverOptionChange();
  
  // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
  const imagePreview = document.getElementById('imagePreview');
  const uploadText = document.getElementById('uploadText');
  imagePreview.classList.add('hidden');
  uploadText.style.display = 'block';
  
  document.getElementById('ocrProcessBtn').disabled = true;
  document.getElementById('ocrStatus').textContent = '';
}

// í˜„ì¬ ë°ì´í„°ë¥¼ í¼ì— ë¡œë“œ
function loadCurrentDataToForm() {
  if (!currentData.customerName) return;
  
  document.getElementById('customerName').value = currentData.customerName;
  document.getElementById('birthDate').value = currentData.birthDate || '';
  
  // ë‹´ë³´ ë°ì´í„° ë¡œë“œ
  if (currentData.coverages) {
    Object.entries(currentData.coverages).forEach(([key, data]) => {
      const input = document.getElementById(key);
      if (input) {
        input.value = data.value || '';
      }
    });
  }
  
  // ê°„ë³‘ì¸ ì˜µì…˜ ë¡œë“œ
  if (currentData.caregiverOption) {
    document.getElementById('caregiverUse').checked = currentData.caregiverOption === 'use';
    document.getElementById('caregiverSupport').checked = currentData.caregiverOption === 'support';
    handleCaregiverOptionChange();
  }
}

// ì£¼ìš”ìˆœí™˜ê³„ ìë™ ê³„ì‚° í•¨ìˆ˜
function handleMajorCirculatoryCalculation() {
  const surgeryInput = document.getElementById('majorCirculatorySurgery');
  const surgeryValue = surgeryInput.value.trim();
  
  if (surgeryValue && !isNaN(surgeryValue)) {
    const value = parseInt(surgeryValue);
    
    // ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ì œê±°) = ì£¼ìš”ìˆœí™˜ê³„(ìˆ˜ìˆ ) ê°’ ë™ì¼
    const thrombectomyInput = document.getElementById('majorCirculatoryThrombectomy');
    if (thrombectomyInput) thrombectomyInput.value = value;
    
    // ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ìš©í•´) = ì£¼ìš”ìˆœí™˜ê³„(ìˆ˜ìˆ ) ê°’ ë™ì¼
    const thrombolysisInput = document.getElementById('majorCirculatoryThrombolysis');
    if (thrombolysisInput) thrombolysisInput.value = value;
    
    // ì£¼ìš”ìˆœí™˜ê³„(ì¤‘í™˜ìì‹¤) = ì£¼ìš”ìˆœí™˜ê³„(ìˆ˜ìˆ )ì˜ 50%
    const icuInput = document.getElementById('majorCirculatoryICU');
    if (icuInput) icuInput.value = Math.floor(value * 0.5);
  } else {
    // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì—°ê´€ í•„ë“œë“¤ë„ ì´ˆê¸°í™”
    const relatedInputs = ['majorCirculatoryThrombectomy', 'majorCirculatoryThrombolysis', 'majorCirculatoryICU'];
    relatedInputs.forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = '';
    });
  }
}

// í‘œì¤€ê¸ˆì•¡ ëŒ€ë¹„ ì§„í–‰ë¥  ê³„ì‚°
function calculateProgressPercentage(currentValue, standardAmount) {
  if (!currentValue || currentValue == 0 || !standardAmount) return 0;
  return (parseInt(currentValue) / standardAmount) * 100;
}

// ì§„í–‰ë¥  ë°” ìƒì„± (ì•”, 2ëŒ€ì¤‘ëŒ€ì§ˆí™˜ìš©)
function generateProgressBar(percentage, value) {
  // ê°’ì´ 0ì´ë©´ ë¹¨ê°„ìƒ‰ X í‘œì‹œ
  if (value === 0) {
    return `
      <div class="coverage-progress">
        <div class="no-coverage-x">âœ—</div>
      </div>
    `;
  }
  
  let colorClass = 'progress-red';
  if (percentage >= 100) colorClass = 'progress-green';
  else if (percentage >= 30) colorClass = 'progress-yellow';
  
  const width = Math.min(percentage, 100);
  
  return `
    <div class="coverage-progress">
      <div class="progress-bar ${colorClass}" style="width: ${width}%"></div>
    </div>
  `;
}

// 5ëŒ€ í•„ìˆ˜ë³´í—˜ìš© ì§„í–‰ë¥  ë°” ìƒì„±
function generateEssentialProgressBar(percentage, value) {
  // ê°’ì´ 0ì´ë©´ ë¹¨ê°„ìƒ‰ X í‘œì‹œ
  if (value === 0) {
    return `
      <div class="coverage-progress">
        <div class="no-coverage-x">âœ—</div>
      </div>
    `;
  }
  
  let colorClass = 'progress-red';
  if (percentage >= 100) colorClass = 'progress-green';
  else if (percentage >= 30) colorClass = 'progress-yellow';
  
  const width = Math.min(percentage, 100);
  
  return `
    <div class="coverage-progress">
      <div class="progress-bar ${colorClass}" style="width: ${width}%"></div>
    </div>
  `;
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (file && file.type.startsWith('image/')) {
    displayImagePreview(file);
  }
}

// ë“œë˜ê·¸ ì˜¤ë²„ ì²˜ë¦¬
function handleDragOver(event) {
  event.preventDefault();
}

// ë“œë¡­ ì²˜ë¦¬
function handleDrop(event) {
  event.preventDefault();
  document.getElementById('imageUploadArea').classList.remove('drag-over');
  
  const files = event.dataTransfer.files;
  if (files.length > 0 && files[0].type.startsWith('image/')) {
    displayImagePreview(files[0]);
  }
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
function displayImagePreview(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const imagePreview = document.getElementById('imagePreview');
    const uploadText = document.getElementById('uploadText');
    
    imagePreview.src = e.target.result;
    imagePreview.classList.remove('hidden');
    uploadText.style.display = 'none';
    
    document.getElementById('ocrProcessBtn').disabled = false;
    document.getElementById('ocrStatus').textContent = 'OCR ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
  };
  reader.readAsDataURL(file);
}

// OCR ì²˜ë¦¬ (Google Vision API ì—°ë™)
async function processOCR() {
  const ocrBtn = document.getElementById('ocrProcessBtn');
  const ocrStatus = document.getElementById('ocrStatus');
  const imagePreview = document.getElementById('imagePreview');
  
  if (!imagePreview.src) {
    alert('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì¼ì¼ ì‚¬ìš©ëŸ‰ ì œí•œ ì²´í¬
  let dailyRequestCount = parseInt(localStorage.getItem('ocrRequestCount') || '0');
  const today = new Date().toDateString();
  const lastRequestDate = localStorage.getItem('lastRequestDate');

  // ë‚ ì§œê°€ ë°”ë€Œë©´ ì¹´ìš´íŠ¸ ë¦¬ì…‹
  if (lastRequestDate !== today) {
    dailyRequestCount = 0;
    localStorage.setItem('lastRequestDate', today);
  }

  // ì¼ì¼ í•œë„ ì²´í¬ (50íšŒ)
  if (dailyRequestCount >= 50) {
    alert('ì¼ì¼ OCR ì‚¬ìš© í•œë„(50íšŒ)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    ocrBtn.disabled = true;
    ocrStatus.innerHTML = '<span class="loading"></span> OCR ì¸ì‹ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
    
    // ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë³€í™˜
    const base64Image = imagePreview.src.split(',')[1];
    
    // Google Vision API í˜¸ì¶œ
    const result = await callGoogleVisionAPI(base64Image);
    await parseOCRResult(result);
    
    // ì„±ê³µ ì‹œ ì¹´ìš´íŠ¸ ì¦ê°€
    dailyRequestCount++;
    localStorage.setItem('ocrRequestCount', dailyRequestCount.toString());
    
    ocrStatus.innerHTML = '<span class="success">âœ… OCR ì¸ì‹ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.</span>';
  } catch (error) {
    console.error('OCR ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    ocrStatus.innerHTML = '<span class="error">âŒ OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</span>';
  } finally {
    ocrBtn.disabled = false;
  }
}

// Google Vision API í˜¸ì¶œ
async function callGoogleVisionAPI(base64Image) {
  const API_KEY = 'AIzaSyDywqG3hrawe_KrgWVpj5Y34ySJE0xjGQM';
  
  const requestBody = {
    requests: [{
      image: {
        content: base64Image
      },
      features: [{
        type: 'DOCUMENT_TEXT_DETECTION',
        maxResults: 1
      }]
    }]
  };
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} - ${response.statusText}`);
  }
  
  return await response.json();
}

// OCR ê²°ê³¼ íŒŒì‹± ë° ì…ë ¥ í•„ë“œ ìë™ ì±„ìš°ê¸°
async function parseOCRResult(apiResult) {
  if (!apiResult || !apiResult.responses || !apiResult.responses[0]) {
    throw new Error('OCR ê²°ê³¼ë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }

  const detectedText = apiResult.responses[0].fullTextAnnotation?.text || '';
  console.log('OCR ì¸ì‹ëœ í…ìŠ¤íŠ¸:', detectedText);

  if (!detectedText.trim()) {
    throw new Error('ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }

  // í…ìŠ¤íŠ¸ì—ì„œ ì •ë³´ ì¶”ì¶œ
  extractCustomerInfo(detectedText);
  extractCoverageAmounts(detectedText);
}

// ê³ ê° ì •ë³´ ì¶”ì¶œ
function extractCustomerInfo(text) {
  // ì´ë¦„ ì¶”ì¶œ (ì†ë•ë ¹ë‹˜ì˜ í•œ ì¥ ìš”ì•½ ë³´ì¥ë¶„ì„ í˜•íƒœ)
  const namePatterns = [
    /([ê°€-í£]{2,4})ë‹˜ì˜\s*í•œ\s*ì¥\s*ìš”ì•½\s*ë³´ì¥ë¶„ì„/,
    /ì†ë•ë ¹ë‹˜ì˜/,
    /^([ê°€-í£]{2,4})ë‹˜/m,
    /ì„±ëª…[:\s]*([ê°€-í£]{2,4})/,
    /ì´ë¦„[:\s]*([ê°€-í£]{2,4})/,
    /ê³ ê°ëª…[:\s]*([ê°€-í£]{2,4})/,
    /ê³„ì•½ì[:\s]*([ê°€-í£]{2,4})/,
    /í”¼ë³´í—˜ì[:\s]*([ê°€-í£]{2,4})/
  ];

  for (const pattern of namePatterns) {
    const match = text.match(pattern);
    if (match) {
      document.getElementById('customerName').value = match[1];
      console.log(`ê³ ê°ëª… ì¶”ì¶œ ì„±ê³µ: ${match[1]}`);
      break;
    }
  }

  // ìƒë…„ì›”ì¼ ì¶”ì¶œ (ìƒë…„ì›”ì¼ yy-mm-dd í˜•íƒœ)
  const birthPatterns = [
    /ìƒë…„ì›”ì¼\s*(\d{2}-\d{1,2}-\d{1,2})/,
    /ìƒë…„ì›”ì¼\s*(\d{4}-\d{1,2}-\d{1,2})/,
    /ìƒë…„ì›”ì¼\s*(\d{2}\.\d{1,2}\.\d{1,2})/,
    /ìƒë…„ì›”ì¼\s*(\d{4}\.\d{1,2}\.\d{1,2})/,
    /(\d{2}-\d{1,2}-\d{1,2})\s*\/\s*ìƒí™©ì¼/,
    /(\d{4}-\d{1,2}-\d{1,2})/
  ];

  for (const pattern of birthPatterns) {
    const match = text.match(pattern);
    if (match) {
      let date = match[1];
      // yy-mm-dd í˜•íƒœë¥¼ yyyy.mm.ddë¡œ ë³€í™˜
      if (date.length === 8 && date.includes('-')) {
        const parts = date.split('-');
        if (parts[0].length === 2) {
          // 20xxë…„ìœ¼ë¡œ ê°€ì •
          date = `20${parts[0]}.${parts[1]}.${parts[2]}`;
        }
      } else {
        date = date.replace(/[-]/g, '.');
      }
      document.getElementById('birthDate').value = date;
      console.log(`ìƒë…„ì›”ì¼ ì¶”ì¶œ ì„±ê³µ: ${date}`);
      break;
    }
  }
}

// ë‹´ë³´ ê¸ˆì•¡ ì¶”ì¶œ (ì‹¤ì œ ì–‘ì‹ì—ì„œ ì¶”ì¶œ ê°€ëŠ¥í•œ í•­ëª©ë§Œ)
function extractCoverageAmounts(text) {
  // ì‹¤ì œ ì–‘ì‹ì—ì„œ ì¶”ì¶œ ê°€ëŠ¥í•œ í•­ëª©ë“¤ì˜ ì •í™•í•œ íŒ¨í„´
  const coveragePatterns = {
    // í°ë³‘ë³´ì¥ ì„¹ì…˜ì—ì„œ ì¶”ì¶œ
    generalCancer: {
      name: 'ì¼ë°˜ì•”ì§„ë‹¨ë¹„',
      extractPattern: /ì¼ë°˜ì•”\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    totalCancer: {
      name: 'í†µí•©ì•”ì§„ë‹¨ë¹„', 
      extractPattern: /í†µí•©ì•”\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    targetTherapy: {
      name: 'í‘œì í•­ì•”ì¹˜ë£Œë¹„',
      extractPattern: /í‘œì í•­ì•”ì•½ë¬¼\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    cerebrovascularDiagnosis: {
      name: 'ë‡Œí˜ˆê´€ì§ˆí™˜ì§„ë‹¨ë¹„',
      extractPattern: /ë‡Œí˜ˆê´€ì§ˆí™˜\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    strokeDiagnosis: {
      name: 'ë‡Œì¡¸ì¤‘ì§„ë‹¨ë¹„',
      extractPattern: /ë‡Œì¡¸ì¤‘\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    ischemicHeartDiagnosis: {
      name: 'í—ˆí˜ˆì„±ì‹¬ì¥ì§ˆí™˜ì§„ë‹¨ë¹„',
      extractPattern: /í—ˆí˜ˆì„±ì‹¬ì§ˆí™˜\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    myocardialInfarctionDiagnosis: {
      name: 'ì‹¬ê·¼ê²½ìƒ‰ì§„ë‹¨ë¹„',
      extractPattern: /ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰ì¦\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    
    // ì˜ë£Œë³´ì¥ ì„¹ì…˜ì—ì„œ ì¶”ì¶œ
    diseaseHospitalization: {
      name: '(ì§ˆë³‘)ì…ì›í•œë„',
      extractPattern: /ì§ˆë³‘ì…ì›\s*ì‹¤ì†\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    injuryHospitalization: {
      name: '(ìƒí•´)ì…ì›í•œë„',
      extractPattern: /ìƒí•´ì…ì›\s*ì‹¤ì†\s*([0-9,]+)\s*\/\s*[0-9,]+ë§Œì›/i
    },
    
    // ìƒí™œë³´ì¥ ì„¹ì…˜ì—ì„œ ì¶”ì¶œ - ë§Œì› í‘œê¸° ë°©ì‹
    criminalSettlement: {
      name: 'í˜•ì‚¬í•©ì˜ê¸ˆ',
      extractPattern: /ëŒ€ì¸í˜•ì‚¬í•©ì˜ì§€ì›ê¸ˆ\s*([0-9,]+)ë§Œì›/i
    },
    lawyerAppointment: {
      name: 'ë³€í˜¸ì‚¬ì„ ì„ë¹„',
      extractPattern: /ë³€í˜¸ì‚¬ì„ ì„ë¹„ìš©\s*([0-9,]+)ë§Œì›/i
    },
    dailyLifeLiability: {
      name: 'ì¼ìƒìƒí™œë°°ìƒì±…ì„',
      extractPattern: /ì¼ìƒìƒí™œë°°ìƒì±…ì„\s*([0-9,]+)ë§Œì›/i
    },
    fireFine: {
      name: 'í™”ì¬ë²Œê¸ˆ',
      extractPattern: /í™”ì¬ë²Œê¸ˆ\s*([0-9,]+)ë§Œì›/i
    }
  };

  // ê° ë‹´ë³´ë³„ë¡œ ê¸ˆì•¡ ì¶”ì¶œ ì‹œë„
  Object.entries(coveragePatterns).forEach(([key, config]) => {
    const element = document.getElementById(key);
    if (!element) {
      console.log(`ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${key}`);
      return;
    }

    const match = text.match(config.extractPattern);
    if (match && match[1]) {
      let amount = match[1].replace(/,/g, '');
      if (amount && !isNaN(amount)) {
        element.value = amount;
        console.log(`âœ… ${config.name} ì¶”ì¶œ ì„±ê³µ: ${amount}ë§Œì›`);
      }
    } else {
      console.log(`âŒ ${config.name} íŒ¨í„´ ë§¤ì¹­ ì‹¤íŒ¨: ${config.extractPattern}`);
    }
  });

  // ì¶”ê°€ ë””ë²„ê¹…: íŠ¹ì • í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë¼ì¸ ì°¾ê¸°
  const lines = text.split('\n');
  const keywords = ['ì¼ë°˜ì•”', 'í†µí•©ì•”', 'í‘œì í•­ì•”ì•½ë¬¼', 'ë‡Œí˜ˆê´€ì§ˆí™˜', 'ë‡Œì¡¸ì¤‘', 'í—ˆí˜ˆì„±ì‹¬ì§ˆí™˜', 'ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰ì¦', 'ì§ˆë³‘ì…ì›', 'ìƒí•´ì…ì›', 'ëŒ€ì¸í˜•ì‚¬í•©ì˜ì§€ì›ê¸ˆ', 'ë³€í˜¸ì‚¬ì„ ì„ë¹„ìš©', 'ì¼ìƒìƒí™œë°°ìƒì±…ì„', 'í™”ì¬ë²Œê¸ˆ'];
  
  keywords.forEach(keyword => {
    const matchingLines = lines.filter(line => line.includes(keyword));
    if (matchingLines.length > 0) {
      console.log(`ğŸ” "${keyword}" í¬í•¨ ë¼ì¸:`, matchingLines);
    }
  });
  
  // ì „ì²´ OCR í…ìŠ¤íŠ¸ ë¡œê·¸
  console.log('ğŸ“„ OCR ì „ì²´ í…ìŠ¤íŠ¸:');
  console.log(text);
  console.log('ğŸ“ í…ìŠ¤íŠ¸ ê¸¸ì´:', text.length);
}

// ìƒ˜í”Œ ë°ì´í„° ì±„ìš°ê¸° (í…ŒìŠ¤íŠ¸ìš© - ë°±ì—…ìœ¼ë¡œ ìœ ì§€)
function fillSampleData() {
  document.getElementById('customerName').value = 'í™ê¸¸ë™';
  document.getElementById('birthDate').value = '1980.01.15';
  document.getElementById('generalCancer').value = '1000';
  document.getElementById('targetTherapy').value = '5000';
  document.getElementById('surgery5Type').value = '1000';
  document.getElementById('strokeDiagnosis').value = '2000';
  document.getElementById('diseaseHospitalization').value = '10';
  document.getElementById('criminalSettlement').value = '3000';
  document.getElementById('nursingHospitalOut').value = '10';
  document.getElementById('dailyLifeLiability').value = '2000';
  document.getElementById('fireFine').value = '300';
}

// ë°ì´í„° ì €ì¥ ë° ë¯¸ë¦¬ë³´ê¸°
function saveAndPreview() {
  const customerName = document.getElementById('customerName').value.trim();
  
  if (!customerName) {
    alert('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // í˜„ì¬ ë°ì´í„° ìˆ˜ì§‘
  currentData = {
    customerName: customerName,
    birthDate: document.getElementById('birthDate').value.trim(),
    inputDate: new Date().toLocaleString('ko-KR'),
    coverages: {},
    caregiverOption: document.querySelector('input[name="caregiverOption"]:checked').value
  };
  
  // ëª¨ë“  ë‹´ë³´ ë°ì´í„° ìˆ˜ì§‘ (ì§ˆë³‘í†µì›, ìƒí•´í†µì› ì œê±°)
  const allFields = [
    ...Object.values(COVERAGE_ITEMS).flat(),
    // 5ëŒ€ í•„ìˆ˜ë³´í—˜ í•­ëª©ë“¤
    { key: 'diseaseHospitalization', name: '(ì§ˆë³‘)ì…ì›í•œë„' },
    { key: 'injuryHospitalization', name: '(ìƒí•´)ì…ì›í•œë„' },
    { key: 'criminalSettlement', name: 'í˜•ì‚¬í•©ì˜ê¸ˆ' },
    { key: 'lawyerAppointment', name: 'ë³€í˜¸ì‚¬ì„ ì„ë¹„' },
    { key: 'nursingHospitalOut', name: 'ìš”ì–‘ë³‘ì› ì™¸' },
    { key: 'nursingHospitalIn', name: 'ìš”ì–‘ë³‘ì›' },
    { key: 'nursingCareIntegrated', name: 'ê°„í˜¸ê°„ë³‘í†µí•©' },
    { key: 'dailyLifeLiability', name: 'ì¼ìƒìƒí™œë°°ìƒì±…ì„' },
    { key: 'fireFine', name: 'í™”ì¬ë²Œê¸ˆ' }
  ];
  
  allFields.forEach(item => {
    const input = document.getElementById(item.key);
    if (input && input.value.trim()) {
      currentData.coverages[item.key] = {
        name: item.name,
        value: input.value.trim()
      };
    }
  });
  
  // ì €ì¥
  saveDataToStorage(currentData);
  
  // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
  generatePreview(currentData);
  
  showScreen('preview');
}

// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë°ì´í„° ì €ì¥
function saveDataToStorage(data) {
  let savedData = JSON.parse(localStorage.getItem('ocrWarrantyData') || '[]');
  
  // ê¸°ì¡´ ê³ ê° ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
  const existingIndex = savedData.findIndex(item => item.customerName === data.customerName);
  
  if (existingIndex >= 0) {
    savedData[existingIndex] = data;
  } else {
    savedData.push(data);
  }
  
  localStorage.setItem('ocrWarrantyData', JSON.stringify(savedData));
  savedDataList = savedData;
}

// ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
function loadSavedData() {
  savedDataList = JSON.parse(localStorage.getItem('ocrWarrantyData') || '[]');
}

// ì €ì¥ëœ ë°ì´í„° ëª©ë¡ í‘œì‹œ
function displaySavedList() {
  const savedList = document.getElementById('savedList');
  
  if (savedDataList.length === 0) {
    savedList.innerHTML = '<div class="hint">ì €ì¥ëœ ë³´ì¥ë¶„ì„ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  savedList.innerHTML = savedDataList.map(data => `
    <div class="saved-item" onclick="loadSavedItem('${data.customerName}')">
      <div class="saved-item-title">${data.customerName}</div>
      <div class="saved-item-date">${data.inputDate}</div>
    </div>
  `).join('');
}

// ì €ì¥ëœ í•­ëª© í•„í„°ë§
function filterSavedList() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const filteredList = savedDataList.filter(data => 
    data.customerName.toLowerCase().includes(searchTerm)
  );
  
  const savedList = document.getElementById('savedList');
  
  if (filteredList.length === 0) {
    savedList.innerHTML = '<div class="hint">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  savedList.innerHTML = filteredList.map(data => `
    <div class="saved-item" onclick="loadSavedItem('${data.customerName}')">
      <div class="saved-item-title">${data.customerName}</div>
      <div class="saved-item-date">${data.inputDate}</div>
    </div>
  `).join('');
}

// ì €ì¥ëœ í•­ëª© ë¡œë“œ
function loadSavedItem(customerName) {
  const data = savedDataList.find(item => item.customerName === customerName);
  if (!data) return;
  
  currentData = data;
  
  // ë¯¸ë¦¬ë³´ê¸° ìƒì„± í›„ í™”ë©´ ì „í™˜
  generatePreview(data);
  showScreen('preview');
}

// ë¯¸ë¦¬ë³´ê¸° ìƒì„± (ê°€ë¡œí˜• A4 ì–‘ì‹)
function generatePreview(data) {
  const preview = document.getElementById('printPreview');
  
  // A4 ê°€ë¡œ ì–‘ì‹ìœ¼ë¡œ ë³´ì¥ë¶„ì„ì§€ ìƒì„±
  preview.innerHTML = `
    <div class="print-header">
      (${data.customerName})ë‹˜ì˜ í•œ ì¥ ìš”ì•½ ë³´ì¥ë¶„ì„
    </div>
    
    <div class="sections-container">
      <!-- ì•” ì„¹ì…˜ -->
      <div class="section">
        <div class="section-title">ì•”</div>
        ${generateCoverageItems(data.coverages, COVERAGE_ITEMS.cancer)}
      </div>
      
      <!-- 2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜ ì„¹ì…˜ -->
      <div class="section">
        <div class="section-title">2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜</div>
        ${generateCoverageItems(data.coverages, COVERAGE_ITEMS.majorDisease)}
      </div>
      
      <!-- 5ëŒ€ í•„ìˆ˜ë³´í—˜ ì„¹ì…˜ -->
      <div class="section">
        <div class="section-title">5ëŒ€ í•„ìˆ˜ ë³´í—˜</div>
        
        <div class="subsection">
          <div class="subsection-title">ì‹¤ì†ì˜ë£Œë¹„</div>
          ${generateEssentialCoverageItem(data.coverages, 'diseaseHospitalization', '(ì§ˆë³‘)ì…ì›í•œë„', 'ë§Œì›/ì¼')}
          ${generateEssentialCoverageItem(data.coverages, 'injuryHospitalization', '(ìƒí•´)ì…ì›í•œë„', 'ë§Œì›/ì¼')}
        </div>
        
        <div class="subsection">
          <div class="subsection-title">ìš´ì „ì</div>
          ${generateEssentialCoverageItem(data.coverages, 'criminalSettlement', 'í˜•ì‚¬í•©ì˜ê¸ˆ', 'ë§Œì›', true)}
          ${generateEssentialCoverageItem(data.coverages, 'lawyerAppointment', 'ë³€í˜¸ì‚¬ì„ ì„ë¹„', 'ë§Œì›', true)}
        </div>
        
        <div class="subsection">
          <div class="subsection-title">ê°„ë³‘ì¸ì¼ë‹¹</div>
          ${data.caregiverOption === 'support' ? 
            '<div class="coverage-item"><div class="coverage-name">ì™¸êµ­ ê°„ë³‘ì¸ í˜„ë¬¼ì§€ì›</div><div class="coverage-value">-</div></div>' :
            `
            ${generateEssentialCoverageItem(data.coverages, 'nursingHospitalOut', 'ìš”ì–‘ë³‘ì› ì™¸', 'ë§Œì›/ì¼')}
            ${generateEssentialCoverageItem(data.coverages, 'nursingHospitalIn', 'ìš”ì–‘ë³‘ì›', 'ë§Œì›/ì¼')}
            ${generateEssentialCoverageItem(data.coverages, 'nursingCareIntegrated', 'ê°„í˜¸ê°„ë³‘í†µí•©', 'ë§Œì›/ì¼')}
            `
          }
        </div>
        
        <div class="subsection">
          <div class="subsection-title">ì¼ìƒìƒí™œë°°ìƒì±…ì„</div>
          ${generateEssentialCoverageItem(data.coverages, 'dailyLifeLiability', 'ì¼ìƒìƒí™œë°°ìƒì±…ì„', 'ë§Œì›')}
        </div>
        
        <div class="subsection">
          <div class="subsection-title">í™”ì¬ë²Œê¸ˆ</div>
          ${generateEssentialCoverageItem(data.coverages, 'fireFine', 'í™”ì¬ë²Œê¸ˆ', 'ë§Œì›')}
        </div>
      </div>
    </div>
    
    <!-- ì¹˜ë£Œ ë³´ì¥ ì˜ˆì‹œ -->
    <div class="examples-container">
      <div class="example-section">
        <div class="example-title">ì¼ë°˜ì•” ì¹˜ë£Œ ë³´ì¥ ì˜ˆì‹œ</div>
        ${generateExampleItem('ë‹¤ë¹ˆì¹˜ë¡œë´‡ìˆ˜ìˆ  1ê°œ ë¶€ìœ„', calculateExample1(data.coverages))}
        ${generateExampleItem('ì „ì´+í‘œì ', calculateExample2(data.coverages))}
        ${generateExampleItem('ì¤‘ì…ìì¹˜ë£Œ', calculateExample3(data.coverages))}
      </div>
      
      <div class="example-section">
        <div class="example-title">ë‡Œê²½ìƒ‰ ì¹˜ë£Œ ë³´ì¥ ì˜ˆì‹œ</div>
        ${generateExampleItem('ìŠ¤í…íŠ¸', calculateStentExample(data.coverages))}
        ${generateExampleItem('ìŠ¤í…íŠ¸+í˜ˆì „ìš©í•´', calculateStentThrombolysisExample(data.coverages))}
        ${generateExampleItem('í˜ˆì „ìš©í•´+í˜ˆì „ì œê±°+ì¤‘í™˜ìì‹¤', calculateComplexTreatmentExample(data.coverages))}
      </div>
      
      <div class="example-section">
        <div class="example-title">ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰ ì¹˜ë£Œ ë³´ì¥ ì˜ˆì‹œ</div>
        ${generateExampleItem('ìŠ¤í…íŠ¸', calculateMyocardialStentExample(data.coverages))}
        ${generateExampleItem('ìŠ¤í…íŠ¸+í˜ˆì „ìš©í•´', calculateMyocardialStentThrombolysisExample(data.coverages))}
        ${generateExampleItem('í˜ˆì „ìš©í•´+í˜ˆì „ì œê±°+ì¤‘í™˜ìì‹¤', calculateMyocardialComplexTreatmentExample(data.coverages))}
      </div>
    </div>
    
    <div style="margin-top: 15px; font-size: 7px; color: #666; text-align: center;">
      * ë‹¨ìœ„: ë§Œì› | ì‘ì„±ì¼: ${data.inputDate} | ìƒë…„ì›”ì¼: ${data.birthDate || ''}<br>
      * ë³¸ ìë£ŒëŠ” ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ ë³´ì¥ë‚´ìš©ì€ ì•½ê´€ì„ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
    </div>
  `;
}

// ê°„ë³‘ì¸ ì˜µì…˜ ë³€ê²½ ì²˜ë¦¬
function handleCaregiverOptionChange() {
  const isUse = document.getElementById('caregiverUse').checked;
  const detailsRow = document.getElementById('caregiverDetails');
  
  if (isUse) {
    detailsRow.style.display = 'table-row';
  } else {
    detailsRow.style.display = 'none';
    // ì§€ì› ì„ íƒ ì‹œ ì„¸ë¶€ ì…ë ¥ê°’ë“¤ ì´ˆê¸°í™”
    ['nursingHospitalOut', 'nursingHospitalIn', 'nursingCareIntegrated'].forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = '';
    });
  }
}

// ë‹´ë³´ í•­ëª© ìƒì„± (ì§„í–‰ë¥  ë°” í¬í•¨)
function generateCoverageItems(coverages, items) {
  return items.map(item => {
    const coverage = coverages[item.key];
    const value = coverage ? parseInt(coverage.value) : 0;
    const percentage = calculateProgressPercentage(value, item.standardAmount);
    
    let nameClass = '';
    if (value === 0) nameClass = 'no-coverage';
    
    const displayValue = value ? `${value}ë§Œì›` : '0ë§Œì›';
    const progressBar = generateProgressBar(percentage, value);
    
    return `
      <div class="coverage-item">
        <div class="coverage-name ${nameClass}">${item.name}</div>
        ${progressBar}
        <div class="coverage-value">${displayValue}</div>
      </div>
    `;
  }).join('');
}

// 5ëŒ€ í•„ìˆ˜ë³´í—˜ í•­ëª© ìƒì„± (ìƒ‰ìƒ í‘œì‹œ ë° ì§„í–‰ë¥  ë°”)
function generateEssentialCoverageItem(coverages, key, name, unit, isDriverSection = false) {
  const coverage = coverages[key];
  const value = coverage ? parseInt(coverage.value) : 0;
  
  // í‘œì¤€ê¸ˆì•¡ ì°¾ê¸°
  const standardItem = ESSENTIAL_ITEMS.find(item => item.key === key);
  const standardAmount = standardItem ? standardItem.standardAmount : 1000;
  const percentage = calculateProgressPercentage(value, standardAmount);
  
  let nameClass = '';
  let valueClass = '';
  
  if (value === 0) {
    nameClass = 'no-coverage';
  } else if (percentage >= 100) {
    valueClass = 'full-coverage';
  } else {
    nameClass = 'insufficient-coverage';
  }
  
  const displayValue = value ? `${value}${unit}` : `0${unit}`;
  
  // ìš´ì „ì êµ¬ì—­ì´ë©´ ì§„í–‰ë¥  ë°” ì¶”ê°€
  let progressBar = '';
  if (isDriverSection) {
    progressBar = generateEssentialProgressBar(percentage, value);
  }
  
  return `
    <div class="coverage-item">
      <div class="coverage-name ${nameClass}">${name}</div>
      ${progressBar}
      <div class="coverage-value ${valueClass}">${displayValue}</div>
    </div>
  `;
}

// ì˜ˆì‹œ í•­ëª© ìƒì„±
function generateExampleItem(name, value) {
  return `
    <div class="example-item">
      <div class="example-name">${name}</div>
      <div class="example-value">${value}ë§Œì›</div>
    </div>
  `;
}

// ì¹˜ë£Œ ë³´ì¥ ì˜ˆì‹œ ê³„ì‚° í•¨ìˆ˜ë“¤ (ì—‘ì…€ ìˆ˜ì‹ ê¸°ë°˜)
function calculateExample1(coverages) {
  // C27: ë‹¤ë¹ˆì¹˜ë¡œë´‡ìˆ˜ìˆ  = C5+C6+C8+C9+C12+C13+C14
  // ì¼ë°˜ì•”ì§„ë‹¨ë¹„ + í†µí•©ì•”ì§„ë‹¨ë¹„ + ì•”íŠ¹ì •ì¹˜ë£Œë¹„ + ì•”íŠ¹ì •ì¹˜ë£Œë¹„(ë¹„ê¸‰ì—¬) + ì•”ìˆ˜ìˆ ë¹„ + ë‹¤ë¹ˆì¹˜ë¡œë´‡ìˆ˜ìˆ ë¹„ + 1-5ì¢…ìˆ˜ìˆ ë¹„(5ì¢…)
  const c5 = parseInt(coverages.generalCancer?.value || 0);
  const c6 = parseInt(coverages.totalCancer?.value || 0);
  const c8 = parseInt(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = parseInt(coverages.cancerNonCoveredTreatment?.value || 0);
  const c12 = parseInt(coverages.cancerSurgery?.value || 0);
  const c13 = parseInt(coverages.daVinciSurgery?.value || 0);
  const c14 = parseInt(coverages.surgery5Type?.value || 0);
  
  return (c5 + c6 + c8 + c9 + c12 + c13 + c14).toLocaleString();
}

function calculateExample2(coverages) {
  // C28: 1ê°œ ë¶€ìœ„ ì „ì´+í‘œì  = C5+C6+C7+C8+C9+C10
  // ì¼ë°˜ì•”ì§„ë‹¨ë¹„ + í†µí•©ì•”ì§„ë‹¨ë¹„ + ì „ì´ì•”ì§„ë‹¨ë¹„ + ì•”íŠ¹ì •ì¹˜ë£Œë¹„ + ì•”íŠ¹ì •ì¹˜ë£Œë¹„(ë¹„ê¸‰ì—¬) + í‘œì í•­ì•”ì¹˜ë£Œë¹„
  const c5 = parseInt(coverages.generalCancer?.value || 0);
  const c6 = parseInt(coverages.totalCancer?.value || 0);
  const c7 = parseInt(coverages.metastasisCancer?.value || 0);
  const c8 = parseInt(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = parseInt(coverages.cancerNonCoveredTreatment?.value || 0);
  const c10 = parseInt(coverages.targetTherapy?.value || 0);
  
  return (c5 + c6 + c7 + c8 + c9 + c10).toLocaleString();
}

function calculateExample3(coverages) {
  // C29: ì¤‘ì…ìì¹˜ë£Œ = C5+C6+C8+C9+C11
  // ì¼ë°˜ì•”ì§„ë‹¨ë¹„ + í†µí•©ì•”ì§„ë‹¨ë¹„ + ì•”íŠ¹ì •ì¹˜ë£Œë¹„ + ì•”íŠ¹ì •ì¹˜ë£Œë¹„(ë¹„ê¸‰ì—¬) + ì¤‘ì…ìì¹˜ë£Œë¹„
  const c5 = parseInt(coverages.generalCancer?.value || 0);
  const c6 = parseInt(coverages.totalCancer?.value || 0);
  const c8 = parseInt(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = parseInt(coverages.cancerNonCoveredTreatment?.value || 0);
  const c11 = parseInt(coverages.heavyIonTherapy?.value || 0);
  
  return (c5 + c6 + c8 + c9 + c11).toLocaleString();
}

function calculateStentExample(coverages) {
  // G27: ìŠ¤í…íŠ¸ = G5+G6+G15+G16+G9+G10+G21+G23+G24/2
  // ë‡Œí˜ˆê´€ì§ˆí™˜ì§„ë‹¨ë¹„ + ë‡Œì¡¸ì¤‘ì§„ë‹¨ë¹„ + 2ëŒ€íŠ¹ì •ì¹˜ë£Œë¹„ + ì£¼ìš”ìˆœí™˜ê³„(ìˆ˜ìˆ ) + ë‡Œí˜ˆê´€ì§ˆí™˜ìˆ˜ìˆ ë¹„ + ë‡Œì¡¸ì¤‘ìˆ˜ìˆ ë¹„ + 1-5ì¢…ìˆ˜ìˆ ë¹„(3ì¢…) + 124ëŒ€ì§ˆë³‘ìˆ˜ìˆ ë¹„(íŠ¹ì •10ëŒ€) + 7ëŒ€ê¸°ê´€ìˆ˜ìˆ ë¹„(ë‡Œ/ì‹¬) ê´€í˜ˆ/2
  const g5 = parseInt(coverages.cerebrovascularDiagnosis?.value || 0);
  const g6 = parseInt(coverages.strokeDiagnosis?.value || 0);
  const g15 = parseInt(coverages.twoMajorTreatment?.value || 0);
  const g16 = parseInt(coverages.majorCirculatorySurgery?.value || 0);
  const g9 = parseInt(coverages.cerebrovascularSurgery?.value || 0);
  const g10 = parseInt(coverages.strokeSurgery?.value || 0);
  const g21 = parseInt(coverages.surgery3Type?.value || 0);
  const g23 = parseInt(coverages.disease124Surgery?.value || 0);
  const g24 = parseInt(coverages.sevenOrganSurgery?.value || 0);
  
  return (g5 + g6 + g15 + g16 + g9 + g10 + g21 + g23 + g24/2).toLocaleString();
}

function calculateStentThrombolysisExample(coverages) {
  // G28: ìŠ¤í…íŠ¸+í˜ˆì „ìš©í•´ = G5+G6+G15+G16+G9+G10+G21+G23+G24/2+G18+G13
  // ìœ„ í•­ëª©ë“¤ + ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ìš©í•´) + ë‡Œì¡¸ì¤‘í˜ˆì „ìš©í•´
  const baseValue = parseFloat(calculateStentExample(coverages).replace(/,/g, ''));
  const g18 = parseInt(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g13 = parseInt(coverages.strokeThrombolysis?.value || 0);
  
  return (baseValue + g18 + g13).toLocaleString();
}

function calculateComplexTreatmentExample(coverages) {
  // G29: í˜ˆì „ìš©í•´+í˜ˆì „ì œê±°+ì¤‘í™˜ìì‹¤ = G5+G6+G15+G17+G9+G10+G21+G23+G24/2+G18+G13+G19+G20
  // ê¸°ë³¸ ìŠ¤í…íŠ¸ í•­ëª©ë“¤ + ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ì œê±°) + ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ìš©í•´) + ë‡Œì¡¸ì¤‘í˜ˆì „ìš©í•´ + ì£¼ìš”ìˆœí™˜ê³„(ì¤‘í™˜ìì‹¤) + í˜ˆì „ì œê±°ì¹˜ë£Œë¹„
  const g5 = parseInt(coverages.cerebrovascularDiagnosis?.value || 0);
  const g6 = parseInt(coverages.strokeDiagnosis?.value || 0);
  const g15 = parseInt(coverages.twoMajorTreatment?.value || 0);
  const g17 = parseInt(coverages.majorCirculatoryThrombectomy?.value || 0);
  const g9 = parseInt(coverages.cerebrovascularSurgery?.value || 0);
  const g10 = parseInt(coverages.strokeSurgery?.value || 0);
  const g21 = parseInt(coverages.surgery3Type?.value || 0);
  const g23 = parseInt(coverages.disease124Surgery?.value || 0);
  const g24 = parseInt(coverages.sevenOrganSurgery?.value || 0);
  const g18 = parseInt(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g13 = parseInt(coverages.strokeThrombolysis?.value || 0);
  const g19 = parseInt(coverages.majorCirculatoryICU?.value || 0);
  const g20 = parseInt(coverages.thrombectomyTreatment?.value || 0);
  
  return (g5 + g6 + g15 + g17 + g9 + g10 + g21 + g23 + g24/2 + g18 + g13 + g19 + g20).toLocaleString();
}

function calculateMyocardialStentExample(coverages) {
  // K27: ìŠ¤í…íŠ¸ = G7+G8+G15+G16+G11+G12+G21+G23+G24/2
  // í—ˆí˜ˆì„±ì‹¬ì¥ì§ˆí™˜ì§„ë‹¨ë¹„ + ì‹¬ê·¼ê²½ìƒ‰ì§„ë‹¨ë¹„ + 2ëŒ€íŠ¹ì •ì¹˜ë£Œë¹„ + ì£¼ìš”ìˆœí™˜ê³„(ìˆ˜ìˆ ) + í—ˆí˜ˆì„±ì‹¬ì¥ì§ˆí™˜ìˆ˜ìˆ ë¹„ + ì‹¬ê·¼ê²½ìƒ‰ìˆ˜ìˆ ë¹„ + 1-5ì¢…ìˆ˜ìˆ ë¹„(3ì¢…) + 124ëŒ€ì§ˆë³‘ìˆ˜ìˆ ë¹„(íŠ¹ì •10ëŒ€) + 7ëŒ€ê¸°ê´€ìˆ˜ìˆ ë¹„(ë‡Œ/ì‹¬) ê´€í˜ˆ/2
  const g7 = parseInt(coverages.ischemicHeartDiagnosis?.value || 0);
  const g8 = parseInt(coverages.myocardialInfarctionDiagnosis?.value || 0);
  const g15 = parseInt(coverages.twoMajorTreatment?.value || 0);
  const g16 = parseInt(coverages.majorCirculatorySurgery?.value || 0);
  const g11 = parseInt(coverages.ischemicHeartSurgery?.value || 0);
  const g12 = parseInt(coverages.myocardialInfarctionSurgery?.value || 0);
  const g21 = parseInt(coverages.surgery3Type?.value || 0);
  const g23 = parseInt(coverages.disease124Surgery?.value || 0);
  const g24 = parseInt(coverages.sevenOrganSurgery?.value || 0);
  
  return (g7 + g8 + g15 + g16 + g11 + g12 + g21 + g23 + g24/2).toLocaleString();
}

function calculateMyocardialStentThrombolysisExample(coverages) {
  // K28: ìŠ¤í…íŠ¸+í˜ˆì „ìš©í•´ = G7+G8+G15+G16+G11+G12+G21+G23+G24/2+G18+G14
  // ìœ„ í•­ëª©ë“¤ + ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ìš©í•´) + ì‹¬ê·¼ê²½ìƒ‰í˜ˆì „ìš©í•´
  const baseValue = parseFloat(calculateMyocardialStentExample(coverages).replace(/,/g, ''));
  const g18 = parseInt(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g14 = parseInt(coverages.myocardialInfarctionThrombolysis?.value || 0);
  
  return (baseValue + g18 + g14).toLocaleString();
}

function calculateMyocardialComplexTreatmentExample(coverages) {
  // K29: í˜ˆì „ìš©í•´+í˜ˆì „ì œê±°+ì¤‘í™˜ìì‹¤ = G7+G8+G15+G17+G11+G12+G21+G23+G24/2+G18+G14+G19+G20
  // í—ˆí˜ˆì„±ì‹¬ì¥ì§ˆí™˜ì§„ë‹¨ë¹„ + ì‹¬ê·¼ê²½ìƒ‰ì§„ë‹¨ë¹„ + 2ëŒ€íŠ¹ì •ì¹˜ë£Œë¹„ + ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ì œê±°) + í—ˆí˜ˆì„±ì‹¬ì¥ì§ˆí™˜ìˆ˜ìˆ ë¹„ + ì‹¬ê·¼ê²½ìƒ‰ìˆ˜ìˆ ë¹„ + 1-5ì¢…ìˆ˜ìˆ ë¹„(3ì¢…) + 124ëŒ€ì§ˆë³‘ìˆ˜ìˆ ë¹„(íŠ¹ì •10ëŒ€) + 7ëŒ€ê¸°ê´€ìˆ˜ìˆ ë¹„(ë‡Œ/ì‹¬) ê´€í˜ˆ/2 + ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ìš©í•´) + ì‹¬ê·¼ê²½ìƒ‰í˜ˆì „ìš©í•´ + ì£¼ìš”ìˆœí™˜ê³„(ì¤‘í™˜ìì‹¤) + í˜ˆì „ì œê±°ì¹˜ë£Œë¹„
  const g7 = parseInt(coverages.ischemicHeartDiagnosis?.value || 0);
  const g8 = parseInt(coverages.myocardialInfarctionDiagnosis?.value || 0);
  const g15 = parseInt(coverages.twoMajorTreatment?.value || 0);
  const g17 = parseInt(coverages.majorCirculatoryThrombectomy?.value || 0);
  const g11 = parseInt(coverages.ischemicHeartSurgery?.value || 0);
  const g12 = parseInt(coverages.myocardialInfarctionSurgery?.value || 0);
  const g21 = parseInt(coverages.surgery3Type?.value || 0);
  const g23 = parseInt(coverages.disease124Surgery?.value || 0);
  const g24 = parseInt(coverages.sevenOrganSurgery?.value || 0);
  const g18 = parseInt(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g14 = parseInt(coverages.myocardialInfarctionThrombolysis?.value || 0);
  const g19 = parseInt(coverages.majorCirculatoryICU?.value || 0);
  const g20 = parseInt(coverages.thrombectomyTreatment?.value || 0);
  
  return (g7 + g8 + g15 + g17 + g11 + g12 + g21 + g23 + g24/2 + g18 + g14 + g19 + g20).toLocaleString();
}

// ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
function downloadImage() {
  const preview = document.getElementById('printPreview');
  
  // ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ì„ í¬í•¨í•œ ìƒˆ ì°½ ìƒì„± (ë¯¸ë¦¬ë³´ê¸°ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <title>ë³´ì¥ë¶„ì„ì§€ - ${currentData.customerName}</title>
      <meta charset="UTF-8">
      <style>
        * {
          box-sizing: border-box;
        }
        
        body { 
          margin: 0; 
          padding: 15px; 
          font-family: Arial, "Noto Sans KR", sans-serif;
          color: #333;
          font-size: 9px;
          background: white;
        }
        
        @media print { 
          body { 
            margin: 0; 
            padding: 10mm; 
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
          }
          
          .sections-container {
            break-inside: avoid;
            page-break-inside: avoid;
          }
          
          .section {
            break-inside: avoid;
            page-break-inside: avoid;
          }
          
          .examples-container {
            break-inside: avoid;
            page-break-inside: avoid;
          }
        }
        
        @page { 
          size: A4 landscape; 
          margin: 10mm;
        }
        
        .print-header {
          text-align: center;
          font-size: 16px;
          font-weight: 700;
          margin-bottom: 20px;
          color: #ff7f00;
        }
        
        .sections-container {
          display: flex !important;
          gap: 15px;
          margin-bottom: 20px;
          width: 100%;
        }
        
        .section {
          flex: 1;
          border: 1px solid #333;
          padding: 10px;
          min-height: 300px;
        }
        
        .section-title {
          text-align: center;
          font-weight: 700;
          font-size: 12px;
          margin-bottom: 10px;
          background: #ff7f00 !important;
          color: white !important;
          margin: -10px -10px 10px -10px;
          padding: 8px;
        }
        
        .coverage-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: 4px 0;
          padding: 2px 0;
          border-bottom: 1px dotted #ccc;
          font-size: 8px;
          line-height: 1.2;
        }
        
        .coverage-name {
          flex: 1;
          padding-right: 8px;
          font-size: 8px;
        }
        
        .coverage-value {
          font-weight: 600;
          color: #ff7f00;
          min-width: 45px;
          text-align: right;
          font-size: 8px;
        }
        
        .coverage-progress {
          margin: 1px 6px;
          height: 6px;
          background: #f0f0f0;
          border-radius: 3px;
          overflow: hidden;
          position: relative;
          min-width: 25px;
        }
        
        .progress-bar {
          height: 100%;
          border-radius: 3px;
        }
        
        .progress-green { background: #28a745 !important; }
        .progress-yellow { background: #ffc107 !important; }
        .progress-red { background: #dc3545 !important; }
        
        .no-coverage-x {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: #dc3545 !important;
          font-weight: 900;
          font-size: 8px;
          line-height: 1;
        }
        
        .coverage-name.no-coverage { color: #dc3545 !important; }
        .coverage-value.full-coverage { color: #28a745 !important; font-weight: 700; }
        .coverage-value.insufficient-coverage { color: #dc3545 !important; }
        
        .subsection {
          margin-bottom: 12px;
          border: 1px solid #ddd;
          padding: 8px;
        }
        
        .subsection-title {
          font-weight: 600;
          font-size: 8px;
          margin-bottom: 6px;
          text-align: center;
          background: #f8f9fa;
          padding: 4px;
          border: 1px solid #ddd;
          margin: -8px -8px 6px -8px;
        }
        
        .examples-container {
          display: flex !important;
          gap: 15px;
          margin-top: 15px;
          width: 100%;
          break-inside: avoid;
          page-break-inside: avoid;
        }
        
        .example-section {
          flex: 1;
          border: 1px solid #333;
          padding: 8px;
        }
        
        .example-title {
          font-weight: 700;
          font-size: 9px;
          margin-bottom: 8px;
          text-align: center;
          padding: 4px;
          background: #f0f0f0;
          border: 1px solid #333;
          margin: -8px -8px 8px -8px;
        }
        
        .example-item {
          display: flex;
          justify-content: space-between;
          margin: 3px 0;
          font-size: 8px;
          padding: 2px 0;
          border-bottom: 1px dotted #ccc;
          line-height: 1.2;
        }
        
        .example-name {
          flex: 1;
          font-size: 8px;
        }
        
        .example-value {
          font-weight: 600;
          color: #ff7f00;
          font-size: 8px;
        }
        
        /* í•˜ë‹¨ ë©”íƒ€ ì •ë³´ */
        div[style*="margin-top: 15px"] {
          margin-top: 15px !important;
          font-size: 7px !important;
        }
      </style>
    </head>
    <body>
      ${preview.innerHTML}
    </body>
    </html>
  `);
  
  printWindow.document.close();
}
</script>

</body>
</html>
