<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OCR 보장분석지 변환기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
  <style>
    :root{
      --hanwha:#ff7f00;
      --hanwha-dark:#e67100;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding-top: 70px;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    
    .header-fixed {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--bg);
      border-bottom: 2px solid #ccc;
      padding: 8px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-left {
      flex: 1;
    }
    
    .header-center {
      flex: 1;
      text-align: center;
    }
    
    .header-right {
      flex: 1;
      text-align: right;
    }
    
    .logo-container {
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
    }
    
    .logo-container:hover {
      transform: scale(1.05);
    }
    
    .logo-main {
      font-size: 32px;
      font-weight: 900;
      color: var(--hanwha);
      letter-spacing: 3px;
      text-shadow: 0 2px 4px rgba(255,127,0,0.2);
      margin: 0;
      line-height: 1;
    }
    
    .logo-sub {
      font-size: 11px;
      color: var(--muted);
      font-weight: 400;
      margin-top: 2px;
      letter-spacing: 1px;
      opacity: 0.8;
    }
    
    .logo-container:hover .logo-main {
      color: var(--hanwha-dark);
      text-shadow: 0 4px 8px rgba(255,127,0,0.3);
    }
    
    .logo-container:hover .logo-sub {
      opacity: 1;
    }
    
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem 1rem;
    }
    .app-title{
      font-size:24px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:20px;
    }
    .card.wide{
      max-width:1200px;
    }
    h2{margin:0 0 .75rem 0}
    .row{margin-bottom:.75rem}
    input, select, textarea{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--hanwha)}
    button{
      width:100%;
      padding:12px 14px;
      background:var(--hanwha);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
    }
    button:hover{background:var(--hanwha-dark)}
    button.secondary{
      background:#6c757d;
      margin-bottom:0;
    }
    button.secondary:hover{background:#545b62}
    button.small{
      width:auto;
      padding:6px 10px;
      font-size:12px;
      margin:2px;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:.25rem}
    .error{color:#d93025; font-size:14px; margin-top:.5rem}
    .success{color:#28a745; font-size:14px; margin-top:.5rem}
    
    /* 이미지 업로드/미리보기 */
    .image-upload-area {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      background: #fafafa;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .image-upload-area:hover {
      border-color: var(--hanwha);
      background: #fff5f0;
    }
    
    .image-upload-area.drag-over {
      border-color: var(--hanwha);
      background: #fff5f0;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    /* 데이터 입력 테이블 */
    .input-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    
    .input-table th,
    .input-table td {
      border: 1px solid var(--border);
      padding: 8px 12px;
      text-align: left;
      vertical-align: top;
    }
    
    .input-table th {
      background: var(--bg);
      font-weight: 600;
      width: 40%;
    }
    
    .input-table input {
      width: 100%;
      padding: 6px 8px;
      margin: 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .section-header {
      background: var(--hanwha);
      color: white;
      font-weight: 700;
      text-align: center;
    }
    
    /* 저장된 데이터 목록 */
    .saved-item {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .saved-item:hover {
      background: #f8f9fa;
      border-color: var(--hanwha);
    }
    
    .saved-item-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .saved-item-date {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* 출력용 스타일 */
    .print-preview {
      background: white;
      border: 1px solid #ccc;
      margin: 20px 0;
      padding: 20px;
      font-size: 12px;
    }
    
    .print-header {
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--hanwha);
    }
    
    .print-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    
    .print-table th,
    .print-table td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
    }
    
    .print-table th {
      background: #f0f0f0;
      font-weight: 600;
    }
    
    /* 로딩 스피너 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--hanwha);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 반응형 */
    @media (max-width: 768px) {
      .card {
        max-width: 100%;
        margin: 0 10px;
      }
      
      .input-table th,
      .input-table td {
        padding: 6px 8px;
        font-size: 14px;
      }
      
      .input-table th {
        width: 35%;
      }
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header-fixed">
    <div class="header-left"></div>
    <div class="header-center">
      <div class="logo-container" onclick="goHome()">
        <div class="logo-main">보장분석</div>
        <div class="logo-sub">OCR 변환기</div>
      </div>
    </div>
    <div class="header-right"></div>
  </div>

  <!-- 메뉴 화면 -->
  <section id="menuScreen" class="screen">
    <div class="app-title">보장분석지 OCR 변환기</div>
    <div class="card">
      <h2 style="margin-bottom:1.5rem; text-align:center;">메뉴 선택</h2>
      
      <button id="inputMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">입력하기</span>
        <span style="font-size:14px; opacity:0.8;">이미지 촬영/업로드 → OCR 인식 → 데이터 입력</span>
      </button>
      
      <button id="loadMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">불러오기</span>
        <span style="font-size:14px; opacity:0.8;">저장된 보장분석지 목록에서 선택</span>
      </button>
      
      <div class="meta" style="margin-top:2rem; text-align:center;">
        Google Vision API를 활용한 한글 OCR 서비스
      </div>
    </div>
  </section>

  <!-- 입력 화면 -->
  <section id="inputScreen" class="screen hidden">
    <div class="app-title">보장분석지 입력하기</div>
    <div class="card wide">
      <div class="row">
        <div class="image-upload-area" id="imageUploadArea">
          <div id="uploadText">
            📸 보장분석지 이미지를 클릭하여 업로드하거나<br>
            드래그 앤 드롭하세요
          </div>
          <img id="imagePreview" class="image-preview hidden" alt="미리보기">
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
        </div>
      </div>
      
      <div class="row">
        <button id="ocrProcessBtn" disabled>OCR 인식 시작</button>
        <div id="ocrStatus" class="hint"></div>
      </div>
      
      <!-- 고객 기본 정보 -->
      <div class="row">
        <h3>고객 기본 정보</h3>
        <table class="input-table">
          <tr>
            <th>고객명</th>
            <td><input type="text" id="customerName" placeholder="고객명을 입력하세요"></td>
          </tr>
          <tr>
            <th>생년월일</th>
            <td><input type="text" id="birthDate" placeholder="YYYY.MM.DD"></td>
          </tr>
        </table>
      </div>
      
      <!-- 암 관련 담보 -->
      <div class="row">
        <h3>암 관련 담보</h3>
        <table class="input-table" id="cancerTable">
          <tr class="section-header">
            <th colspan="2">암 관련 담보 (만원)</th>
          </tr>
        </table>
      </div>
      
      <!-- 2대 중대질환 -->
      <div class="row">
        <h3>2대 중대질환</h3>
        <table class="input-table" id="majorDiseaseTable">
          <tr class="section-header">
            <th colspan="2">2대 중대질환 (만원)</th>
          </tr>
        </table>
      </div>
      
      <!-- 수술비 -->
      <div class="row">
        <h3>수술비</h3>
        <table class="input-table" id="surgeryTable">
          <tr class="section-header">
            <th colspan="2">수술비 (만원)</th>
          </tr>
        </table>
      </div>
      
      <!-- 입원/통원 -->
      <div class="row">
        <h3>입원/통원</h3>
        <table class="input-table" id="hospitalTable">
          <tr class="section-header">
            <th colspan="2">입원/통원 한도 (만원/일)</th>
          </tr>
        </table>
      </div>
      
      <!-- 기타 -->
      <div class="row">
        <h3>기타 담보</h3>
        <table class="input-table" id="otherTable">
          <tr class="section-header">
            <th colspan="2">기타 담보 (만원)</th>
          </tr>
        </table>
      </div>
      
      <div class="row" style="margin-top: 2rem;">
        <button id="saveDataBtn">이미지로 저장하기</button>
        <button id="backToMenuBtn" class="secondary">뒤로가기</button>
      </div>
    </div>
  </section>

  <!-- 불러오기 화면 -->
  <section id="loadScreen" class="screen hidden">
    <div class="app-title">저장된 보장분석지 불러오기</div>
    <div class="card">
      <div class="row">
        <input type="text" id="searchInput" placeholder="고객명으로 검색...">
      </div>
      
      <div id="savedList">
        <!-- 저장된 항목들이 여기에 동적으로 추가됩니다 -->
      </div>
      
      <div class="row" style="margin-top: 2rem;">
        <button id="backToMenuFromLoadBtn" class="secondary">뒤로가기</button>
      </div>
    </div>
  </section>

  <!-- 미리보기/출력 화면 -->
  <section id="previewScreen" class="screen hidden">
    <div class="app-title">보장분석지 미리보기</div>
    <div class="card wide">
      <div id="printPreview" class="print-preview">
        <!-- 출력용 보장분석지가 여기에 생성됩니다 -->
      </div>
      
      <div class="row">
        <button id="downloadImageBtn">이미지 다운로드</button>
        <button id="editDataBtn" class="secondary">수정하기</button>
        <button id="backToMenuFromPreviewBtn" class="secondary">메뉴로 돌아가기</button>
      </div>
    </div>
  </section>

<script>
// 전역 변수
let currentData = {};
let savedDataList = [];

// 담보 항목 정의
const COVERAGE_ITEMS = {
  cancer: [
    { key: 'generalCancer', name: '일반암진단비' },
    { key: 'totalCancer', name: '통합암진단비' },
    { key: 'metastasisCancer', name: '전이암진단비' },
    { key: 'cancerSpecificTreatment', name: '암특정치료비' },
    { key: 'cancerNonCoveredTreatment', name: '암특정치료비(비급여)' },
    { key: 'targetTherapy', name: '표적항암치료비' },
    { key: 'heavyIonTherapy', name: '중입자치료비' },
    { key: 'cancerSurgery', name: '암수술비' },
    { key: 'daVinciSurgery', name: '다빈치로봇수술비' },
    { key: 'surgery5Type', name: '1-5종수술비(5종)' }
  ],
  majorDisease: [
    { key: 'cerebrovascularDiagnosis', name: '뇌혈관질환진단비' },
    { key: 'strokeDiagnosis', name: '뇌졸중진단비' },
    { key: 'ischemicHeartDiagnosis', name: '허혈성심장질환진단비' },
    { key: 'myocardialInfarctionDiagnosis', name: '심근경색진단비' },
    { key: 'cerebrovascularSurgery', name: '뇌혈관질환수술비' },
    { key: 'strokeSurgery', name: '뇌졸중수술비' },
    { key: 'ischemicHeartSurgery', name: '허혈성심장질환수술비' },
    { key: 'myocardialInfarctionSurgery', name: '심근경색수술비' },
    { key: 'strokeThrombolysis', name: '뇌졸중혈전용해' },
    { key: 'myocardialInfarctionThrombolysis', name: '심근경색혈전용해' },
    { key: 'twoMajorTreatment', name: '2대특정치료비' },
    { key: 'majorCirculatorySurgery', name: '주요순환계(수술)' },
    { key: 'majorCirculatoryThrombectomy', name: '주요순환계(혈전제거)' },
    { key: 'majorCirculatoryThrombolysis', name: '주요순환계(혈전용해)' },
    { key: 'majorCirculatoryICU', name: '주요순환계(중환자실)' },
    { key: 'thrombectomyTreatment', name: '혈전제거치료비' }
  ],
  surgery: [
    { key: 'surgery3Type', name: '1-5종수술비(3종)' },
    { key: 'surgery5Type2', name: '1-5종수술비(5종)' },
    { key: 'disease124Surgery', name: '124대질병수술비(특정10대)' },
    { key: 'sevenOrganSurgery', name: '7대기관수술비(뇌/심) 관혈' }
  ],
  hospital: [
    { key: 'diseaseHospitalization', name: '(질병)입원한도' },
    { key: 'diseaseOutpatient', name: '(질병)통원한도' },
    { key: 'injuryHospitalization', name: '(상해)입원한도' },
    { key: 'injuryOutpatient', name: '(상해)통원한도' }
  ],
  other: [
    { key: 'criminalSettlement', name: '형사합의금' },
    { key: 'lawyerAppointment', name: '변호사선임비' },
    { key: 'nursingHospitalOut', name: '요양병원 외' },
    { key: 'nursingHospitalIn', name: '요양병원' },
    { key: 'nursingCareIntegrated', name: '간호간병통합' },
    { key: 'dailyLifeLiability', name: '일상생활배상책임' },
    { key: 'fireFine', name: '화재벌금' }
  ]
};

// DOM 로드 완료 시 초기화
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  loadSavedData();
  setupEventListeners();
});

// 앱 초기화
function initializeApp() {
  showScreen('menu');
  createInputTables();
}

// 이벤트 리스너 설정
function setupEventListeners() {
  // 메뉴 버튼들
  document.getElementById('inputMenuBtn').addEventListener('click', () => showScreen('input'));
  document.getElementById('loadMenuBtn').addEventListener('click', () => {
    showScreen('load');
    displaySavedList();
  });
  
  // 뒤로가기 버튼들
  document.getElementById('backToMenuBtn').addEventListener('click', () => showScreen('menu'));
  document.getElementById('backToMenuFromLoadBtn').addEventListener('click', () => showScreen('menu'));
  document.getElementById('backToMenuFromPreviewBtn').addEventListener('click', () => showScreen('menu'));
  document.getElementById('editDataBtn').addEventListener('click', () => showScreen('input'));
  
  // 이미지 업로드 관련
  const imageUploadArea = document.getElementById('imageUploadArea');
  const imageInput = document.getElementById('imageInput');
  const imagePreview = document.getElementById('imagePreview');
  
  imageUploadArea.addEventListener('click', () => imageInput.click());
  imageInput.addEventListener('change', handleImageUpload);
  
  // 드래그 앤 드롭
  imageUploadArea.addEventListener('dragover', handleDragOver);
  imageUploadArea.addEventListener('drop', handleDrop);
  imageUploadArea.addEventListener('dragenter', (e) => {
    e.preventDefault();
    imageUploadArea.classList.add('drag-over');
  });
  imageUploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    imageUploadArea.classList.remove('drag-over');
  });
  
  // OCR 처리 버튼
  document.getElementById('ocrProcessBtn').addEventListener('click', processOCR);
  
  // 저장 버튼
  document.getElementById('saveDataBtn').addEventListener('click', saveAndPreview);
  
  // 다운로드 버튼
  document.getElementById('downloadImageBtn').addEventListener('click', downloadImage);
  
  // 검색 기능
  document.getElementById('searchInput').addEventListener('input', filterSavedList);
}

// 화면 전환
function showScreen(screenName) {
  const screens = ['menu', 'input', 'load', 'preview'];
  screens.forEach(name => {
    document.getElementById(name + 'Screen').classList.toggle('hidden', name !== screenName);
  });
  
  if (screenName === 'input') {
    resetInputForm();
  }
}

// 홈으로 이동
function goHome() {
  showScreen('menu');
}

// 입력 테이블 생성
function createInputTables() {
  Object.entries(COVERAGE_ITEMS).forEach(([category, items]) => {
    const table = document.getElementById(category + 'Table');
    items.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <th>${item.name}</th>
        <td><input type="text" id="${item.key}" placeholder="0" data-coverage="${item.name}"></td>
      `;
      table.appendChild(row);
    });
  });
}

// 입력 폼 초기화
function resetInputForm() {
  document.getElementById('customerName').value = '';
  document.getElementById('birthDate').value = '';
  
  // 모든 담보 항목 초기화
  Object.values(COVERAGE_ITEMS).flat().forEach(item => {
    const input = document.getElementById(item.key);
    if (input) input.value = '';
  });
  
  // 이미지 미리보기 초기화
  const imagePreview = document.getElementById('imagePreview');
  const uploadText = document.getElementById('uploadText');
  imagePreview.classList.add('hidden');
  uploadText.style.display = 'block';
  
  document.getElementById('ocrProcessBtn').disabled = true;
  document.getElementById('ocrStatus').textContent = '';
}

// 이미지 업로드 처리
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (file && file.type.startsWith('image/')) {
    displayImagePreview(file);
  }
}

// 드래그 오버 처리
function handleDragOver(event) {
  event.preventDefault();
}

// 드롭 처리
function handleDrop(event) {
  event.preventDefault();
  document.getElementById('imageUploadArea').classList.remove('drag-over');
  
  const files = event.dataTransfer.files;
  if (files.length > 0 && files[0].type.startsWith('image/')) {
    displayImagePreview(files[0]);
  }
}

// 이미지 미리보기 표시
function displayImagePreview(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const imagePreview = document.getElementById('imagePreview');
    const uploadText = document.getElementById('uploadText');
    
    imagePreview.src = e.target.result;
    imagePreview.classList.remove('hidden');
    uploadText.style.display = 'none';
    
    document.getElementById('ocrProcessBtn').disabled = false;
    document.getElementById('ocrStatus').textContent = 'OCR 인식을 시작할 수 있습니다.';
  };
  reader.readAsDataURL(file);
}

// OCR 처리 (Google Vision API 연동)
async function processOCR() {
  const ocrBtn = document.getElementById('ocrProcessBtn');
  const ocrStatus = document.getElementById('ocrStatus');
  const imagePreview = document.getElementById('imagePreview');
  
  if (!imagePreview.src) {
    alert('먼저 이미지를 업로드해주세요.');
    return;
  }
  
  try {
    ocrBtn.disabled = true;
    ocrStatus.innerHTML = '<span class="loading"></span> OCR 인식 중... 잠시만 기다려주세요.';
    
    // 이미지를 base64로 변환
    const base64Image = imagePreview.src.split(',')[1];
    
    // Google Vision API 호출
    const result = await callGoogleVisionAPI(base64Image);
    
    if (result && result.responses && result.responses[0]) {
      const textAnnotations = result.responses[0].textAnnotations;
      if (textAnnotations && textAnnotations.length > 0) {
        const detectedText = textAnnotations[0].description;
        
        // OCR 결과를 파싱하여 입력 필드에 자동 입력
        parseOCRResult(detectedText);
        
        ocrStatus.innerHTML = '<span class="success">✅ OCR 인식이 완료되었습니다. 결과를 확인하고 필요시 수정해주세요.</span>';
      } else {
        ocrStatus.innerHTML = '<span class="error">❌ 텍스트를 인식할 수 없습니다.</span>';
      }
    } else {
      ocrStatus.innerHTML = '<span class="error">❌ OCR 처리 중 오류가 발생했습니다.</span>';
    }
  } catch (error) {
    console.error('OCR 처리 오류:', error);
    ocrStatus.innerHTML = '<span class="error">❌ OCR 처리 중 오류가 발생했습니다: ' + error.message + '</span>';
  } finally {
    ocrBtn.disabled = false;
  }
}

// Google Vision API 호출
async function callGoogleVisionAPI(base64Image) {
  const API_KEY = 'YOUR_GOOGLE_VISION_API_KEY'; // 실제 API 키로 교체 필요
  
  const requestBody = {
    requests: [{
      image: {
        content: base64Image
      },
      features: [{
        type: 'DOCUMENT_TEXT_DETECTION',
        maxResults: 1
      }]
    }]
  };
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
    throw new Error(`API 호출 실패: ${response.status}`);
  }
  
  return await response.json();
}

// OCR 결과 파싱 및 자동 입력
function parseOCRResult(text) {
  const lines = text.split('\n');
  const coverageMap = new Map();
  
  // 모든 담보 항목의 이름을 맵에 저장
  Object.values(COVERAGE_ITEMS).flat().forEach(item => {
    coverageMap.set(item.name, item.key);
  });
  
  // 텍스트에서 담보명과 금액을 찾아서 매칭
  lines.forEach(line => {
    const cleanLine = line.trim();
    
    // 고객명 추출
    if (cleanLine.includes('님의') || cleanLine.includes('고객명')) {
      const nameMatch = cleanLine.match(/([가-힣]+)님의/);
      if (nameMatch) {
        document.getElementById('customerName').value = nameMatch[1];
      }
    }
    
    // 담보별 금액 추출
    coverageMap.forEach((key, name) => {
      if (cleanLine.includes(name)) {
        // 숫자 패턴 찾기 (1000, 5000 등)
        const numberMatch = cleanLine.match(/(\d{1,5})/);
        if (numberMatch) {
          const input = document.getElementById(key);
          if (input && !input.value) { // 이미 값이 있으면 덮어쓰지 않음
            input.value = numberMatch[1];
          }
        }
      }
    });
  });
  
  // 샘플 데이터로 테스트 (실제 OCR 결과가 없을 때)
  if (!document.getElementById('customerName').value) {
    fillSampleData();
  }
}

// 샘플 데이터 채우기 (테스트용)
function fillSampleData() {
  document.getElementById('customerName').value = '홍길동';
  document.getElementById('birthDate').value = '1980.01.15';
  document.getElementById('generalCancer').value = '1000';
  document.getElementById('targetTherapy').value = '5000';
  document.getElementById('surgery5Type').value = '1000';
}

// 데이터 저장 및 미리보기
function saveAndPreview() {
  const customerName = document.getElementById('customerName').value.trim();
  
  if (!customerName) {
    alert('고객명을 입력해주세요.');
    return;
  }
  
  // 현재 데이터 수집
  currentData = {
    customerName: customerName,
    birthDate: document.getElementById('birthDate').value.trim(),
    inputDate: new Date().toLocaleString('ko-KR'),
    coverages: {}
  };
  
  // 모든 담보 데이터 수집
  Object.values(COVERAGE_ITEMS).flat().forEach(item => {
    const input = document.getElementById(item.key);
    if (input && input.value.trim()) {
      currentData.coverages[item.key] = {
        name: item.name,
        value: input.value.trim()
      };
    }
  });
  
  // 저장
  saveDataToStorage(currentData);
  
  // 미리보기 생성
  generatePreview(currentData);
  
  showScreen('preview');
}

// 로컬 스토리지에 데이터 저장
function saveDataToStorage(data) {
  let savedData = JSON.parse(localStorage.getItem('ocrWarrantyData') || '[]');
  
  // 기존 고객 데이터가 있으면 업데이트, 없으면 추가
  const existingIndex = savedData.findIndex(item => item.customerName === data.customerName);
  
  if (existingIndex >= 0) {
    savedData[existingIndex] = data;
  } else {
    savedData.push(data);
  }
  
  localStorage.setItem('ocrWarrantyData', JSON.stringify(savedData));
  savedDataList = savedData;
}

// 저장된 데이터 로드
function loadSavedData() {
  savedDataList = JSON.parse(localStorage.getItem('ocrWarrantyData') || '[]');
}

// 저장된 데이터 목록 표시
function displaySavedList() {
  const savedList = document.getElementById('savedList');
  
  if (savedDataList.length === 0) {
    savedList.innerHTML = '<div class="hint">저장된 보장분석지가 없습니다.</div>';
    return;
  }
  
  savedList.innerHTML = savedDataList.map(data => `
    <div class="saved-item" onclick="loadSavedItem('${data.customerName}')">
      <div class="saved-item-title">${data.customerName}</div>
      <div class="saved-item-date">${data.inputDate}</div>
    </div>
  `).join('');
}

// 저장된 항목 필터링
function filterSavedList() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const filteredList = savedDataList.filter(data => 
    data.customerName.toLowerCase().includes(searchTerm)
  );
  
  const savedList = document.getElementById('savedList');
  
  if (filteredList.length === 0) {
    savedList.innerHTML = '<div class="hint">검색 결과가 없습니다.</div>';
    return;
  }
  
  savedList.innerHTML = filteredList.map(data => `
    <div class="saved-item" onclick="loadSavedItem('${data.customerName}')">
      <div class="saved-item-title">${data.customerName}</div>
      <div class="saved-item-date">${data.inputDate}</div>
    </div>
  `).join('');
}

// 저장된 항목 로드
function loadSavedItem(customerName) {
  const data = savedDataList.find(item => item.customerName === customerName);
  if (!data) return;
  
  currentData = data;
  
  // 입력 폼에 데이터 로드
  document.getElementById('customerName').value = data.customerName;
  document.getElementById('birthDate').value = data.birthDate || '';
  
  // 담보 데이터 로드
  Object.values(COVERAGE_ITEMS).flat().forEach(item => {
    const input = document.getElementById(item.key);
    if (input) {
      input.value = data.coverages[item.key]?.value || '';
    }
  });
  
  // 미리보기 생성 후 화면 전환
  generatePreview(data);
  showScreen('preview');
}

// 미리보기 생성
function generatePreview(data) {
  const preview = document.getElementById('printPreview');
  
  // A4 가로 양식으로 보장분석지 생성
  preview.innerHTML = `
    <div class="print-header">
      (${data.customerName})님의 한 장 요약 보장분석
    </div>
    
    <div style="display: flex; justify-content: space-between; margin: 20px 0;">
      <div>작성일: ${data.inputDate}</div>
      <div>생년월일: ${data.birthDate || ''}</div>
    </div>
    
    <table class="print-table">
      <tr>
        <th rowspan="2">구분</th>
        <th colspan="3">암</th>
        <th colspan="3">2대 중대질환</th>
        <th colspan="2">수술비</th>
        <th colspan="2">입원/통원</th>
        <th colspan="3">기타</th>
      </tr>
      <tr>
        <th>진단비</th>
        <th>치료비</th>
        <th>수술비</th>
        <th>진단비</th>
        <th>치료비</th>
        <th>수술비</th>
        <th>질병</th>
        <th>상해</th>
        <th>입원</th>
        <th>통원</th>
        <th>배상</th>
        <th>형사</th>
        <th>기타</th>
      </tr>
      <tr>
        <td style="font-weight:600;">${data.customerName}</td>
        ${generateTableCells(data.coverages)}
      </tr>
    </table>
    
    <div style="margin-top: 30px; font-size: 10px; color: #666;">
      * 단위: 만원<br>
      * 본 자료는 참고용이며, 실제 보장내용은 약관을 확인하시기 바랍니다.
    </div>
  `;
}

// 테이블 셀 생성
function generateTableCells(coverages) {
  // 각 카테고리별로 대표 값들을 추출
  const cancerDiagnosis = coverages.generalCancer?.value || coverages.totalCancer?.value || '0';
  const cancerTreatment = coverages.cancerSpecificTreatment?.value || coverages.targetTherapy?.value || '0';
  const cancerSurgery = coverages.cancerSurgery?.value || '0';
  
  const majorDiagnosis = coverages.cerebrovascularDiagnosis?.value || coverages.strokeDiagnosis?.value || '0';
  const majorTreatment = coverages.twoMajorTreatment?.value || '0';
  const majorSurgery = coverages.cerebrovascularSurgery?.value || coverages.strokeSurgery?.value || '0';
  
  const diseaseSurgery = coverages.surgery5Type?.value || coverages.surgery3Type?.value || '0';
  const injurySurgery = coverages.sevenOrganSurgery?.value || '0';
  
  const hospitalization = coverages.diseaseHospitalization?.value || '0';
  const outpatient = coverages.diseaseOutpatient?.value || '0';
  
  const liability = coverages.dailyLifeLiability?.value || '0';
  const criminal = coverages.criminalSettlement?.value || '0';
  const others = coverages.fireFine?.value || coverages.lawyerAppointment?.value || '0';
  
  return `
    <td>${cancerDiagnosis}</td>
    <td>${cancerTreatment}</td>
    <td>${cancerSurgery}</td>
    <td>${majorDiagnosis}</td>
    <td>${majorTreatment}</td>
    <td>${majorSurgery}</td>
    <td>${diseaseSurgery}</td>
    <td>${injurySurgery}</td>
    <td>${hospitalization}</td>
    <td>${outpatient}</td>
    <td>${liability}</td>
    <td>${criminal}</td>
    <td>${others}</td>
  `;
}

// 이미지 다운로드
function downloadImage() {
  const preview = document.getElementById('printPreview');
  
  // html2canvas 라이브러리가 필요합니다
  // 여기서는 간단히 알림만 표시
  alert('이미지 다운로드 기능을 위해서는 html2canvas 라이브러리 추가가 필요합니다.\n현재는 브라우저의 인쇄 기능을 이용해주세요.');
  
  // 인쇄 대화상자 열기
  window.print();
}
</script>

</body>
</html>
