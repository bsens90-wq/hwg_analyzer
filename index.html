<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î≥¥Ïû•Î∂ÑÏÑùÏßÄ - OCR ÏßÄÏõê</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    
    <!-- Tesseract.js ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script>
        // Î∞±ÏóÖ CDN Î™©Î°ù
        var tesseractSources = [
            'https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js',
            'https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js'
        ];
        
        // ÏàúÏ∞®Ï†ÅÏúºÎ°ú ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÏãúÎèÑ
        function loadTesseract() {
            return new Promise(function(resolve, reject) {
                var currentIndex = 0;
                
                function tryLoad() {
                    if (currentIndex >= tesseractSources.length) {
                        reject(new Error('Î™®Îì† CDN Î°úÎî© Ïã§Ìå®'));
                        return;
                    }
                    
                    var script = document.createElement('script');
                    script.src = tesseractSources[currentIndex];
                    
                    script.onload = function() {
                        if (typeof Tesseract !== 'undefined') {
                            console.log('Tesseract.js Î°úÎìú ÏÑ±Í≥µ:', tesseractSources[currentIndex]);
                            resolve(true);
                        } else {
                            currentIndex++;
                            tryLoad();
                        }
                    };
                    
                    script.onerror = function() {
                        console.log('CDN Ïã§Ìå®:', tesseractSources[currentIndex]);
                        currentIndex++;
                        tryLoad();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoad();
            });
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎùºÏù¥Î∏åÎü¨Î¶¨ Ï¥àÍ∏∞Ìôî
        window.addEventListener('DOMContentLoaded', function() {
            loadTesseract().then(function(success) {
                if (success) {
                    document.getElementById('ocr-status').textContent = 'OCR Ï§ÄÎπÑ ÏôÑÎ£å';
                } else {
                    document.getElementById('ocr-status').textContent = 'OCR ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎî© Ïã§Ìå®';
                }
            }).catch(function(error) {
                console.error('Tesseract Î°úÎî© Ïò§Î•ò:', error);
                document.getElementById('ocr-status').textContent = 'OCR ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎî© Ïã§Ìå®';
            });
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-steps {
            display: flex;
            background: #f8f9fa;
            padding: 10px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-step {
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
        }

        .nav-step.active {
            background: #c62828;
            color: white;
        }

        .nav-step:not(.active) {
            background: white;
            border: 1px solid #ddd;
        }

        .header {
            padding: 20px;
            border-bottom: 2px solid #eee;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .info-row {
            display: flex;
            gap: 30px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            gap: 5px;
        }

        .ocr-status {
            padding: 10px 20px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            font-size: 12px;
            color: #1565c0;
        }

        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #c62828;
            background: #fafafa;
        }

        .upload-area.processing {
            border-color: #2196F3;
            background: #f0f8ff;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: #c62828;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        .upload-btn:hover {
            background: #a52525;
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .sample-btn {
            background: #4CAF50;
        }

        .sample-btn:hover {
            background: #45a049;
        }

        .progress-info {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            display: none;
        }

        .progress-info.show {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #2196F3;
            transition: width 0.3s;
            border-radius: 5px;
        }

        .uploaded-image {
            max-width: 300px;
            max-height: 200px;
            margin: 20px auto;
            display: none;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .main-content {
            padding: 20px;
        }

        .sections-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .section {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background: white;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #4caf50 0deg, #4caf50 var(--score-deg), #e0e0e0 var(--score-deg), #e0e0e0 360deg);
        }

        .score-circle span {
            position: relative;
            z-index: 1;
            background: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 14px;
        }

        .item {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .item-amounts {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .amount-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
            font-size: 12px;
        }

        .amount-display {
            font-size: 13px;
            color: #666;
        }

        .shortage {
            color: #c62828;
            font-weight: bold;
            font-size: 12px;
        }

        .sufficient {
            color: #4caf50;
            font-weight: bold;
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .lifestyle-section {
            grid-column: 1 / -1;
        }

        .lifestyle-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .lifestyle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
        }

        .status-o { background: #4caf50; }
        .status-triangle { background: #ff9800; }
        .status-x { background: #f44336; }

        .personal-editor {
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }

        .personal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .action-buttons {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
            background: #f9f9f9;
        }

        .generate-btn {
            background: #2196F3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 0 10px;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .original-layout {
            width: 1200px;
            height: 800px;
            background: white;
            font-family: 'Malgun Gothic', sans-serif;
            position: absolute;
            left: -9999px;
            top: -9999px;
            box-sizing: border-box;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .sections-container {
                grid-template-columns: 1fr;
            }
            
            .info-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-steps {
                overflow-x: auto;
                justify-content: flex-start;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="ocr-status">
            OCR ÏÉÅÌÉú: <span id="ocr-status">ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎî© Ï§ë...</span>
        </div>

        <div class="nav-steps">
            <div class="nav-step">1. Ïª®ÏÑ§ÌåÖ Í∞ÄÏù¥Îìú</div>
            <div class="nav-step active">2. Í∞ÑÌé∏Î∂ÑÏÑù</div>
            <div class="nav-step">3. Í≥ÑÏïΩÏÉÅÏÑ∏</div>
            <div class="nav-step">4. Ï£ºÏöîÎ≥¥Ïû•</div>
            <div class="nav-step">5. ÏòàÏÉÅÎ≥¥ÌóòÍ∏à Ï°∞Ìöå</div>
            <div class="nav-step">6. Ïª®ÏÑ§ÌåÖ Í≤∞Í≥º</div>
            <div class="nav-step">7. Ï†Ñ/ÌõÑÎπÑÍµê</div>
        </div>

        <div class="header">
            <div class="title" id="title">Í≥†Í∞ùÎãòÏùò Ìïú Ïû• ÏöîÏïΩ Î≥¥Ïû•Î∂ÑÏÑù</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span>100% Ïù¥ÏÉÅ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>80% Ïù¥ÏÉÅ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f44336;"></div>
                    <span>30% ÎØ∏Îßå</span>
                </div>
            </div>
            <div class="info-row" id="info-row">
                <div class="info-item">
                    <span>ÏÉùÎÖÑÏõîÏùº</span>
                    <span id="birth-date">-</span>
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ÏÉÅÎ†πÏùº</span>
                    <span id="age-date">-</span>
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ÏÜêÌï¥Î≥¥Ìóò</span>
                    <span id="damage-insurance">-</span>Í±¥
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ÏÉùÎ™ÖÎ≥¥Ìóò</span>
                    <span id="life-insurance">-</span>Í±¥
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ÏõîÎÇ©Î≥¥ÌóòÎ£å Ìï©Í≥Ñ</span>
                    <span id="monthly-premium">-</span>Ïõê
                </div>
            </div>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(event)">
                <div id="upload-content">
                    <h3>Î≥¥Ïû•Î∂ÑÏÑùÏßÄ Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</h3>
                    <p>OCR Í∏∞Îä•ÏúºÎ°ú ÏûêÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Ï∂îÏ∂úÌï©ÎãàÎã§</p>
                    <button class="upload-btn" type="button" id="upload-btn">ÌååÏùº ÏÑ†ÌÉù</button>
                    <button class="upload-btn sample-btn" type="button" onclick="loadSampleData()">ÏÉòÌîå Îç∞Ïù¥ÌÑ∞</button>
                </div>
                <img id="uploaded-image" class="uploaded-image" alt="ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ">
            </div>
            
            <div class="progress-info" id="progress-info">
                <div id="progress-text">Ïù¥ÎØ∏ÏßÄÎ•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progress-bar"></div>
                </div>
                <div id="progress-details"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="sections-container" id="sections-container">
                <div class="section personal-editor">
                    <div class="section-header">
                        <div class="section-title">Í∞úÏù∏Ï†ïÎ≥¥ ÏûÖÎ†•</div>
                    </div>
                    <div class="personal-grid">
                        <div class="input-group">
                            <label>Ïù¥Î¶Ñ</label>
                            <input type="text" id="name-input" onchange="updatePersonalData('name', this.value)">
                        </div>
                        <div class="input-group">
                            <label>ÏÉùÎÖÑÏõîÏùº (YY-MM-DD)</label>
                            <input type="text" id="birth-input" placeholder="73-12-19" onchange="updatePersonalData('birthDate', this.value)">
                        </div>
                        <div class="input-group">
                            <label>ÏÜêÌï¥Î≥¥Ìóò Í±¥Ïàò</label>
                            <input type="number" id="damage-input" onchange="updatePersonalData('damageInsurance', parseInt(this.value) || 0)">
                        </div>
                        <div class="input-group">
                            <label>ÏÉùÎ™ÖÎ≥¥Ìóò Í±¥Ïàò</label>
                            <input type="number" id="life-input" onchange="updatePersonalData('lifeInsurance', parseInt(this.value) || 0)">
                        </div>
                        <div class="input-group">
                            <label>ÏõîÎÇ©Î≥¥ÌóòÎ£å (Ïõê)</label>
                            <input type="number" id="premium-input" onchange="updatePersonalData('monthlyPremium', parseInt(this.value) || 0)">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Í∞ÄÏ°±Î≥¥Ïû•</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="family-score">-Ï†ê</span>
                        </div>
                    </div>
                    <div id="family-items"></div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ÌÅ∞Î≥ëÎ≥¥Ïû•</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="disease-score">-Ï†ê</span>
                        </div>
                    </div>
                    <div id="disease-items"></div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ÏùòÎ£åÎ≥¥Ïû•</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="medical-score">-Ï†ê</span>
                        </div>
                    </div>
                    <div id="medical-items"></div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Í∞ÑÎ≥ëÎ≥¥Ïû•</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="care-score">-Ï†ê</span>
                        </div>
                    </div>
                    <div id="care-items"></div>
                </div>

                <div class="section lifestyle-section">
                    <div class="section-header">
                        <div class="section-title">ÏÉùÌôúÎ≥¥Ïû•</div>
                        <div style="font-size: 12px; color: #666;">
                            <span style="color: #4caf50;">‚óè</span> Ï†ÅÏ†ï
                            <span style="color: #ff9800; margin-left: 10px;">‚ñ≤</span> Î∂ÄÏ°±
                            <span style="color: #f44336; margin-left: 10px;">‚úï</span> ÎØ∏Î≥¥Ïû•
                        </div>
                    </div>
                    <div class="lifestyle-items" id="lifestyle-items"></div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="generate-btn" onclick="generateOriginalLayout()">
                üìä ÏõêÎ≥∏ ÌòïÌÉú Î≥¥Ïû•Î∂ÑÏÑùÏßÄ ÏÉùÏÑ±
            </button>
            <button class="generate-btn" onclick="downloadAsImage()">
                üíæ Ïù¥ÎØ∏ÏßÄÎ°ú Îã§Ïö¥Î°úÎìú
            </button>
        </div>
    </div>

    <div id="original-layout" class="original-layout"></div>

    <script>
        var currentData = {
            personal: {
                name: "Í≥†Í∞ù",
                birthDate: "",
                ageDate: "",
                damageInsurance: 0,
                lifeInsurance: 0,
                monthlyPremium: 0
            },
            sections: {
                family: { score: 0, items: [] },
                disease: { score: 0, items: [] },
                medical: { score: 0, items: [] },
                care: { score: 0, items: [] }
            },
            lifestyle: []
        };

        var isProcessing = false;

        function init() {
            loadEmptyTemplate();
            updatePersonalInfoInputs();
        }

        function updatePersonalInfoInputs() {
            document.getElementById('name-input').value = currentData.personal.name;
            document.getElementById('birth-input').value = currentData.personal.birthDate;
            document.getElementById('damage-input').value = currentData.personal.damageInsurance;
            document.getElementById('life-input').value = currentData.personal.lifeInsurance;
            document.getElementById('premium-input').value = currentData.personal.monthlyPremium;
        }

        function updatePersonalData(field, value) {
            currentData.personal[field] = value;
            updatePersonalInfo();
        }

        function updatePersonalInfo() {
            document.getElementById('title').textContent = currentData.personal.name + 'ÎãòÏùò Ìïú Ïû• ÏöîÏïΩ Î≥¥Ïû•Î∂ÑÏÑù';
            document.getElementById('birth-date').textContent = currentData.personal.birthDate || '-';
            document.getElementById('age-date').textContent = currentData.personal.ageDate || '-';
            document.getElementById('damage-insurance').textContent = currentData.personal.damageInsurance || '-';
            document.getElementById('life-insurance').textContent = currentData.personal.lifeInsurance || '-';
            document.getElementById('monthly-premium').textContent = currentData.personal.monthlyPremium ? 
                currentData.personal.monthlyPremium.toLocaleString() : '-';
        }

        function handleFileUpload(event) {
            if (isProcessing) return;
            
            var file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }

            if (typeof Tesseract === 'undefined') {
                alert('OCR ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            isProcessing = true;
            var uploadBtn = document.getElementById('upload-btn');
            var uploadArea = document.getElementById('upload-area');
            var progressInfo = document.getElementById('progress-info');
            var uploadedImage = document.getElementById('uploaded-image');

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Ï≤òÎ¶¨ Ï§ë...';
            uploadArea.classList.add('processing');
            progressInfo.classList.add('show');

            var imageUrl = URL.createObjectURL(file);
            uploadedImage.src = imageUrl;
            uploadedImage.style.display = 'block';

            performOCR(file).then(function() {
                // ÏÑ±Í≥µ
            }).catch(function(error) {
                console.error('OCR Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:', error);
                loadEmptyTemplate();
                alert('OCR Ïù∏ÏãùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
            }).finally(function() {
                isProcessing = false;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Îã§Î•∏ ÌååÏùº ÏÑ†ÌÉù';
                uploadArea.classList.remove('processing');
                
                setTimeout(function() {
                    progressInfo.classList.remove('show');
                }, 3000);
            });
        }

        function performOCR(file) {
            return new Promise(function(resolve, reject) {
                var progressBar = document.getElementById('progress-bar');
                var progressText = document.getElementById('progress-text');
                var progressDetails = document.getElementById('progress-details');
                var processedFile = null;
                var worker = null;

                progressText.textContent = 'Ïù¥ÎØ∏ÏßÄÎ•º Ï†ÑÏ≤òÎ¶¨ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                progressBar.style.width = '10%';

                preprocessImage(file).then(function(result) {
                    processedFile = result;
                    progressText.textContent = 'OCR ÏõåÏª§Î•º Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                    progressBar.style.width = '20%';

                    return Tesseract.createWorker({
                        logger: function(m) {
                            if (m.status === 'recognizing text' && typeof m.progress === 'number') {
                                var progress = 60 + Math.round(m.progress * 30);
                                progressBar.style.width = progress + '%';
                                progressDetails.textContent = 'Ïà´Ïûê Ïù∏Ïãù Ï§ë: ' + Math.round(m.progress * 100) + '%';
                            }
                        }
                    });
                }).then(function(createdWorker) {
                    worker = createdWorker;
                    progressText.textContent = 'Ïñ∏Ïñ¥ Î™®Îç∏ÏùÑ Î°úÎî©ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                    progressBar.style.width = '30%';
                    
                    return worker.loadLanguage('kor+eng');
                }).then(function() {
                    progressText.textContent = 'OCR ÏóîÏßÑÏùÑ Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                    progressBar.style.width = '40%';
                    
                    return worker.initialize('kor+eng');
                }).then(function() {
                    progressText.textContent = 'OCR ÏÑ§Ï†ïÏùÑ ÏµúÏ†ÅÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                    progressBar.style.width = '50%';
                    
                    return worker.setParameters({
                        tessedit_char_whitelist: '0123456789Í∞Ä-Ìû£„Ñ±-„Öé„Öè-„Ö£ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz(),.:/%-ÎßåÏõêÏ†êÍ±¥ÎãòÏùòÏÉÅÎ†πÏùºÏõîÎÇ©Î≥¥ÌóòÎ£åÌï©Í≥ÑÏÜêÌï¥ÏÉùÎ™ÖÏßàÎ≥ëÌõÑÏú†ÏïîÎáåÌòàÍ¥ÄÍ≤ΩÏÉâÏûÖÏõêÏã§ÏÜêÏπòÎß§ÏöîÏñëÍ∏âÏÑ±Ïã¨Í∑ºÌòàÏ¶ùÏ§ëÏ¶ùÏû•Í∏∞ÎåÄÏù∏ÌòïÏÇ¨Ìï©ÏùòÏßÄÏõêÍ∏àÎ≥ÄÌò∏ÏÇ¨ÏÑ†ÏûÑÎπÑÏö©Ïö¥Ï†ÑÏûêÎ≤åÍ∏àÏÉÅÏÉùÌôúÎ∞∞Ï±ÖÏûÑÏûÑÌîåÎûÄÌä∏Ïú†ÏÇ¨ÏùºÎ∞òÌÜµÌï©ÏàòÏà†ÎπÑÌóàÌòàÏÑ±Ïã¨Ïû•ÌòàÍ¥Ä',
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                        tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY
                    });
                }).then(function() {
                    progressText.textContent = 'ÌïµÏã¨ Îç∞Ïù¥ÌÑ∞Î•º Ïù∏ÏãùÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                    progressBar.style.width = '60%';
                    
                    return worker.recognize(processedFile);
                }).then(function(result) {
                    var text = result.data.text;
                    var confidence = result.data.confidence;
                    
                    console.log('OCR ÏõêÎ≥∏ Í≤∞Í≥º:', text);
                    console.log('Ïã†Î¢∞ÎèÑ:', confidence);
                    
                    progressBar.style.width = '90%';
                    progressText.textContent = 'Îç∞Ïù¥ÌÑ∞Î•º ÌååÏã±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                    
                    // Ï¢åÌëú Ï†ïÎ≥¥ÏôÄ Ìï®Íªò ÌååÏã±
                    parseFixedFormatData(text, result);
                    
                    progressBar.style.width = '100%';
                    progressText.textContent = 'ÏôÑÎ£å!';
                    progressDetails.textContent = 'ÌïµÏã¨ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú ÏôÑÎ£å';
                    
                    return worker.terminate();
                }).then(function() {
                    resolve();
                }).catch(function(error) {
                    console.error('OCR Ïò§Î•ò:', error);
                    if (worker) {
                        worker.terminate().catch(function(terminateError) {
                            console.error('Worker Ï¢ÖÎ£å Ïò§Î•ò:', terminateError);
                        });
                    }
                    reject(error);
                });
            });
        }

        function parseFixedFormatData(text, ocrResult) {
            console.log('Ï¢åÌëú Í∏∞Î∞ò ÌååÏã± ÏãúÏûë:', text);
            
            // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Í∏∞Ï§Ä Ï¢åÌëú ÏòÅÏó≠ Ï†ïÏùò (Ïã§Ï†ú ÌååÎûÄÏÉâ Î∞ïÏä§ ÏúÑÏπò)
            var regions = {
                // Í∞úÏù∏Ï†ïÎ≥¥ ÏòÅÏó≠ (ÏÉÅÎã®)
                customerName: { x1: 67, y1: 120, x2: 200, y2: 160 },
                birthDate: { x1: 565, y1: 160, x2: 650, y2: 185 },
                ageDate: { x1: 678, y1: 160, x2: 760, y2: 185 },
                damageInsurance: { x1: 820, y1: 135, x2: 870, y2: 160 },
                lifeInsurance: { x1: 958, y1: 135, x2: 1008, y2: 160 },
                monthlyPremium: { x1: 1099, y1: 135, x2: 1227, y2: 160 },
                
                // Ï†êÏàò ÏòÅÏó≠ (4Í∞úÏùò ÌååÎûÄÏÉâ Î∞ïÏä§Îì§)
                familyScore: { x1: 236, y1: 213, x2: 340, y2: 293 },      // Í∞ÄÏ°±Î≥¥Ïû• Ï†êÏàò
                diseaseScore: { x1: 524, y1: 213, x2: 628, y2: 293 },     // ÌÅ∞Î≥ëÎ≥¥Ïû• Ï†êÏàò  
                medicalScore: { x1: 810, y1: 213, x2: 914, y2: 293 },     // ÏùòÎ£åÎ≥¥Ïû• Ï†êÏàò
                careScore: { x1: 1099, y1: 213, x2: 1203, y2: 293 },      // Í∞ÑÎ≥ëÎ≥¥Ïû• Ï†êÏàò
                
                // Í∞Å ÏÑπÏÖòÎ≥Ñ Îç∞Ïù¥ÌÑ∞ ÏòÅÏó≠Îì§ (ÌååÎûÄÏÉâ Î∞ïÏä§Îì§)
                // Í∞ÄÏ°±Î≥¥Ïû• ÏòÅÏó≠Ïùò 4Í∞ú Î∞ïÏä§
                familyItem1: { x1: 184, y1: 310, x2: 340, y2: 340 },      // ÏßàÎ≥ëÏÇ¨Îßù
                familyItem2: { x1: 184, y1: 372, x2: 340, y2: 402 },      // ÏÉÅÌï¥ÏÇ¨Îßù  
                familyItem3: { x1: 184, y1: 431, x2: 340, y2: 461 },      // ÏßàÎ≥ëÌõÑÏú†(3%)
                familyItem4: { x1: 184, y1: 490, x2: 340, y2: 520 },      // ÏÉÅÌï¥ÌõÑÏú†(3%)
                
                // ÌÅ∞Î≥ëÎ≥¥Ïû• ÏòÅÏó≠Ïùò Î∞ïÏä§Îì§
                diseaseItem1: { x1: 483, y1: 310, x2: 625, y2: 340 },     // Ïú†ÏÇ¨Ïïî
                diseaseItem2: { x1: 483, y1: 372, x2: 625, y2: 402 },     // ÏùºÎ∞òÏïî
                diseaseItem3: { x1: 483, y1: 431, x2: 625, y2: 461 },     // ÌÜµÌï©Ïïî
                diseaseItem4: { x1: 483, y1: 490, x2: 625, y2: 520 },     // ÌëúÏ†ÅÌï≠ÏïîÏïΩÎ¨º
                diseaseItem5: { x1: 483, y1: 541, x2: 625, y2: 571 },     // ÎáåÌòàÍ¥ÄÏßàÌôò
                diseaseItem6: { x1: 483, y1: 602, x2: 625, y2: 632 },     // ÎáåÏ°∏Ï§ë
                diseaseItem7: { x1: 483, y1: 661, x2: 625, y2: 691 },     // ÌóàÌòàÏÑ±Ïã¨ÏßàÌôò
                diseaseItem8: { x1: 483, y1: 720, x2: 625, y2: 750 },     // Í∏âÏÑ±Ïã¨Í∑ºÍ≤ΩÏÉâÏ¶ù
                
                // ÏùòÎ£åÎ≥¥Ïû• ÏòÅÏó≠Ïùò Î∞ïÏä§Îì§
                medicalItem1: { x1: 770, y1: 310, x2: 912, y2: 340 },     // ÏßàÎ≥ëÏûÖÏõê Ïã§ÏÜê
                medicalItem2: { x1: 770, y1: 372, x2: 912, y2: 402 },     // ÏÉÅÌï¥ÏûÖÏõê Ïã§ÏÜê
                medicalItem3: { x1: 770, y1: 431, x2: 912, y2: 461 },     // ÏßàÎ≥ëÏûÖÏõê(1Ïùº)
                medicalItem4: { x1: 770, y1: 490, x2: 912, y2: 520 },     // ÏÉÅÌï¥ÏûÖÏõê(1Ïùº)
                medicalItem5: { x1: 770, y1: 549, x2: 912, y2: 579 },     // ÏßàÎ≥ëÏàòÏà†ÎπÑ
                medicalItem6: { x1: 770, y1: 602, x2: 912, y2: 632 },     // ÏÉÅÌï¥ÏàòÏà†ÎπÑ
                
                // Í∞ÑÎ≥ëÎ≥¥Ïû• ÏòÅÏó≠Ïùò Î∞ïÏä§Îì§
                careItem1: { x1: 1079, y1: 310, x2: 1191, y2: 340 },     // Í≤ΩÏ¶ùÏπòÎß§
                careItem2: { x1: 1079, y1: 372, x2: 1191, y2: 402 },     // Ï§ëÏ¶ùÏπòÎß§
                careItem3: { x1: 1079, y1: 431, x2: 1191, y2: 461 },     // Ïû•Í∏∞ÏöîÏñë(4Í∏â)
                careItem4: { x1: 1079, y1: 490, x2: 1191, y2: 520 },     // Ïû•Í∏∞ÏöîÏñë(1Í∏â)
                careItem5: { x1: 1079, y1: 549, x2: 1191, y2: 579 },     // Í∞ÑÎ≥ëÏù∏ÏÉÅÌï¥ÏûÖÏõê
                careItem6: { x1: 1079, y1: 602, x2: 1191, y2: 632 },     // Í∞ÑÎ≥ëÏù∏ÏßàÎ≥ëÏûÖÏõê
                
                // ÏÉùÌôúÎ≥¥Ïû• ÏòÅÏó≠Ïùò Î∞ïÏä§Îì§
                lifestyleItem1: { x1: 577, y1: 794, x2: 603, y2: 820 },  // ÎåÄÏù∏ÌòïÏÇ¨Ìï©ÏùòÏßÄÏõêÍ∏à
                lifestyleItem2: { x1: 577, y1: 835, x2: 603, y2: 861 },  // Î≥ÄÌò∏ÏÇ¨ÏÑ†ÏûÑÎπÑÏö©
                lifestyleItem3: { x1: 577, y1: 876, x2: 603, y2: 902 },  // Ïö¥Ï†ÑÏûêÎ≤åÍ∏à
                lifestyleItem4: { x1: 817, y1: 794, x2: 899, y2: 820 },  // ÏûêÎèôÏ∞®Î∂ÄÎ∂ÄÎ∞©ÏÉù
                lifestyleItem5: { x1: 817, y1: 835, x2: 899, y2: 861 },  // ÌôîÏû¨Î∞∞Í∏à
                lifestyleItem6: { x1: 817, y1: 876, x2: 899, y2: 902 },  // ÏùºÏÉÅÏÉùÌôúÎ∞∞ÏÉÅÏ±ÖÏûÑ
                lifestyleItem7: { x1: 1070, y1: 794, x2: 1135, y2: 820 } // ÏûÑÌîåÎûÄÌä∏
            };

            // OCR Í≤∞Í≥ºÏóêÏÑú Ï¢åÌëú Ï†ïÎ≥¥Í∞Ä ÏûàÎäî Í≤ΩÏö∞ ÏÇ¨Ïö©
            if (ocrResult && ocrResult.data && ocrResult.data.words) {
                parseByCoordinates(ocrResult.data.words, regions);
            } else {
                // Î∞±ÏóÖ: Í∏∞Ï°¥ Ìå®ÌÑ¥ Îß§Ïπ≠ Î∞©Ïãù
                parseByPatterns(text);
            }

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updatePersonalInfo();
            renderSections();
            renderLifestyle();
        }

        function parseByCoordinates(words, regions) {
            console.log('Ï¢åÌëú Í∏∞Î∞ò Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú ÏãúÏûë');
            console.log('OCR words Î∞∞Ïó¥:', words);
            console.log('words Í∏∏Ïù¥:', words ? words.length : 0);
            
            if (!words || words.length === 0) {
                console.log('words Î∞∞Ïó¥Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§. Î∞±ÏóÖ Î∞©Ïãù ÏÇ¨Ïö©');
                return;
            }
            
            words.forEach(function(word, index) {
                if (!word.bbox) {
                    console.log('word', index, 'Ïóê bboxÍ∞Ä ÏóÜÏäµÎãàÎã§:', word);
                    return;
                }
                
                var bbox = word.bbox;
                var text = word.text ? word.text.trim() : '';
                var centerX = (bbox.x0 + bbox.x1) / 2;
                var centerY = (bbox.y0 + bbox.y1) / 2;
                
                console.log('Word:', text, 'at', centerX, centerY, 'bbox:', bbox);
                
                // Ï†êÏàò Ï∂îÏ∂ú (4Í∞ú ÌååÎûÄÏÉâ Î∞ïÏä§)
                if (isInRegion(centerX, centerY, regions.familyScore)) {
                    console.log('Í∞ÄÏ°±Î≥¥Ïû• Ï†êÏàò ÏòÅÏó≠ÏóêÏÑú Î∞úÍ≤¨:', text);
                    var score = extractNumber(text);
                    if (score >= 0 && score <= 100) {
                        currentData.sections.family.score = score;
                        console.log('Í∞ÄÏ°±Î≥¥Ïû• Ï†êÏàò ÏÑ§Ï†ï:', score);
                    }
                }
                
                if (isInRegion(centerX, centerY, regions.diseaseScore)) {
                    console.log('ÌÅ∞Î≥ëÎ≥¥Ïû• Ï†êÏàò ÏòÅÏó≠ÏóêÏÑú Î∞úÍ≤¨:', text);
                    var score = extractNumber(text);
                    if (score >= 0 && score <= 100) {
                        currentData.sections.disease.score = score;
                        console.log('ÌÅ∞Î≥ëÎ≥¥Ïû• Ï†êÏàò ÏÑ§Ï†ï:', score);
                    }
                }
                
                if (isInRegion(centerX, centerY, regions.medicalScore)) {
                    console.log('ÏùòÎ£åÎ≥¥Ïû• Ï†êÏàò ÏòÅÏó≠ÏóêÏÑú Î∞úÍ≤¨:', text);
                    var score = extractNumber(text);
                    if (score >= 0 && score <= 100) {
                        currentData.sections.medical.score = score;
                        console.log('ÏùòÎ£åÎ≥¥Ïû• Ï†êÏàò ÏÑ§Ï†ï:', score);
                    }
                }
                
                if (isInRegion(centerX, centerY, regions.careScore)) {
                    console.log('Í∞ÑÎ≥ëÎ≥¥Ïû• Ï†êÏàò ÏòÅÏó≠ÏóêÏÑú Î∞úÍ≤¨:', text);
                    var score = extractNumber(text);
                    if (score >= 0 && score <= 100) {
                        currentData.sections.care.score = score;
                        console.log('Í∞ÑÎ≥ëÎ≥¥Ïû• Ï†êÏàò ÏÑ§Ï†ï:', score);
                    }
                }
                
                // Í∞úÎ≥Ñ Ìï≠Î™©Î≥Ñ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
                extractIndividualItemData(centerX, centerY, text, regions);
            });
            
            console.log('Ï¢åÌëú Í∏∞Î∞ò Ï∂îÏ∂ú ÏôÑÎ£å');
        }

        function extractIndividualItemData(x, y, text, regions) {
            // ÌòÑÏû¨Í∞í/Î™©ÌëúÍ∞í Ìå®ÌÑ¥ Ï∞æÍ∏∞
            var amountPattern = /(\d{1,5}(?:,\d{3})*)\s*\/\s*(\d{1,5}(?:,\d{3})*)/;
            var match = text.match(amountPattern);
            
            if (!match) return;
            
            var current = parseInt(match[1].replace(/,/g, ''));
            var target = parseInt(match[2].replace(/,/g, ''));
            
            console.log('Í∏àÏï° Ìå®ÌÑ¥ Î∞úÍ≤¨:', text, '-> current:', current, 'target:', target, 'at', x, y);
            
            // Í∞ÄÏ°±Î≥¥Ïû• Ìï≠Î™©Îì§
            if (isInRegion(x, y, regions.familyItem1)) {
                currentData.sections.family.items[0].current = current;
                currentData.sections.family.items[0].target = target;
                console.log('ÏßàÎ≥ëÏÇ¨Îßù Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.familyItem2)) {
                currentData.sections.family.items[1].current = current;
                currentData.sections.family.items[1].target = target;
                console.log('ÏÉÅÌï¥ÏÇ¨Îßù Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.familyItem3)) {
                currentData.sections.family.items[2].current = current;
                currentData.sections.family.items[2].target = target;
                console.log('ÏßàÎ≥ëÌõÑÏú† Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.familyItem4)) {
                currentData.sections.family.items[3].current = current;
                currentData.sections.family.items[3].target = target;
                console.log('ÏÉÅÌï¥ÌõÑÏú† Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            
            // ÌÅ∞Î≥ëÎ≥¥Ïû• Ìï≠Î™©Îì§
            else if (isInRegion(x, y, regions.diseaseItem1)) {
                currentData.sections.disease.items[0].current = current;
                currentData.sections.disease.items[0].target = target;
                console.log('Ïú†ÏÇ¨Ïïî Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.diseaseItem2)) {
                currentData.sections.disease.items[1].current = current;
                currentData.sections.disease.items[1].target = target;
                console.log('ÏùºÎ∞òÏïî Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.diseaseItem3)) {
                currentData.sections.disease.items[2].current = current;
                currentData.sections.disease.items[2].target = target;
                console.log('ÌÜµÌï©Ïïî Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.diseaseItem8)) {
                currentData.sections.disease.items[4].current = current;
                currentData.sections.disease.items[4].target = target;
                console.log('Í∏âÏÑ±Ïã¨Í∑ºÍ≤ΩÏÉâ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            
            // ÏùòÎ£åÎ≥¥Ïû• Ìï≠Î™©Îì§
            else if (isInRegion(x, y, regions.medicalItem1)) {
                currentData.sections.medical.items[0].current = current;
                currentData.sections.medical.items[0].target = target;
                console.log('ÏßàÎ≥ëÏûÖÏõêÏã§ÏÜê Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.medicalItem2)) {
                currentData.sections.medical.items[1].current = current;
                currentData.sections.medical.items[1].target = target;
                console.log('ÏÉÅÌï¥ÏûÖÏõêÏã§ÏÜê Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.medicalItem3)) {
                currentData.sections.medical.items[2].current = current;
                currentData.sections.medical.items[2].target = target;
                console.log('ÏßàÎ≥ëÏûÖÏõê(1Ïùº) Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.medicalItem4)) {
                currentData.sections.medical.items[3].current = current;
                currentData.sections.medical.items[3].target = target;
                console.log('ÏÉÅÌï¥ÏûÖÏõê(1Ïùº) Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            
            // Í∞ÑÎ≥ëÎ≥¥Ïû• Ìï≠Î™©Îì§
            else if (isInRegion(x, y, regions.careItem1)) {
                currentData.sections.care.items[0].current = current;
                currentData.sections.care.items[0].target = target;
                console.log('Í≤ΩÏ¶ùÏπòÎß§ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.careItem2)) {
                currentData.sections.care.items[1].current = current;
                currentData.sections.care.items[1].target = target;
                console.log('Ï§ëÏ¶ùÏπòÎß§ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.careItem3)) {
                currentData.sections.care.items[2].current = current;
                currentData.sections.care.items[2].target = target;
                console.log('Ïû•Í∏∞ÏöîÏñë(4Í∏â) Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
            else if (isInRegion(x, y, regions.careItem4)) {
                currentData.sections.care.items[3].current = current;
                currentData.sections.care.items[3].target = target;
                console.log('Ïû•Í∏∞ÏöîÏñë(1Í∏â) Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï:', current, '/', target);
            }
        }

        function isInRegion(x, y, region) {
            return x >= region.x1 && x <= region.x2 && y >= region.y1 && y <= region.y2;
        }

        function extractNumber(text) {
            var match = text.match(/\d+/);
            return match ? parseInt(match[0]) : -1;
        }

        function extractAmountFromRegion(x, y, text, regions) {
            // Í∞Å ÏòÅÏó≠ÏóêÏÑú ÌòÑÏû¨Í∞í/Î™©ÌëúÍ∞í Ìå®ÌÑ¥ Ï∞æÍ∏∞
            var amountPattern = /(\d{1,5}(?:,\d{3})*)\s*\/\s*(\d{1,5}(?:,\d{3})*)/;
            var match = text.match(amountPattern);
            
            if (!match) return;
            
            var current = parseInt(match[1].replace(/,/g, ''));
            var target = parseInt(match[2].replace(/,/g, ''));
            
            // ÏòÅÏó≠Î≥ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ìï†Îãπ
            var sectionData = null;
            var itemIndex = -1;
            
            if (isInRegion(x, y, regions.familyData)) {
                sectionData = currentData.sections.family;
                itemIndex = Math.floor((y - regions.familyData.y1) / 50); // ÎåÄÎûµÏ†ÅÏù∏ Ï§Ñ Í∞ÑÍ≤©
            } else if (isInRegion(x, y, regions.diseaseData)) {
                sectionData = currentData.sections.disease;
                itemIndex = Math.floor((y - regions.diseaseData.y1) / 60);
            } else if (isInRegion(x, y, regions.medicalData)) {
                sectionData = currentData.sections.medical;
                itemIndex = Math.floor((y - regions.medicalData.y1) / 60);
            } else if (isInRegion(x, y, regions.careData)) {
                sectionData = currentData.sections.care;
                itemIndex = Math.floor((y - regions.careData.y1) / 60);
            }
            
            if (sectionData && itemIndex >= 0 && itemIndex < sectionData.items.length) {
                sectionData.items[itemIndex].current = current;
                sectionData.items[itemIndex].target = target;
            }
        }

        function parseByPatterns(text) {
            console.log('Ìå®ÌÑ¥ Í∏∞Î∞ò Î∞±ÏóÖ ÌååÏã± ÏÇ¨Ïö©');
            
            // Í∏∞Ï°¥ Ìå®ÌÑ¥ Îß§Ïπ≠ Î°úÏßÅ (Î∞±ÏóÖÏö©)
            var namePattern = /([Í∞Ä-Ìû£]{2,4})/g;
            var nameMatches = text.match(namePattern);
            if (nameMatches && nameMatches.length > 0) {
                for (var i = 0; i < nameMatches.length; i++) {
                    var name = nameMatches[i];
                    if (name !== 'Í∞ÄÏ°±' && name !== 'Î≥¥Ïû•' && name !== 'ÏùòÎ£å' && name !== 'Í∞ÑÎ≥ë' && name !== 'ÏÉùÌôú') {
                        currentData.personal.name = name;
                        document.getElementById('name-input').value = name;
                        break;
                    }
                }
            }

            // ÏÉùÎÖÑÏõîÏùº Ï∂îÏ∂ú
            var birthPattern = /(\d{2}-\d{2}-\d{2})/g;
            var birthMatch = text.match(birthPattern);
            if (birthMatch) {
                currentData.personal.birthDate = birthMatch[0];
                document.getElementById('birth-input').value = birthMatch[0];
            }

            // Ï†êÏàò Ï∂îÏ∂ú
            var scorePattern = /(\d{1,3})Ï†ê/g;
            var scoreMatches = [];
            var match;
            while ((match = scorePattern.exec(text)) !== null) {
                scoreMatches.push(parseInt(match[1]));
            }
            
            if (scoreMatches.length >= 4) {
                currentData.sections.family.score = scoreMatches[0];
                currentData.sections.disease.score = scoreMatches[1];
                currentData.sections.medical.score = scoreMatches[2];
                currentData.sections.care.score = scoreMatches[3];
            }
        }

        function extractAmountData(text) {
            // ÏùºÎ∞òÏ†ÅÏù∏ Í∏àÏï° Ìå®ÌÑ¥Îì§
            var patterns = [
                // 3,800 / 10,000ÎßåÏõê ÌòïÌÉú
                /(\d{1,3}(?:,\d{3})*)\s*\/\s*(\d{1,3}(?:,\d{3})*)ÎßåÏõê/g,
                // 3800 / 10000 ÌòïÌÉú
                /(\d{3,6})\s*\/\s*(\d{3,6})/g,
                // Îã®Ïàú Ïà´Ïûê / Ïà´Ïûê ÌòïÌÉú
                /(\d{1,5})\s*\/\s*(\d{1,5})/g
            ];

            var amounts = [];
            
            for (var p = 0; p < patterns.length; p++) {
                var pattern = patterns[p];
                var match;
                while ((match = pattern.exec(text)) !== null) {
                    var current = parseInt(match[1].replace(/,/g, ''));
                    var target = parseInt(match[2].replace(/,/g, ''));
                    
                    // Ìï©Î¶¨Ï†ÅÏù∏ Î≤îÏúÑ Ï≤¥ÌÅ¨ (0~100,000)
                    if (current >= 0 && current <= 100000 && target >= 0 && target <= 100000) {
                        amounts.push({ current: current, target: target });
                    }
                }
            }

            console.log('Ï∂îÏ∂úÎêú Í∏àÏï°Îì§:', amounts);

            // Ï∂îÏ∂úÎêú Í∏àÏï°ÏùÑ Í∞Å ÏÑπÏÖòÏóê Ìï†Îãπ
            var sectionKeys = ['family', 'disease', 'medical', 'care'];
            var amountIndex = 0;

            for (var s = 0; s < sectionKeys.length; s++) {
                var sectionKey = sectionKeys[s];
                var section = currentData.sections[sectionKey];
                
                for (var i = 0; i < section.items.length && amountIndex < amounts.length; i++) {
                    var amount = amounts[amountIndex];
                    if (amount) {
                        section.items[i].current = amount.current;
                        section.items[i].target = amount.target;
                        amountIndex++;
                    }
                }
            }

            // Ï†êÏàò Ïû¨Í≥ÑÏÇ∞
            for (var s = 0; s < sectionKeys.length; s++) {
                var sectionKey = sectionKeys[s];
                var section = currentData.sections[sectionKey];
                var totalPercentage = 0;
                var itemCount = 0;
                
                for (var i = 0; i < section.items.length; i++) {
                    var item = section.items[i];
                    if (item.target > 0) {
                        var percentage = (item.current / item.target) * 100;
                        totalPercentage += Math.min(100, percentage);
                        itemCount++;
                    }
                }
                
                if (itemCount > 0 && section.score === 0) {
                    section.score = Math.round(totalPercentage / itemCount);
                }
            }
        }

        function preprocessImage(file) {
            return new Promise(function(resolve, reject) {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var img = new Image();
                
                img.onload = function() {
                    try {
                        var originalWidth = img.width;
                        var originalHeight = img.height;
                        
                        // ÏµúÏÜå ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨
                        if (originalWidth < 200 || originalHeight < 150) {
                            reject(new Error('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÎÑàÎ¨¥ ÏûëÏäµÎãàÎã§. Îçî ÌÅ∞ Ïù¥ÎØ∏ÏßÄÎ•º ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.'));
                            return;
                        }
                        
                        // OCR ÏµúÏ†ÅÌôîÎêú ÌÅ¨Í∏∞Î°ú Ï°∞Ï†ï
                        var targetWidth = 1800;  // Îçî ÌÅ∞ ÌÅ¨Í∏∞Î°ú Ï≤òÎ¶¨
                        var targetHeight = 1400;
                        
                        var ratio = Math.min(targetWidth / originalWidth, targetHeight / originalHeight);
                        
                        // ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÏûëÏúºÎ©¥ ÌôïÎåÄ
                        if (ratio < 1) ratio = 1.5;  // ÏµúÏÜå 1.5Î∞∞ ÌôïÎåÄ
                        if (ratio > 4) ratio = 4;    // ÏµúÎåÄ 4Î∞∞ÍπåÏßÄ ÌôïÎåÄ
                        
                        var newWidth = Math.round(originalWidth * ratio);
                        var newHeight = Math.round(originalHeight * ratio);
                        
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        
                        // Í≥†ÌíàÏßà Î†åÎçîÎßÅ ÏÑ§Ï†ï
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // Ìù∞ÏÉâ Î∞∞Í≤Ω
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, newWidth, newHeight);
                        
                        // Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Í∏∞
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);
                        
                        // Ïà´Ïûê Ïù∏Ïãù ÏµúÏ†ÅÌôîÎêú Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨
                        var imageData = ctx.getImageData(0, 0, newWidth, newHeight);
                        var data = imageData.data;
                        
                        for (var i = 0; i < data.length; i += 4) {
                            var r = data[i];
                            var g = data[i + 1];
                            var b = data[i + 2];
                            
                            // Í∑∏Î†àÏù¥Ïä§ÏºÄÏùº Î≥ÄÌôò
                            var gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                            
                            // ÏÉ§ÌîÑÎãù Ìö®Í≥ºÎ°ú ÌÖçÏä§Ìä∏ ÏÑ†Î™ÖÎèÑ Ìñ•ÏÉÅ
                            var enhanced = gray;
                            if (gray > 100 && gray < 200) {
                                // Ï§ëÍ∞ÑÌÜ§ÏùÑ Îçî ÏÑ†Î™ÖÌïòÍ≤å
                                enhanced = gray < 150 ? Math.max(0, gray - 30) : Math.min(255, gray + 30);
                            }
                            
                            // ÎåÄÎπÑ Ï¶ùÍ∞Ä (Ïà´ÏûêÍ∞Ä Ïûò Î≥¥Ïù¥ÎèÑÎ°ù)
                            var contrast = 2.0;
                            var result = Math.round((enhanced - 128) * contrast + 128);
                            result = Math.max(0, Math.min(255, result));
                            
                            data[i] = result;     // R
                            data[i + 1] = result; // G
                            data[i + 2] = result; // B
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        
                        canvas.toBlob(function(blob) {
                            if (blob) {
                                console.log('Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨ ÏôÑÎ£å:', newWidth + 'x' + newHeight + ' ÌîΩÏÖÄ');
                                resolve(blob);
                            } else {
                                reject(new Error('Ïù¥ÎØ∏ÏßÄ Î≥ÄÌôò Ïã§Ìå®'));
                            }
                        }, 'image/png', 0.95);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®'));
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        function parseOCRResult(text) {
            var cleanText = text.replace(/[^\w\sÍ∞Ä-Ìû£(),.:/%-]/g, ' ').replace(/\s+/g, ' ').trim();
            
            var nameMatch = cleanText.match(/([Í∞Ä-Ìû£]{2,4})\s?ÎãòÏùò/);
            if (nameMatch) {
                currentData.personal.name = nameMatch[1];
                document.getElementById('name-input').value = nameMatch[1];
            }

            var birthMatch = cleanText.match(/(\d{2}-\d{2}-\d{2})/);
            if (birthMatch) {
                currentData.personal.birthDate = birthMatch[1];
                document.getElementById('birth-input').value = birthMatch[1];
            }

            var premiumMatch = cleanText.match(/ÏõîÎÇ©Î≥¥ÌóòÎ£å[^0-9]*([0-9,]+)Ïõê/);
            if (premiumMatch) {
                var premium = parseInt(premiumMatch[1].replace(/,/g, ''));
                currentData.personal.monthlyPremium = premium;
                document.getElementById('premium-input').value = premium;
            }

            var damageMatch = cleanText.match(/ÏÜêÌï¥Î≥¥Ìóò[^0-9]*(\d+)Í±¥/);
            if (damageMatch) {
                var count = parseInt(damageMatch[1]);
                currentData.personal.damageInsurance = count;
                document.getElementById('damage-input').value = count;
            }

            var lifeMatch = cleanText.match(/ÏÉùÎ™ÖÎ≥¥Ìóò[^0-9]*(\d+)Í±¥/);
            if (lifeMatch) {
                var count = parseInt(lifeMatch[1]);
                currentData.personal.lifeInsurance = count;
                document.getElementById('life-input').value = count;
            }

            var familyScoreMatch = cleanText.match(/Í∞ÄÏ°±Î≥¥Ïû•[^0-9]*(\d+)Ï†ê/);
            if (familyScoreMatch) {
                currentData.sections.family.score = parseInt(familyScoreMatch[1]);
            }

            var diseaseScoreMatch = cleanText.match(/ÌÅ∞Î≥ëÎ≥¥Ïû•[^0-9]*(\d+)Ï†ê/);
            if (diseaseScoreMatch) {
                currentData.sections.disease.score = parseInt(diseaseScoreMatch[1]);
            }

            var medicalScoreMatch = cleanText.match(/ÏùòÎ£åÎ≥¥Ïû•[^0-9]*(\d+)Ï†ê/);
            if (medicalScoreMatch) {
                currentData.sections.medical.score = parseInt(medicalScoreMatch[1]);
            }

            var careScoreMatch = cleanText.match(/Í∞ÑÎ≥ëÎ≥¥Ïû•[^0-9]*(\d+)Ï†ê/);
            if (careScoreMatch) {
                currentData.sections.care.score = parseInt(careScoreMatch[1]);
            }

            updatePersonalInfo();
            renderSections();
            renderLifestyle();
        }

        function loadEmptyTemplate() {
            currentData.sections = {
                family: {
                    score: 0,
                    items: [
                        { name: "ÏßàÎ≥ëÏÇ¨Îßù", current: 0, target: 10000 },
                        { name: "ÏÉÅÌï¥ÏÇ¨Îßù", current: 0, target: 20000 },
                        { name: "ÏßàÎ≥ëÌõÑÏú†(3%)", current: 0, target: 3000 },
                        { name: "ÏÉÅÌï¥ÌõÑÏú†(3%)", current: 0, target: 10000 }
                    ]
                },
                disease: {
                    score: 0,
                    items: [
                        { name: "Ïú†ÏÇ¨Ïïî", current: 0, target: 1000 },
                        { name: "ÏùºÎ∞òÏïî", current: 0, target: 7000 },
                        { name: "ÌÜµÌï©Ïïî", current: 0, target: 7000 },
                        { name: "ÎáåÌòàÍ¥ÄÏßàÌôò", current: 0, target: 2000 },
                        { name: "Í∏âÏÑ±Ïã¨Í∑ºÍ≤ΩÏÉâ", current: 0, target: 3000 }
                    ]
                },
                medical: {
                    score: 0,
                    items: [
                        { name: "ÏßàÎ≥ëÏûÖÏõê Ïã§ÏÜê", current: 0, target: 5000 },
                        { name: "ÏÉÅÌï¥ÏûÖÏõê Ïã§ÏÜê", current: 0, target: 5000 },
                        { name: "ÏßàÎ≥ëÏûÖÏõê(1Ïùº)", current: 0, target: 3 },
                        { name: "ÏÉÅÌï¥ÏûÖÏõê(1Ïùº)", current: 0, target: 3 }
                    ]
                },
                care: {
                    score: 0,
                    items: [
                        { name: "Í≤ΩÏ¶ùÏπòÎß§", current: 0, target: 2000 },
                        { name: "Ï§ëÏ¶ùÏπòÎß§", current: 0, target: 4000 },
                        { name: "Ïû•Í∏∞ÏöîÏñë(4Í∏â)", current: 0, target: 2000 },
                        { name: "Ïû•Í∏∞ÏöîÏñë(1Í∏â)", current: 0, target: 4000 }
                    ]
                }
            };

            currentData.lifestyle = [
                { name: "ÎåÄÏù∏ÌòïÏÇ¨Ìï©ÏùòÏßÄÏõêÍ∏à", amount: 0, status: "‚úï" },
                { name: "Î≥ÄÌò∏ÏÇ¨ÏÑ†ÏûÑÎπÑÏö©", amount: 0, status: "‚úï" },
                { name: "Ïö¥Ï†ÑÏûêÎ≤åÍ∏à", amount: 0, status: "‚úï" },
                { name: "ÏùºÏÉÅÏÉùÌôúÎ∞∞ÏÉÅÏ±ÖÏûÑ", amount: 0, status: "‚úï" },
                { name: "ÏûÑÌîåÎûÄÌä∏", amount: 0, status: "‚úï" }
            ];

            renderSections();
            renderLifestyle();
        }

        function loadSampleData() {
            currentData = {
                personal: {
                    name: "ÏÜêÎçïÎ†π",
                    birthDate: "73-12-19",
                    ageDate: "06-18",
                    damageInsurance: 3,
                    lifeInsurance: 7,
                    monthlyPremium: 563810
                },
                sections: {
                    family: {
                        score: 53,
                        items: [
                            { name: "ÏßàÎ≥ëÏÇ¨Îßù", current: 3800, target: 10000 },
                            { name: "ÏÉÅÌï¥ÏÇ¨Îßù", current: 8200, target: 20000 },
                            { name: "ÏßàÎ≥ëÌõÑÏú†(3%)", current: 2000, target: 3000 },
                            { name: "ÏÉÅÌï¥ÌõÑÏú†(3%)", current: 7000, target: 10000 }
                        ]
                    },
                    disease: {
                        score: 78,
                        items: [
                            { name: "Ïú†ÏÇ¨Ïïî", current: 900, target: 1000 },
                            { name: "ÏùºÎ∞òÏïî", current: 3000, target: 7000 },
                            { name: "ÌÜµÌï©Ïïî", current: 0, target: 7000 },
                            { name: "ÎáåÌòàÍ¥ÄÏßàÌôò", current: 1000, target: 2000 },
                            { name: "Í∏âÏÑ±Ïã¨Í∑ºÍ≤ΩÏÉâ", current: 1000, target: 3000 }
                        ]
                    },
                    medical: {
                        score: 87,
                        items: [
                            { name: "ÏßàÎ≥ëÏûÖÏõê Ïã§ÏÜê", current: 5000, target: 5000 },
                            { name: "ÏÉÅÌï¥ÏûÖÏõê Ïã§ÏÜê", current: 5000, target: 5000 },
                            { name: "ÏßàÎ≥ëÏûÖÏõê(1Ïùº)", current: 10, target: 3 },
                            { name: "ÏÉÅÌï¥ÏûÖÏõê(1Ïùº)", current: 2, target: 3 }
                        ]
                    },
                    care: {
                        score: 13,
                        items: [
                            { name: "Í≤ΩÏ¶ùÏπòÎß§", current: 0, target: 2000 },
                            { name: "Ï§ëÏ¶ùÏπòÎß§", current: 0, target: 4000 },
                            { name: "Ïû•Í∏∞ÏöîÏñë(4Í∏â)", current: 0, target: 2000 },
                            { name: "Ïû•Í∏∞ÏöîÏñë(1Í∏â)", current: 0, target: 4000 }
                        ]
                    }
                },
                lifestyle: [
                    { name: "ÎåÄÏù∏ÌòïÏÇ¨Ìï©ÏùòÏßÄÏõêÍ∏à", amount: 20000, status: "‚óè" },
                    { name: "Î≥ÄÌò∏ÏÇ¨ÏÑ†ÏûÑÎπÑÏö©", amount: 3000, status: "‚ñ≤" },
                    { name: "Ïö¥Ï†ÑÏûêÎ≤åÍ∏à", amount: 3500, status: "‚óè" },
                    { name: "ÏùºÏÉÅÏÉùÌôúÎ∞∞ÏÉÅÏ±ÖÏûÑ", amount: 10000, status: "‚óè" },
                    { name: "ÏûÑÌîåÎûÄÌä∏", amount: 200, status: "‚óè" }
                ]
            };

            updatePersonalInfo();
            updatePersonalInfoInputs();
            renderSections();
            renderLifestyle();
            
            alert('ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
        }

        function createItemElement(item, sectionKey, itemIndex) {
            var div = document.createElement('div');
            div.className = 'item';
            
            var shortage = Math.max(0, item.target - item.current);
            var percentage = item.target > 0 ? Math.min(100, (item.current / item.target) * 100) : 0;
            
            var progressColor = '#f44336';
            if (percentage >= 100) progressColor = '#4caf50';
            else if (percentage >= 80) progressColor = '#ff9800';
            
            div.innerHTML = '<div class="item-name">' + item.name + '</div>' +
                '<div class="item-amounts">' +
                    '<input type="number" class="amount-input" value="' + item.current + '" ' +
                           'onchange="updateAmount(\'' + sectionKey + '\', ' + itemIndex + ', \'current\', this.value)">' +
                    '<span class="amount-display">ÎßåÏõê /</span>' +
                    '<input type="number" class="amount-input" value="' + item.target + '" ' +
                           'onchange="updateAmount(\'' + sectionKey + '\', ' + itemIndex + ', \'target\', this.value)">' +
                    '<span class="amount-display">ÎßåÏõê</span>' +
                    (shortage > 0 ? '<span class="shortage">(' + shortage.toLocaleString() + 'ÎßåÏõê Î∂ÄÏ°±)</span>' : 
                      item.current >= item.target ? '<span class="sufficient">Ï∂©Ï°±</span>' : '') +
                '</div>' +
                '<div class="progress-bar">' +
                    '<div class="progress-fill" style="width: ' + Math.min(100, percentage) + '%; background: ' + progressColor + ';"></div>' +
                '</div>';
            
            return div;
        }

        function renderSections() {
            var sections = ['family', 'disease', 'medical', 'care'];
            
            for (var i = 0; i < sections.length; i++) {
                var sectionKey = sections[i];
                var section = currentData.sections[sectionKey];
                var container = document.getElementById(sectionKey + '-items');
                var scoreElement = document.getElementById(sectionKey + '-score');
                
                scoreElement.textContent = section.score + 'Ï†ê';
                updateScoreCircle(scoreElement.parentElement, section.score);
                
                container.innerHTML = '';
                if (section.items && section.items.length > 0) {
                    for (var j = 0; j < section.items.length; j++) {
                        var item = section.items[j];
                        var itemElement = createItemElement(item, sectionKey, j);
                        container.appendChild(itemElement);
                    }
                } else {
                    container.innerHTML = '<div class="item"><div class="item-name">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div></div>';
                }
            }
        }

        function updateScoreCircle(element, score) {
            var degrees = (score / 100) * 360;
            element.style.setProperty('--score-deg', degrees + 'deg');
        }

        function renderLifestyle() {
            var container = document.getElementById('lifestyle-items');
            
            if (!currentData.lifestyle || currentData.lifestyle.length === 0) {
                container.innerHTML = '<div class="lifestyle-item"><div>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div></div>';
                return;
            }

            container.innerHTML = '';
            for (var i = 0; i < currentData.lifestyle.length; i++) {
                var item = currentData.lifestyle[i];
                var div = document.createElement('div');
                div.className = 'lifestyle-item';
                
                var statusClass = item.status === '‚óè' ? 'status-o' : 
                                 item.status === '‚ñ≤' ? 'status-triangle' : 'status-x';
                
                div.innerHTML = '<div><strong>' + item.name + '</strong>' +
                    '<div style="font-size: 12px; color: #666; margin-top: 2px;">' +
                    '<input type="number" class="amount-input" value="' + item.amount + '" ' +
                    'onchange="updateLifestyle(' + i + ', \'amount\', this.value)">ÎßåÏõê' +
                    '</div></div>' +
                    '<div class="status-indicator ' + statusClass + '" onclick="toggleStatus(' + i + ')">' + item.status + '</div>';
                
                container.appendChild(div);
            }
        }

        function updateAmount(sectionKey, itemIndex, field, value) {
            var numValue = parseInt(value) || 0;
            currentData.sections[sectionKey].items[itemIndex][field] = numValue;
            
            var section = currentData.sections[sectionKey];
            var totalPercentage = 0;
            for (var i = 0; i < section.items.length; i++) {
                var item = section.items[i];
                var percentage = item.target > 0 ? (item.current / item.target) * 100 : 0;
                totalPercentage += Math.min(100, percentage);
            }
            section.score = Math.round(totalPercentage / section.items.length);
            
            renderSections();
        }

        function updateLifestyle(index, field, value) {
            currentData.lifestyle[index][field] = field === 'amount' ? (parseInt(value) || 0) : value;
            renderLifestyle();
        }

        function toggleStatus(index) {
            var statuses = ['‚óè', '‚ñ≤', '‚úï'];
            var currentStatus = currentData.lifestyle[index].status;
            var currentIndex = statuses.indexOf(currentStatus);
            var nextIndex = (currentIndex + 1) % statuses.length;
            currentData.lifestyle[index].status = statuses[nextIndex];
            renderLifestyle();
        }

        function generateOriginalLayout() {
            var container = document.getElementById('original-layout');
            container.innerHTML = '';

            container.style.position = 'fixed';
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';
            container.style.zIndex = '1000';
            container.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';

            var content = '<div style="text-align: center; font-size: 24px; font-weight: bold; margin: 20px;">' +
                currentData.personal.name + 'ÎãòÏùò Ìïú Ïû• ÏöîÏïΩ Î≥¥Ïû•Î∂ÑÏÑù</div>';
            
            container.innerHTML = content;

            setTimeout(function() {
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.top = '-9999px';
                container.style.transform = 'none';
                container.style.zIndex = 'auto';
            }, 3000);
        }

        function downloadAsImage() {
            generateOriginalLayout();
            setTimeout(function() {
                if (!window.html2canvas) {
                    var script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    script.onload = function() {
                        captureImage();
                    };
                    document.head.appendChild(script);
                } else {
                    captureImage();
                }
            }, 100);
        }

        function captureImage() {
            var element = document.getElementById('original-layout');
            
            if (window.html2canvas) {
                html2canvas(element, {
                    width: 1200,
                    height: 800,
                    scale: 1,
                    backgroundColor: '#ffffff'
                }).then(function(canvas) {
                    var link = document.createElement('a');
                    link.download = currentData.personal.name + '_Î≥¥Ïû•Î∂ÑÏÑùÏßÄ.png';
                    link.href = canvas.toDataURL();
                    link.click();
                }).catch(function(error) {
                    console.error('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                    alert('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                });
            } else {
                alert('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            var uploadArea = document.querySelector('.upload-area');
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                uploadArea.style.borderColor = '#c62828';
                uploadArea.style.background = '#fafafa';
            }
            
            function unhighlight(e) {
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.background = 'white';
            }
            
            function handleDrop(e) {
                var dt = e.dataTransfer;
                var files = dt.files;
                
                if (files.length > 0) {
                    document.getElementById('file-input').files = files;
                    handleFileUpload({ target: { files: files } });
                }
            }
            
            var events = ['dragenter', 'dragover', 'dragleave', 'drop'];
            for (var i = 0; i < events.length; i++) {
                uploadArea.addEventListener(events[i], preventDefaults, false);
                document.body.addEventListener(events[i], preventDefaults, false);
            }
            
            var highlightEvents = ['dragenter', 'dragover'];
            for (var i = 0; i < highlightEvents.length; i++) {
                uploadArea.addEventListener(highlightEvents[i], highlight, false);
            }
            
            var unhighlightEvents = ['dragleave', 'drop'];
            for (var i = 0; i < unhighlightEvents.length; i++) {
                uploadArea.addEventListener(unhighlightEvents[i], unhighlight, false);
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
        });
    </script>
</body>
</html>
