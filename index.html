<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>보장분석 앱</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
  <style>
    :root{
      --hanwha:#ff7f00;
      --hanwha-dark:#e67100;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e6e6e6;
    }
    
    *{box-sizing:border-box}
    body{
      margin:0;
      padding-top: 70px;
      font-family: "Noto Sans KR", Arial, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    
    .header-fixed {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--bg);
      border-bottom: 2px solid #ccc;
      padding: 8px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo-container {
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
    }
    
    .logo-container:hover {
      transform: scale(1.05);
    }
    
    .logo-main {
      font-size: 32px;
      font-weight: 900;
      color: var(--hanwha);
      letter-spacing: 3px;
      text-shadow: 0 2px 4px rgba(255,127,0,0.2);
      margin: 0;
      line-height: 1;
    }
    
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:1rem;
    }
    
    .app-title{
      font-size:24px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
    }
    
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:20px;
      margin-bottom:20px;
    }
    
    button{
      width:100%;
      padding:12px 14px;
      background:var(--hanwha);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
    }
    
    button:hover{background:var(--hanwha-dark)}
    
    button.secondary{
      background:#6c757d;
      margin-bottom:0;
    }
    
    button.secondary:hover{background:#545b62}
    
    .saved-item{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    
    .saved-item:hover{
      background:#f8f9fa;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.1);
    }
    
    .saved-item-title{
      font-size:16px;
      font-weight:600;
      color:var(--text);
      margin-bottom:5px;
    }
    
    .saved-item-date{
      font-size:12px;
      color:var(--muted);
    }
    
    .meta{
      color:var(--muted); 
      font-size:13px; 
      margin-top:.25rem;
      text-align:center;
    }
    
    .error{
      color:#d93025; 
      font-size:14px; 
      margin-top:.5rem;
      text-align:center;
    }
    
    .success{
      color:#28a745; 
      font-size:14px; 
      margin-top:.5rem;
      text-align:center;
    }

    /* 모바일 최적화 입력 인터페이스 */
    .mobile-input-container {
      width: 100%;
      max-width: 100%;
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .customer-section {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #ff7f00, #ff9933);
      border-radius: 12px;
      color: white;
    }

    .customer-name-input {
      width: 100%;
      max-width: 250px;
      padding: 12px;
      border: none;
      border-radius: 8px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
    }

    .input-section {
      margin-bottom: 25px;
    }

    .section-header {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-left: 4px solid var(--hanwha);
      border-radius: 4px;
    }

    .input-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px;
      background: #fafafa;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }

    .input-label {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      min-width: 120px;
    }

    .input-field {
      width: 80px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: right;
      font-size: 14px;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--hanwha);
      box-shadow: 0 0 0 2px rgba(255, 127, 0, 0.2);
    }

    .input-unit {
      margin-left: 6px;
      font-size: 12px;
      color: #666;
      min-width: 30px;
    }

    .calculated-field {
      background: #e3f2fd !important;
      border-color: #2196f3 !important;
    }

    .calculated-field::after {
      content: ' (자동)';
      font-size: 11px;
      color: #2196f3;
    }

    /* 간병인일당 특수 UI */
    .caregiver-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .radio-group {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .caregiver-inputs {
      display: none;
      margin-top: 10px;
    }

    .caregiver-inputs.active {
      display: block;
    }

    /* 조건부 서식 */
    .status-good { background-color: #d4edda !important; border-color: #28a745 !important; }
    .status-warning { background-color: #fff3cd !important; border-color: #ffc107 !important; }
    .status-poor { background-color: #f8d7da !important; border-color: #dc3545 !important; }

    .button-area {
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (max-width: 768px) {
      .screen { padding: 0.5rem; }
      .mobile-input-container { padding: 12px; }
      .input-row { flex-direction: column; align-items: stretch; gap: 8px; }
      .input-label { min-width: auto; }
      .input-field { width: 100%; text-align: left; }
    }
  </style>
</head>
<body>
  <div class="header-fixed">
    <div class="logo-container" onclick="goHome()">
      <div class="logo-main">보장분석</div>
    </div>
  </div>

  <!-- 메뉴 화면 -->
  <section id="menuScreen" class="screen">
    <div class="app-title">보장분석 앱</div>
    <div class="card">
      <h2 style="margin:0 0 1.5rem 0;">메뉴 선택</h2>
      
      <button id="inputMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">입력하기</span>
        <span style="font-size:14px; opacity:0.8;">새로운 보장분석 작성</span>
      </button>
      
      <button id="loadMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">불러오기</span>
        <span style="font-size:14px; opacity:0.8;">저장된 보장분석 불러오기</span>
      </button>

      <div class="meta" style="margin-top:2rem;">Copyright 2025 보장분석 앱</div>
    </div>
  </section>

  <!-- 입력 화면 -->
  <section id="inputScreen" class="screen" style="display:none;">
    <div class="app-title">보장분석 입력</div>
    
    <div class="mobile-input-container">
      <!-- 고객명 섹션 -->
      <div class="customer-section">
        <div style="font-size: 20px; margin-bottom: 10px;">고객정보</div>
        <input type="text" id="customerName" placeholder="고객명 입력" class="customer-name-input">
        <div style="font-size: 16px; margin-top: 10px;">님의 한 장 요약 보장분석</div>
      </div>

      <!-- 암 섹션 -->
      <div class="input-section">
        <div class="section-header">암</div>
        <div class="input-row">
          <div class="input-label">일반암진단비</div>
          <input type="number" id="C5" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">통합암진단비</div>
          <input type="number" id="C6" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">전이암진단비</div>
          <input type="number" id="C7" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">암특정치료비</div>
          <input type="number" id="C8" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">암특정치료비(비급여)</div>
          <input type="number" id="C9" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">표적항암치료비</div>
          <input type="number" id="C10" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">중입자치료비</div>
          <input type="number" id="C11" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">암수술비</div>
          <input type="number" id="C12" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">다빈치로봇수술비</div>
          <input type="number" id="C13" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">1-5종수술비(5종)</div>
          <input type="number" id="C14" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
      </div>

      <!-- 2대 중대질환 섹션 -->
      <div class="input-section">
        <div class="section-header">2대 중대질환</div>
        <div class="input-row">
          <div class="input-label">뇌혈관질환진단비</div>
          <input type="number" id="G5" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">뇌졸중진단비</div>
          <input type="number" id="G6" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">허혈성심장질환진단비</div>
          <input type="number" id="G7" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">심근경색진단비</div>
          <input type="number" id="G8" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">뇌혈관질환수술비</div>
          <input type="number" id="G9" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">뇌졸중수술비</div>
          <input type="number" id="G10" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">허혈성심장질환수술비</div>
          <input type="number" id="G11" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">심근경색수술비</div>
          <input type="number" id="G12" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">뇌졸중혈전용해</div>
          <input type="number" id="G13" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">심근경색혈전용해</div>
          <input type="number" id="G14" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">2대특정치료비</div>
          <input type="number" id="G15" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">주요순환계(수술)</div>
          <input type="number" id="G16" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">주요순환계(혈전제거)</div>
          <input type="number" id="G17" class="input-field calculated-field" readonly>
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">주요순환계(혈전용해)</div>
          <input type="number" id="G18" class="input-field calculated-field" readonly>
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">주요순환계(중환자실)</div>
          <input type="number" id="G19" class="input-field calculated-field" readonly>
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">혈전제거치료비</div>
          <input type="number" id="G20" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">1-5종수술비(3종)</div>
          <input type="number" id="G21" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">1-5종수술비(5종)</div>
          <input type="number" id="G22" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">124대질병수술비(특정10대)</div>
          <input type="number" id="G23" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
        <div class="input-row">
          <div class="input-label">7대기관수술비(뇌/심) 관혈</div>
          <input type="number" id="G24" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
      </div>

      <!-- 5대 필수 보험 섹션 -->
      <div class="input-section">
        <div class="section-header">5대 필수 보험</div>
        
        <!-- 실손의료비 -->
        <div style="margin-bottom: 15px;">
          <div style="font-weight: 600; margin-bottom: 10px; color: #555;">실손의료비</div>
          <div class="input-row">
            <div class="input-label">(질병)입원한도</div>
            <input type="number" id="J5" class="input-field" placeholder="0">
            <span class="input-unit">만원</span>
          </div>
          <div class="input-row">
            <div class="input-label">(질병)통원한도</div>
            <input type="number" id="J6" class="input-field" placeholder="0">
            <span class="input-unit">일</span>
          </div>
          <div class="input-row">
            <div class="input-label">(상해)입원한도</div>
            <input type="number" id="J7" class="input-field" placeholder="0">
            <span class="input-unit">만원</span>
          </div>
          <div class="input-row">
            <div class="input-label">(상해)통원한도</div>
            <input type="number" id="J8" class="input-field" placeholder="0">
            <span class="input-unit">일</span>
          </div>
        </div>

        <!-- 운전자 -->
        <div style="margin-bottom: 15px;">
          <div style="font-weight: 600; margin-bottom: 10px; color: #555;">운전자</div>
          <div class="input-row">
            <div class="input-label">형사합의금</div>
            <input type="number" id="J11" class="input-field" placeholder="0">
            <span class="input-unit">만원</span>
          </div>
          <div class="input-row">
            <div class="input-label">변호사선임비</div>
            <input type="number" id="J12" class="input-field" placeholder="0">
            <span class="input-unit">만원</span>
          </div>
        </div>

        <!-- 간병인일당 -->
        <div class="caregiver-section">
          <div style="font-weight: 600; margin-bottom: 10px; color: #555;">간병인일당</div>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="caregiverSupport" name="caregiver" value="support">
              <label for="caregiverSupport">지원</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="caregiverUse" name="caregiver" value="use">
              <label for="caregiverUse">사용</label>
            </div>
          </div>
          <div id="caregiverInputs" class="caregiver-inputs">
            <div class="input-row">
              <div class="input-label">요양병원 외</div>
              <input type="number" id="J16" class="input-field" placeholder="0">
              <span class="input-unit">만원</span>
            </div>
            <div class="input-row">
              <div class="input-label">요양병원</div>
              <input type="number" id="J17" class="input-field" placeholder="0">
              <span class="input-unit">만원</span>
            </div>
            <div class="input-row">
              <div class="input-label">간호간병통합</div>
              <input type="number" id="J18" class="input-field" placeholder="0">
              <span class="input-unit">만원</span>
            </div>
          </div>
        </div>

        <!-- 일상생활배상책임 -->
        <div class="input-row">
          <div class="input-label">일상생활배상책임</div>
          <input type="number" id="I21" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>

        <!-- 화재벌금 -->
        <div class="input-row">
          <div class="input-label">화재벌금</div>
          <input type="number" id="I24" class="input-field" placeholder="0">
          <span class="input-unit">만원</span>
        </div>
      </div>
    </div>

    <!-- 버튼 영역 -->
    <div class="button-area">
      <button id="saveImageBtn">이미지로 저장하기</button>
      <button id="loadFromMenuBtn" class="secondary">불러오기</button>
      <button id="backToMenuBtn" class="secondary">뒤로가기</button>
      
      <div id="statusMessage" class="meta"></div>
    </div>
  </section>

  <!-- 불러오기 화면 -->
  <section id="loadScreen" class="screen" style="display:none;">
    <div class="app-title">저장된 보장분석</div>
    <div class="card">
      <h2 style="margin:0 0 1rem 0;">저장된 목록</h2>
      <div id="savedList">
        <!-- 저장된 항목들이 여기에 표시됩니다 -->
      </div>
      <button id="backToMenuFromLoadBtn" class="secondary" style="margin-top:20px;">뒤로가기</button>
    </div>
  </section>

<script>
let currentScreen = 'menu';
let savedData = JSON.parse(localStorage.getItem('insuranceAnalysisData')) || [];

// 화면 전환 함수
function hideAllScreens() {
  document.getElementById("menuScreen").style.display = "none";
  document.getElementById("inputScreen").style.display = "none";
  document.getElementById("loadScreen").style.display = "none";
}

function navigateToScreen(screen) {
  currentScreen = screen;
  hideAllScreens();
  
  switch(screen) {
    case 'menu':
      document.getElementById("menuScreen").style.display = "flex";
      break;
    case 'input':
      document.getElementById("inputScreen").style.display = "flex";
      setupFormCalculations();
      break;
    case 'load':
      document.getElementById("loadScreen").style.display = "flex";
      displaySavedList();
      break;
  }
}

// 홈으로 이동
function goHome() {
  navigateToScreen('menu');
}

// 계산 필드 설정
function setupFormCalculations() {
  const allInputs = document.querySelectorAll('.input-field[type="number"]');
  allInputs.forEach(input => {
    input.addEventListener('input', function() {
      updateCalculatedFields();
      applyConditionalFormatting();
    });
    input.addEventListener('change', function() {
      updateCalculatedFields();
      applyConditionalFormatting();
    });
  });

  // 간병인일당 라디오 버튼 이벤트
  const caregiverRadios = document.querySelectorAll('input[name="caregiver"]');
  caregiverRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      const caregiverInputs = document.getElementById('caregiverInputs');
      if (this.value === 'use') {
        caregiverInputs.classList.add('active');
      } else {
        caregiverInputs.classList.remove('active');
        // 지원 선택시 입력 필드들 초기화
        document.getElementById('J16').value = '';
        document.getElementById('J17').value = '';
        document.getElementById('J18').value = '';
      }
      applyConditionalFormatting();
    });
  });
  
  applyConditionalFormatting();
}

// 계산 필드 업데이트 (G16 기반 계산)
function updateCalculatedFields() {
  const g16Value = parseFloat(document.getElementById('G16')?.value) || 0;
  
  // G17 = G16 (주요순환계 혈전제거)
  const g17Input = document.getElementById('G17');
  if (g17Input) g17Input.value = g16Value;
  
  // G18 = G16 (주요순환계 혈전용해)
  const g18Input = document.getElementById('G18');
  if (g18Input) g18Input.value = g16Value;
  
  // G19 = G16/2 (주요순환계 중환자실)
  const g19Input = document.getElementById('G19');
  if (g19Input) g19Input.value = Math.floor(g16Value / 2);
}

// 조건부 서식 적용
function applyConditionalFormatting() {
  // 1보다 큰 값은 좋음, 작으면 나쁨으로 표시
  const greaterThanOneIds = ['J5', 'J6', 'J7', 'J8', 'J16', 'J17', 'J18', 'I21', 'I24'];
  greaterThanOneIds.forEach(id => {
    const input = document.getElementById(id);
    if (!input) return;
    
    const value = parseFloat(input.value) || 0;
    input.classList.remove('status-good', 'status-poor');
    
    if (value > 1) {
      input.classList.add('status-good');
    } else if (value > 0) {
      input.classList.add('status-poor');
    }
  });
  
  // 간병인일당 지원/사용 조건부 서식
  const caregiverSupport = document.getElementById('caregiverSupport');
  const caregiverUse = document.getElementById('caregiverUse');
  const caregiverSection = document.querySelector('.caregiver-section');
  
  if (caregiverSupport && caregiverSupport.checked) {
    caregiverSection.style.backgroundColor = '#f8d7da';
  } else {
    caregiverSection.style.backgroundColor = '#f8f9fa';
  }
  
  // J11 특별 조건 (형사합의금)
  const j11Input = document.getElementById('J11');
  if (j11Input) {
    const value = parseFloat(j11Input.value) || 0;
    j11Input.classList.remove('status-good', 'status-warning', 'status-poor');
    
    if (value >= 20000) {
      j11Input.classList.add('status-good');
    } else if (value >= 10000) {
      j11Input.classList.add('status-warning');
    } else if (value > 0) {
      j11Input.classList.add('status-poor');
    }
  }
  
  // J12 특별 조건 (변호사선임비)
  const j12Input = document.getElementById('J12');
  if (j12Input) {
    const value = parseFloat(j12Input.value) || 0;
    j12Input.classList.remove('status-good', 'status-warning', 'status-poor');
    
    if (value >= 5000) {
      j12Input.classList.add('status-good');
    } else if (value >= 3000) {
      j12Input.classList.add('status-warning');
    } else if (value > 0) {
      j12Input.classList.add('status-poor');
    }
  }
}

// 데이터 저장 및 이미지 생성
function saveData() {
  const customerName = document.getElementById('customerName').value.trim();
  
  if (!customerName) {
    showMessage('고객명을 입력해주세요.', 'error');
    return;
  }
  
  // 데이터 수집
  const data = {
    id: Date.now(),
    customerName: customerName,
    timestamp: new Date().toLocaleString('ko-KR'),
    values: {},
    caregiverOption: document.querySelector('input[name="caregiver"]:checked')?.value || 'none'
  };
  
  // 모든 입력 필드 값 저장
  const inputFields = [
    'C5', 'C6', 'C7', 'C8', 'C9', 'C10', 'C11', 'C12', 'C13', 'C14',
    'G5', 'G6', 'G7', 'G8', 'G9', 'G10', 'G11', 'G12', 'G13', 'G14', 
    'G15', 'G16', 'G17', 'G18', 'G19', 'G20', 'G21', 'G22', 'G23', 'G24',
    'J5', 'J6', 'J7', 'J8', 'J11', 'J12', 'J16', 'J17', 'J18', 'I21', 'I24'
  ];
  
  inputFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      data.values[fieldId] = parseFloat(field.value) || 0;
    }
  });
  
  // 로컬스토리지에 저장
  const existingIndex = savedData.findIndex(item => item.customerName === customerName);
  if (existingIndex >= 0) {
    savedData[existingIndex] = data;
  } else {
    savedData.push(data);
  }
  
  localStorage.setItem('insuranceAnalysisData', JSON.stringify(savedData));
  showMessage('저장되었습니다!', 'success');
  
  // 엑셀과 동일한 가로형 이미지 생성
  generateHorizontalExcelImage(data);
}

// 엑셀과 동일한 가로형 이미지 생성
function generateHorizontalExcelImage(data) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // 가로형 캔버스 크기
  canvas.width = 1400;
  canvas.height = 1000;
  
  // 배경
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // 제목
  ctx.fillStyle = '#333';
  ctx.font = 'bold 24px "Noto Sans KR", Arial';
  ctx.textAlign = 'center';
  ctx.fillText(`(${data.customerName})님의 한 장 요약 보장분석`, canvas.width / 2, 40);
  
  let yPos = 80;
  
  // 메인 섹션들 배치
  const sectionWidth = 350;
  const sectionSpacing = 50;
  
  // 암 섹션
  drawSection(ctx, 50, yPos, sectionWidth, '암', [
    { id: 'C5', label: '일반암진단비' },
    { id: 'C6', label: '통합암진단비' },
    { id: 'C7', label: '전이암진단비' },
    { id: 'C8', label: '암특정치료비' },
    { id: 'C9', label: '암특정치료비(비급여)' },
    { id: 'C10', label: '표적항암치료비' },
    { id: 'C11', label: '중입자치료비' },
    { id: 'C12', label: '암수술비' },
    { id: 'C13', label: '다빈치로봇수술비' },
    { id: 'C14', label: '1-5종수술비(5종)' }
  ], data.values);
  
  // 2대 중대질환 섹션
  drawSection(ctx, 450, yPos, sectionWidth, '2대 중대질환', [
    { id: 'G5', label: '뇌혈관질환진단비' },
    { id: 'G6', label: '뇌졸중진단비' },
    { id: 'G7', label: '허혈성심장질환진단비' },
    { id: 'G8', label: '심근경색진단비' },
    { id: 'G9', label: '뇌혈관질환수술비' },
    { id: 'G10', label: '뇌졸중수술비' },
    { id: 'G11', label: '허혈성심장질환수술비' },
    { id: 'G12', label: '심근경색수술비' },
    { id: 'G13', label: '뇌졸중혈전용해' },
    { id: 'G14', label: '심근경색혈전용해' },
    { id: 'G15', label: '2대특정치료비' },
    { id: 'G16', label: '주요순환계(수술)' },
    { id: 'G17', label: '주요순환계(혈전제거)' },
    { id: 'G18', label: '주요순환계(혈전용해)' },
    { id: 'G19', label: '주요순환계(중환자실)' },
    { id: 'G20', label: '혈전제거치료비' },
    { id: 'G21', label: '1-5종수술비(3종)' },
    { id: 'G22', label: '1-5종수술비(5종)' },
    { id: 'G23', label: '124대질병수술비(특정10대)' },
    { id: 'G24', label: '7대기관수술비(뇌/심) 관혈' }
  ], data.values);
  
  // 5대 필수 보험 섹션
  drawSection(ctx, 850, yPos, sectionWidth, '5대 필수 보험', [
    { id: 'J5', label: '(질병)입원한도', unit: '만원' },
    { id: 'J6', label: '(질병)통원한도', unit: '일' },
    { id: 'J7', label: '(상해)입원한도', unit: '만원' },
    { id: 'J8', label: '(상해)통원한도', unit: '일' },
    { id: 'J11', label: '형사합의금', unit: '만원' },
    { id: 'J12', label: '변호사선임비', unit: '만원' },
    { label: '간병인일당', special: 'caregiver' },
    { id: 'I21', label: '일상생활배상책임', unit: '만원' },
    { id: 'I24', label: '화재벌금', unit: '만원' }
  ], data.values, data.caregiverOption);
  
  // 치료 보장 예시 섹션들
  yPos = 650;
  
  // 일반암 치료 보장 예시
  drawTreatmentExample(ctx, 50, yPos, 300, '일반암 치료 보장 예시', [
    { label: '다빈치로봇수술', amount: '3,500만' },
    { label: '1개 부위 전이+표적', amount: '4,000만' },
    { label: '중입자치료', amount: '7,000만' }
  ]);
  
  // 뇌경색 치료 보장 예시
  drawTreatmentExample(ctx, 400, yPos, 300, '뇌경색 치료 보장 예시', [
    { label: '스텐트', amount: '3,200만' },
    { label: '스텐트+혈전용해', amount: '3,200만' },
    { label: '혈전용해+혈전제거+중환자실', amount: '3,200만' }
  ]);
  
  // 급성심근경색 치료 보장 예시
  drawTreatmentExample(ctx, 750, yPos, 300, '급성심근경색 치료 보장 예시', [
    { label: '스텐트', amount: '4,200만' },
    { label: '스텐트+혈전용해', amount: '4,200만' },
    { label: '혈전용해+혈전제거+중환자실', amount: '4,200만' }
  ]);
  
  // 이미지 다운로드
  canvas.toBlob(function(blob) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${data.customerName}_보장분석_${new Date().toISOString().slice(0,10).replace(/-/g, '')}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showMessage('가로형 보장분석표 이미지가 다운로드되었습니다!', 'success');
  }, 'image/png');
}

// 섹션 그리기 함수
function drawSection(ctx, x, y, width, title, items, values, caregiverOption) {
  // 섹션 헤더
  ctx.fillStyle = '#f0f0f0';
  ctx.fillRect(x, y, width, 30);
  ctx.strokeStyle = '#333';
  ctx.strokeRect(x, y, width, 30);
  
  ctx.fillStyle = '#333';
  ctx.font = 'bold 16px "Noto Sans KR", Arial';
  ctx.textAlign = 'center';
  ctx.fillText(title, x + width/2, y + 20);
  
  let itemY = y + 40;
  
  items.forEach(item => {
    if (item.special === 'caregiver') {
      // 간병인일당 특수 처리
      const bgColor = caregiverOption === 'support' ? '#ffcccc' : '#ffffff';
      ctx.fillStyle = bgColor;
      ctx.fillRect(x, itemY, width, 25);
      
      ctx.strokeStyle = '#ddd';
      ctx.strokeRect(x, itemY, width, 25);
      
      ctx.fillStyle = '#333';
      ctx.font = '12px "Noto Sans KR", Arial';
      ctx.textAlign = 'left';
      ctx.fillText(item.label, x + 10, itemY + 16);
      
      ctx.textAlign = 'right';
      const statusText = caregiverOption === 'support' ? '지원' : 
                        caregiverOption === 'use' ? '사용' : '-';
      ctx.fillText(statusText, x + width - 10, itemY + 16);
      
      itemY += 25;
      
      if (caregiverOption === 'use') {
        const caregiverItems = [
          { id: 'J16', label: '요양병원 외' },
          { id: 'J17', label: '요양병원' },
          { id: 'J18', label: '간호간병통합' }
        ];
        
        caregiverItems.forEach(subItem => {
          const value = values[subItem.id] || 0;
          const barColor = getBarColor(value);
          
          // 막대그래프 배경
          ctx.fillStyle = '#f8f8f8';
          ctx.fillRect(x + 5, itemY, width - 10, 20);
          
          // 막대그래프
          if (value > 0) {
            const barWidth = Math.min((value / 100) * (width - 100), width - 100);
            ctx.fillStyle = barColor;
            ctx.fillRect(x + 5, itemY, barWidth, 20);
          }
          
          ctx.strokeStyle = '#ddd';
          ctx.strokeRect(x + 5, itemY, width - 10, 20);
          
          // 텍스트
          ctx.fillStyle = '#333';
          ctx.font = '11px "Noto Sans KR", Arial';
          ctx.textAlign = 'left';
          ctx.fillText(subItem.label, x + 10, itemY + 14);
          
          ctx.textAlign = 'right';
          ctx.fillText(`${value}만`, x + width - 10, itemY + 14);
          
          itemY += 20;
        });
      }
    } else {
      // 일반 항목
      const value = values[item.id] || 0;
      const barColor = getBarColor(value);
      
      // 막대그래프 배경
      ctx.fillStyle = '#f8f8f8';
      ctx.fillRect(x, itemY, width, 25);
      
      // 막대그래프
      if (value > 0) {
        const barWidth = Math.min((value / 10000) * (width - 100), width - 100);
        ctx.fillStyle = barColor;
        ctx.fillRect(x, itemY, barWidth, 25);
      }
      
      ctx.strokeStyle = '#ddd';
      ctx.strokeRect(x, itemY, width, 25);
      
      // 텍스트
      ctx.fillStyle = '#333';
      ctx.font = '12px "Noto Sans KR", Arial';
      ctx.textAlign = 'left';
      ctx.fillText(item.label, x + 10, itemY + 16);
      
      ctx.textAlign = 'right';
      const unit = item.unit || '만원';
      ctx.fillText(`${value.toLocaleString()}${unit}`, x + width - 10, itemY + 16);
      
      itemY += 25;
    }
  });
}

// 치료 보장 예시 그리기
function drawTreatmentExample(ctx, x, y, width, title, examples) {
  // 헤더
  ctx.fillStyle = '#e8f5e8';
  ctx.fillRect(x, y, width, 30);
  ctx.strokeStyle = '#333';
  ctx.strokeRect(x, y, width, 30);
  
  ctx.fillStyle = '#333';
  ctx.font = 'bold 14px "Noto Sans KR", Arial';
  ctx.textAlign = 'center';
  ctx.fillText(title, x + width/2, y + 20);
  
  let exampleY = y + 40;
  
  examples.forEach(example => {
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(x, exampleY, width, 25);
    ctx.strokeStyle = '#ddd';
    ctx.strokeRect(x, exampleY, width, 25);
    
    ctx.fillStyle = '#333';
    ctx.font = '12px "Noto Sans KR", Arial';
    ctx.textAlign = 'left';
    ctx.fillText(example.label, x + 10, exampleY + 16);
    
    ctx.textAlign = 'right';
    ctx.fillText(example.amount, x + width - 10, exampleY + 16);
    
    exampleY += 25;
  });
}

// 막대그래프 색상 결정
function getBarColor(value) {
  if (value >= 3000) return '#28a745';  // 초록색
  if (value >= 1000) return '#ffc107';  // 노란색
  if (value > 0) return '#dc3545';      // 빨간색
  return '#f8f8f8';                     // 회색
}

// 데이터 불러오기
function loadData(id) {
  const data = savedData.find(item => item.id === id);
  if (!data) {
    showMessage('데이터를 찾을 수 없습니다.', 'error');
    return;
  }
  
  // 고객명 설정
  document.getElementById('customerName').value = data.customerName;
  
  // 모든 필드 값 설정
  Object.keys(data.values).forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.value = data.values[fieldId];
    }
  });
  
  // 간병인일당 옵션 설정
  if (data.caregiverOption) {
    const caregiverRadio = document.getElementById(data.caregiverOption === 'support' ? 'caregiverSupport' : 'caregiverUse');
    if (caregiverRadio) caregiverRadio.checked = true;
  }
  
  // 계산 필드 업데이트
  setupFormCalculations();
  updateCalculatedFields();
  applyConditionalFormatting();
  
  navigateToScreen('input');
  showMessage(`${data.customerName}의 데이터를 불러왔습니다.`, 'success');
}

// 저장된 목록 표시
function displaySavedList() {
  const savedList = document.getElementById('savedList');
  
  if (savedData.length === 0) {
    savedList.innerHTML = '<div class="meta">저장된 보장분석이 없습니다.</div>';
    return;
  }
  
  savedList.innerHTML = savedData.map(item => `
    <div class="saved-item" onclick="loadData(${item.id})">
      <div class="saved-item-title">${item.customerName}님의 보장분석</div>
      <div class="saved-item-date">${item.timestamp}</div>
    </div>
  `).join('');
}

// 메시지 표시
function showMessage(message, type = 'info') {
  const statusMessage = document.getElementById('statusMessage');
  statusMessage.textContent = message;
  statusMessage.className = `meta ${type}`;
  
  setTimeout(() => {
    statusMessage.textContent = '';
    statusMessage.className = 'meta';
  }, 3000);
}

// 이벤트 리스너 설정
document.addEventListener('DOMContentLoaded', () => {
  // 메뉴 버튼들
  document.getElementById('inputMenuBtn').addEventListener('click', () => navigateToScreen('input'));
  document.getElementById('loadMenuBtn').addEventListener('click', () => navigateToScreen('load'));
  
  // 입력 화면 버튼들
  document.getElementById('saveImageBtn').addEventListener('click', saveData);
  document.getElementById('loadFromMenuBtn').addEventListener('click', () => navigateToScreen('load'));
  document.getElementById('backToMenuBtn').addEventListener('click', () => navigateToScreen('menu'));
  
  // 불러오기 화면 버튼들
  document.getElementById('backToMenuFromLoadBtn').addEventListener('click', () => navigateToScreen('menu'));
  
  // 초기 화면 설정
  navigateToScreen('menu');
});
</script>

</body>
</html>
