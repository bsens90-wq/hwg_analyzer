<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë³´ì¥ë¶„ì„ í•œ ì¥ ìš”ì•½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
  <style>
    :root{
      --hanwha:#ff6600;
      --hanwha-dark:#e65100;
      --hanwha-light:#fff3e0;
      --hanwha-accent:#ff8f00;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e0e0e0;
      --before-bg:#f5f5f5;
      --after-bg:#fff8f0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding-top: 20px;
      font-family: 'Noto Sans KR', Arial, system-ui, -apple-system, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem 1rem;
    }
    .app-title{
      font-size:28px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.1);
      padding:24px;
      border: 1px solid var(--border);
    }
    .card.wide{
      max-width:1400px;
    }
    h2{margin:0 0 .75rem 0; color: var(--hanwha);}
    h3 {
      margin: 1.5rem 0 1rem 0;
      color: var(--hanwha);
      font-size: 18px;
      font-weight: 700;
      border-bottom: 2px solid var(--hanwha);
      padding-bottom: 8px;
    }
    .section-notice {
      background: var(--hanwha-light);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      color: var(--hanwha-dark);
      border: 1px solid #ffcc80;
    }
    .row{margin-bottom:.75rem}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:14px;
      outline:none;
      background:#fff;
      transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--hanwha);
      box-shadow: 0 0 0 3px rgba(255,102,0,0.1);
    }
    button{
      width:100%;
      padding:14px;
      background:linear-gradient(135deg, var(--hanwha), var(--hanwha-accent));
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255,102,0,0.3);
    }
    button:hover{
      background:linear-gradient(135deg, var(--hanwha-dark), var(--hanwha));
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255,102,0,0.4);
    }
    button.secondary{
      background:linear-gradient(135deg, #6c757d, #545b62);
      margin-bottom:0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button.secondary:hover{
      background:linear-gradient(135deg, #545b62, #6c757d);
    }
    button.small{
      width:auto;
      padding:6px 10px;
      font-size:12px;
      margin:2px;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:.25rem}
    .error{color:#d93025; font-size:14px; margin-top:.5rem}
    .success{color:#28a745; font-size:14px; margin-top:.5rem}
    
    .image-upload-area {
      border: 2px dashed var(--hanwha);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      background: linear-gradient(135deg, #fff5f0, #fffaf5);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .image-upload-area:hover {
      border-color: var(--hanwha-dark);
      background: linear-gradient(135deg, #fff0e8, #fff5ed);
      transform: scale(1.02);
    }
    
    .image-upload-area.drag-over {
      border-color: var(--hanwha-dark);
      background: var(--hanwha-light);
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .input-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 1rem 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .input-table th,
    .input-table td {
      border: 1px solid var(--border);
      padding: 10px 12px;
      text-align: left;
      vertical-align: middle;
    }
    
    .input-table thead th {
      background: linear-gradient(135deg, var(--hanwha), var(--hanwha-accent));
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 12px;
      font-size: 14px;
    }
    
    .input-table tbody th {
      background: var(--bg);
      font-weight: 600;
      width: 40%;
      font-size: 13px;
      color: var(--text);
    }
    
    .input-table .before-column {
      background: var(--before-bg);
      width: 30%;
      position: relative;
    }
    
    .input-table .after-column {
      background: var(--after-bg);
      width: 30%;
      position: relative;
    }
    
    .input-table input {
      width: 100%;
      padding: 6px 8px;
      margin: 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      display: inline-block;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 12px;
    }
    
    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-modal:hover,
    .close-modal:focus {
      color: #000;
    }
    
    .standard-amount-input {
      width: 100px;
      padding: 5px;
      margin-left: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .section-header {
      background: linear-gradient(135deg, var(--hanwha), var(--hanwha-accent));
      color: white;
      font-weight: 700;
      text-align: center;
      font-size: 15px;
    }
    
    .section-header td {
      padding: 10px;
      border: none;
    }
    
    .radio-group {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }
    
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .radio-group input[type="radio"] {
      width: auto;
      margin: 0;
    }
    
    .saved-item {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .saved-item:hover {
      background: var(--hanwha-light);
      border-color: var(--hanwha);
      transform: translateX(5px);
    }
    
    .saved-item-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .saved-item-date {
      font-size: 12px;
      color: var(--muted);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--hanwha);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .card {
        max-width: 100%;
        margin: 0 10px;
      }
      
      .input-table th,
      .input-table td {
        padding: 6px 8px;
        font-size: 12px;
      }
      
      .input-table tbody th {
        font-size: 12px;
      }
      
      .input-table input {
        font-size: 12px;
      }
    }
    
    .hidden {
      display: none;
    }
    
    #hiddenPrintContainer {
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: 3900px;
    }
    
    .auto-calculated {
      background-color: #e8f5e8 !important;
      border: 1px solid #4caf50 !important;
    }
    
    .auto-calculated::after {
      content: "ğŸ”¢";
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <!-- ë©”ë‰´ í™”ë©´ -->
  <section id="menuScreen" class="screen">
    <div class="app-title">ë³´ì¥ë¶„ì„ í•œ ì¥ ìš”ì•½</div>
    <div class="card">
      <h2 style="margin-bottom:1.5rem; text-align:center;">ë©”ë‰´ ì„ íƒ</h2>
      
      <button id="inputMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">ğŸ“ ì…ë ¥í•˜ê¸°</span>
        <span style="font-size:14px; opacity:0.9;">ë³´ì¥ë¶„ì„ì§€ ì´¬ì˜/ì—…ë¡œë“œ</span>
      </button>
      
      <button id="loadMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</span>
        <span style="font-size:14px; opacity:0.9;">ì €ì¥ëœ ë³´ì¥ë¶„ì„ ëª©ë¡ì—ì„œ ì„ íƒ</span>
      </button>
      
      <div class="meta" style="margin-top:2rem; text-align:center; color: var(--muted); font-size: 12px;">
        Copyright 2025 í•˜ì„¸ë´‰ all rights reserved.
      </div>
    </div>
  </section>

  <!-- ì…ë ¥ í™”ë©´ -->
  <section id="inputScreen" class="screen hidden">
    <div class="app-title">ë³´ì¥ê¸ˆì•¡ ì…ë ¥í•˜ê¸°</div>
    <div class="card wide">
      <div class="row">
        <div class="image-upload-area" id="imageUploadArea">
          <div id="uploadText">
            ğŸ“· ì—¬ê¸°ë¥¼ í„°ì¹˜í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
            <span style="font-size: 12px; color: var(--muted);">ë“œë˜ê·¸ ì•¤ ë“œë¡­ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤</span>
          </div>
          <img id="imagePreview" class="image-preview hidden" alt="ë¯¸ë¦¬ë³´ê¸°">
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
        </div>
      </div>
      
      <div class="row">
        <button id="ocrProcessBtn" disabled>ğŸ” ìë™ ìŠ¤ìº”í•˜ê¸°</button>
        <div id="ocrStatus" class="hint"></div>
      </div>
      
      <!-- ê³ ê° ê¸°ë³¸ ì •ë³´ -->
      <div class="row">
        <h3>ê³ ê° ê¸°ë³¸ ì •ë³´</h3>
        <table class="input-table">
          <tr>
            <th style="width: 30%;">ê³ ê°ëª…</th>
            <td style="width: 70%;"><input type="text" id="customerName" placeholder="ê³ ê°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></td>
          </tr>
          <tr>
            <th style="width: 30%;">ìƒë…„ì›”ì¼</th>
            <td style="width: 70%;"><input type="text" id="birthDate" placeholder="YY-MM-DD"></td>
          </tr>
        </table>
      </div>
      
      <!-- ë‹´ë³´ ì…ë ¥ í…Œì´ë¸” (ë³€ê²½ ì „/í›„ í†µí•©) -->
      <div class="row">
        <h3>ë‹´ë³´ í•­ëª©ë³„ ë³´ì¥ê¸ˆì•¡</h3>
        <div style="text-align: right; margin-bottom: 10px;">
          <button id="standardAmountBtn" class="small" style="background: linear-gradient(135deg, #ff6600, #ff8f00); color: white; padding: 8px 16px; font-size: 13px; width: auto; margin: 0;">
            âš™ï¸ í‘œì¤€ê¸ˆì•¡ ì„¤ì •
          </button>
        </div>
        <div class="section-notice">
          âš ï¸ OCR ì¸ì‹ í›„ ë³€ê²½ ì „/í›„ ê°’ì´ ë™ì¼í•˜ê²Œ ì„¸íŒ…ë©ë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.<br>
          ğŸ”¢ ì£¼ìš”ìˆœí™˜ê³„(ìˆ˜ìˆ ) ì…ë ¥ ì‹œ ê´€ë ¨ í•­ëª©ë“¤ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.
        </div>
        <table class="input-table" id="coverageTable">
          <thead>
            <tr>
              <th>ë‹´ë³´ í•­ëª©</th>
              <th style="background: #f5f5f5; color: #333;">ë³€ê²½ ì „</th>
              <th style="background: var(--hanwha-light); color: #333;">ë³€ê²½ í›„</th>
            </tr>
          </thead>
          <tbody id="coverageTableBody">
            <!-- ë‹´ë³´ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
          </tbody>
        </table>
      </div>
      
      <!-- ê°„ë³‘ì¸ì¼ë‹¹ -->
      <div class="row">
        <h3>ê°„ë³‘ì¸ì¼ë‹¹ ì„¤ì •</h3>
        <table class="input-table">
          <tr>
            <th>ê°„ë³‘ì¸ì¼ë‹¹ ì¢…ë¥˜</th>
            <td colspan="2">
              <div class="radio-group">
                <label>
                  <input type="radio" name="caregiverOption" value="use" id="caregiverUse" checked>
                  ì‚¬ìš©
                </label>
                <label>
                  <input type="radio" name="caregiverOption" value="support" id="caregiverSupport">
                  ì§€ì›
                </label>
              </div>
            </td>
          </tr>
        </table>
        <table class="input-table" id="caregiverDetailsTable" style="margin-top: -1px;">
          <thead>
            <tr>
              <th>ê°„ë³‘ì¸ í•­ëª©</th>
              <th style="background: #f5f5f5; color: #333;">ë³€ê²½ ì „</th>
              <th style="background: var(--hanwha-light); color: #333;">ë³€ê²½ í›„</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>ìš”ì–‘ë³‘ì› ì™¸</th>
              <td class="before-column">
                <input type="text" id="nursingHospitalOut_before" placeholder="0" class="amount-input">
              </td>
              <td class="after-column">
                <input type="text" id="nursingHospitalOut_after" placeholder="0" class="amount-input">
              </td>
            </tr>
            <tr>
              <th>ìš”ì–‘ë³‘ì›</th>
              <td class="before-column">
                <input type="text" id="nursingHospitalIn_before" placeholder="0" class="amount-input">
              </td>
              <td class="after-column">
                <input type="text" id="nursingHospitalIn_after" placeholder="0" class="amount-input">
              </td>
            </tr>
            <tr>
              <th>ê°„í˜¸ê°„ë³‘í†µí•©</th>
              <td class="before-column">
                <input type="text" id="nursingCareIntegrated_before" placeholder="0" class="amount-input">
              </td>
              <td class="after-column">
                <input type="text" id="nursingCareIntegrated_after" placeholder="0" class="amount-input">
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="row" style="margin-top: 2rem;">
        <button id="saveDataBtn">ğŸ’¾ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
        <button id="backToMenuBtn" class="secondary">â—€ ë’¤ë¡œê°€ê¸°</button>
      </div>
    </div>
  </section>

  <!-- ë¶ˆëŸ¬ì˜¤ê¸° í™”ë©´ -->
  <section id="loadScreen" class="screen hidden">
    <div class="app-title">ì €ì¥ëœ ë³´ì¥ë¶„ì„ ë¶ˆëŸ¬ì˜¤ê¸°</div>
    <div class="card">
      <div class="row">
        <input type="text" id="searchInput" placeholder="ğŸ” ê³ ê°ëª…ìœ¼ë¡œ ê²€ìƒ‰...">
      </div>
      
      <div id="savedList">
        <!-- ì €ì¥ëœ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
      
      <div class="row" style="margin-top: 2rem;">
        <button id="backToMenuFromLoadBtn" class="secondary">â—€ ë’¤ë¡œê°€ê¸°</button>
      </div>
    </div>
  </section>

  <!-- ìˆ¨ê²¨ì§„ ì¶œë ¥ìš© ì»¨í…Œì´ë„ˆ -->
  <div id="hiddenPrintContainer"></div>

  <!-- í‘œì¤€ê¸ˆì•¡ ì„¤ì • ëª¨ë‹¬ -->
  <div id="standardAmountModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 style="color: var(--hanwha); margin-bottom: 1rem;">í‘œì¤€ê¸ˆì•¡ ì„¤ì •</h2>
      <p style="font-size: 13px; color: var(--muted); margin-bottom: 1rem;">
        ê° í•­ëª©ì˜ í‘œì¤€ê¸ˆì•¡ì„ ì„¤ì •í•˜ë©´ ì§„í–‰ë¥  ë°”ì˜ ê¸°ì¤€ê°’ì´ ë³€ê²½ë©ë‹ˆë‹¤.
      </p>
      <div id="standardAmountList" style="max-height: 400px; overflow-y: auto;">
        <!-- í‘œì¤€ê¸ˆì•¡ ì…ë ¥ í•„ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
      </div>
      <div style="margin-top: 1.5rem; text-align: center;">
        <button id="saveStandardAmountBtn" style="padding: 10px 20px; width: auto;">
          ì €ì¥í•˜ê¸°
        </button>
      </div>
    </div>
  </div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
// ì „ì—­ ë³€ìˆ˜
let currentData = {};
let savedDataList = [];

// ëª¨ë“  ë‹´ë³´ í•­ëª© í†µí•© ì •ì˜
const ALL_COVERAGE_ITEMS = [
  // ì•” ê´€ë ¨ ë‹´ë³´
  { key: 'generalCancer', name: 'ì¼ë°˜ì•”ì§„ë‹¨ë¹„', standardAmount: 5000, category: 'cancer' },
  { key: 'totalCancer', name: 'í†µí•©ì•”ì§„ë‹¨ë¹„', standardAmount: 3000, category: 'cancer' },
  { key: 'metastasisCancer', name: 'ì „ì´ì•”ì§„ë‹¨ë¹„', standardAmount: 2000, category: 'cancer' },
  { key: 'cancerSpecificTreatment', name: 'ì•”ì¹˜ë£Œë¹„', standardAmount: 1000, category: 'cancer' },
  { key: 'cancerNonCoveredTreatment', name: 'ì•”ì¹˜ë£Œë¹„(ë¹„ê¸‰ì—¬)', standardAmount: 3000, category: 'cancer' },
  { key: 'targetTherapy', name: 'í‘œì í•­ì•”ì¹˜ë£Œë¹„', standardAmount: 3000, category: 'cancer' },
  { key: 'heavyIonTherapy', name: 'ì¤‘ì…ìì¹˜ë£Œë¹„', standardAmount: 5000, category: 'cancer' },
  { key: 'cancerSurgery', name: 'ì•”ìˆ˜ìˆ ë¹„', standardAmount: 500, category: 'cancer' },
  { key: 'daVinciSurgery', name: 'ë‹¤ë¹ˆì¹˜ìˆ˜ìˆ ë¹„', standardAmount: 2000, category: 'cancer' },
  { key: 'surgery5Type', name: '1-5ì¢…ìˆ˜ìˆ ë¹„(5ì¢…)', standardAmount: 100, category: 'cancer' },
  
  // 2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜
  { key: 'cerebrovascularDiagnosis', name: 'ë‡Œí˜ˆê´€ì§„ë‹¨ë¹„', standardAmount: 3000, category: 'majorDisease' },
  { key: 'strokeDiagnosis', name: 'ë‡Œì¡¸ì¤‘ì§„ë‹¨ë¹„', standardAmount: 3000, category: 'majorDisease' },
  { key: 'ischemicHeartDiagnosis', name: 'í—ˆí˜ˆì„±ì§„ë‹¨ë¹„', standardAmount: 2000, category: 'majorDisease' },
  { key: 'myocardialInfarctionDiagnosis', name: 'ì‹¬ê·¼ê²½ìƒ‰ì§„ë‹¨ë¹„', standardAmount: 2000, category: 'majorDisease' },
  { key: 'cerebrovascularSurgery', name: 'ë‡Œí˜ˆê´€ìˆ˜ìˆ ë¹„', standardAmount: 1000, category: 'majorDisease' },
  { key: 'strokeSurgery', name: 'ë‡Œì¡¸ì¤‘ìˆ˜ìˆ ë¹„', standardAmount: 1000, category: 'majorDisease' },
  { key: 'ischemicHeartSurgery', name: 'í—ˆí˜ˆì„±ìˆ˜ìˆ ë¹„', standardAmount: 1000, category: 'majorDisease' },
  { key: 'myocardialInfarctionSurgery', name: 'ì‹¬ê·¼ê²½ìƒ‰ìˆ˜ìˆ ë¹„', standardAmount: 1000, category: 'majorDisease' },
  { key: 'strokeThrombolysis', name: 'ë‡Œì¡¸ì¤‘í˜ˆì „ìš©í•´', standardAmount: 1000, category: 'majorDisease' },
  { key: 'myocardialInfarctionThrombolysis', name: 'ì‹¬ê·¼ê²½ìƒ‰í˜ˆì „ìš©í•´', standardAmount: 1000, category: 'majorDisease' },
  { key: 'twoMajorTreatment', name: '2ëŒ€íŠ¹ì •ì¹˜ë£Œë¹„', standardAmount: 1000, category: 'majorDisease' },
  { key: 'majorCirculatorySurgery', name: 'ì£¼ìš”ìˆœí™˜ê³„(ìˆ˜ìˆ )', standardAmount: 3000, category: 'majorDisease' },
  { key: 'majorCirculatoryThrombectomy', name: 'ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ì œê±°)', standardAmount: 3000, category: 'majorDisease' },
  { key: 'majorCirculatoryThrombolysis', name: 'ì£¼ìš”ìˆœí™˜ê³„(í˜ˆì „ìš©í•´)', standardAmount: 3000, category: 'majorDisease' },
  { key: 'majorCirculatoryICU', name: 'ì£¼ìš”ìˆœí™˜ê³„(ì¤‘í™˜ìì‹¤)', standardAmount: 1500, category: 'majorDisease' },
  { key: 'thrombectomyTreatment', name: 'í˜ˆì „ì œê±°ì¹˜ë£Œë¹„', standardAmount: 3000, category: 'majorDisease' },
  { key: 'surgery3Type', name: '1-5ì¢…ìˆ˜ìˆ ë¹„(3ì¢…)', standardAmount: 300, category: 'majorDisease' },
  { key: 'surgery5Type2', name: '1-5ì¢…ìˆ˜ìˆ ë¹„(5ì¢…)', standardAmount: 100, category: 'majorDisease' },
  { key: 'disease124Surgery', name: '124ëŒ€(íŠ¹ì •10ëŒ€)', standardAmount: 500, category: 'majorDisease' },
  { key: 'sevenOrganSurgery', name: '7ëŒ€ê¸°ê´€(ë‡Œ/ì‹¬ ê´€í˜ˆ)', standardAmount: 2000, category: 'majorDisease' },
  
  // 5ëŒ€ í•„ìˆ˜ë³´í—˜
  { key: 'diseaseHospitalization', name: '(ì‹¤ì†)ì§ˆë³‘ì…ì›', standardAmount: 5000, category: 'essential' },
  { key: 'injuryHospitalization', name: '(ì‹¤ì†)ìƒí•´ì…ì›', standardAmount: 5000, category: 'essential' },
  { key: 'criminalSettlement', name: 'í˜•ì‚¬í•©ì˜ê¸ˆ', standardAmount: 20000, category: 'essential' },
  { key: 'lawyerAppointment', name: 'ë³€í˜¸ì‚¬ì„ ì„ë¹„', standardAmount: 3000, category: 'essential' },
  { key: 'dailyLifeLiability', name: 'ì¼ìƒìƒí™œë°°ìƒì±…ì„', standardAmount: 10000, category: 'essential' },
  { key: 'fireFine', name: 'í™”ì¬ë²Œê¸ˆ', standardAmount: 2000, category: 'essential' }
];

// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  loadStandardAmounts();
  initializeApp();
  loadSavedData();
  setupEventListeners();
});

// ì•± ì´ˆê¸°í™”
function initializeApp() {
  showScreen('menu');
  createCoverageTable();
  addAmountFormatting();
  setupMajorCirculatoryAutoCalculation();
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
  // ë©”ë‰´ ë²„íŠ¼ë“¤
  document.getElementById('inputMenuBtn').addEventListener('click', () => showScreen('input'));
  document.getElementById('loadMenuBtn').addEventListener('click', () => {
    showScreen('load');
    displaySavedList();
  });
  
  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ë“¤
  document.getElementById('backToMenuBtn').addEventListener('click', () => showScreen('menu'));
  document.getElementById('backToMenuFromLoadBtn').addEventListener('click', () => showScreen('menu'));
  
  // ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨
  const imageUploadArea = document.getElementById('imageUploadArea');
  const imageInput = document.getElementById('imageInput');
  
  imageUploadArea.addEventListener('click', () => imageInput.click());
  imageInput.addEventListener('change', handleImageUpload);
  
  // ë“œë˜ê·¸ ì•¤ ë“œë¡­
  imageUploadArea.addEventListener('dragover', handleDragOver);
  imageUploadArea.addEventListener('drop', handleDrop);
  imageUploadArea.addEventListener('dragenter', (e) => {
    e.preventDefault();
    imageUploadArea.classList.add('drag-over');
  });
  imageUploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    imageUploadArea.classList.remove('drag-over');
  });
  
  // OCR ì²˜ë¦¬ ë²„íŠ¼
  document.getElementById('ocrProcessBtn').addEventListener('click', processOCR);
  
  // ì €ì¥ ë²„íŠ¼
  document.getElementById('saveDataBtn').addEventListener('click', saveAndDownloadImage);
  
  // ê²€ìƒ‰ ê¸°ëŠ¥
  document.getElementById('searchInput').addEventListener('input', filterSavedList);
  
  // ê°„ë³‘ì¸ ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.querySelectorAll('input[name="caregiverOption"]').forEach(radio => {
    radio.addEventListener('change', handleCaregiverOptionChange);
  });
  
  // í‘œì¤€ê¸ˆì•¡ ì„¤ì • ë²„íŠ¼
  document.getElementById('standardAmountBtn').addEventListener('click', openStandardAmountModal);
  
  // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
  document.querySelector('.close-modal').addEventListener('click', closeStandardAmountModal);
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('standardAmountModal');
    if (event.target === modal) {
      closeStandardAmountModal();
    }
  });
  
  // í‘œì¤€ê¸ˆì•¡ ì €ì¥ ë²„íŠ¼
  document.getElementById('saveStandardAmountBtn').addEventListener('click', saveStandardAmounts);
}

// ì£¼ìš”ìˆœí™˜ê³„ ìë™ ê³„ì‚° ì„¤ì •
function setupMajorCirculatoryAutoCalculation() {
  setTimeout(() => {
    const surgeryInputBefore = document.getElementById('majorCirculatorySurgery_before');
    const surgeryInputAfter = document.getElementById('majorCirculatorySurgery_after');
    
    if (surgeryInputBefore) {
      surgeryInputBefore.addEventListener('input', () => handleMajorCirculatoryCalculation('before'));
      surgeryInputBefore.addEventListener('blur', () => handleMajorCirculatoryCalculation('before'));
    }
    
    if (surgeryInputAfter) {
      surgeryInputAfter.addEventListener('input', () => handleMajorCirculatoryCalculation('after'));
      surgeryInputAfter.addEventListener('blur', () => handleMajorCirculatoryCalculation('after'));
    }
  }, 100);
}

// ìˆ«ì ì¶”ì¶œ í•¨ìˆ˜
function extractNumber(value) {
  if (!value) return 0;
  const numbers = value.toString().replace(/[^0-9]/g, '');
  return numbers ? parseInt(numbers) : 0;
}

// í¬ë§·íŒ…ëœ ê°’ìœ¼ë¡œ ë³€í™˜
function formatToDisplayValue(value) {
  if (!value || value === 0) return '';
  return value.toLocaleString() + 'ë§Œì›';
}

// ì£¼ìš”ìˆœí™˜ê³„ ìë™ ê³„ì‚° í•¨ìˆ˜
function handleMajorCirculatoryCalculation(type) {
  const surgeryInput = document.getElementById('majorCirculatorySurgery_' + type);
  if (!surgeryInput) return;
  
  const surgeryValue = extractNumber(surgeryInput.value);
  
  // ê´€ë ¨ í•„ë“œë“¤
  const thrombectomyInput = document.getElementById('majorCirculatoryThrombectomy_' + type);
  const thrombolysisInput = document.getElementById('majorCirculatoryThrombolysis_' + type);
  const icuInput = document.getElementById('majorCirculatoryICU_' + type);
  
  if (surgeryValue > 0) {
    if (thrombectomyInput) {
      thrombectomyInput.value = formatToDisplayValue(surgeryValue);
      thrombectomyInput.classList.add('auto-calculated');
    }
    
    if (thrombolysisInput) {
      thrombolysisInput.value = formatToDisplayValue(surgeryValue);
      thrombolysisInput.classList.add('auto-calculated');
    }
    
    if (icuInput) {
      const icuValue = Math.floor(surgeryValue * 0.5);
      icuInput.value = formatToDisplayValue(icuValue);
      icuInput.classList.add('auto-calculated');
    }
  } else {
    if (thrombectomyInput) {
      thrombectomyInput.value = '';
      thrombectomyInput.classList.remove('auto-calculated');
    }
    if (thrombolysisInput) {
      thrombolysisInput.value = '';
      thrombolysisInput.classList.remove('auto-calculated');
    }
    if (icuInput) {
      icuInput.value = '';
      icuInput.classList.remove('auto-calculated');
    }
  }
}

// í‘œì¤€ê¸ˆì•¡ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
function openStandardAmountModal() {
  const modal = document.getElementById('standardAmountModal');
  const list = document.getElementById('standardAmountList');
  
  const categories = {
    'cancer': 'ì•” ê´€ë ¨ ë‹´ë³´',
    'majorDisease': '2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜',
    'essential': '5ëŒ€ í•„ìˆ˜ë³´í—˜'
  };
  
  list.innerHTML = '';
  
  Object.entries(categories).forEach(([category, title]) => {
    const categoryDiv = document.createElement('div');
    categoryDiv.innerHTML = `<h3 style="color: var(--hanwha); font-size: 14px; margin: 1rem 0 0.5rem 0; border-bottom: 1px solid #ddd; padding-bottom: 5px;">${title}</h3>`;
    
    const items = ALL_COVERAGE_ITEMS.filter(item => item.category === category);
    items.forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin: 8px 0;';
      itemDiv.innerHTML = `
        <label style="font-size: 13px; flex: 1;">${item.name}</label>
        <input type="number" class="standard-amount-input" data-key="${item.key}" value="${item.standardAmount}" placeholder="0">
        <span style="font-size: 12px; color: var(--muted); margin-left: 5px;">ë§Œì›</span>
      `;
      categoryDiv.appendChild(itemDiv);
    });
    
    list.appendChild(categoryDiv);
  });
  
  modal.style.display = 'block';
}

// í‘œì¤€ê¸ˆì•¡ ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
function closeStandardAmountModal() {
  const modal = document.getElementById('standardAmountModal');
  modal.style.display = 'none';
}

// í‘œì¤€ê¸ˆì•¡ ì €ì¥
function saveStandardAmounts() {
  const inputs = document.querySelectorAll('.standard-amount-input');
  
  inputs.forEach(input => {
    const key = input.dataset.key;
    const value = parseInt(input.value) || 0;
    
    const item = ALL_COVERAGE_ITEMS.find(item => item.key === key);
    if (item) {
      item.standardAmount = value;
    }
  });
  
  localStorage.setItem('standardAmounts', JSON.stringify(ALL_COVERAGE_ITEMS));
  
  alert('í‘œì¤€ê¸ˆì•¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  closeStandardAmountModal();
}

// ì €ì¥ëœ í‘œì¤€ê¸ˆì•¡ ë¡œë“œ
function loadStandardAmounts() {
  const saved = localStorage.getItem('standardAmounts');
  if (saved) {
    const savedAmounts = JSON.parse(saved);
    savedAmounts.forEach(savedItem => {
      const item = ALL_COVERAGE_ITEMS.find(i => i.key === savedItem.key);
      if (item) {
        item.standardAmount = savedItem.standardAmount;
      }
    });
  }
}

// ë‹´ë³´ í…Œì´ë¸” ìƒì„±
function createCoverageTable() {
  const tbody = document.getElementById('coverageTableBody');
  tbody.innerHTML = '';
  
  ALL_COVERAGE_ITEMS.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <th>${item.name}</th>
      <td class="before-column" style="position: relative;">
        <input type="text" id="${item.key}_before" placeholder="0" class="amount-input">
      </td>
      <td class="after-column" style="position: relative;">
        <input type="text" id="${item.key}_after" placeholder="0" class="amount-input">
      </td>
    `;
    tbody.appendChild(row);
  });
  
  setupMajorCirculatoryAutoCalculation();
}

// ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
function formatAmount(value) {
  const numbers = value.replace(/[^0-9]/g, '');
  if (!numbers) return '';
  
  const formatted = parseInt(numbers).toLocaleString();
  return formatted + 'ë§Œì›';
}

// ì…ë ¥ í•„ë“œ í¬ë§·íŒ… ì´ë²¤íŠ¸ ì¶”ê°€
function addAmountFormatting() {
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('amount-input')) {
      const cursorPos = e.target.selectionStart;
      const numbers = e.target.value.replace(/[^0-9]/g, '');
      
      if (numbers) {
        const formatted = parseInt(numbers).toLocaleString() + 'ë§Œì›';
        e.target.value = formatted;
        
        const newCursorPos = formatted.length - 2;
        e.target.setSelectionRange(newCursorPos, newCursorPos);
      }
    }
  });
  
  document.addEventListener('blur', function(e) {
    if (e.target.classList.contains('amount-input')) {
      const numbers = e.target.value.replace(/[^0-9]/g, '');
      if (numbers) {
        e.target.value = parseInt(numbers).toLocaleString() + 'ë§Œì›';
      }
    }
  });
  
  document.addEventListener('focus', function(e) {
    if (e.target.classList.contains('amount-input') && !e.target.classList.contains('auto-calculated')) {
      const numbers = e.target.value.replace(/[^0-9]/g, '');
      if (numbers) {
        e.target.value = numbers;
        e.target.select();
      }
    }
  });
}

// í™”ë©´ ì „í™˜
function showScreen(screenName) {
  const screens = ['menu', 'input', 'load'];
  screens.forEach(name => {
    document.getElementById(name + 'Screen').classList.toggle('hidden', name !== screenName);
  });
  
  if (screenName === 'input' && !currentData.customerName) {
    resetInputForm();
  }
}

// ì…ë ¥ í¼ ì´ˆê¸°í™”
function resetInputForm() {
  document.getElementById('customerName').value = '';
  document.getElementById('birthDate').value = '';
  
  ALL_COVERAGE_ITEMS.forEach(item => {
    const beforeInput = document.getElementById(item.key + '_before');
    const afterInput = document.getElementById(item.key + '_after');
    if (beforeInput) {
      beforeInput.value = '';
      beforeInput.classList.remove('auto-calculated');
    }
    if (afterInput) {
      afterInput.value = '';
      afterInput.classList.remove('auto-calculated');
    }
  });
  
  ['nursingHospitalOut', 'nursingHospitalIn', 'nursingCareIntegrated'].forEach(id => {
    const beforeInput = document.getElementById(id + '_before');
    const afterInput = document.getElementById(id + '_after');
    if (beforeInput) beforeInput.value = '';
    if (afterInput) afterInput.value = '';
  });
  
  document.getElementById('caregiverUse').checked = true;
  handleCaregiverOptionChange();
  
  const imagePreview = document.getElementById('imagePreview');
  const uploadText = document.getElementById('uploadText');
  imagePreview.classList.add('hidden');
  uploadText.style.display = 'block';
  
  document.getElementById('ocrProcessBtn').disabled = true;
  document.getElementById('ocrStatus').textContent = '';
}

// ê°„ë³‘ì¸ ì˜µì…˜ ë³€ê²½ ì²˜ë¦¬
function handleCaregiverOptionChange() {
  const isUse = document.getElementById('caregiverUse').checked;
  const detailsTable = document.getElementById('caregiverDetailsTable');
  
  if (isUse) {
    detailsTable.style.display = 'table';
  } else {
    detailsTable.style.display = 'none';
    ['nursingHospitalOut', 'nursingHospitalIn', 'nursingCareIntegrated'].forEach(id => {
      const beforeInput = document.getElementById(id + '_before');
      const afterInput = document.getElementById(id + '_after');
      if (beforeInput) beforeInput.value = '';
      if (afterInput) afterInput.value = '';
    });
  }
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (file && file.type.startsWith('image/')) {
    displayImagePreview(file);
  }
}

// ë“œë˜ê·¸ ì˜¤ë²„ ì²˜ë¦¬
function handleDragOver(event) {
  event.preventDefault();
}

// ë“œë¡­ ì²˜ë¦¬
function handleDrop(event) {
  event.preventDefault();
  document.getElementById('imageUploadArea').classList.remove('drag-over');
  
  const files = event.dataTransfer.files;
  if (files.length > 0 && files[0].type.startsWith('image/')) {
    displayImagePreview(files[0]);
  }
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
function displayImagePreview(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const imagePreview = document.getElementById('imagePreview');
    const uploadText = document.getElementById('uploadText');
    
    imagePreview.src = e.target.result;
    imagePreview.classList.remove('hidden');
    uploadText.style.display = 'none';
    
    document.getElementById('ocrProcessBtn').disabled = false;
    document.getElementById('ocrStatus').textContent = 'OCR ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
  };
  reader.readAsDataURL(file);
}

// OCR ì²˜ë¦¬
async function processOCR() {
  const ocrBtn = document.getElementById('ocrProcessBtn');
  const ocrStatus = document.getElementById('ocrStatus');
  const imagePreview = document.getElementById('imagePreview');
  
  if (!imagePreview.src) {
    alert('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    ocrBtn.disabled = true;
    ocrStatus.innerHTML = '<span class="loading"></span> OCR ì¸ì‹ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
    
    const base64Image = imagePreview.src.split(',')[1];
    
    const result = await callGoogleVisionAPI(base64Image);
    await parseOCRResult(result);
    
    ocrStatus.innerHTML = '<span class="success">âœ… OCR ì¸ì‹ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.</span>';
  } catch (error) {
    console.error('OCR ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    ocrStatus.innerHTML = '<span class="error">âŒ OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</span>';
  } finally {
    ocrBtn.disabled = false;
  }
}

// Google Vision API í˜¸ì¶œ
async function callGoogleVisionAPI(base64Image) {
  const API_KEY = 'AIzaSyDywqG3hrawe_KrgWVpj5Y34ySJE0xjGQM';
  
  const requestBody = {
    requests: [{
      image: {
        content: base64Image
      },
      features: [{
        type: 'DOCUMENT_TEXT_DETECTION',
        maxResults: 1
      }]
    }]
  };
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} - ${response.statusText}`);
  }
  
  return await response.json();
}

// OCR ê²°ê³¼ íŒŒì‹±
async function parseOCRResult(apiResult) {
  if (!apiResult || !apiResult.responses || !apiResult.responses[0]) {
    throw new Error('OCR ê²°ê³¼ë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }

  // ê°œì„ ëœ OCR í…ìŠ¤íŠ¸ ì¸ì‹ ìˆœì„œ ë¶„ì„ ë° ì •ë ¬ëœ í…ìŠ¤íŠ¸ íšë“
  const sortedText = analyzeOCRTextOrder(apiResult.responses[0]);
  
  console.log('ì •ë ¬ëœ OCR í…ìŠ¤íŠ¸:', sortedText);

  if (!sortedText.trim()) {
    throw new Error('ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }

  // ì •ë ¬ëœ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ ì¶”ì¶œ
  extractCustomerInfo(sortedText);
  extractCoverageAmountsForBeforeAfter(sortedText);
}

// ë¼ì¸ì„ ì˜ë¯¸ ë‹¨ìœ„ë³„ë¡œ ë¶„í• í•˜ëŠ” í•¨ìˆ˜ (ì™„ì „íˆ ìƒˆë¡œìš´ ì ‘ê·¼)
function splitLineIntoMeaningfulChunks(lineBlocks) {
  // 1. ì „ì²´ ë¼ì¸ì„ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ í•©ì¹˜ê¸°
  const fullText = lineBlocks.map(block => block.text).join(' ');
  console.log(`ì „ì²´ ë¼ì¸ í…ìŠ¤íŠ¸: "${fullText}"`);
  
  // 2. íŒ¨í„´ë“¤ì„ ì°¾ì•„ì„œ ì¸ë±ìŠ¤ ì €ì¥
  const patterns = [];
  
  // íŒ¨í„´1: ë¶„ìˆ˜í˜•íƒœ (ë‹´ë³´ëª… + ìˆ«ì/ìˆ«ìë§Œì›)
  let fractionMatches = [...fullText.matchAll(/([ê°€-í£\s]*?)(\d{1,3}(?:,\d{3})*)\s*\/\s*(\d{1,3}(?:,\d{3})*)\s*ë§Œì›/g)];
  fractionMatches.forEach(match => {
    patterns.push({
      start: match.index,
      end: match.index + match[0].length,
      text: match[0],
      type: 'fraction'
    });
  });
  
  // íŒ¨í„´2: ë¶€ì¡±í˜•íƒœ (ìˆ«ìë§Œì› ë¶€ì¡±)
  let deficitMatches = [...fullText.matchAll(/(\d{1,3}(?:,\d{3})*)\s*ë§Œì›\s*ë¶€ì¡±/g)];
  deficitMatches.forEach(match => {
    patterns.push({
      start: match.index,
      end: match.index + match[0].length,
      text: match[0],
      type: 'deficit'
    });
  });
  
  // íŒ¨í„´3: ë‹¨ìˆœ ë§Œì›í˜•íƒœ (ë¶„ìˆ˜ë‚˜ ë¶€ì¡±ì´ ì•„ë‹Œ ê²½ìš°)
  let simpleMatches = [...fullText.matchAll(/([ê°€-í£\s]*?)(\d{1,3}(?:,\d{3})*)\s*ë§Œì›(?!\s*[\/ë¶€ì¡±])/g)];
  simpleMatches.forEach(match => {
    // ì´ë¯¸ ë‹¤ë¥¸ íŒ¨í„´ì— í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ ì¶”ê°€
    const isOverlapped = patterns.some(p => 
      (match.index >= p.start && match.index < p.end) ||
      (match.index + match[0].length > p.start && match.index + match[0].length <= p.end)
    );
    if (!isOverlapped) {
      patterns.push({
        start: match.index,
        end: match.index + match[0].length,
        text: match[0],
        type: 'simple'
      });
    }
  });
  
  // 3. íŒ¨í„´ì„ ì‹œì‘ ìœ„ì¹˜ ìˆœìœ¼ë¡œ ì •ë ¬
  patterns.sort((a, b) => a.start - b.start);
  
  console.log('ì°¾ì€ íŒ¨í„´ë“¤:', patterns);
  
  // 4. íŒ¨í„´ì— ë”°ë¼ ì²­í¬ ìƒì„±
  const chunks = [];
  let lastEnd = 0;
  
  patterns.forEach(pattern => {
    // íŒ¨í„´ ì‚¬ì´ì˜ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë³„ë„ ì²­í¬ë¡œ ì¶”ê°€
    if (pattern.start > lastEnd) {
      const betweenText = fullText.substring(lastEnd, pattern.start).trim();
      if (betweenText) {
        // í•´ë‹¹ í…ìŠ¤íŠ¸ì— ë§ëŠ” ë¸”ë¡ë“¤ ì°¾ê¸°
        const betweenBlocks = findBlocksForText(lineBlocks, betweenText, lastEnd, pattern.start);
        if (betweenBlocks.length > 0) {
          chunks.push(betweenBlocks);
        }
      }
    }
    
    // í˜„ì¬ íŒ¨í„´ì˜ ë¸”ë¡ë“¤ ì°¾ê¸°
    const patternBlocks = findBlocksForText(lineBlocks, pattern.text, pattern.start, pattern.end);
    if (patternBlocks.length > 0) {
      chunks.push(patternBlocks);
    }
    
    lastEnd = pattern.end;
  });
  
  // ë§ˆì§€ë§‰ ë‚¨ì€ í…ìŠ¤íŠ¸ ì²˜ë¦¬
  if (lastEnd < fullText.length) {
    const remainingText = fullText.substring(lastEnd).trim();
    if (remainingText) {
      const remainingBlocks = findBlocksForText(lineBlocks, remainingText, lastEnd, fullText.length);
      if (remainingBlocks.length > 0) {
        chunks.push(remainingBlocks);
      }
    }
  }
  
  return chunks;
}

// í…ìŠ¤íŠ¸ì— í•´ë‹¹í•˜ëŠ” ë¸”ë¡ë“¤ì„ ì°¾ëŠ” í—¬í¼ í•¨ìˆ˜
function findBlocksForText(lineBlocks, targetText, startPos, endPos) {
  const blocks = [];
  let currentPos = 0;
  let targetWords = targetText.replace(/\s+/g, ' ').trim().split(' ');
  let wordIndex = 0;
  
  for (let i = 0; i < lineBlocks.length && wordIndex < targetWords.length; i++) {
    const block = lineBlocks[i];
    const blockText = block.text.trim();
    
    if (blockText === targetWords[wordIndex] || 
        (blockText.includes(targetWords[wordIndex]) && targetWords[wordIndex].length > 2)) {
      blocks.push(block);
      wordIndex++;
    } else if (targetWords[wordIndex].includes(blockText) && blockText.length > 1) {
      blocks.push(block);
      // ë¶€ë¶„ ë§¤ì¹­ì¸ ê²½ìš° ë‹¤ìŒ ë‹¨ì–´ëŠ” ê±´ë„ˆë›°ì§€ ì•ŠìŒ
    }
  }
  
  return blocks;
}

// OCR í…ìŠ¤íŠ¸ ì¸ì‹ ìˆœì„œ ë¶„ì„ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „ - ì¢Œìƒë‹¨ì—ì„œ ìš°í•˜ë‹¨ ìˆœì„œ)
function analyzeOCRTextOrder(response) {
  console.log('=== OCR í…ìŠ¤íŠ¸ ì¸ì‹ ìˆœì„œ ë¶„ì„ (ê°œì„ ëœ ë²„ì „) ===');
  
 // ì´ ë¶€ë¶„ì„ ì™„ì „íˆ ì œê±°í•˜ê³  ë°”ë¡œ ì¢Œí‘œ ê¸°ë°˜ ì •ë ¬ë¡œ ë„˜ì–´ê°
console.log('ğŸ“ ì¢Œí‘œ ê¸°ë°˜ í…ìŠ¤íŠ¸ ì •ë ¬ ì‹œì‘...');
  
  // 2. textAnnotationsë¥¼ í†µí•œ ê°œë³„ í…ìŠ¤íŠ¸ ë¸”ë¡ ë¶„ì„ ë° ì •ë ¬
  if (response.textAnnotations && response.textAnnotations.length > 1) {
    console.log('\nğŸ” ê°œë³„ í…ìŠ¤íŠ¸ ë¸”ë¡ ì¢Œí‘œ ê¸°ë°˜ ì •ë ¬:');
    
    // ì²« ë²ˆì§¸ëŠ” ì „ì²´ í…ìŠ¤íŠ¸ì´ë¯€ë¡œ ì œì™¸í•˜ê³  ê°œë³„ ë‹¨ì–´ë“¤ë§Œ ë¶„ì„
    const textBlocks = response.textAnnotations.slice(1);
    
    // ì¢Œí‘œ ì •ë³´ê°€ ìˆëŠ” ë¸”ë¡ë“¤ë§Œ í•„í„°ë§í•˜ê³  ë³€í™˜
    const blocksWithCoords = textBlocks
      .filter(block => block.boundingPoly && block.boundingPoly.vertices)
      .map(block => ({
        text: block.description,
        x: block.boundingPoly.vertices[0].x || 0,
        y: block.boundingPoly.vertices[0].y || 0,
        width: (block.boundingPoly.vertices[2].x || 0) - (block.boundingPoly.vertices[0].x || 0),
        height: (block.boundingPoly.vertices[2].y || 0) - (block.boundingPoly.vertices[0].y || 0)
      }));
    
    console.log('\nğŸ“Š ëª¨ë“  í…ìŠ¤íŠ¸ ë¸”ë¡ì˜ ì¢Œí‘œ ì •ë³´:');
    blocksWithCoords.forEach((block, index) => {
      console.log(`${index + 1}: "${block.text}" -> (${block.x}, ${block.y})`);
    });
    
// Yì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ë˜, ê°™ì€ ì¤„(Yì¢Œí‘œ ì°¨ì´ê°€ 15í”½ì…€ ì´ë‚´)ì¸ ê²½ìš° Xì¢Œí‘œë¡œ ì •ë ¬
const sortedBlocks = blocksWithCoords
  .sort((a, b) => {
    // Yì¢Œí‘œ ì°¨ì´ê°€ 15í”½ì…€ ì´ë‚´ë©´ ê°™ì€ ì¤„ë¡œ ê°„ì£¼
    const yDiff = Math.abs(a.y - b.y);
    if (yDiff < 15) {
      return a.x - b.x; // ê°™ì€ ì¤„ì´ë©´ Xì¢Œí‘œë¡œ ì •ë ¬ (ì™¼ìª½ì—ì„œ ì˜¤ë¥¸ìª½)
    }
    return a.y - b.y; // ë‹¤ë¥¸ ì¤„ì´ë©´ Yì¢Œí‘œë¡œ ì •ë ¬ (ìœ„ì—ì„œ ì•„ë˜)
  });
    
    console.log('\nğŸ”„ ì •ë ¬ í›„ ë¸”ë¡ ìˆœì„œ:');
    sortedBlocks.forEach((block, index) => {
      console.log(`${index + 1}: "${block.text}" -> (${block.x}, ${block.y})`);
    });
    
    // ì •ë ¬ëœ ê²°ê³¼ë¥¼ ë¼ì¸ë³„ë¡œ ê·¸ë£¹í™”
    const organizedLines = [];
    let currentLine = [];
    let currentY = -1;
    
sortedBlocks.forEach((block, index) => {
  // Yì¢Œí‘œê°€ í¬ê²Œ ë³€í–ˆìœ¼ë©´ ìƒˆë¡œìš´ ì¤„ (15í”½ì…€ ê¸°ì¤€)
  if (Math.abs(block.y - currentY) > 15) {
    if (currentLine.length > 0) {
      organizedLines.push([...currentLine]);
    }
    currentLine = [block];
    currentY = block.y;
  } else {
    currentLine.push(block);
  }
});
    
    // ë§ˆì§€ë§‰ ì¤„ ì¶”ê°€
    if (currentLine.length > 0) {
      organizedLines.push(currentLine);
    }
    
    console.log('\nğŸ“ ì •ë ¬ëœ í…ìŠ¤íŠ¸ (ì¢Œìƒë‹¨ â†’ ìš°í•˜ë‹¨ ìˆœì„œ):');
    const sortedText = [];
    
// ë¼ì¸ ê²½ê³„ë¥¼ ë¬´ì‹œí•˜ê³  ì „ì²´ ë¸”ë¡ì—ì„œ íŒ¨í„´ ì¶”ì¶œ
const allBlocks = organizedLines.flat();
const globalPatterns = extractGlobalPatterns(allBlocks);

globalPatterns.forEach((pattern, index) => {
  console.log(`íŒ¨í„´ ${index + 1}: "${pattern.text}"`);
  sortedText.push(pattern.text);
});

// ê°œë³„ ë¸”ë¡ ì •ë³´ë„ ì¶œë ¥
allBlocks.forEach((block, blockIndex) => {
  console.log(`  ë¸”ë¡ ${blockIndex + 1}: "${block.text}" (${block.x}, ${block.y})`);
});

    // ì „ì²´ ë¸”ë¡ì—ì„œ ê¸€ë¡œë²Œ íŒ¨í„´ì„ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
function extractGlobalPatterns(allBlocks) {
  const fullText = allBlocks.map(block => block.text).join(' ');
  console.log(`ì „ì²´ í…ìŠ¤íŠ¸: "${fullText}"`);
  
  const patterns = [];
  let processedIndices = new Set();
  
  // íŒ¨í„´1: ë¶„ìˆ˜í˜•íƒœ ì°¾ê¸°
  const fractionMatches = [...fullText.matchAll(/([ê°€-í£\s]*?)(\d{1,3}(?:,\d{3})*)\s*\/\s*(\d{1,3}(?:,\d{3})*)\s*ë§Œì›/g)];
  fractionMatches.forEach(match => {
    const patternText = match[0].trim().replace(/\s+/g, '');
    patterns.push({
      text: patternText,
      originalMatch: match[0],
      type: 'fraction'
    });
  });
  
  // íŒ¨í„´2: ë¶€ì¡±í˜•íƒœ ì°¾ê¸°
  const deficitMatches = [...fullText.matchAll(/(\d{1,3}(?:,\d{3})*)\s*ë§Œì›\s*ë¶€ì¡±/g)];
  deficitMatches.forEach(match => {
    const patternText = match[0].trim().replace(/\s+/g, '');
    patterns.push({
      text: patternText,
      originalMatch: match[0], 
      type: 'deficit'
    });
  });
  
  // íŒ¨í„´3: ë‹¨ìˆœí˜•íƒœ ì°¾ê¸°
  const simpleMatches = [...fullText.matchAll(/([ê°€-í£\s]*?)(\d{1,3}(?:,\d{3})*)\s*ë§Œì›(?!\s*[\/ë¶€ì¡±])/g)];
  simpleMatches.forEach(match => {
    // ì´ë¯¸ ë¶„ìˆ˜ë‚˜ ë¶€ì¡± íŒ¨í„´ì— í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ
    const isAlreadyMatched = patterns.some(p => p.originalMatch.includes(match[0]));
    if (!isAlreadyMatched) {
      const patternText = match[0].trim().replace(/\s+/g, '');
      patterns.push({
        text: patternText,
        originalMatch: match[0],
        type: 'simple'
      });
    }
  });
  
  return patterns;
}


    
    
    // ì •ë ¬ëœ í…ìŠ¤íŠ¸ë¥¼ ì „ì²´ í…ìŠ¤íŠ¸ë¡œ ê²°í•©
    const organizedFullText = sortedText.join('\n');
    console.log('\nğŸ“‹ ìµœì¢… ì •ë ¬ëœ ì „ì²´ í…ìŠ¤íŠ¸:');
    console.log(organizedFullText);
    
    console.log('=== OCR ë¶„ì„ ì™„ë£Œ ===\n');
    
    // ì •ë ¬ëœ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜
    return organizedFullText;
  }
  
console.log('=== OCR ë¶„ì„ ì™„ë£Œ (fallback) ===\n');
return ''; // ì¢Œí‘œ ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¹ˆ í…ìŠ¤íŠ¸ ë°˜í™˜
}

// ê³ ê° ì •ë³´ ì¶”ì¶œ
function extractCustomerInfo(text) {
  const namePatterns = [
    /([ê°€-í£]{2,4})ë‹˜ì˜\s*í•œ\s*ì¥\s*ìš”ì•½\s*ë³´ì¥ë¶„ì„/,
    /^([ê°€-í£]{2,4})ë‹˜/m,
    /ì„±ëª…[:\s]*([ê°€-í£]{2,4})/,
    /ê³ ê°ëª…[:\s]*([ê°€-í£]{2,4})/
  ];

  for (const pattern of namePatterns) {
    const match = text.match(pattern);
    if (match) {
      document.getElementById('customerName').value = match[1];
      console.log(`ê³ ê°ëª… ì¶”ì¶œ ì„±ê³µ: ${match[1]}`);
      break;
    }
  }

  const birthPatterns = [
    /ìƒë…„ì›”ì¼\s*(\d{2}-\d{1,2}-\d{1,2})/,
    /ìƒë…„ì›”ì¼\s*(\d{4}-\d{1,2}-\d{1,2})/,
    /ìƒë…„ì›”ì¼\s*(\d{2}\.\d{1,2}\.\d{1,2})/
  ];

  for (const pattern of birthPatterns) {
    const match = text.match(pattern);
    if (match) {
      let date = match[1];
      if (date.includes('.')) {
        date = date.replace(/\./g, '-');
      }
      if (date.length > 8) {
        const parts = date.split('-');
        if (parts[0].length === 4) {
          date = `${parts[0].slice(2)}-${parts[1]}-${parts[2]}`;
        }
      }
      document.getElementById('birthDate').value = date;
      console.log(`ìƒë…„ì›”ì¼ ì¶”ì¶œ ì„±ê³µ: ${date}`);
      break;
    }
  }
}

// ê°œì„ ëœ OCR ë‹´ë³´ ê¸ˆì•¡ ì¶”ì¶œ (êµ¬ì¡°í™”ëœ íŒ¨í„´ ì¸ì‹)
function extractCoverageAmountsForBeforeAfter(text) {
  console.log('ê°œì„ ëœ OCR ë‹´ë³´ ê¸ˆì•¡ ì¶”ì¶œ ì‹œì‘...');
  
  // 1ë‹¨ê³„: "ë¶€ì¡±" í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë¼ì¸ë“¤ì„ ì™„ì „íˆ ì œê±°
  const cleanedText = removeDeficitLines(text);
  console.log('ë¶€ì¡± ë¼ì¸ ì œê±° í›„:', cleanedText);
  
  // ì •í™•í•œ ë§¤í•‘ í…Œì´ë¸” (ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ì™€ ì½”ë“œ ë§¤í•‘)
  const coverageMappings = [
    // ì•” ì„¹ì…˜
    { imageText: 'ì¼ë°˜ì•”', codeKey: 'generalCancer', type: 'fraction' },
    { imageText: 'í†µí•©ì•”', codeKey: 'totalCancer', type: 'fraction' },
    { imageText: 'í‘œì í•­ì•”ì•½ë¬¼', codeKey: 'targetTherapy', type: 'fraction' },
    
    // 2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜ ì„¹ì…˜
    { imageText: 'ë‡Œí˜ˆê´€ì§ˆí™˜', codeKey: 'cerebrovascularDiagnosis', type: 'fraction' },
    { imageText: 'ë‡Œì¡¸ì¤‘', codeKey: 'strokeDiagnosis', type: 'fraction' },
    { imageText: 'í—ˆí˜ˆì„±ì‹¬ì§ˆí™˜', codeKey: 'ischemicHeartDiagnosis', type: 'fraction' },
    { imageText: 'ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰ì¦', codeKey: 'myocardialInfarctionDiagnosis', type: 'fraction' },
    
    // 5ëŒ€ í•„ìˆ˜ë³´í—˜ ì„¹ì…˜ (ì¼ë°˜ êµ¬ì¡°)
    { imageText: 'ì§ˆë³‘ì…ì› ì‹¤ì†', codeKey: 'diseaseHospitalization', type: 'fraction' },
    { imageText: 'ìƒí•´ì…ì›ì‹¤ì†', codeKey: 'injuryHospitalization', type: 'fraction' },
    { imageText: 'ê°„ë³‘ì¸ì§ˆë³‘ì…ì›', codeKey: 'nursingHospitalOut', type: 'fraction' },
    
    // 5ëŒ€ í•„ìˆ˜ë³´í—˜ ì„¹ì…˜ (íŠ¹ìˆ˜ êµ¬ì¡° - Aë§Œì› í˜•íƒœ)
    { imageText: 'í˜•ì‚¬í•©ì˜ì§€ì›ê¸ˆ', codeKey: 'criminalSettlement', type: 'simple' },
    { imageText: 'ë³€í˜¸ì‚¬ì„ ì„ë¹„ìš©', codeKey: 'lawyerAppointment', type: 'simple' },
    { imageText: 'í™”ì¬ë²Œê¸ˆ', codeKey: 'fireFine', type: 'simple' },
    { imageText: 'ì¼ìƒìƒí™œë°°ìƒì±…ì„', codeKey: 'dailyLifeLiability', type: 'simple' }
  ];
  
  // 2ë‹¨ê³„: êµ¬ì¡°í™”ëœ ë°ì´í„° ì¶”ì¶œ (íŒ¨í„´ë³„ ë¶„ë¦¬)
  const structuredData = extractStructuredDataByPattern(cleanedText);
  console.log('êµ¬ì¡°í™”ëœ ë°ì´í„°:', structuredData);
  
  // 3ë‹¨ê³„: ë§¤í•‘ í…Œì´ë¸”ê³¼ ë§¤ì¹­í•˜ì—¬ ê°’ ì„¤ì •
  coverageMappings.forEach(mapping => {
    const matchedData = findMatchingDataByPattern(structuredData, mapping.imageText, mapping.type);
    
    if (matchedData) {
      const extractedValue = matchedData.value;
      console.log(`${mapping.imageText}: ${extractedValue}ë§Œì› ì¶”ì¶œ (íŒ¨í„´: ${mapping.type})`);
      
      // ë³€ê²½ ì „ê³¼ ë³€ê²½ í›„ ëª¨ë‘ì— ê°’ ì„¤ì •
      const beforeInput = document.getElementById(mapping.codeKey + '_before');
      const afterInput = document.getElementById(mapping.codeKey + '_after');
      
      if (extractedValue === 0) {
        if (beforeInput) beforeInput.value = '';
        if (afterInput) afterInput.value = '';
        console.log(`${mapping.codeKey}: 0ê°’ìœ¼ë¡œ ì¸ì‹ - ë¹ˆ ê°’ ì„¤ì •`);
      } else {
        if (beforeInput) {
          beforeInput.value = extractedValue.toLocaleString() + 'ë§Œì›';
          console.log(`${mapping.codeKey}_beforeì— ${extractedValue}ë§Œì› ì„¤ì •`);
        }
        
        if (afterInput) {
          afterInput.value = extractedValue.toLocaleString() + 'ë§Œì›';
          console.log(`${mapping.codeKey}_afterì— ${extractedValue}ë§Œì› ì„¤ì •`);
        }
      }
    } else {
      console.log(`${mapping.imageText}: ë§¤ì¹­ë˜ëŠ” ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
    }
  });
  
  // OCR ì™„ë£Œ í›„ ìë™ê³„ì‚° íŠ¸ë¦¬ê±°
  setTimeout(() => {
    handleMajorCirculatoryCalculation('before');
    handleMajorCirculatoryCalculation('after');
  }, 100);
}

// ë‹´ë³´ëª… ë¶„ë¦¬ í•¨ìˆ˜
function separateCoverageNames(line) {
  const cleanLine = line.trim();
  
  // ì¼ë°˜ì ì¸ ë‹´ë³´ëª… íŒ¨í„´ë“¤
  const coveragePatterns = [
    'ì¼ë°˜ì•”', 'í†µí•©ì•”', 'ì „ì´ì•”', 'í‘œì í•­ì•”', 'ë‡Œí˜ˆê´€', 'ë‡Œì¡¸ì¤‘', 
    'í—ˆí˜ˆì„±', 'ì‹¬ê·¼ê²½ìƒ‰', 'ì§ˆë³‘ì…ì›', 'ìƒí•´ì…ì›', 'í˜•ì‚¬í•©ì˜', 
    'ë³€í˜¸ì‚¬ì„ ì„', 'í™”ì¬ë²Œê¸ˆ', 'ì¼ìƒìƒí™œë°°ìƒ', 'ê°„ë³‘ì¸'
  ];
  
  const foundNames = [];
  let remainingText = cleanLine;
  
  // ê° íŒ¨í„´ì„ ì°¾ì•„ì„œ ë¶„ë¦¬
  for (const pattern of coveragePatterns) {
    if (remainingText.includes(pattern)) {
      foundNames.push(pattern);
      remainingText = remainingText.replace(pattern, '').trim();
    }
  }
  
  // ì°¾ì€ ê²ƒì´ ì—†ìœ¼ë©´ ì›ë³¸ ë¼ì¸ì„ ë°˜í™˜
  return foundNames.length > 0 ? foundNames : [cleanLine];
}

// ì•ìª½ ë¼ì¸ë“¤ì—ì„œ ëª¨ë“  ë¶„ìˆ˜ ê°’ë“¤ì„ ë¯¸ë¦¬ ì°¾ëŠ” í•¨ìˆ˜
function findAllFractionValuesAhead(lines, currentIndex, processedLines) {
  const values = [];
  
  // ë‹¤ìŒ ë¼ì¸ë¶€í„° ìµœëŒ€ 5ë¼ì¸ê¹Œì§€ ê²€ì‚¬
  for (let i = currentIndex + 1; i < Math.min(lines.length, currentIndex + 6); i++) {
    const line = lines[i];
    
    // ì´ë¯¸ ì²˜ë¦¬ëœ ë¼ì¸ì´ê±°ë‚˜ ìƒˆë¡œìš´ ë‹´ë³´ëª…ì´ ë‚˜ì˜¤ë©´ ì¤‘ë‹¨
    if (processedLines.has(i) || isCoverageNameLine(line)) {
      break;
    }
    
    // "ë¶€ì¡±" ë¼ì¸ì€ ê±´ë„ˆë›°ê¸°
    if (line.includes('ë¶€ì¡±')) {
      continue;
    }
    
    // A / Bë§Œì› íŒ¨í„´ ë§¤ì¹­
    const fractionMatch = line.match(/(\d{1,3}(?:,\d{3})*)\s*\/\s*(\d{1,3}(?:,\d{3})*)ë§Œì›/);
    
    if (fractionMatch) {
      const valueA = parseInt(fractionMatch[1].replace(/,/g, ''));
      const valueB = parseInt(fractionMatch[2].replace(/,/g, ''));
      
      values.push({
        valueA: valueA,
        valueB: valueB,
        rawLine: line,
        lineIndex: i
      });
    }
  }
  
  return values;
}

// ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
function isDataAlreadyExists(structuredData, coverageName) {
  return structuredData.some(data => {
    const normalizedDataName = data.name.toLowerCase().replace(/\s+/g, '');
    const normalizedCoverageName = coverageName.toLowerCase().replace(/\s+/g, '');
    return normalizedDataName.includes(normalizedCoverageName) || 
           normalizedCoverageName.includes(normalizedDataName);
  });
}

// íŒ¨í„´ë³„ êµ¬ì¡°í™”ëœ ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜ (ìˆœì„œ ë³´ì¥ ê°œì„ )
function extractStructuredDataByPattern(text) {
  const lines = text.split(/\r?\n/)
    .map(line => line.trim())
    .filter(line => line.length > 0);
  
  const structuredData = [];
  const processedLines = new Set(); // ì´ë¯¸ ì²˜ë¦¬ëœ ë¼ì¸ ì¶”ì 
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    // ì´ë¯¸ ì²˜ë¦¬ëœ ë¼ì¸ì€ ê±´ë„ˆë›°ê¸°
    if (processedLines.has(i)) continue;
    
    // íŒ¨í„´ 1: í•œ ë¼ì¸ì— ë‹´ë³´ëª…ê³¼ ê°’ì´ ëª¨ë‘ ìˆëŠ” ê²½ìš° (ìš°ì„  ì²˜ë¦¬)
    const inlineData = extractInlinePattern(line);
    if (inlineData) {
      structuredData.push(inlineData);
      console.log(`ì¸ë¼ì¸ íŒ¨í„´ ì¶”ì¶œ: ${line} -> ${inlineData.value}`);
      processedLines.add(i);
      continue;
    }
    
    // íŒ¨í„´ 2: ë‹´ë³´ëª…ì´ ë³„ë„ ë¼ì¸ì— ìˆëŠ” ê²½ìš°
    if (isCoverageNameLine(line)) {
      console.log(`ë‹´ë³´ëª… í›„ë³´ ë°œê²¬: "${line}"`);
      
      // ê°œë³„ ë‹´ë³´ëª… ë¶„ë¦¬ ì²˜ë¦¬
      const separatedNames = separateCoverageNames(line);
      
      if (separatedNames.length > 1) {
        // ì—¬ëŸ¬ ë‹´ë³´ëª…ì´ ì—°ì†ìœ¼ë¡œ ìˆëŠ” ê²½ìš° ê°œë³„ ì²˜ë¦¬
        console.log(`ì—¬ëŸ¬ ë‹´ë³´ëª… ë°œê²¬: ${separatedNames.join(', ')}`);
        
        // ë‹¤ìŒ ë¼ì¸ë“¤ì—ì„œ ë¶„ìˆ˜ íŒ¨í„´ë“¤ì„ ë¯¸ë¦¬ ì°¾ê¸°
        const availableValues = findAllFractionValuesAhead(lines, i, processedLines);
        console.log(`ì‚¬ìš© ê°€ëŠ¥í•œ ê°’ë“¤: ${JSON.stringify(availableValues)}`);
        
        for (let nameIndex = 0; nameIndex < separatedNames.length; nameIndex++) {
          const coverageName = separatedNames[nameIndex];
          
          if (nameIndex < availableValues.length && !isDataAlreadyExists(structuredData, coverageName)) {
            const valueData = availableValues[nameIndex];
            const fractionData = {
              name: coverageName,
              value: valueData.valueA,
              pattern: 'fraction',
              rawLine: valueData.rawLine,
              usedLineIndex: valueData.lineIndex
            };
            
            structuredData.push(fractionData);
            console.log(`ë¶„ë¦¬ëœ ë‹´ë³´ íŒ¨í„´ ì¶”ì¶œ: ${coverageName} -> ${fractionData.value}`);
            
            // ì‚¬ìš©ëœ ë¼ì¸ ë§ˆí‚¹
            processedLines.add(valueData.lineIndex);
          }
        }
        
        // ì²˜ë¦¬ëœ ë¼ì¸ ë§ˆí‚¹
        processedLines.add(i);
        continue;
      } else {
        // ë‹¨ì¼ ë‹´ë³´ëª…ì¸ ê²½ìš° ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
        const fractionData = extractFractionPatternSequential(lines, i, line, processedLines);
        if (fractionData) {
          structuredData.push(fractionData);
          console.log(`ìˆœì°¨ ë¶„ìˆ˜ íŒ¨í„´ ì¶”ì¶œ: ${line} -> ${fractionData.value}`);
          // ì‚¬ìš©ëœ ë¼ì¸ë“¤ì„ processedLinesì— ì¶”ê°€
          for (let j = i + 1; j <= fractionData.usedLineIndex; j++) {
            processedLines.add(j);
          }
          continue;
        }
        
        // ë‹¨ìˆœ íŒ¨í„´
        const simpleData = extractSimplePatternSequential(lines, i, line, processedLines);
        if (simpleData) {
          structuredData.push(simpleData);
          console.log(`ìˆœì°¨ ë‹¨ìˆœ íŒ¨í„´ ì¶”ì¶œ: ${line} -> ${simpleData.value}`);
          for (let j = i + 1; j <= simpleData.usedLineIndex; j++) {
            processedLines.add(j);
          }
          continue;
        }
      }
    }
  }
  
  return structuredData;
}

// ìˆœì°¨ì  ë¶„ìˆ˜ íŒ¨í„´ ì¶”ì¶œ (ê°€ì¥ ê°€ê¹Œìš´ ê°’ ìš°ì„ )
function extractFractionPatternSequential(lines, currentIndex, coverageName, processedLines) {
  // ë‹¤ìŒ ë¼ì¸ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ê²€ì‚¬ (ìµœëŒ€ 3ë¼ì¸ê¹Œì§€)
  for (let i = 1; i <= 3 && currentIndex + i < lines.length; i++) {
    const targetLineIndex = currentIndex + i;
    const targetLine = lines[targetLineIndex];
    
    // ì´ë¯¸ ì²˜ë¦¬ëœ ë¼ì¸ì´ê±°ë‚˜ ë‹¤ë¥¸ ë‹´ë³´ëª…ì´ ë‚˜ì˜¤ë©´ ì¤‘ë‹¨
    if (processedLines.has(targetLineIndex) || isCoverageNameLine(targetLine)) {
      break;
    }
    
    // "ë¶€ì¡±" ë¼ì¸ì€ ê±´ë„ˆë›°ê¸°
    if (targetLine.includes('ë¶€ì¡±')) {
      continue;
    }
    
    // A / Bë§Œì› íŒ¨í„´ ë§¤ì¹­ (ê³µë°± í—ˆìš©)
    const fractionMatch = targetLine.match(/(\d{1,3}(?:,\d{3})*)\s*\/\s*(\d{1,3}(?:,\d{3})*)ë§Œì›/);
    
    if (fractionMatch) {
      const valueA = parseInt(fractionMatch[1].replace(/,/g, ''));
      const valueB = parseInt(fractionMatch[2].replace(/,/g, ''));
      
      console.log(`ìˆœì°¨ ë¶„ìˆ˜ íŒ¨í„´ ë°œê²¬: "${coverageName}" + "${targetLine}" -> A=${valueA}, B=${valueB}`);
      
      // ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ë¶„ìˆ˜ íŒ¨í„´ì„ ì¦‰ì‹œ ë°˜í™˜ (ê°€ì¥ ê°€ê¹Œìš´ ê°’ ìš°ì„ )
      return {
        name: coverageName,
        value: valueA, // A ê°’ì„ ì¶”ì¶œ
        pattern: 'fraction',
        rawLine: targetLine,
        usedLineIndex: targetLineIndex
      };
    }
  }
  
  return null;
}

// ìˆœì°¨ì  ë‹¨ìˆœ íŒ¨í„´ ì¶”ì¶œ
function extractSimplePatternSequential(lines, currentIndex, coverageName, processedLines) {
  // íŠ¹ìˆ˜ í•­ëª©ë“¤ë§Œ ì²´í¬
  const specialItems = ['í˜•ì‚¬í•©ì˜ì§€ì›ê¸ˆ', 'ë³€í˜¸ì‚¬ì„ ì„ë¹„ìš©', 'í™”ì¬ë²Œê¸ˆ', 'ì¼ìƒìƒí™œë°°ìƒì±…ì„'];
  const isSpecialItem = specialItems.some(item => coverageName.includes(item));
  
  if (!isSpecialItem) {
    return null;
  }
  
  // ë‹¤ìŒ ë¼ì¸ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ê²€ì‚¬
  for (let i = 1; i <= 3 && currentIndex + i < lines.length; i++) {
    const targetLineIndex = currentIndex + i;
    const targetLine = lines[targetLineIndex];
    
    // ì´ë¯¸ ì²˜ë¦¬ëœ ë¼ì¸ì´ê±°ë‚˜ ë‹¤ë¥¸ ë‹´ë³´ëª…ì´ ë‚˜ì˜¤ë©´ ì¤‘ë‹¨
    if (processedLines.has(targetLineIndex) || isCoverageNameLine(targetLine)) {
      break;
    }
    
    // Aë§Œì› íŒ¨í„´ ë§¤ì¹­ (ë¶„ìˆ˜ê°€ ì•„ë‹Œ ë‹¨ìˆœ í˜•íƒœ)
    const simpleMatch = targetLine.match(/(?<!\/\s*)(\d{1,3}(?:,\d{3})*)ë§Œì›(?!\s*\/)/);
    
    if (simpleMatch) {
      const value = parseInt(simpleMatch[1].replace(/,/g, ''));
      
      console.log(`ìˆœì°¨ ë‹¨ìˆœ íŒ¨í„´ ë°œê²¬: "${coverageName}" + "${targetLine}" -> ${value}`);
      
      return {
        name: coverageName,
        value: value,
        pattern: 'simple',
        rawLine: targetLine,
        usedLineIndex: targetLineIndex
      };
    }
  }
  
  return null;
}

// ì¸ë¼ì¸ íŒ¨í„´ ì¶”ì¶œ (ë‹´ë³´ëª…ê³¼ ê°’ì´ í•œ ë¼ì¸ì— ìˆëŠ” ê²½ìš°)
function extractInlinePattern(line) {
  console.log(`ì¸ë¼ì¸ íŒ¨í„´ ê²€ì‚¬: "${line}"`);
  
  // ì—¬ëŸ¬ ë‹´ë³´ í•­ëª©ì´ í•œ ì¤„ì— ìˆëŠ” ê²½ìš° ê°œë³„ ì²˜ë¦¬
  const multipleItemsMatch = line.match(/([ê°€-í£\s]+?)\s+(\d{1,3}(?:,\d{3})*)\s*\/\s*(\d{1,3}(?:,\d{3})*)ë§Œì›/g);
  if (multipleItemsMatch && multipleItemsMatch.length > 0) {
    console.log(`ë‹¤ì¤‘ ì¸ë¼ì¸ íŒ¨í„´ ë°œê²¬: ${multipleItemsMatch.length}ê°œ í•­ëª©`);
    
    // ì²« ë²ˆì§¸ ë§¤ì¹­ëœ í•­ëª©ë§Œ ë°˜í™˜ (ë‚˜ë¨¸ì§€ëŠ” ë³„ë„ë¡œ ì²˜ë¦¬ë  ì˜ˆì •)
    const firstMatch = line.match(/([ê°€-í£\s]+?)\s+(\d{1,3}(?:,\d{3})*)\s*\/\s*(\d{1,3}(?:,\d{3})*)ë§Œì›/);
    if (firstMatch) {
      const coverageName = firstMatch[1].trim();
      const valueA = parseInt(firstMatch[2].replace(/,/g, ''));
      
      console.log(`ì²« ë²ˆì§¸ ì¸ë¼ì¸ ë¶„ìˆ˜ íŒ¨í„´: "${coverageName}" -> ${valueA}`);
      
      return {
        name: coverageName,
        value: valueA,
        pattern: 'inline_fraction',
        rawLine: line
      };
    }
  }
  
  // ë‹¨ì¼ ë‹´ë³´ëª… + ë¶„ìˆ˜ íŒ¨í„´ (ì˜ˆ: "ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰ì¦ 1,000/3,000ë§Œì›")
  const inlineFractionMatch = line.match(/^([ê°€-í£\s]+?)\s+(\d{1,3}(?:,\d{3})*)\s*\/\s*(\d{1,3}(?:,\d{3})*)ë§Œì›/);
  if (inlineFractionMatch) {
const coverageName = inlineFractionMatch[1].trim().replace(/\s+/g, '');
    const valueA = parseInt(inlineFractionMatch[2].replace(/,/g, ''));
    const valueB = parseInt(inlineFractionMatch[3].replace(/,/g, ''));
    
    console.log(`ì¸ë¼ì¸ ë¶„ìˆ˜ íŒ¨í„´ ë°œê²¬: "${coverageName}" -> A=${valueA}, B=${valueB}`);
    
    return {
      name: coverageName,
      value: valueA, // A ê°’ì„ ì¶”ì¶œ
      pattern: 'inline_fraction',
      rawLine: line
    };
  }
  
  // íŠ¹ìˆ˜ í•­ëª©ë“¤ì˜ ë‹¨ìˆœ íŒ¨í„´ (ì˜ˆ: "í˜•ì‚¬í•©ì˜ì§€ì›ê¸ˆ 20,000ë§Œì›")
  const inlineSimpleMatch = line.match(/([ê°€-í£\s]+?)\s+(\d{1,3}(?:,\d{3})*)ë§Œì›(?!\s*\/)/);
  if (inlineSimpleMatch) {
    const coverageName = inlineSimpleMatch[1].trim();
    const value = parseInt(inlineSimpleMatch[2].replace(/,/g, ''));
    
    // íŠ¹ìˆ˜ í•­ëª©ë“¤ë§Œ ë‹¨ìˆœ íŒ¨í„´ í—ˆìš©
    const specialItems = ['ëŒ€ì¸í˜•ì‚¬í•©ì˜ì§€ì›ê¸ˆ', 'ë³€í˜¸ì‚¬ì„ ì„ë¹„ìš©', 'í™”ì¬ë²Œê¸ˆ', 'ì¼ìƒìƒí™œë°°ìƒì±…ì„'];
    const isSpecialItem = specialItems.some(item => coverageName.includes(item.replace('ëŒ€ì¸í˜•ì‚¬í•©ì˜ì§€ì›ê¸ˆ', 'í˜•ì‚¬')) || item.includes(coverageName));
    
    if (isSpecialItem) {
      console.log(`ì¸ë¼ì¸ ë‹¨ìˆœ íŒ¨í„´ ë°œê²¬: "${coverageName}" -> ${value}`);
      
      return {
        name: coverageName,
        value: value,
        pattern: 'inline_simple',
        rawLine: line
      };
    }
  }
  
  return null;
}

// íŒ¨í„´ë³„ ë§¤ì¹­ ë°ì´í„° ì°¾ê¸° (ì •í™•í•œ ë§¤ì¹­ ìš°ì„ )
function findMatchingDataByPattern(structuredData, targetText, expectedPattern) {
  console.log(`ë§¤ì¹­ ì‹œë„: "${targetText}" (íŒ¨í„´: ${expectedPattern})`);
  
  // 1ë‹¨ê³„: ì™„ì „ ì¼ì¹˜ ìš°ì„ 
  let match = structuredData.find(data => {
    const normalizedName = data.name.toLowerCase().replace(/\s+/g, '');
    const normalizedTarget = targetText.toLowerCase().replace(/\s+/g, '');
    return normalizedName === normalizedTarget && 
           (expectedPattern === 'any' || data.pattern === expectedPattern || 
            data.pattern.includes(expectedPattern.replace('fraction', '')));
  });
  
  if (match) {
    console.log(`ì™„ì „ ì¼ì¹˜ ë°œê²¬: "${match.name}" -> ${match.value} (íŒ¨í„´: ${match.pattern})`);
    return match;
  }
  
  // 2ë‹¨ê³„: ì •í™•í•œ ë‹¨ì–´ í¬í•¨ ë§¤ì¹­ (ì „ì²´ íƒ€ê²Ÿ ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ì•¼ í•¨)
  match = structuredData.find(data => {
    const normalizedName = data.name.toLowerCase().replace(/\s+/g, '');
    const normalizedTarget = targetText.toLowerCase().replace(/\s+/g, '');
    // íƒ€ê²Ÿ ì „ì²´ê°€ ë°ì´í„°ëª…ì— í¬í•¨ë˜ì–´ì•¼ í•˜ê³ , íƒ€ê²Ÿì´ ì¶©ë¶„íˆ êµ¬ì²´ì ì´ì–´ì•¼ í•¨
    return normalizedName.includes(normalizedTarget) && 
           normalizedTarget.length >= 3 && // ìµœì†Œ 3ê¸€ì ì´ìƒìœ¼ë¡œ ë³€ê²½
           (expectedPattern === 'any' || data.pattern === expectedPattern || 
            data.pattern.includes(expectedPattern.replace('fraction', '')));
  });
  
  if (match) {
    console.log(`ì •í™•í•œ í¬í•¨ ë§¤ì¹­ ë°œê²¬: "${match.name}" -> ${match.value} (íŒ¨í„´: ${match.pattern})`);
    return match;
  }
  
  // 3ë‹¨ê³„: ë°ì´í„°ëª…ì´ íƒ€ê²Ÿì— í¬í•¨ë˜ëŠ” ê²½ìš°ë§Œ í—ˆìš© (ì—­ë°©í–¥ í¬í•¨ ì œê±°)
  match = structuredData.find(data => {
    const normalizedName = data.name.toLowerCase().replace(/\s+/g, '');
    const normalizedTarget = targetText.toLowerCase().replace(/\s+/g, '');
    // "ë‡Œì¡¸ì¤‘"ì´ "ë‡Œí˜ˆê´€ì§ˆí™˜"ì— ì˜ëª» ë§¤ì¹­ë˜ëŠ” ê²ƒì„ ë°©ì§€
    return normalizedTarget.includes(normalizedName) &&
           normalizedName.length >= 3 && // ë°ì´í„°ëª…ë„ ì¶©ë¶„íˆ êµ¬ì²´ì ì´ì–´ì•¼ í•¨
           (expectedPattern === 'any' || data.pattern === expectedPattern || 
            data.pattern.includes(expectedPattern.replace('fraction', '')));
  });
  
  if (match) {
    console.log(`ì—­ë°©í–¥ í¬í•¨ ë§¤ì¹­ ë°œê²¬: "${match.name}" -> ${match.value} (íŒ¨í„´: ${match.pattern})`);
    return match;
  }
  
  console.log(`ë§¤ì¹­ ì‹¤íŒ¨: "${targetText}"`);
  return null;
}

// "ë¶€ì¡±" í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë¼ì¸ë“¤ì„ ì™„ì „íˆ ì œê±°í•˜ëŠ” í•¨ìˆ˜
function removeDeficitLines(text) {
  const lines = text.split(/\r?\n/);
  const cleanedLines = lines.filter(line => {
    const trimmedLine = line.trim();
    // "ë¶€ì¡±" í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë¼ì¸ì„ ì™„ì „íˆ ì œê±°
    return !trimmedLine.includes('ë¶€ì¡±');
  });
  
  return cleanedLines.join('\n');
}

// ë‹´ë³´ëª… ë¼ì¸ì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
function isCoverageNameLine(line) {
  // ë‹´ë³´ëª… íŒ¨í„´ì„ ë” ì •í™•í•˜ê²Œ ì¸ì‹
  const hasKorean = /[ê°€-í£]/.test(line);
  const hasNumbers = /\d/.test(line);
  const hasWon = line.includes('ë§Œì›');
  const hasSlash = line.includes('/');

  // ë‹´ë³´ëª… í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš°ë„ ë‹´ë³´ëª…ìœ¼ë¡œ ì¸ì‹
  const coverageKeywords = ['ì•”', 'ì§ˆí™˜', 'ì¹˜ë§¤', 'ì‚¬ë§', 'ì…ì›', 'ìˆ˜ìˆ ', 'í›„ìœ ', 'ì‹¤ì†', 'ê°„ë³‘', 'í˜•ì‚¬', 'ë³€í˜¸ì‚¬', 'ë²Œê¸ˆ', 'ë°°ìƒ'];
  const hasCoverageKeyword = coverageKeywords.some(keyword => line.includes(keyword));

  return hasKorean && (hasCoverageKeyword || (!hasNumbers && !hasWon && !hasSlash)) && line.length >= 2;
}

// ë°ì´í„° ì €ì¥ ë° ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
async function saveAndDownloadImage() {
  const customerName = document.getElementById('customerName').value.trim();
  
  if (!customerName) {
    alert('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  currentData = {
    customerName: customerName,
    birthDate: document.getElementById('birthDate').value.trim(),
    inputDate: new Date().toLocaleString('ko-KR'),
    coverages_before: {},
    coverages_after: {},
    caregiverOption: document.querySelector('input[name="caregiverOption"]:checked').value
  };
  
  const allFields = [
    ...ALL_COVERAGE_ITEMS,
    { key: 'nursingHospitalOut', name: 'ìš”ì–‘ë³‘ì› ì™¸' },
    { key: 'nursingHospitalIn', name: 'ìš”ì–‘ë³‘ì›' },
    { key: 'nursingCareIntegrated', name: 'ê°„í˜¸ê°„ë³‘í†µí•©' }
  ];
  
  allFields.forEach(item => {
    const beforeInput = document.getElementById(item.key + '_before');
    const afterInput = document.getElementById(item.key + '_after');
    
    if (beforeInput && beforeInput.value.trim()) {
      currentData.coverages_before[item.key] = {
        name: item.name,
        value: beforeInput.value.trim()
      };
    }
    
    if (afterInput && afterInput.value.trim()) {
      currentData.coverages_after[item.key] = {
        name: item.name,
        value: afterInput.value.trim()
      };
    }
  });
  
  saveDataToStorage(currentData);
  await generateAndDownloadImage(currentData);
  
  alert('ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// í‘œì¤€ê¸ˆì•¡ ëŒ€ë¹„ ì§„í–‰ë¥  ê³„ì‚°
function calculateProgressPercentage(currentValue, standardAmount) {
  if (!currentValue || currentValue == 0 || !standardAmount) return 0;
  return (parseInt(currentValue) / standardAmount) * 100;
}

// ì´ë¯¸ì§€ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
async function generateAndDownloadImage(data) {
  const container = document.getElementById('hiddenPrintContainer');
  
  container.innerHTML = `
   <div style="background: white; padding: 50px; width: auto; min-width: 5000px; height: auto; min-height: 2000px; font-family: 'Noto Sans KR', Arial, sans-serif; overflow: visible;">
      <style>
        .main-title {
          text-align: center;
          font-size: 140px;
          font-weight: 900;
          margin-bottom: 30px;
          color: white;
          padding: 25px 40px;
          background: linear-gradient(135deg, #ff6600, #ff8f00);
          border-radius: 20px;
          text-shadow: 0 3px 6px rgba(0,0,0,0.2);
          box-shadow: 0 8px 24px rgba(255,102,0,0.3);
        }
        .print-container {
          display: flex;
          gap: 40px;
          height: calc(100% - 140px);
          flex-direction: column;
          align-items: stretch;
        }
        .main-sections-container {
          display: flex;
          gap: 40px;
          flex: 1;
        }
        .comparison-section {
          flex: 1;
          display: flex;
          flex-direction: column;
        }
        .section-header {
          text-align: center;
          font-size: 80px;
          font-weight: 800;
          margin-bottom: 25px;
          padding: 20px;
          border-radius: 16px;
          text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .before-header {
          color: #444;
          background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
          border: 3px solid #999;
        }
        .after-header {
          color: #1565C0;
          background: linear-gradient(135deg, #E8F4FD, #D1E7DD);
          border: 3px solid #1976D2;
        }
        .sections-container {
          display: flex;
          gap: 25px;
          justify-content: center;
          flex: 1;
        }
        .section {
          width: 800px;
          border-radius: 16px;
          padding: 20px;
          overflow-y: auto;
        }
        .before-sections .section {
          border: 3px solid #999;
          background: linear-gradient(135deg, #fafafa, #f5f5f5);
          box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .after-sections .section {
          border: 3px solid #1976D2;
          background: linear-gradient(135deg, #E8F5FF, #F0F9FF);
          box-shadow: 0 6px 18px rgba(25,118,210,0.25);
        }
        .before-sections .section-title {
          background: linear-gradient(135deg, #666, #888);
        }
        .after-sections .section-title {
          background: linear-gradient(135deg, #1565C0, #1976D2);
        }
        .section-title {
          text-align: center;
          font-weight: 800;
          font-size: 80px;
          margin-bottom: 15px;
          color: white;
          margin: -16px -16px 15px -16px;
          padding: 15px;
          border-radius: 12px 12px 0 0;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .subsection {
          margin-bottom: 12px;
          border: 2px solid #ddd;
          padding: 12px;
          border-radius: 12px;
          background: rgba(255,255,255,0.7);
        }
        .before-sections .subsection {
          background: rgba(248,248,248,0.9);
        }
        .after-sections .subsection {
          background: rgba(245,250,255,0.9);
        }
        .subsection-title {
          font-weight: 800;
          font-size: 60px;
          margin-bottom: 12px;
          text-align: center;
          background: white;
          padding: 10px;
          border: 2px solid #ddd;
          margin: -12px -12px 12px -12px;
          border-radius: 10px 10px 0 0;
          color: #333;
        }
        .coverage-item {
          margin-bottom: 4px;
          display: flex;
          flex-direction: column;
          padding: 3px 0;
        }
        .coverage-name {
          font-size: 40px;
          margin-bottom: 4px;
          font-weight: 600;
          line-height: 1.3;
        }
        .coverage-display {
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .progress-container {
          flex: 1;
          max-width: 500px;
          min-width: 20px;
          height: 20px;
          background: #e0e0e0;
          border-radius: 10px;
          overflow: hidden;
          margin-right: 4px;
        }
        .progress-bar {
          height: 100%;
          border-radius: 10px;
          transition: width 0.3s ease;
        }
        .coverage-value {
          font-size: 40px;
          font-weight: 700;
          white-space: nowrap;
          min-width: 140px;
          text-align: right;
        }
        .examples-container {
          display: flex;
          gap: 40px;
          justify-content: flex-start;
          height: auto;
          margin-top: 10px;
          align-items: flex-start;
        }
        .example-section {
          width: 800px;
          padding: 20px;
          border-radius: 15px;
        }
        .before-sections .example-section {
          border: 3px solid #999;
          background: rgba(248,248,248,0.9);
          box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .after-sections .example-section {
          border: 3px solid #1976D2;
          background: rgba(240,249,255,0.9);
          box-shadow: 0 6px 18px rgba(25,118,210,0.25);
        }
        .before-sections .example-title {
          background: linear-gradient(135deg, #666, #888);
        }
        .after-sections .example-title {
          background: linear-gradient(135deg, #1565C0, #1976D2);
        }
        .example-title {
          font-weight: 800;
          font-size: 80px;
          margin-bottom: 15px;
          text-align: center;
          padding: 12px;
          color: white;
          border-radius: 12px;
          margin: -16px -16px 15px -16px;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .example-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: 4px 0;
          padding: 4px 0;
          border-bottom: 2px dotted #ccc;
          white-space: nowrap;
          line-height: 1.4;
        }
        .example-name {
          flex: 1;
          font-size: 40px;
          overflow: hidden;
          text-overflow: ellipsis;
          font-weight: 600;
          color: #333;
        }
        .example-value {
          font-weight: 800;
          font-size: 40px;
          margin-left: 15px;
          color: #333;
          min-width: 200px;
          text-align: right;
        }
      </style>
      
      <div class="main-title">
        ${data.customerName}ë‹˜ì˜ í•œ ì¥ ìš”ì•½ ë³´ì¥ë¶„ì„ (${data.birthDate ? data.birthDate.replace(/-/g, '') : 'yymmdd'})
      </div>
      
      <div class="print-container">
        <div class="main-sections-container">
          <div class="comparison-section">
            <div class="section-header before-header">ë³€ê²½ ì „ ë³´ì¥ë‚´ìš©</div>
            <div class="before-sections">
              <div class="sections-container">
                <div class="section">
                  <div class="section-title">ì•”</div>
                  ${generateCoverageItemsForPrint(data.coverages_before, ALL_COVERAGE_ITEMS.filter(i => i.category === 'cancer'), 'before')}
                </div>
                <div class="section">
                  <div class="section-title">2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜</div>
                  ${generateCoverageItemsForPrint(data.coverages_before, ALL_COVERAGE_ITEMS.filter(i => i.category === 'majorDisease'), 'before')}
                </div>
                <div class="section">
                  <div class="section-title">5ëŒ€ í•„ìˆ˜ ë³´í—˜</div>
                  ${generateEssentialSectionForPrint(data.coverages_before, data.caregiverOption, 'before')}
                </div>
              </div>
            </div>
          </div>
          
          <div class="comparison-section">
            <div class="section-header after-header">ë³€ê²½ í›„ ë³´ì¥ë‚´ìš©</div>
            <div class="after-sections">
              <div class="sections-container">
                <div class="section">
                  <div class="section-title">ì•”</div>
                  ${generateCoverageItemsForPrint(data.coverages_after, ALL_COVERAGE_ITEMS.filter(i => i.category === 'cancer'), 'after')}
                </div>
                <div class="section">
                  <div class="section-title">2ëŒ€ ì¤‘ëŒ€ì§ˆí™˜</div>
                  ${generateCoverageItemsForPrint(data.coverages_after, ALL_COVERAGE_ITEMS.filter(i => i.category === 'majorDisease'), 'after')}
                </div>
                <div class="section">
                  <div class="section-title">5ëŒ€ í•„ìˆ˜ ë³´í—˜</div>
                  ${generateEssentialSectionForPrint(data.coverages_after, data.caregiverOption, 'after')}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="examples-container">
          <div class="comparison-section">
            <div class="before-sections">
              <div class="sections-container">
                ${generateExampleSectionsForPrint(data.coverages_before, 'before')}
              </div>
            </div>
          </div>
          
          <div class="comparison-section">
            <div class="after-sections">
              <div class="sections-container">
                ${generateExampleSectionsForPrint(data.coverages_after, 'after')}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  try {
    const canvas = await html2canvas(container.firstElementChild, {
      scale: 2,
      logging: false,
      useCORS: true,
      backgroundColor: '#ffffff',
    });
    
    canvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ë³´ì¥ë¶„ì„_${data.customerName}_${new Date().getTime()}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  } catch (error) {
    console.error('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:', error);
    alert('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
  
  container.innerHTML = '';
}

// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë°ì´í„° ì €ì¥
function saveDataToStorage(data) {
  let savedData = JSON.parse(localStorage.getItem('ocrWarrantyData') || '[]');
  
  const existingIndex = savedData.findIndex(item => item.customerName === data.customerName);
  
  if (existingIndex >= 0) {
    savedData[existingIndex] = data;
  } else {
    savedData.push(data);
  }
  
  localStorage.setItem('ocrWarrantyData', JSON.stringify(savedData));
  savedDataList = savedData;
}

// ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
function loadSavedData() {
  savedDataList = JSON.parse(localStorage.getItem('ocrWarrantyData') || '[]');
}

// ì €ì¥ëœ ë°ì´í„° ëª©ë¡ í‘œì‹œ
function displaySavedList() {
  const savedList = document.getElementById('savedList');
  
  if (savedDataList.length === 0) {
    savedList.innerHTML = '<div class="hint">ì €ì¥ëœ ë³´ì¥ë¶„ì„ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  savedList.innerHTML = savedDataList.map(data => `
    <div class="saved-item" onclick="loadSavedItem('${data.customerName}')">
      <div class="saved-item-title">${data.customerName}</div>
      <div class="saved-item-date">${data.inputDate}</div>
    </div>
  `).join('');
}

// ì €ì¥ëœ í•­ëª© í•„í„°ë§
function filterSavedList() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const filteredList = savedDataList.filter(data => 
    data.customerName.toLowerCase().includes(searchTerm)
  );
  
  const savedList = document.getElementById('savedList');
  
  if (filteredList.length === 0) {
    savedList.innerHTML = '<div class="hint">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  savedList.innerHTML = filteredList.map(data => `
    <div class="saved-item" onclick="loadSavedItem('${data.customerName}')">
      <div class="saved-item-title">${data.customerName}</div>
      <div class="saved-item-date">${data.inputDate}</div>
    </div>
  `).join('');
}

// ì €ì¥ëœ í•­ëª© ë¡œë“œí•˜ì—¬ ì…ë ¥ í™”ë©´ì— í‘œì‹œ
function loadSavedItem(customerName) {
  const data = savedDataList.find(item => item.customerName === customerName);
  if (!data) return;
  
  currentData = data;
  
  showScreen('input');
  loadCurrentDataToForm();
}

// í˜„ì¬ ë°ì´í„°ë¥¼ í¼ì— ë¡œë“œ
function loadCurrentDataToForm() {
  if (!currentData.customerName) return;
  
  document.getElementById('customerName').value = currentData.customerName;
  document.getElementById('birthDate').value = currentData.birthDate || '';
  
  // ë‹´ë³´ ë°ì´í„° ë¡œë“œ (ë³€ê²½ ì „/í›„)
  if (currentData.coverages_before) {
    Object.entries(currentData.coverages_before).forEach(([key, data]) => {
      const input = document.getElementById(key + '_before');
      if (input) {
        input.value = data.value || '';
      }
    });
  }
  
  if (currentData.coverages_after) {
    Object.entries(currentData.coverages_after).forEach(([key, data]) => {
      const input = document.getElementById(key + '_after');
      if (input) {
        input.value = data.value || '';
      }
    });
  }
  
  // ê°„ë³‘ì¸ ì˜µì…˜ ë¡œë“œ
  if (currentData.caregiverOption) {
    document.getElementById('caregiverUse').checked = currentData.caregiverOption === 'use';
    document.getElementById('caregiverSupport').checked = currentData.caregiverOption === 'support';
    handleCaregiverOptionChange();
  }
}

// ì¸ì‡„ìš© ë‹´ë³´ í•­ëª© ìƒì„±
function generateCoverageItemsForPrint(coverages, items, type) {
  return items.map(item => {
    const coverage = coverages[item.key];
    const value = coverage ? extractNumber(coverage.value) : 0;
    
    let displayValue = '';
    let valueColor = '#333'; 
    
    if (value === 0) {
      displayValue = 'âœ—';
      valueColor = '#dc3545';
    } else {
      displayValue = value.toLocaleString() + 'ë§Œì›';
      valueColor = '#333';
    }
    
    let progressBarHtml = '';
    if (value === 0) {
      progressBarHtml = '<div class="progress-container"><div class="progress-bar" style="width: 0%; background: #e0e0e0;"></div></div>';
    } else {
      let barColor = '#dc3545';
      const percentage = calculateProgressPercentage(value, item.standardAmount);
      if (percentage >= 100) barColor = '#28a745';
      else if (percentage >= 30) barColor = '#ffc107';
      const width = Math.min(percentage, 100);
      progressBarHtml = `<div class="progress-container"><div class="progress-bar" style="width: ${width}%; background: ${barColor};"></div></div>`;
    }
    
    let shortName = item.name;
    if (shortName.length > 12) {
      shortName = shortName.replace('ì§ˆí™˜ì§„ë‹¨ë¹„', 'ì§„ë‹¨').replace('ì§ˆí™˜ìˆ˜ìˆ ë¹„', 'ìˆ˜ìˆ ').replace('íŠ¹ì •ì¹˜ë£Œë¹„', 'ì¹˜ë£Œ');
    }
    
    return `
      <div class="coverage-item">
        <div class="coverage-name" style="color: ${value === 0 ? '#dc3545' : '#333'};">${shortName}</div>
        <div class="coverage-display">
          ${progressBarHtml}
          <span class="coverage-value" style="color: ${valueColor};">${displayValue}</span>
        </div>
      </div>
    `;
  }).join('');
}

// ì§„í–‰ë¥  ë°”ì™€ ê¸ˆì•¡ë§Œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function generateSimpleItemForPrint(coverages, key, type) {
  const coverage = coverages[key];
  const value = coverage ? extractNumber(coverage.value) : 0;
  
  let displayValue = '';
  let valueColor = '#333';
  
  if (value === 0) {
    displayValue = 'âœ—';
    valueColor = '#dc3545';
  } else {
    displayValue = value.toLocaleString() + 'ë§Œì›';
    valueColor = '#333';
  }
  
  let progressBarHtml = '';
  if (value === 0) {
    progressBarHtml = '<div class="progress-container"><div class="progress-bar" style="width: 0%; background: #e0e0e0;"></div></div>';
  } else {
    const standardItem = ALL_COVERAGE_ITEMS.find(item => item.key === key) || { standardAmount: 1000 };
    const percentage = calculateProgressPercentage(value, standardItem.standardAmount);
    let barColor = '#dc3545';
    if (percentage >= 100) barColor = '#28a745';
    else if (percentage >= 30) barColor = '#ffc107';
    const width = Math.min(percentage, 100);
    progressBarHtml = `<div class="progress-container"><div class="progress-bar" style="width: ${width}%; background: ${barColor};"></div></div>`;
  }
  
  return `
    <div class="coverage-item">
      <div class="coverage-display">
        ${progressBarHtml}
        <span class="coverage-value" style="color: ${valueColor};">${displayValue}</span>
      </div>
    </div>
  `;
}

// í•„ìˆ˜ë³´í—˜ ê°œë³„ í•­ëª© ìƒì„±
function generateEssentialItemForPrint(coverages, key, name, type) {
  const coverage = coverages[key];
  const value = coverage ? extractNumber(coverage.value) : 0;
  
  let displayValue = '';
  let valueColor = '#333';
  
  if (value === 0) {
    displayValue = 'âœ—';
    valueColor = '#dc3545';
  } else {
    displayValue = value.toLocaleString() + 'ë§Œì›';
    valueColor = '#333';
  }
  
  let progressBarHtml = '';
  if (value === 0) {
    progressBarHtml = '<div class="progress-container"><div class="progress-bar" style="width: 0%; background: #e0e0e0;"></div></div>';
  } else {
    const standardItem = ALL_COVERAGE_ITEMS.find(item => item.key === key) || { standardAmount: 1000 };
    const percentage = calculateProgressPercentage(value, standardItem.standardAmount);
    let barColor = '#dc3545';
    if (percentage >= 100) barColor = '#28a745';
    else if (percentage >= 30) barColor = '#ffc107';
    const width = Math.min(percentage, 100);
    progressBarHtml = `<div class="progress-container"><div class="progress-bar" style="width: ${width}%; background: ${barColor};"></div></div>`;
  }
  
  return `
    <div class="coverage-item">
      <div class="coverage-name" style="color: ${value === 0 ? '#dc3545' : '#333'};">${name}</div>
      <div class="coverage-display">
        ${progressBarHtml}
        <span class="coverage-value" style="color: ${valueColor};">${displayValue}</span>
      </div>
    </div>
  `;
}

// 5ëŒ€ í•„ìˆ˜ë³´í—˜ ì„¹ì…˜ ìƒì„±
function generateEssentialSectionForPrint(coverages, caregiverOption, type) {
  let html = '';
  
  html += `
    <div class="subsection">
      <div class="subsection-title">ì‹¤ì†ì˜ë£Œë¹„</div>
      ${generateEssentialItemForPrint(coverages, 'diseaseHospitalization', '(ì‹¤ì†)ì§ˆë³‘ì…ì›', type)}
      ${generateEssentialItemForPrint(coverages, 'injuryHospitalization', '(ì‹¤ì†)ìƒí•´ì…ì›', type)}
    </div>
  `;
  
  html += `
    <div class="subsection">
      <div class="subsection-title">ìš´ì „ì</div>
      ${generateEssentialItemForPrint(coverages, 'criminalSettlement', 'í˜•ì‚¬í•©ì˜ê¸ˆ', type)}
      ${generateEssentialItemForPrint(coverages, 'lawyerAppointment', 'ë³€í˜¸ì‚¬ì„ ì„ë¹„', type)}
    </div>
  `;
  
  html += `
    <div class="subsection">
      <div class="subsection-title">ê°„ë³‘ì¸ì¼ë‹¹</div>`;
  
  if (caregiverOption === 'support') {
    html += `
      <div class="coverage-item">
        <div class="coverage-name">ì§€ì› ì„ íƒ</div>
        <div class="coverage-display">
          <div class="progress-container"><div class="progress-bar" style="width: 0%; background: #e0e0e0;"></div></div>
          <span class="coverage-value" style="color: #999;">-</span>
        </div>
      </div>`;
  } else {
    html += `
      ${generateEssentialItemForPrint(coverages, 'nursingHospitalOut', 'ìš”ì–‘ë³‘ì› ì™¸', type)}
      ${generateEssentialItemForPrint(coverages, 'nursingHospitalIn', 'ìš”ì–‘ë³‘ì›', type)}
      ${generateEssentialItemForPrint(coverages, 'nursingCareIntegrated', 'ê°„í˜¸ê°„ë³‘í†µí•©', type)}`;
  }
  
  html += `</div>`;
  
  html += `
    <div class="subsection">
      <div class="subsection-title">ì¼ìƒìƒí™œë°°ìƒì±…ì„</div>
      ${generateSimpleItemForPrint(coverages, 'dailyLifeLiability', type)}
    </div>
  `;

  html += `
    <div class="subsection">
      <div class="subsection-title">í™”ì¬ë²Œê¸ˆ</div>
      ${generateSimpleItemForPrint(coverages, 'fireFine', type)}
    </div>
  `;
  
  return html;
}

// ì˜ˆì‹œ ì„¹ì…˜ ìƒì„±
function generateExampleSectionsForPrint(coverages, type) {
  return `
    <div class="example-section">
      <div class="example-title">ì¼ë°˜ì•” ì˜ˆì‹œ</div>
      ${generateExampleItemForPrint('ë‹¤ë¹ˆì¹˜ìˆ˜ìˆ ', calculateExample1(coverages))}
      ${generateExampleItemForPrint('1ë¶€ìœ„ ì „ì´+í‘œì ', calculateExample2(coverages))}
      ${generateExampleItemForPrint('ì¤‘ì…ìì¹˜ë£Œ', calculateExample3(coverages))}
    </div>
    
    <div class="example-section">
      <div class="example-title">ë‡Œê²½ìƒ‰ ì˜ˆì‹œ</div>
      ${generateExampleItemForPrint('ìŠ¤í…íŠ¸', calculateStentExample(coverages))}
      ${generateExampleItemForPrint('ìŠ¤í…íŠ¸+í˜ˆì „ìš©í•´', calculateStentThrombolysisExample(coverages))}
      ${generateExampleItemForPrint('í˜ˆì „ì œê±°+ìš©í•´+ì¤‘í™˜ì', calculateComplexTreatmentExample(coverages))}
    </div>
    
    <div class="example-section">
      <div class="example-title">ì‹¬ê·¼ê²½ìƒ‰ ì˜ˆì‹œ</div>
      ${generateExampleItemForPrint('ìŠ¤í…íŠ¸', calculateMyocardialStentExample(coverages))}
      ${generateExampleItemForPrint('ìŠ¤í…íŠ¸+í˜ˆì „ìš©í•´', calculateMyocardialStentThrombolysisExample(coverages))}
      ${generateExampleItemForPrint('í˜ˆì „ì œê±°+ìš©í•´+ì¤‘í™˜ì', calculateMyocardialComplexTreatmentExample(coverages))}
    </div>
  `;
}

// ì¸ì‡„ìš© ì˜ˆì‹œ í•­ëª© ìƒì„±
function generateExampleItemForPrint(name, value) {
  return `
    <div class="example-item">
      <div class="example-name">${name}</div>
      <div class="example-value">${value}ë§Œì›</div>
    </div>
  `;
}

// ì¹˜ë£Œ ë³´ì¥ ì˜ˆì‹œ ê³„ì‚° í•¨ìˆ˜ë“¤
function calculateExample1(coverages) {
  const c5 = extractNumber(coverages.generalCancer?.value || 0);
  const c6 = extractNumber(coverages.totalCancer?.value || 0);
  const c8 = extractNumber(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = extractNumber(coverages.cancerNonCoveredTreatment?.value || 0);
  const c12 = extractNumber(coverages.cancerSurgery?.value || 0);
  const c13 = extractNumber(coverages.daVinciSurgery?.value || 0);
  const c14 = extractNumber(coverages.surgery5Type?.value || 0);
  
  return (c5 + c6 + c8 + c9 + c12 + c13 + c14).toLocaleString();
}

function calculateExample2(coverages) {
  const c5 = extractNumber(coverages.generalCancer?.value || 0);
  const c6 = extractNumber(coverages.totalCancer?.value || 0);
  const c7 = extractNumber(coverages.metastasisCancer?.value || 0);
  const c8 = extractNumber(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = extractNumber(coverages.cancerNonCoveredTreatment?.value || 0);
  const c10 = extractNumber(coverages.targetTherapy?.value || 0);
  
  return (c5 + c6 + c7 + c8 + c9 + c10).toLocaleString();
}

function calculateExample3(coverages) {
  const c5 = extractNumber(coverages.generalCancer?.value || 0);
  const c6 = extractNumber(coverages.totalCancer?.value || 0);
  const c8 = extractNumber(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = extractNumber(coverages.cancerNonCoveredTreatment?.value || 0);
  const c11 = extractNumber(coverages.heavyIonTherapy?.value || 0);
  
  return (c5 + c6 + c8 + c9 + c11).toLocaleString();
}

function calculateStentExample(coverages) {
  const g5 = extractNumber(coverages.cerebrovascularDiagnosis?.value || 0);
  const g6 = extractNumber(coverages.strokeDiagnosis?.value || 0);
  const g15 = extractNumber(coverages.twoMajorTreatment?.value || 0);
  const g16 = extractNumber(coverages.majorCirculatorySurgery?.value || 0);
  const g9 = extractNumber(coverages.cerebrovascularSurgery?.value || 0);
  const g10 = extractNumber(coverages.strokeSurgery?.value || 0);
  const g21 = extractNumber(coverages.surgery3Type?.value || 0);
  const g23 = extractNumber(coverages.disease124Surgery?.value || 0);
  const g24 = extractNumber(coverages.sevenOrganSurgery?.value || 0);
  
  return (g5 + g6 + g15 + g16 + g9 + g10 + g21 + g23 + g24/2).toLocaleString();
}

function calculateStentThrombolysisExample(coverages) {
  const baseValue = parseFloat(calculateStentExample(coverages).replace(/,/g, ''));
  const g18 = extractNumber(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g13 = extractNumber(coverages.strokeThrombolysis?.value || 0);
  
  return (baseValue + g18 + g13).toLocaleString();
}

function calculateComplexTreatmentExample(coverages) {
  const g5 = extractNumber(coverages.cerebrovascularDiagnosis?.value || 0);
  const g6 = extractNumber(coverages.strokeDiagnosis?.value || 0);
  const g15 = extractNumber(coverages.twoMajorTreatment?.value || 0);
  const g17 = extractNumber(coverages.majorCirculatoryThrombectomy?.value || 0);
  const g9 = extractNumber(coverages.cerebrovascularSurgery?.value || 0);
  const g10 = extractNumber(coverages.strokeSurgery?.value || 0);
  const g21 = extractNumber(coverages.surgery3Type?.value || 0);
  const g23 = extractNumber(coverages.disease124Surgery?.value || 0);
  const g24 = extractNumber(coverages.sevenOrganSurgery?.value || 0);
  const g18 = extractNumber(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g13 = extractNumber(coverages.strokeThrombolysis?.value || 0);
  const g19 = extractNumber(coverages.majorCirculatoryICU?.value || 0);
  const g20 = extractNumber(coverages.thrombectomyTreatment?.value || 0);
  
  return (g5 + g6 + g15 + g17 + g9 + g10 + g21 + g23 + g24/2 + g18 + g13 + g19 + g20).toLocaleString();
}

function calculateMyocardialStentExample(coverages) {
  const g7 = extractNumber(coverages.ischemicHeartDiagnosis?.value || 0);
  const g8 = extractNumber(coverages.myocardialInfarctionDiagnosis?.value || 0);
  const g15 = extractNumber(coverages.twoMajorTreatment?.value || 0);
  const g16 = extractNumber(coverages.majorCirculatorySurgery?.value || 0);
  const g11 = extractNumber(coverages.ischemicHeartSurgery?.value || 0);
  const g12 = extractNumber(coverages.myocardialInfarctionSurgery?.value || 0);
  const g21 = extractNumber(coverages.surgery3Type?.value || 0);
  const g23 = extractNumber(coverages.disease124Surgery?.value || 0);
  const g24 = extractNumber(coverages.sevenOrganSurgery?.value || 0);
  
  return (g7 + g8 + g15 + g16 + g11 + g12 + g21 + g23 + g24/2).toLocaleString();
}

function calculateMyocardialStentThrombolysisExample(coverages) {
  const baseValue = parseFloat(calculateMyocardialStentExample(coverages).replace(/,/g, ''));
  const g18 = extractNumber(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g14 = extractNumber(coverages.myocardialInfarctionThrombolysis?.value || 0);
  
  return (baseValue + g18 + g14).toLocaleString();
}

function calculateMyocardialComplexTreatmentExample(coverages) {
  const g7 = extractNumber(coverages.ischemicHeartDiagnosis?.value || 0);
  const g8 = extractNumber(coverages.myocardialInfarctionDiagnosis?.value || 0);
  const g15 = extractNumber(coverages.twoMajorTreatment?.value || 0);
  const g17 = extractNumber(coverages.majorCirculatoryThrombectomy?.value || 0);
  const g11 = extractNumber(coverages.ischemicHeartSurgery?.value || 0);
  const g12 = extractNumber(coverages.myocardialInfarctionSurgery?.value || 0);
  const g21 = extractNumber(coverages.surgery3Type?.value || 0);
  const g23 = extractNumber(coverages.disease124Surgery?.value || 0);
  const g24 = extractNumber(coverages.sevenOrganSurgery?.value || 0);
  const g18 = extractNumber(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g14 = extractNumber(coverages.myocardialInfarctionThrombolysis?.value || 0);
  const g19 = extractNumber(coverages.majorCirculatoryICU?.value || 0);
  const g20 = extractNumber(coverages.thrombectomyTreatment?.value || 0);
  
  return (g7 + g8 + g15 + g17 + g11 + g12 + g21 + g23 + g24/2 + g18 + g14 + g19 + g20).toLocaleString();
}
</script>

</body>
</html>
