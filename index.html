<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î≥¥Ïû•Î∂ÑÏÑùÏßÄ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .nav-steps {
            display: flex;
            background: #f8f9fa;
            padding: 10px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-step {
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
        }

        .nav-step.active {
            background: #c62828;
            color: white;
        }

        .nav-step:not(.active) {
            background: white;
            border: 1px solid #ddd;
        }

        /* Ìó§Îçî */
        .header {
            padding: 20px;
            border-bottom: 2px solid #eee;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .info-row {
            display: flex;
            gap: 30px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            gap: 5px;
        }

        /* ÏóÖÎ°úÎìú ÏÑπÏÖò */
        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            position: relative;
        }

        .upload-area:hover {
            border-color: #c62828;
            background: #fafafa;
        }

        .upload-area.processing {
            border-color: #2196F3;
            background: #f0f8ff;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: #c62828;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        .upload-btn:hover {
            background: #a52525;
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-info {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            display: none;
        }

        .progress-info.show {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #2196F3;
            transition: width 0.3s;
            border-radius: 5px;
        }

        .uploaded-image {
            max-width: 300px;
            max-height: 200px;
            margin: 20px auto;
            display: none;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† */
        .main-content {
            padding: 20px;
        }

        .sections-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .section {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background: white;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #4caf50 0deg, #4caf50 var(--score-deg), #e0e0e0 var(--score-deg), #e0e0e0 360deg);
        }

        .score-circle span {
            position: relative;
            z-index: 1;
            background: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 14px;
        }

        .item {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .item-amounts {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .amount-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
            font-size: 12px;
        }

        .amount-display {
            font-size: 13px;
            color: #666;
        }

        .shortage {
            color: #c62828;
            font-weight: bold;
            font-size: 12px;
        }

        .sufficient {
            color: #4caf50;
            font-weight: bold;
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }

        /* ÏÉùÌôúÎ≥¥Ïû• Ïä§ÌÉÄÏùº */
        .lifestyle-section {
            grid-column: 1 / -1;
        }

        .lifestyle-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .lifestyle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .status-o { background: #4caf50; }
        .status-triangle { background: #ff9800; }
        .status-x { background: #f44336; }

        /* Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î≤ÑÌäº */
        .action-buttons {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
            background: #f9f9f9;
        }

        .generate-btn {
            background: #2196F3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 0 10px;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Ïà®Í≤®ÏßÑ Ï∂úÎ†•Ïö© Ï∫îÎ≤ÑÏä§ */
        .output-canvas {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }

        /* ÏõêÎ≥∏ Ïä§ÌÉÄÏùºÏùò Î≥¥Ïû•Î∂ÑÏÑùÏßÄ */
        .original-layout {
            width: 1200px;
            height: 800px;
            background: white;
            font-family: 'Malgun Gothic', sans-serif;
            position: relative;
            box-sizing: border-box;
            padding: 20px;
        }

        .original-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .original-nav-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #666;
            border: 1px solid #ddd;
        }

        .original-nav-item.active {
            background: #c62828;
            color: white;
            border-color: #c62828;
        }

        .original-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: left;
        }

        .original-legend {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 11px;
        }

        .original-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .original-legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .original-info {
            display: flex;
            gap: 20px;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .original-main {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            height: 500px;
        }

        .original-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .original-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .original-section-title {
            font-size: 16px;
            font-weight: bold;
        }

        .original-score {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
            position: relative;
        }

        .original-items {
            flex: 1;
            overflow-y: auto;
        }

        .original-item {
            margin-bottom: 8px;
            font-size: 10px;
            line-height: 1.3;
        }

        .original-item-name {
            font-weight: bold;
            margin-bottom: 3px;
            color: #333;
        }

        .original-item-amount {
            color: #666;
        }

        .original-shortage {
            color: #c62828;
            font-weight: bold;
        }

        .original-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 2px;
            overflow: hidden;
        }

        .original-bar-fill {
            height: 100%;
        }

        .original-lifestyle {
            grid-column: 1 / -1;
            height: 120px;
        }

        .original-lifestyle-items {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            height: 80px;
        }

        .original-lifestyle-item {
            font-size: 9px;
            text-align: center;
            padding: 5px;
            border-radius: 4px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .original-status {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
            margin: 0 auto;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .sections-container {
                grid-template-columns: 1fr;
            }
            
            .info-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-steps {
                overflow-x: auto;
                justify-content: flex-start;
                padding: 10px;
            }
        }

        .edit-mode {
            background: #fff3cd !important;
            border: 1px solid #ffc107 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="nav-steps">
            <div class="nav-step">1. Ïª®ÏÑ§ÌåÖ Í∞ÄÏù¥Îìú</div>
            <div class="nav-step active">2. Í∞ÑÌé∏Î∂ÑÏÑù</div>
            <div class="nav-step">3. Í≥ÑÏïΩÏÉÅÏÑ∏</div>
            <div class="nav-step">4. Ï£ºÏöîÎ≥¥Ïû•</div>
            <div class="nav-step">5. ÏòàÏÉÅÎ≥¥ÌóòÍ∏à Ï°∞Ìöå</div>
            <div class="nav-step">6. Ïª®ÏÑ§ÌåÖ Í≤∞Í≥º</div>
            <div class="nav-step">7. Ï†Ñ/ÌõÑÎπÑÍµê</div>
        </div>

        <!-- Ìó§Îçî -->
        <div class="header">
            <div class="title" id="title">Í≥†Í∞ùÎãòÏùò Ìïú Ïû• ÏöîÏïΩ Î≥¥Ïû•Î∂ÑÏÑù</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span>100% Ïù¥ÏÉÅ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>80% Ïù¥ÏÉÅ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f44336;"></div>
                    <span>30% ÎØ∏Îßå</span>
                </div>
            </div>
            <div class="info-row" id="info-row">
                <div class="info-item">
                    <span>ÏÉùÎÖÑÏõîÏùº</span>
                    <span id="birth-date">-</span>
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ÏÉÅÎ†πÏùº</span>
                    <span id="age-date">-</span>
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ÏÜêÌï¥Î≥¥Ìóò</span>
                    <span id="damage-insurance">-</span>Í±¥
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ÏÉùÎ™ÖÎ≥¥Ìóò</span>
                    <span id="life-insurance">-</span>Í±¥
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ÏõîÎÇ©Î≥¥ÌóòÎ£å Ìï©Í≥Ñ</span>
                    <span id="monthly-premium">-</span>Ïõê
                </div>
            </div>
        </div>

        <!-- ÏóÖÎ°úÎìú ÏÑπÏÖò -->
        <div class="upload-section">
            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(event)">
                <div id="upload-content">
                    <h3>Î≥¥Ïû•Î∂ÑÏÑùÏßÄ Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</h3>
                    <p>ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏Ìï¥ÏÑú ÏóÖÎ°úÎìú</p>
                    <button class="upload-btn" type="button" id="upload-btn">ÌååÏùº ÏÑ†ÌÉù</button>
                    <button class="upload-btn" type="button" onclick="loadSampleData()" style="background: #4CAF50; margin-left: 10px;">ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ Î°úÎìú</button>
                </div>
                <img id="uploaded-image" class="uploaded-image" alt="ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ">
            </div>
            
            <div class="progress-info" id="progress-info">
                <div id="progress-text">Ïù¥ÎØ∏ÏßÄÎ•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progress-bar"></div>
                </div>
                <div id="progress-details"></div>
            </div>
        </div>

        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
        <div class="main-content">
            <div class="sections-container" id="sections-container">
                <!-- Í∞ÄÏ°±Î≥¥Ïû• -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Í∞ÄÏ°±Î≥¥Ïû•</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="family-score">-Ï†ê</span>
                        </div>
                    </div>
                    <div id="family-items">
                        <div class="item">
                            <div class="item-name">Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</div>
                        </div>
                    </div>
                </div>

                <!-- ÌÅ∞Î≥ëÎ≥¥Ïû• -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ÌÅ∞Î≥ëÎ≥¥Ïû•</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="disease-score">-Ï†ê</span>
                        </div>
                    </div>
                    <div id="disease-items">
                        <div class="item">
                            <div class="item-name">Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</div>
                        </div>
                    </div>
                </div>

                <!-- ÏùòÎ£åÎ≥¥Ïû• -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ÏùòÎ£åÎ≥¥Ïû•</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="medical-score">-Ï†ê</span>
                        </div>
                    </div>
                    <div id="medical-items">
                        <div class="item">
                            <div class="item-name">Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</div>
                        </div>
                    </div>
                </div>

                <!-- Í∞ÑÎ≥ëÎ≥¥Ïû• -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Í∞ÑÎ≥ëÎ≥¥Ïû•</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="care-score">-Ï†ê</span>
                        </div>
                    </div>
                    <div id="care-items">
                        <div class="item">
                            <div class="item-name">Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</div>
                        </div>
                    </div>
                </div>

                <!-- ÏÉùÌôúÎ≥¥Ïû• -->
                <div class="section lifestyle-section">
                    <div class="section-header">
                        <div class="section-title">ÏÉùÌôúÎ≥¥Ïû•</div>
                        <div style="font-size: 12px; color: #666;">
                            <span style="color: #4caf50;">‚óè</span> Ï†ÅÏ†ï
                            <span style="color: #ff9800; margin-left: 10px;">‚ñ≤</span> Î∂ÄÏ°±
                            <span style="color: #f44336; margin-left: 10px;">‚úï</span> ÎØ∏Î≥¥Ïû•
                        </div>
                    </div>
                    <div class="lifestyle-items" id="lifestyle-items">
                        <div class="lifestyle-item">
                            <div>Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
        <div class="action-buttons">
            <button class="generate-btn" onclick="generateOriginalLayout()">
                üìä ÏõêÎ≥∏ ÌòïÌÉú Î≥¥Ïû•Î∂ÑÏÑùÏßÄ ÏÉùÏÑ±
            </button>
            <button class="generate-btn" onclick="downloadAsImage()">
                üíæ Ïù¥ÎØ∏ÏßÄÎ°ú Îã§Ïö¥Î°úÎìú
            </button>
        </div>
    </div>

    <!-- Ïà®Í≤®ÏßÑ ÏõêÎ≥∏ Î†àÏù¥ÏïÑÏõÉ -->
    <div id="original-layout" class="original-layout output-canvas">
        <!-- ÏõêÎ≥∏ ÌòïÌÉúÏùò Î≥¥Ïû•Î∂ÑÏÑùÏßÄÍ∞Ä Ïó¨Í∏∞Ïóê ÏÉùÏÑ±Îê©ÎãàÎã§ -->
    </div>

    <script>
        let currentData = {
            personal: {
                name: "Í≥†Í∞ù",
                birthDate: "",
                ageDate: "",
                damageInsurance: 0,
                lifeInsurance: 0,
                monthlyPremium: 0
            },
            sections: {
                family: { score: 0, items: [] },
                disease: { score: 0, items: [] },
                medical: { score: 0, items: [] },
                care: { score: 0, items: [] }
            },
            lifestyle: []
        };

        let isProcessing = false;

        // Ï¥àÍ∏∞Ìôî
        function init() {
            updatePersonalInfo();
            renderEmptySections();
            renderEmptyLifestyle();
        }

        // Îπà ÏÑπÏÖò Î†åÎçîÎßÅ
        function renderEmptySections() {
            const sections = ['family', 'disease', 'medical', 'care'];
            sections.forEach(sectionKey => {
                const scoreElement = document.getElementById(`${sectionKey}-score`);
                scoreElement.textContent = '-Ï†ê';
                updateScoreCircle(scoreElement.parentElement, 0);
            });
        }

        // Îπà ÏÉùÌôúÎ≥¥Ïû• Î†åÎçîÎßÅ
        function renderEmptyLifestyle() {
            const container = document.getElementById('lifestyle-items');
            container.innerHTML = '<div class="lifestyle-item"><div>Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</div></div>';
        }

        // Í∞úÏù∏Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePersonalInfo() {
            document.getElementById('title').textContent = `${currentData.personal.name}ÎãòÏùò Ìïú Ïû• ÏöîÏïΩ Î≥¥Ïû•Î∂ÑÏÑù`;
            document.getElementById('birth-date').textContent = currentData.personal.birthDate || '-';
            document.getElementById('age-date').textContent = currentData.personal.ageDate || '-';
            document.getElementById('damage-insurance').textContent = currentData.personal.damageInsurance || '-';
            document.getElementById('life-insurance').textContent = currentData.personal.lifeInsurance || '-';
            document.getElementById('monthly-premium').textContent = currentData.personal.monthlyPremium ? 
                currentData.personal.monthlyPremium.toLocaleString() : '-';
        }

        // ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        async function handleFileUpload(event) {
            if (isProcessing) return;
            
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }

            isProcessing = true;
            const uploadBtn = document.getElementById('upload-btn');
            const uploadArea = document.getElementById('upload-area');
            const progressInfo = document.getElementById('progress-info');
            const uploadedImage = document.getElementById('uploaded-image');

            // UI ÏÉÅÌÉú Î≥ÄÍ≤Ω
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Ï≤òÎ¶¨ Ï§ë...';
            uploadArea.classList.add('processing');
            progressInfo.classList.add('show');

            try {
                // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú
                const imageUrl = URL.createObjectURL(file);
                uploadedImage.src = imageUrl;
                uploadedImage.style.display = 'block';

                // OCR Ï≤òÎ¶¨
                await performOCR(file);

            } catch (error) {
                console.error('OCR Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:', error);
                alert('Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                
                // Ïò§Î•ò Ïãú UI Î≥µÏõê
                uploadedImage.style.display = 'none';
                progressInfo.classList.remove('show');
                
            } finally {
                isProcessing = false;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Îã§Î•∏ ÌååÏùº ÏÑ†ÌÉù';
                uploadArea.classList.remove('processing');
            }
        }

        // OCR ÏàòÌñâ - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        async function performOCR(file) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressDetails = document.getElementById('progress-details');

            try {
                progressText.textContent = 'OCR ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                progressBar.style.width = '5%';

                // Tesseract.jsÍ∞Ä Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                if (typeof Tesseract === 'undefined') {
                    throw new Error('Tesseract.js ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                progressText.textContent = 'OCR ÏõåÏª§Î•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                progressBar.style.width = '10%';

                // Worker ÏÉùÏÑ± Ïãú Îçî Î™ÖÌôïÌïú ÏòµÏÖò ÏÑ§Ï†ï
                const worker = await Tesseract.createWorker(['kor', 'eng'], 1, {
                    corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@4/tesseract-core-simd.wasm.js',
                    workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/worker.min.js',
                    langPath: 'https://tessdata.projectnaptha.com/4.0.0_best',
                    logger: (m) => {
                        console.log('Tesseract Î°úÍ∑∏:', m);
                        
                        if (m.status === 'loading tesseract core') {
                            progressText.textContent = 'OCR ÏóîÏßÑÏùÑ Î°úÎî©ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                            progressBar.style.width = '15%';
                        } else if (m.status === 'initializing tesseract') {
                            progressText.textContent = 'OCR ÏóîÏßÑÏùÑ Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                            progressBar.style.width = '20%';
                        } else if (m.status === 'loading language traineddata') {
                            progressText.textContent = 'ÌïúÍ∏Ä Ïñ∏Ïñ¥ Î™®Îç∏ÏùÑ Î°úÎî©ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                            progressBar.style.width = '25%';
                            progressDetails.textContent = 'Ï≤òÏùå Ïã§Ìñâ Ïãú Ïñ∏Ïñ¥ Î™®Îç∏ Îã§Ïö¥Î°úÎìúÎ°ú ÏãúÍ∞ÑÏù¥ Í±∏Î¶¥ Ïàò ÏûàÏäµÎãàÎã§.';
                        } else if (m.status === 'initializing api') {
                            progressText.textContent = 'OCR APIÎ•º Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                            progressBar.style.width = '30%';
                        } else if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 60) + 30; // 30-90%
                            progressBar.style.width = progress + '%';
                            progressText.textContent = 'Ïù¥ÎØ∏ÏßÄÏóêÏÑú ÌÖçÏä§Ìä∏Î•º Ïù∏ÏãùÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                            progressDetails.textContent = `ÏßÑÌñâÎ•†: ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                progressText.textContent = 'Ïù¥ÎØ∏ÏßÄÎ•º Ï≤òÎ¶¨ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                
                // Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨Î•º ÏúÑÌïú Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ±
                const processedImage = await preprocessImage(file);
                
                // OCR Ïã§Ìñâ
                const { data: { text, confidence } } = await worker.recognize(processedImage);
                
                console.log('OCR Í≤∞Í≥º:', text);
                console.log('Ïã†Î¢∞ÎèÑ:', confidence);
                
                progressBar.style.width = '95%';
                progressText.textContent = 'Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
                progressDetails.textContent = 'ÌÖçÏä§Ìä∏ ÌååÏã± Ï§ë...';

                // OCR Í≤∞Í≥º ÌååÏã±
                await parseOCRResult(text);

                progressBar.style.width = '100%';
                progressText.textContent = 'ÏôÑÎ£å! Î≥¥Ïû•Î∂ÑÏÑùÏßÄÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.';
                progressDetails.textContent = `Ïù∏Ïãù Ïã†Î¢∞ÎèÑ: ${Math.round(confidence)}%`;

                await worker.terminate();

                // 3Ï¥à ÌõÑ ÏßÑÌñâÎ•† Ï†ïÎ≥¥ Ïà®Í∏∞Í∏∞
                setTimeout(() => {
                    document.getElementById('progress-info').classList.remove('show');
                }, 4000);

            } catch (error) {
                console.error('OCR ÏÉÅÏÑ∏ Ïò§Î•ò:', error);
                
                progressText.textContent = 'OCR Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                progressDetails.textContent = 'ÏàòÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò Îã§Î•∏ Ïù¥ÎØ∏ÏßÄÎ•º ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                
                // Ïã§Ìå® Ïãú Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï±ÑÏö∞Í∏∞
                fillDefaultItems();
                updatePersonalInfo();
                renderSections();
                renderLifestyle();
                
                // Ïò§Î•ò Î©îÏãúÏßÄÎ•º Îçî ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†ÅÏúºÎ°ú ÌëúÏãú
                setTimeout(() => {
                    alert('Ïù¥ÎØ∏ÏßÄ Ïù∏ÏãùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÍ∞ÄÎä•Ìïú Ìï¥Í≤∞Î∞©Î≤ï:\n1. Îçî ÏÑ†Î™ÖÌïòÍ≥† Í≥†ÌôîÏßàÏùò Ïù¥ÎØ∏ÏßÄÎ•º ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî\n2. Ïù¥ÎØ∏ÏßÄÏùò ÌÖçÏä§Ìä∏Í∞Ä ÏàòÌèâÏúºÎ°ú Ï†ïÎ†¨ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî\n3. ÏàòÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º ÏûÖÎ†•ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§');
                    document.getElementById('progress-info').classList.remove('show');
                }, 2000);
                
                throw error;
            }
        }

        // Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨ Ìï®Ïàò
        async function preprocessImage(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï (ÏµúÎåÄ 1920x1080ÏúºÎ°ú Ï†úÌïú)
                    const maxWidth = 1920;
                    const maxHeight = 1080;
                    let { width, height } = img;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Í∏∞
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ÎåÄÎπÑ Î∞è Î∞ùÍ∏∞ Ï°∞Ï†ïÏúºÎ°ú OCR Ï†ïÌôïÎèÑ Ìñ•ÏÉÅ
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        // RGB Í∞í Ï°∞Ï†ï (ÎåÄÎπÑ Ï¶ùÍ∞Ä)
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        const factor = 1.2; // ÎåÄÎπÑ Ï°∞Ï†ï Ìå©ÌÑ∞
                        
                        data[i] = Math.min(255, Math.max(0, (data[i] - avg) * factor + avg));
                        data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - avg) * factor + avg));
                        data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - avg) * factor + avg));
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    // CanvasÎ•º BlobÏúºÎ°ú Î≥ÄÌôò
                    canvas.toBlob(resolve, 'image/png', 0.95);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // OCR Í≤∞Í≥º ÌååÏã±
        function parseOCRResult(text) {
            console.log('OCR Í≤∞Í≥º:', text);
            
            // ÌïúÍ∏Ä ÌÖçÏä§Ìä∏ Ï†ïÎ¶¨
            const cleanText = text.replace(/[^\w\sÍ∞Ä-Ìû£(),.:/%-]/g, ' ')
                                 .replace(/\s+/g, ' ')
                                 .trim();

            // Ïù¥Î¶Ñ Ï∂îÏ∂ú (Ìå®ÌÑ¥: "OOOÎãòÏùò" ÎòêÎäî "OOO ÎãòÏùò")
            const nameMatch = cleanText.match(/([Í∞Ä-Ìû£]{2,4})\s?ÎãòÏùò/);
            if (nameMatch) {
                currentData.personal.name = nameMatch[1];
            }

            // ÏÉùÎÖÑÏõîÏùº Ï∂îÏ∂ú (Ìå®ÌÑ¥: YY-MM-DD)
            const birthMatch = cleanText.match(/(\d{2}-\d{2}-\d{2})/);
            if (birthMatch) {
                currentData.personal.birthDate = birthMatch[1];
            }

            // ÏõîÎÇ©Î≥¥ÌóòÎ£å Ï∂îÏ∂ú (Ìå®ÌÑ¥: Ïà´Ïûê,Ïà´ÏûêÏõê)
            const premiumMatch = cleanText.match(/ÏõîÎÇ©Î≥¥ÌóòÎ£å[^0-9]*([0-9,]+)Ïõê/);
            if (premiumMatch) {
                currentData.personal.monthlyPremium = parseInt(premiumMatch[1].replace(/,/g, ''));
            }

            // ÏÜêÌï¥Î≥¥Ìóò/ÏÉùÎ™ÖÎ≥¥Ìóò Í±¥Ïàò Ï∂îÏ∂ú
            const damageMatch = cleanText.match(/ÏÜêÌï¥Î≥¥Ìóò[^0-9]*(\d+)Í±¥/);
            if (damageMatch) {
                currentData.personal.damageInsurance = parseInt(damageMatch[1]);
            }

            const lifeMatch = cleanText.match(/ÏÉùÎ™ÖÎ≥¥Ìóò[^0-9]*(\d+)Í±¥/);
            if (lifeMatch) {
                currentData.personal.lifeInsurance = parseInt(lifeMatch[1]);
            }

            // Ï†êÏàò Ï∂îÏ∂ú (Ìå®ÌÑ¥: Ïà´ÏûêÏ†ê)
            const familyScoreMatch = cleanText.match(/Í∞ÄÏ°±Î≥¥Ïû•[^0-9]*(\d+)Ï†ê/);
            if (familyScoreMatch) {
                currentData.sections.family.score = parseInt(familyScoreMatch[1]);
            }

            const diseaseScoreMatch = cleanText.match(/ÌÅ∞Î≥ëÎ≥¥Ïû•[^0-9]*(\d+)Ï†ê/);
            if (diseaseScoreMatch) {
                currentData.sections.disease.score = parseInt(diseaseScoreMatch[1]);
            }

            const medicalScoreMatch = cleanText.match(/ÏùòÎ£åÎ≥¥Ïû•[^0-9]*(\d+)Ï†ê/);
            if (medicalScoreMatch) {
                currentData.sections.medical.score = parseInt(medicalScoreMatch[1]);
            }

            const careScoreMatch = cleanText.match(/Í∞ÑÎ≥ëÎ≥¥Ïû•[^0-9]*(\d+)Ï†ê/);
            if (careScoreMatch) {
                currentData.sections.care.score = parseInt(careScoreMatch[1]);
            }

            // Î≥¥Ïû• Ìï≠Î™©Îì§ ÌååÏã± (Í∏∞Î≥∏ Ìå®ÌÑ¥ Îß§Ïπ≠)
            parseInsuranceItems(cleanText);

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updatePersonalInfo();
            renderSections();
            renderLifestyle();
        }

        // Î≥¥Ìóò Ìï≠Î™© ÌååÏã±
        function parseInsuranceItems(text) {
            // Í∞ÄÏ°±Î≥¥Ïû• Ìï≠Î™©Îì§
            const familyItems = [
                { name: "ÏßàÎ≥ëÏÇ¨Îßù", pattern: /ÏßàÎ≥ëÏÇ¨Îßù[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ÏÉÅÌï¥ÏÇ¨Îßù", pattern: /ÏÉÅÌï¥ÏÇ¨Îßù[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ÏßàÎ≥ëÌõÑÏú†", pattern: /ÏßàÎ≥ëÌõÑÏú†[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ÏÉÅÌï¥ÌõÑÏú†", pattern: /ÏÉÅÌï¥ÌõÑÏú†[^0-9]*(\d+)[^0-9]*(\d+)/ }
            ];

            // ÌÅ∞Î≥ëÎ≥¥Ïû• Ìï≠Î™©Îì§
            const diseaseItems = [
                { name: "Ïú†ÏÇ¨Ïïî", pattern: /Ïú†ÏÇ¨Ïïî[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ÏùºÎ∞òÏïî", pattern: /ÏùºÎ∞òÏïî[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ÎáåÌòàÍ¥ÄÏßàÌôò", pattern: /ÎáåÌòàÍ¥ÄÏßàÌôò[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "Ïã¨Ïû•ÏßàÌôò", pattern: /Ïã¨Ïû•ÏßàÌôò[^0-9]*(\d+)[^0-9]*(\d+)/ }
            ];

            // ÏùòÎ£åÎ≥¥Ïû• Ìï≠Î™©Îì§
            const medicalItems = [
                { name: "Ïã§ÏÜêÎ≥¥Ìóò", pattern: /Ïã§ÏÜê[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ÏûÖÏõêÎπÑ", pattern: /ÏûÖÏõê[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ÏàòÏà†ÎπÑ", pattern: /ÏàòÏà†[^0-9]*(\d+)[^0-9]*(\d+)/ }
            ];

            // Í∞ÑÎ≥ëÎ≥¥Ïû• Ìï≠Î™©Îì§
            const careItems = [
                { name: "ÏπòÎß§Î≥¥Ïû•", pattern: /ÏπòÎß§[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "Ïû•Í∏∞ÏöîÏñë", pattern: /Ïû•Í∏∞ÏöîÏñë[^0-9]*(\d+)[^0-9]*(\d+)/ }
            ];

            // Í∞Å ÏÑπÏÖòÎ≥Ñ ÏïÑÏù¥ÌÖú ÌååÏã±
            currentData.sections.family.items = parseSection(text, familyItems);
            currentData.sections.disease.items = parseSection(text, diseaseItems);
            currentData.sections.medical.items = parseSection(text, medicalItems);
            currentData.sections.care.items = parseSection(text, careItems);

            // Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï±ÑÏö∞Í∏∞ (OCRÏóêÏÑú Ïù∏ÏãùÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞)
            fillDefaultItems();
        }

        // ÏÑπÏÖòÎ≥Ñ ÏïÑÏù¥ÌÖú ÌååÏã±
        function parseSection(text, itemPatterns) {
            const items = [];
            
            itemPatterns.forEach(item => {
                const match = text.match(item.pattern);
                if (match) {
                    items.push({
                        name: item.name,
                        current: parseInt(match[1]) || 0,
                        target: parseInt(match[2]) || 0
                    });
                }
            });

            return items;
        }

        // Í∏∞Î≥∏ ÏïÑÏù¥ÌÖúÏúºÎ°ú Ï±ÑÏö∞Í∏∞
        function fillDefaultItems() {
            if (currentData.sections.family.items.length === 0) {
                currentData.sections.family.items = [
                    { name: "ÏßàÎ≥ëÏÇ¨Îßù", current: 0, target: 10000 },
                    { name: "ÏÉÅÌï¥ÏÇ¨Îßù", current: 0, target: 20000 },
                    { name: "ÏßàÎ≥ëÌõÑÏú†(3%)", current: 0, target: 3000 },
                    { name: "ÏÉÅÌï¥ÌõÑÏú†(3%)", current: 0, target: 10000 }
                ];
            }

            if (currentData.sections.disease.items.length === 0) {
                currentData.sections.disease.items = [
                    { name: "Ïú†ÏÇ¨Ïïî", current: 0, target: 1000 },
                    { name: "ÏùºÎ∞òÏïî", current: 0, target: 7000 },
                    { name: "ÎáåÌòàÍ¥ÄÏßàÌôò", current: 0, target: 2000 },
                    { name: "Ïã¨Ïû•ÏßàÌôò", current: 0, target: 3000 }
                ];
            }

            if (currentData.sections.medical.items.length === 0) {
                currentData.sections.medical.items = [
                    { name: "ÏßàÎ≥ëÏûÖÏõê Ïã§ÏÜê", current: 0, target: 5000 },
                    { name: "ÏÉÅÌï¥ÏûÖÏõê Ïã§ÏÜê", current: 0, target: 5000 },
                    { name: "ÏßàÎ≥ëÏûÖÏõê(1Ïùº)", current: 0, target: 3 },
                    { name: "ÏàòÏà†ÎπÑ", current: 0, target: 50 }
                ];
            }

            if (currentData.sections.care.items.length === 0) {
                currentData.sections.care.items = [
                    { name: "Í≤ΩÏ¶ùÏπòÎß§", current: 0, target: 2000 },
                    { name: "Ï§ëÏ¶ùÏπòÎß§", current: 0, target: 4000 },
                    { name: "Ïû•Í∏∞ÏöîÏñë", current: 0, target: 2000 }
                ];
            }

            // ÏÉùÌôúÎ≥¥Ïû• Í∏∞Î≥∏Í∞í
            if (currentData.lifestyle.length === 0) {
                currentData.lifestyle = [
                    { name: "ÎåÄÏù∏Î∞∞ÏÉÅÏ±ÖÏûÑ", amount: 0, status: "‚úï" },
                    { name: "Î≥ÄÌò∏ÏÇ¨ÏÑ†ÏûÑÎπÑÏö©", amount: 0, status: "‚úï" },
                    { name: "Ïö¥Ï†ÑÏûêÎ≤åÍ∏à", amount: 0, status: "‚úï" },
                    { name: "ÏùºÏÉÅÏÉùÌôúÎ∞∞ÏÉÅÏ±ÖÏûÑ", amount: 0, status: "‚úï" }
                ];
            }
        }

        // ÏÑπÏÖò Î†åÎçîÎßÅ
        function renderSections() {
            const sections = ['family', 'disease', 'medical', 'care'];
            
            sections.forEach((sectionKey) => {
                const section = currentData.sections[sectionKey];
                const container = document.getElementById(`${sectionKey}-items`);
                const scoreElement = document.getElementById(`${sectionKey}-score`);
                
                // Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
                scoreElement.textContent = `${section.score}Ï†ê`;
                updateScoreCircle(scoreElement.parentElement, section.score);
                
                // ÏïÑÏù¥ÌÖú Î†åÎçîÎßÅ
                container.innerHTML = '';
                if (section.items.length > 0) {
                    section.items.forEach((item, itemIndex) => {
                        const itemElement = createItemElement(item, sectionKey, itemIndex);
                        container.appendChild(itemElement);
                    });
                } else {
                    container.innerHTML = '<div class="item"><div class="item-name">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div></div>';
                }
            });
        }

        // ÏïÑÏù¥ÌÖú ÏöîÏÜå ÏÉùÏÑ±
        function createItemElement(item, sectionKey, itemIndex) {
            const div = document.createElement('div');
            div.className = 'item';
            
            const shortage = Math.max(0, item.target - item.current);
            const percentage = item.target > 0 ? Math.min(100, (item.current / item.target) * 100) : 0;
            
            let progressColor = '#f44336'; // 30% ÎØ∏Îßå
            if (percentage >= 100) progressColor = '#4caf50'; // 100% Ïù¥ÏÉÅ
            else if (percentage >= 80) progressColor = '#ff9800'; // 80% Ïù¥ÏÉÅ
            
            div.innerHTML = `
                <div class="item-name">${item.name}</div>
                <div class="item-amounts">
                    <input type="number" class="amount-input" value="${item.current}" 
                           onchange="updateAmount('${sectionKey}', ${itemIndex}, 'current', this.value)">
                    <span class="amount-display">ÎßåÏõê /</span>
                    <input type="number" class="amount-input" value="${item.target}" 
                           onchange="updateAmount('${sectionKey}', ${itemIndex}, 'target', this.value)">
                    <span class="amount-display">ÎßåÏõê</span>
                    ${shortage > 0 ? `<span class="shortage">(${shortage.toLocaleString()}ÎßåÏõê Î∂ÄÏ°±)</span>` : 
                      item.current >= item.target ? `<span class="sufficient">Ï∂©Ï°±</span>` : ''}
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(100, percentage)}%; background: ${progressColor};"></div>
                </div>
            `;
            
            return div;
        }

        // Ï†êÏàò ÏõêÌòï Í∑∏ÎûòÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateScoreCircle(element, score) {
            const degrees = (score / 100) * 360;
            element.style.setProperty('--score-deg', `${degrees}deg`);
        }

        // ÏÉùÌôúÎ≥¥Ïû• Î†åÎçîÎßÅ
        function renderLifestyle() {
            const container = document.getElementById('lifestyle-items');
            
            if (currentData.lifestyle.length === 0) {
                container.innerHTML = '<div class="lifestyle-item"><div>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div></div>';
                return;
            }

            container.innerHTML = '';
            currentData.lifestyle.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'lifestyle-item';
                
                const statusClass = item.status === '‚óè' ? 'status-o' : 
                                   item.status === '‚ñ≤' ? 'status-triangle' : 'status-x';
                
                div.innerHTML = `
                    <div>
                        <strong>${item.name}</strong>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">
                            <input type="number" class="amount-input" value="${item.amount}" 
                                   onchange="updateLifestyle(${index}, 'amount', this.value)">ÎßåÏõê
                        </div>
                    </div>
                    <div class="status-indicator ${statusClass}" onclick="toggleStatus(${index})">${item.status}</div>
                `;
                
                container.appendChild(div);
            });
        }

        // Í∏àÏï° ÏóÖÎç∞Ïù¥Ìä∏
        function updateAmount(sectionKey, itemIndex, field, value) {
            const numValue = parseInt(value) || 0;
            currentData.sections[sectionKey].items[itemIndex][field] = numValue;
            
            // Ï†êÏàò Ïû¨Í≥ÑÏÇ∞
            const section = currentData.sections[sectionKey];
            const totalPercentage = section.items.reduce((sum, item) => {
                const percentage = item.target > 0 ? (item.current / item.target) * 100 : 0;
                return sum + Math.min(100, percentage);
            }, 0);
            section.score = Math.round(totalPercentage / section.items.length);
            
            renderSections();
        }

        // ÏÉùÌôúÎ≥¥Ïû• ÏóÖÎç∞Ïù¥Ìä∏
        function updateLifestyle(index, field, value) {
            currentData.lifestyle[index][field] = field === 'amount' ? (parseInt(value) || 0) : value;
            renderLifestyle();
        }

        // ÏÉÅÌÉú ÌÜ†Í∏Ä
        function toggleStatus(index) {
            const statuses = ['‚óè', '‚ñ≤', '‚úï'];
            const currentStatus = currentData.lifestyle[index].status;
            const currentIndex = statuses.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statuses.length;
            currentData.lifestyle[index].status = statuses[nextIndex];
            renderLifestyle();
        }

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.querySelector('.upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                uploadArea.style.borderColor = '#c62828';
                uploadArea.style.background = '#fafafa';
            }
            
            function unhighlight(e) {
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.background = 'white';
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    document.getElementById('file-input').files = files;
                    handleFileUpload({ target: { files: files } });
                }
            }
        });

        // ÏõêÎ≥∏ Î†àÏù¥ÏïÑÏõÉ ÏÉùÏÑ±
        function generateOriginalLayout() {
            const container = document.getElementById('original-layout');
            container.innerHTML = '';

            // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
            const nav = document.createElement('div');
            nav.className = 'original-nav';
            nav.innerHTML = `
                <div class="original-nav-item">1. Ïª®ÏÑ§ÌåÖ Í∞ÄÏù¥Îìú</div>
                <div class="original-nav-item active">2. Í∞ÑÌé∏Î∂ÑÏÑù</div>
                <div class="original-nav-item">3. Í≥ÑÏïΩÏÉÅÏÑ∏</div>
                <div class="original-nav-item">4. Ï£ºÏöîÎ≥¥Ïû•</div>
                <div class="original-nav-item">5. ÏòàÏÉÅÎ≥¥ÌóòÍ∏à Ï°∞Ìöå</div>
                <div class="original-nav-item">6. Ïª®ÏÑ§ÌåÖ Í≤∞Í≥º</div>
                <div class="original-nav-item">7. Ï†Ñ/ÌõÑÎπÑÍµê</div>
            `;
            container.appendChild(nav);

            // Ï†úÎ™©
            const title = document.createElement('div');
            title.className = 'original-title';
            title.textContent = `${currentData.personal.name}ÎãòÏùò Ìïú Ïû• ÏöîÏïΩ Î≥¥Ïû•Î∂ÑÏÑù`;
            container.appendChild(title);

            // Î≤îÎ°Ä
            const legend = document.createElement('div');
            legend.className = 'original-legend';
            legend.innerHTML = `
                <div class="original-legend-item">
                    <div class="original-legend-color" style="background: #4caf50;"></div>
                    <span>100% Ïù¥ÏÉÅ</span>
                </div>
                <div class="original-legend-item">
                    <div class="original-legend-color" style="background: #ff9800;"></div>
                    <span>80% Ïù¥ÏÉÅ</span>
                </div>
                <div class="original-legend-item">
                    <div class="original-legend-color" style="background: #f44336;"></div>
                    <span>30% ÎØ∏Îßå</span>
                </div>
            `;
            container.appendChild(legend);

            // Í∞úÏù∏Ï†ïÎ≥¥
            const info = document.createElement('div');
            info.className = 'original-info';
            info.innerHTML = `
                <span>ÏÉùÎÖÑÏõîÏùº ${currentData.personal.birthDate || '-'}</span>
                <span>/ ÏÜêÌï¥Î≥¥Ìóò ${currentData.personal.damageInsurance || '-'}Í±¥</span>
                <span>/ ÏÉùÎ™ÖÎ≥¥Ìóò ${currentData.personal.lifeInsurance || '-'}Í±¥</span>
                <span>/ ÏõîÎÇ©Î≥¥ÌóòÎ£å Ìï©Í≥Ñ ${currentData.personal.monthlyPremium ? 
                    currentData.personal.monthlyPremium.toLocaleString() : '-'}Ïõê</span>
            `;
            container.appendChild(info);

            // Î©îÏù∏ ÏÑπÏÖòÎì§
            const main = document.createElement('div');
            main.className = 'original-main';

            // 4Í∞ú Ï£ºÏöî ÏÑπÏÖò ÏÉùÏÑ±
            const sections = [
                { key: 'family', title: 'Í∞ÄÏ°±Î≥¥Ïû•' },
                { key: 'disease', title: 'ÌÅ∞Î≥ëÎ≥¥Ïû•' },
                { key: 'medical', title: 'ÏùòÎ£åÎ≥¥Ïû•' },
                { key: 'care', title: 'Í∞ÑÎ≥ëÎ≥¥Ïû•' }
            ];

            sections.forEach(sectionInfo => {
                const section = document.createElement('div');
                section.className = 'original-section';

                const sectionData = currentData.sections[sectionInfo.key];
                
                // Ìó§Îçî
                const header = document.createElement('div');
                header.className = 'original-section-header';
                
                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'original-section-title';
                sectionTitle.textContent = sectionInfo.title;
                
                const score = document.createElement('div');
                score.className = 'original-score';
                score.textContent = `${sectionData.score}Ï†ê`;
                
                // Ï†êÏàòÏóê Îî∞Î•∏ Î∞∞Í≤ΩÏÉâ
                let bgColor = '#f44336'; // 30% ÎØ∏Îßå
                if (sectionData.score >= 100) bgColor = '#4caf50'; // 100% Ïù¥ÏÉÅ
                else if (sectionData.score >= 80) bgColor = '#ff9800'; // 80% Ïù¥ÏÉÅ
                score.style.background = bgColor;
                
                header.appendChild(sectionTitle);
                header.appendChild(score);
                section.appendChild(header);

                // ÏïÑÏù¥ÌÖúÎì§
                const items = document.createElement('div');
                items.className = 'original-items';
                
                sectionData.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'original-item';
                    
                    const shortage = Math.max(0, item.target - item.current);
                    const percentage = item.target > 0 ? Math.min(100, (item.current / item.target) * 100) : 0;
                    
                    let barColor = '#f44336';
                    if (percentage >= 100) barColor = '#4caf50';
                    else if (percentage >= 80) barColor = '#ff9800';
                    
                    itemDiv.innerHTML = `
                        <div class="original-item-name">${item.name}</div>
                        <div class="original-item-amount">
                            ${item.current.toLocaleString()}ÎßåÏõê / ${item.target.toLocaleString()}ÎßåÏõê
                            ${shortage > 0 ? `<span class="original-shortage">(${shortage.toLocaleString()}ÎßåÏõê Î∂ÄÏ°±)</span>` : ''}
                        </div>
                        <div class="original-bar">
                            <div class="original-bar-fill" style="width: ${Math.min(100, percentage)}%; background: ${barColor};"></div>
                        </div>
                    `;
                    
                    items.appendChild(itemDiv);
                });
                
                section.appendChild(items);
                main.appendChild(section);
            });

            // ÏÉùÌôúÎ≥¥Ïû• ÏÑπÏÖò
            const lifestyleSection = document.createElement('div');
            lifestyleSection.className = 'original-section original-lifestyle';
            
            const lifestyleHeader = document.createElement('div');
            lifestyleHeader.className = 'original-section-header';
            lifestyleHeader.innerHTML = `
                <div class="original-section-title">ÏÉùÌôúÎ≥¥Ïû•</div>
                <div style="font-size: 10px; color: #666;">
                    <span style="color: #4caf50;">‚óè</span> Ï†ÅÏ†ï
                    <span style="color: #ff9800; margin-left: 8px;">‚ñ≤</span> Î∂ÄÏ°±
                    <span style="color: #f44336; margin-left: 8px;">‚úï</span> ÎØ∏Î≥¥Ïû•
                </div>
            `;
            lifestyleSection.appendChild(lifestyleHeader);

            const lifestyleItems = document.createElement('div');
            lifestyleItems.className = 'original-lifestyle-items';
            
            currentData.lifestyle.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'original-lifestyle-item';
                
                const status = document.createElement('div');
                status.className = 'original-status';
                
                if (item.status === '‚óè') {
                    status.style.background = '#4caf50';
                    status.textContent = '‚óè';
                } else if (item.status === '‚ñ≤') {
                    status.style.background = '#ff9800';
                    status.textContent = '‚ñ≤';
                } else {
                    status.style.background = '#f44336';
                    status.textContent = '‚úï';
                }
                
                itemDiv.innerHTML = `
                    <div style="flex: 1; font-weight: bold; margin-bottom: 3px;">${item.name}</div>
                    <div style="font-size: 8px; color: #666; margin-bottom: 3px;">${item.amount.toLocaleString()}ÎßåÏõê</div>
                `;
                itemDiv.appendChild(status);
                
                lifestyleItems.appendChild(itemDiv);
            });
            
            lifestyleSection.appendChild(lifestyleItems);
            main.appendChild(lifestyleSection);
            
            container.appendChild(main);

            // ÌôîÎ©¥Ïóê Ïû†Ïãú ÌëúÏãú
            container.style.position = 'fixed';
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';
            container.style.zIndex = '1000';
            container.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
            container.style.border = '1px solid #ddd';

            // 3Ï¥à ÌõÑ Ïà®Í∏∞Í∏∞
            setTimeout(() => {
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.top = '-9999px';
                container.style.transform = 'none';
                container.style.zIndex = 'auto';
            }, 3000);
        }

        // Ïù¥ÎØ∏ÏßÄÎ°ú Îã§Ïö¥Î°úÎìú
        function downloadAsImage() {
            const element = document.getElementById('original-layout');
            
            // ÏõêÎ≥∏ Î†àÏù¥ÏïÑÏõÉÏù¥ ÏóÜÏúºÎ©¥ Î®ºÏ†Ä ÏÉùÏÑ±
            if (!element.innerHTML.trim()) {
                generateOriginalLayout();
                // ÏÉùÏÑ± ÌõÑ Ïû†Ïãú Í∏∞Îã§Î¶∞ Îã§Ïùå Îã§Ïö¥Î°úÎìú
                setTimeout(() => {
                    captureAndDownload();
                }, 100);
            } else {
                captureAndDownload();
            }
        }

        function captureAndDownload() {
            // html2canvas ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º ÎèôÏ†ÅÏúºÎ°ú Î°úÎìú
            if (!window.html2canvas) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = () => {
                    performCapture();
                };
                document.head.appendChild(script);
            } else {
                performCapture();
            }
        }

        function performCapture() {
            const element = document.getElementById('original-layout');
            
            // ÏûÑÏãúÎ°ú ÌôîÎ©¥Ïóê ÌëúÏãú
            element.style.position = 'fixed';
            element.style.left = '0';
            element.style.top = '0';
            element.style.zIndex = '-1';
            
            html2canvas(element, {
                width: 1200,
                height: 800,
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                // Îã§Ïãú Ïà®Í∏∞Í∏∞
                element.style.position = 'absolute';
                element.style.left = '-9999px';
                element.style.top = '-9999px';
                element.style.zIndex = 'auto';
                
                // Îã§Ïö¥Î°úÎìú
                const link = document.createElement('a');
                link.download = `${currentData.personal.name}_Î≥¥Ïû•Î∂ÑÏÑùÏßÄ_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(error => {
                console.error('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                
                // ÏóêÎü¨ ÏãúÏóêÎèÑ ÏöîÏÜå Ïà®Í∏∞Í∏∞
                element.style.position = 'absolute';
                element.style.left = '-9999px';
                element.style.top = '-9999px';
                element.style.zIndex = 'auto';
            });
        }

        // Ï¥àÍ∏∞Ìôî Ïã§Ìñâ
        init();
    </script>
</body>
</html>
