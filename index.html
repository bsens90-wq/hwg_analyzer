// 계산 필드 설정 - 엑셀 수식 및 조건부 서식 구현
function setupFormCalculations() {
  // 모든 입력 필드에 이벤트 리스너 추가
  const allInputs = document.querySelectorAll('.excel-table input[type="number"]');
  allInputs.forEach(input => {
    input.addEventListener('input', function() {
      updateCalculatedFields();
      applyConditionalFormatting();
    });
    input.addEventListener('change', function() {
      updateCalculatedFields();
      applyConditionalFormatting();
    });
  });
  
  // 초기 조건부 서식 적용
  applyConditionalFormatting();
}

// 계산 필드 업데이트 (G16 기반 계산)
function updateCalculatedFields() {
  // G16 값을 기반으로 계산된 필드들 업데이트
  const g16Value = parseFloat(document.getElementById('G16')?.value) || 0;
  
  // G17 = G16 (주요순환계 혈전제거)
  const g17Input = document.getElementById('G17');
  if (g17Input) g17Input.value = g16Value;
  
  // G18 = G16 (주요순환계 혈전용해)
  const g18Input = document.getElementById('G18');
  if (g18Input) g18Input.value = g16Value;
  
  // G19 = G16/2 (주요순환계 중환자실)
  const g19Input = document.getElementById('G19');
  if (g19Input) g19Input.value = Math.floor(g16Value / 2);
}

// 막대그래프 업데이트 함수
function updateBarChart(barId, value) {
  const barFill = document.getElementById(`bar-${barId}`);
  
  if (!barFill) return;
  
  // 값에 따른 색상 및 너비 설정
  let color, width;
  
  if (value >= 100) {
    color = 'bar-green';
    width = '100%';
  } else if (value >= 30) {
    color = 'bar-yellow';
    width = `${Math.min(value, 100)}%`;
  } else if (value > 0) {
    color = 'bar-red';
    width = `${Math.max(value, 10)}%`; // 최소 10% 너비
  } else {
    color = '';
    width = '0%';
  }
  
  // 기존 색상 클래스 제거
  barFill.classList.remove('bar-green', 'bar-yellow', 'bar-red');
  
  // 새로운 색상 및 너비 적용
  if (color) barFill.classList.add(color);
  barFill.style.width = width;
}

// 엑셀 조건부 서식 적용 함수
function applyConditionalFormatting() {
  // B5:B14 막대그래프 (암 관련)
  const cancerInputs = ['C5', 'C6', 'C7', 'C8', 'C9', 'C10', 'C11', 'C12', 'C13', 'C14'];
  cancerInputs.forEach((inputId, index) => {
    const input = document.getElementById(inputId);
    const value = parseFloat(input?.value) || 0;
    const barId = `B${index + 5}`;
    updateBarChart(barId, value);
  });
  
  // F5:F24 막대그래프 (뇌혈관/심장 관련)
  const heartInputs = ['G5', 'G6', 'G7', 'G8', 'G9', 'G10', 'G11', 'G12', 'G13', 'G14', 
                      'G15', 'G16', 'G17', 'G18', 'G19', 'G20', 'G21', 'G22', 'G23', 'G24'];
  heartInputs.forEach((inputId, index) => {
    let value;
    if (inputId === 'G17' || inputId === 'G18') {
      value = parseFloat(document.getElementById('G16')?.value) || 0;
    } else if (inputId === 'G19') {
      value = Math.floor((parseFloat(document.getElementById('G16')?.value) || 0) / 2);
    } else {
      const input = document.getElementById(inputId);
      value = parseFloat(input?.value) || 0;
    }
    const barId = `F${index + 5}`;
    updateBarChart(barId, value);
  });
  
  // 셀 채우기 서식 적용
  applyCellFillFormatting();
}

// 셀 채우기 서식 적용
function applyCellFillFormatting() {
  // J5:J8, J16:J18 - 1보다 크면 녹색, 작으면 빨간색
  const greaterThanOneIds = ['J5', 'J6', 'J7', 'J8', 'J16', 'J17', 'J18'];
  greaterThanOneIds.forEach(id => {
    const input = document.getElementById(id);
    const cell = input?.parentNode;
    if (!input || !cell) return;
    
    const value = parseFloat(input.value) || 0;
    
    // 기존 클래스 제거
    cell.classList.remove('fill-green', 'fill-red');
    
    // 조건에 따른 클래스 추가
    if (value > 1) {
      cell.classList.add('fill-green');
    } else {
      cell.classList.add('fill-red');
    }
  });
  
  // I21, J21, I24, J24 - 1보다 크면 녹색, 작으면 빨간색
  const specialIds = ['I21', 'J21', 'I24', 'J24'];
  specialIds.forEach(id => {
    const input = document.getElementById(id);
    const cell = input?.parentNode;
    if (!input || !cell) return;
    
    const value = parseFloat(input.value) || 0;
    
    // 기존 클래스 제거
    cell.classList.remove('fill-green', 'fill-red');
    
    // 조건에 따른 클래스 추가
    if (value > 1) {
      cell.classList.add('fill-green');
    } else {
      cell.classList.add('fill-red');
    }
  });
  
  // J11 - 20000 이상이면 녹색, 10000 이상이면 겨자색, 10000 미만이면 빨간색
  const j11Input = document.getElementById('J11');
  const j11Cell = j11Input?.parentNode;
  if (j11Input && j11Cell) {
    const value = parseFloat(j11Input.value) || 0;
    
    // 기존 클래스 제거
    j11Cell.classList.remove('fill-green', 'fill-yellow', 'fill-red');
    
    // 조건에 따른 클래스 추가
    if (value >= 20000) {
      j11Cell.classList.add('fill-green');
    } else if (value >= 10000) {
      j11Cell.classList.add('fill-yellow');
    } else {
      j11Cell.classList.add('fill-red');
    }
  }
  
  // J12 - 5000 이상이면 녹색, 3000 이상이면 겨자색, 3000 미만이면 빨간색
  const j12Input = document.getElementById('J12');
  const j12Cell = j12Input?.parentNode;
  if (j12Input && j12Cell) {
    const value = parseFloat(j12Input.value) || 0;
    
    // 기존 클래스 제거
    j12Cell.classList.remove('fill-green', 'fill-yellow', 'fill-red');
    
    // 조건에 따른 클래스 추가
    if (value >= 5000) {
      j12Cell.classList.add('fill-green');
    } else if (value >= 3000) {
      j12Cell.classList.add('fill-yellow');
    } else {
      j12Cell.classList.add('fill-red');
    }
  }
}기 조건부 서식 적용
  applyConditionalFormatting();
}

// 계산 필드 업데이트 (G16 기반 계산)
function updateCalculatedFields() {
  // G16 값을 기반으로 F16~F19 막대그래프 업데이트
  const g16Value = parseFloat(document.getElementById('G16')?.value) || 0;
  
  // F17 = F16 (G17 = G16)
  updateBarChart('F17', g16Value);
  document.getElementById('text-F17').textContent = g16Value || '-';
  
  // F18 = F16 (G18 = G16)
  updateBarChart('F18', g16Value);
  document.getElementById('text-F18').textContent = g16Value || '-';
  
  // F19 = F16/2 (G19 = G16/2)
  const g19Value = Math.floor(g16Value / 2);
  updateBarChart('F19', g19Value);
  document.getElementById('text-F19').textContent = g19Value || '-';
}

// 막대그래프 업데이트 함수
function updateBarChart(barId, value) {
  const barFill = document.getElementById(`bar-${barId}`);
  const barText = document.getElementById(`text-${barId}`);
  
  if (!barFill || !barText) return;
  
  // 값에 따른 색상 및 너비 설정
  let color, width;
  
  if (value >= 100) {
    color = 'bar-green';
    width = '100%';
  } else if (value >= 30) {
    color = 'bar-yellow';
    width = `${Math.min(value, 100)}%`;
  } else if (value > 0) {
    color = 'bar-red';
    width = `${Math.max(value, 10)}%`; // 최소 10% 너비
  } else {
    color = '';
    width = '0%';
  }
  
  // 기존 색상 클래스 제거
  barFill.classList.remove('bar-green', 'bar-yellow', 'bar-red');
  
  // 새로운 색상 및 너비 적용
  if (color) barFill.classList.add(color);
  barFill.style.width = width;
  
  // 텍스트 업데이트
  barText.textContent = value > 0 ? `${value}%` : '-';
}

// 엑셀 조건부 서식 적용 함수
function applyConditionalFormatting() {
  // B5:B14 막대그래프 (암 관련)
  const cancerInputs = ['C5', 'C6', 'C7', 'C8', 'C9', 'C10', 'C11', 'C12', 'C13', 'C14'];
  cancerInputs.forEach((inputId, index) => {
    const input = document.getElementById(inputId);
    const value = parseFloat(input?.value) || 0;
    const barId = `B${index + 5}`;
    updateBarChart(barId, value);
  });
  
  // F5:F24 막대그래프 (뇌혈관/심장 관련)
  const heartInputs = ['G5', 'G6', 'G7', 'G8', 'G9', 'G10', 'G11', 'G12', 'G13', 'G14', 
                      'G15', 'G16', 'G17', 'G18', 'G19', 'G20', 'G21', 'G22', 'G23', 'G24'];
  heartInputs.forEach((inputId, index) => {
    let value;
    if (inputId === 'G17' || inputId === 'G18') {
      value = parseFloat(document.getElementById('G16')?.value) || 0;
    } else if (inputId === 'G19') {
      value = Math.floor((parseFloat(document.getElementById('G16')?.value) || 0) / 2);
    } else {
      const input = document.getElementById(inputId);
      value = parseFloat(input?.value) || 0;
    }
    const barId = `F${index + 5}`;
    updateBarChart(barId, value);
  });
  
  // 셀 채우기 서식 적용
  applyCellFillFormatting();
}

// 셀 채우기 서식 적용
function applyCellFillFormatting() {
  // J5:J8, J16:J18 - 1보다 크면 녹색, 작으면 빨간색
  const greaterThanOneIds = ['J5', 'J6', 'J7', 'J8', 'J16', 'J17', 'J18'];
  greaterThanOneIds.forEach(id => {
    const input = document.getElementById(id);
    const cell = input?.parentNode;
    if (!input || !cell) return;
    
    const value = parseFloat(input.value) || 0;
    
    // 기존 클래스 제거
    cell.classList.remove('fill-green', 'fill-red');
    
    // 조건에 따른 클래스 추가
    if (value > 1) {
      cell.classList.add('fill-green');
    } else {
      cell.classList.add('fill-red');
    }
  });
  
  // I21, J21, I24, J24 - 1보다 크면 녹색, 작으면 빨간색
  const specialIds = ['I21', 'J21', 'I24', 'J24'];
  specialIds.forEach(id => {
    const input = document.getElementById(id);
    const cell = input?.parentNode;
    if (!input || !cell) return;
    
    const value = parseFloat(input.value) || 0;
    
    // 기존 클래스 제거
    cell.classList.remove('fill-green', 'fill-red');
    
    // 조건에 따른 클래스 추가
    if (value > 1) {
      cell.classList.add('fill-green');
    } else {
      cell.classList.add('fill-red');
    }
  });
  
  // J11 - 20000 이상이면 녹색, 10000 이상이면 겨자색, 10000 미만이면 빨간색
  const j11Input = document.getElementById('J11');
  const j11Cell = j11Input?.parentNode;
  if (j11Input && j11Cell) {
    const value = parseFloat(j11Input.value) || 0;
    
    // 기존 클래스 제거
    j11Cell.classList.remove('fill-green', 'fill-yellow', 'fill-red');
    
    // 조건에 따른 클래스 추가
    if (value >= 20000) {
      j11Cell.classList.add('fill-green');
    } else if (value >= 10000) {
      j11Cell.classList.add('fill-yellow');
    } else {
      j11Cell.classList.add('fill-red');
    }
  }
  
  // J12 - 5000 이상이면 녹색, 3000 이상이면 겨자색, 3000 미만이면 빨간색
  const j12Input = document.getElementById('J12');
  const j12Cell = j12Input?.parentNode;
  if (j12Input && j12Cell) {
    const value = parseFloat(j12Input.value) || 0;
    
    // 기존 클래스 제거
    j12Cell.classList.remove('fill-green', 'fill-yellow', 'fill-red');
    
    // 조건에 따른 클래스 추가
    if (value >= 5000) {
      j12Cell.classList.add('fill-green');
    } else if (value >= 3000) {
      j12Cell.classList.add('fill-yellow');
    } else {
      j12Cell.classList.add('fill-red');
    }
  }
}<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>보장분석 앱</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
  <style>
    :root{
      --hanwha:#ff7f00;
      --hanwha-dark:#e67100;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e6e6e6;
    }
    
    *{box-sizing:border-box}
    body{
      margin:0;
      padding-top: 70px;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    
    .header-fixed {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--bg);
      border-bottom: 2px solid #ccc;
      padding: 8px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo-container {
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
    }
    
    .logo-container:hover {
      transform: scale(1.05);
    }
    
    .logo-main {
      font-size: 32px;
      font-weight: 900;
      color: var(--hanwha);
      letter-spacing: 3px;
      text-shadow: 0 2px 4px rgba(255,127,0,0.2);
      margin: 0;
      line-height: 1;
    }
    
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:1rem;
    }
    
    .app-title{
      font-size:24px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
    }
    
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:20px;
      margin-bottom:20px;
    }
    
    button{
      width:100%;
      padding:12px 14px;
      background:var(--hanwha);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
    }
    
    button:hover{background:var(--hanwha-dark)}
    
    button.secondary{
      background:#6c757d;
      margin-bottom:0;
    }
    
    button.secondary:hover{background:#545b62}
    
    .saved-item{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    
    .saved-item:hover{
      background:#f8f9fa;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.1);
    }
    
    .saved-item-title{
      font-size:16px;
      font-weight:600;
      color:var(--text);
      margin-bottom:5px;
    }
    
    .saved-item-date{
      font-size:12px;
      color:var(--muted);
    }
    
    .meta{
      color:var(--muted); 
      font-size:13px; 
      margin-top:.25rem;
      text-align:center;
    }
    
    .error{
      color:#d93025; 
      font-size:14px; 
      margin-top:.5rem;
      text-align:center;
    }
    
    .success{
      color:#28a745; 
      font-size:14px; 
      margin-top:.5rem;
      text-align:center;
    }

    /* 엑셀 테이블 스타일 */
    .excel-container {
      width: 100%;
      max-width: 100%;
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .excel-title {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 20px;
      padding: 10px;
      border-bottom: 2px solid #ff7f00;
    }
    
    .excel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      font-family: 'Malgun Gothic', Arial, sans-serif;
    }
    
    .excel-table th,
    .excel-table td {
      border: 1px solid #333;
      padding: 6px 4px;
      text-align: center;
      vertical-align: middle;
      min-width: 40px;
    }
    
    .excel-table th {
      background-color: #d9d9d9;
      font-weight: bold;
    }
    
    .excel-table .section-header {
      background-color: #b8b8b8;
      font-weight: bold;
      font-size: 14px;
    }
    
    .excel-table .label-cell {
      text-align: left;
      padding-left: 8px;
      background-color: #f5f5f5;
      font-weight: 500;
    }
    
    .excel-table .input-cell {
      background-color: #fff;
      text-align: right;
      padding-right: 8px;
      font-weight: 600;
    }
    
    .excel-table .calculated-cell {
      background-color: #f0f8ff;
      text-align: right;
      padding-right: 8px;
      font-weight: 600;
      color: #0066cc;
    }
    
    .excel-table .unit-cell {
      text-align: center;
      font-size: 11px;
      background-color: #f9f9f9;
    }

    /* 입력 모드에서만 보이는 스타일 */
    .input-mode .excel-table input {
      border: none;
      background: transparent;
      width: 100%;
      text-align: right;
      padding: 2px 4px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .input-mode .excel-table input:focus {
      background-color: #ffffcc;
      outline: 2px solid #ff7f00;
    }
    
    .input-mode .customer-name-input {
      text-align: center !important;
      font-size: 16px !important;
      font-weight: bold !important;
      background-color: #fff !important;
      border: 2px solid #ff7f00 !important;
      border-radius: 4px !important;
      padding: 8px !important;
    }

    /* 조건부 서식 - 엑셀 규칙에 따른 색상 변경 */
    
    /* 가로 막대그래프 스타일 (B5:B14, F5:F24) */
    .bar-chart-cell {
      position: relative;
      background: white;
      overflow: hidden;
    }
    
    .bar-chart-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 1;
      transition: width 0.3s ease;
    }
    
    .bar-chart-text {
      position: relative;
      z-index: 2;
      padding: 6px 4px;
      color: black;
      font-weight: 600;
    }
    
    .bar-green { background-color: #92d050; }
    .bar-yellow { background-color: #ffff00; }
    .bar-red { background-color: #ff9999; }
    
    /* 셀 채우기 서식 */
    .fill-green {
      background-color: #92d050 !important;
      color: #000 !important;
      font-weight: 600 !important;
    }
    
    .fill-yellow {
      background-color: #ffff00 !important;
      color: #000 !important;
      font-weight: 600 !important;
    }
    
    .fill-red {
      background-color: #ff9999 !important;
      color: #000 !important;
      font-weight: 600 !important;
    }
    
    /* 계산된 셀 스타일 */
    .calculated-cell {
      background-color: #f0f8ff !important;
      color: #0066cc !important;
      font-style: italic !important;
    }

    /* 버튼 영역 */
    .button-area {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (max-width: 768px) {
      .screen {
        padding: 0.5rem;
      }
      
      .excel-container {
        padding: 10px;
      }
      
      .excel-table {
        font-size: 11px;
      }
      
      .excel-table th,
      .excel-table td {
        padding: 4px 2px;
        min-width: 35px;
      }
      
      .input-mode .excel-table input {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="header-fixed">
    <div class="logo-container" onclick="goHome()">
      <div class="logo-main">보장분석</div>
    </div>
  </div>

  <!-- 메뉴 화면 -->
  <section id="menuScreen" class="screen">
    <div class="app-title">보장분석 앱</div>
    <div class="card">
      <h2 style="margin:0 0 1.5rem 0;">메뉴 선택</h2>
      
      <button id="inputMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">입력하기</span>
        <span style="font-size:14px; opacity:0.8;">새로운 보장분석 작성</span>
      </button>
      
      <button id="loadMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">불러오기</span>
        <span style="font-size:14px; opacity:0.8;">저장된 보장분석 불러오기</span>
      </button>

      <div class="meta" style="margin-top:2rem;">Copyright 2025 보장분석 앱</div>
    </div>
  </section>

  <!-- 입력 화면 -->
  <section id="inputScreen" class="screen input-mode" style="display:none;">
    <div class="app-title">보장분석 입력</div>
    
    <div class="excel-container">
      <table class="excel-table" id="analysisTable">
        <!-- 제목 행 -->
        <tr>
          <td colspan="4" class="excel-title">
            <input type="text" id="customerName" placeholder="(고객명)" class="customer-name-input">님의 한 장 요약 보장분석
          </td>
        </tr>
        
        <!-- 헤더 행 -->
        <tr>
          <th class="section-header">암</th>
          <th class="section-header">보장내용</th>
          <th class="section-header">가입한도(만원)</th>
          <th class="section-header">뇌혈관/심장</th>
          <th class="section-header">보장내용</th>
          <th class="section-header">가입한도(만원)</th>
          <th class="section-header">기타</th>
          <th class="section-header">보장내용</th>
          <th class="section-header">가입한도</th>
        </tr>
        
        <!-- 데이터 행들 -->
        <tr>
          <td rowspan="10" class="section-header" style="writing-mode: vertical-lr; text-align: center;">암관련보장</td>
          <td class="label-cell">일반암진단비</td>
          <td class="bar-chart-cell" data-bar="B5">
            <div class="bar-chart-fill" id="bar-B5"></div>
            <div class="bar-chart-text" id="text-B5">
              <input type="number" id="C5" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td rowspan="10" class="section-header" style="writing-mode: vertical-lr; text-align: center;">뇌혈관심장관련보장</td>
          <td class="label-cell">뇌혈관질환진단비</td>
          <td class="bar-chart-cell" data-bar="F5">
            <div class="bar-chart-fill" id="bar-F5"></div>
            <div class="bar-chart-text" id="text-F5">
              <input type="number" id="G5" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td rowspan="4" class="section-header" style="writing-mode: vertical-lr; text-align: center;">의료실비</td>
          <td class="label-cell">(질병)입원한도</td>
          <td class="input-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="J5" placeholder="0" data-condition="greater-than-1"><span class="unit-cell">만원</span></td>
        </tr>
        <tr>
          <td class="label-cell">통합암진단비</td>
          <td class="bar-chart-cell" data-bar="B6">
            <div class="bar-chart-fill" id="bar-B6"></div>
            <div class="bar-chart-text" id="text-B6">
              <input type="number" id="C6" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">뇌졸중진단비</td>
          <td class="bar-chart-cell" data-bar="F6">
            <div class="bar-chart-fill" id="bar-F6"></div>
            <div class="bar-chart-text" id="text-F6">
              <input type="number" id="G6" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">(질병)통원한도</td>
          <td class="input-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="J6" placeholder="0" data-condition="greater-than-1"><span class="unit-cell">일</span></td>
        </tr>
        <tr>
          <td class="label-cell">전이암진단비</td>
          <td class="bar-chart-cell" data-bar="B7">
            <div class="bar-chart-fill" id="bar-B7"></div>
            <div class="bar-chart-text" id="text-B7">
              <input type="number" id="C7" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">허혈성심장질환진단비</td>
          <td class="bar-chart-cell" data-bar="F7">
            <div class="bar-chart-fill" id="bar-F7"></div>
            <div class="bar-chart-text" id="text-F7">
              <input type="number" id="G7" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">(상해)입원한도</td>
          <td class="input-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="J7" placeholder="0" data-condition="greater-than-1"><span class="unit-cell">만원</span></td>
        </tr>
        <tr>
          <td class="label-cell">암특정치료비</td>
          <td class="bar-chart-cell" data-bar="B8">
            <div class="bar-chart-fill" id="bar-B8"></div>
            <div class="bar-chart-text" id="text-B8">
              <input type="number" id="C8" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">심근경색진단비</td>
          <td class="bar-chart-cell" data-bar="F8">
            <div class="bar-chart-fill" id="bar-F8"></div>
            <div class="bar-chart-text" id="text-F8">
              <input type="number" id="G8" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">(상해)통원한도</td>
          <td class="input-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="J8" placeholder="0" data-condition="greater-than-1"><span class="unit-cell">일</span></td>
        </tr>
        <tr>
          <td class="label-cell">암특정치료비(비급여)</td>
          <td class="bar-chart-cell" data-bar="B9">
            <div class="bar-chart-fill" id="bar-B9"></div>
            <div class="bar-chart-text" id="text-B9">
              <input type="number" id="C9" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">뇌혈관질환수술비</td>
          <td class="bar-chart-cell" data-bar="F9">
            <div class="bar-chart-fill" id="bar-F9"></div>
            <div class="bar-chart-text" id="text-F9">
              <input type="number" id="G9" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td rowspan="3" class="section-header" style="writing-mode: vertical-lr; text-align: center;">운전자</td>
          <td class="label-cell">형사합의금</td>
          <td class="input-cell conditional-cell" data-condition="j11"><input type="number" id="J11" placeholder="0" data-condition="j11"><span class="unit-cell">만원</span></td>
        </tr>
        <tr>
          <td class="label-cell">표적항암치료비</td>
          <td class="bar-chart-cell" data-bar="B10">
            <div class="bar-chart-fill" id="bar-B10"></div>
            <div class="bar-chart-text" id="text-B10">
              <input type="number" id="C10" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">뇌졸중수술비</td>
          <td class="bar-chart-cell" data-bar="F10">
            <div class="bar-chart-fill" id="bar-F10"></div>
            <div class="bar-chart-text" id="text-F10">
              <input type="number" id="G10" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">변호사선임비</td>
          <td class="input-cell conditional-cell" data-condition="j12"><input type="number" id="J12" placeholder="0" data-condition="j12"><span class="unit-cell">만원</span></td>
        </tr>
        <tr>
          <td class="label-cell">중입자치료비</td>
          <td class="bar-chart-cell" data-bar="B11">
            <div class="bar-chart-fill" id="bar-B11"></div>
            <div class="bar-chart-text" id="text-B11">
              <input type="number" id="C11" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">허혈성심장질환수술비</td>
          <td class="bar-chart-cell" data-bar="F11">
            <div class="bar-chart-fill" id="bar-F11"></div>
            <div class="bar-chart-text" id="text-F11">
              <input type="number" id="G11" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">간병인일당</td>
          <td class="input-cell"><input type="number" id="J13" placeholder="0"><span class="unit-cell">만원</span></td>
        </tr>
        <tr>
          <td class="label-cell">암수술비</td>
          <td class="bar-chart-cell" data-bar="B12">
            <div class="bar-chart-fill" id="bar-B12"></div>
            <div class="bar-chart-text" id="text-B12">
              <input type="number" id="C12" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">심근경색수술비</td>
          <td class="bar-chart-cell" data-bar="F12">
            <div class="bar-chart-fill" id="bar-F12"></div>
            <div class="bar-chart-text" id="text-F12">
              <input type="number" id="G12" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td rowspan="6" class="section-header" style="writing-mode: vertical-lr; text-align: center;">간병비</td>
          <td class="label-cell">지원 / 사용</td>
          <td class="input-cell">-</td>
        </tr>
        <tr>
          <td class="label-cell">다빈치로봇수술비</td>
          <td class="bar-chart-cell" data-bar="B13">
            <div class="bar-chart-fill" id="bar-B13"></div>
            <div class="bar-chart-text" id="text-B13">
              <input type="number" id="C13" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">뇌졸중혈전용해</td>
          <td class="bar-chart-cell" data-bar="F13">
            <div class="bar-chart-fill" id="bar-F13"></div>
            <div class="bar-chart-text" id="text-F13">
              <input type="number" id="G13" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">요양병원 외</td>
          <td class="input-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="J16" placeholder="0" data-condition="greater-than-1"><span class="unit-cell">만원</span></td>
        </tr>
        <tr>
          <td class="label-cell">1-5종수술비(5종)</td>
          <td class="bar-chart-cell" data-bar="B14">
            <div class="bar-chart-fill" id="bar-B14"></div>
            <div class="bar-chart-text" id="text-B14">
              <input type="number" id="C14" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">심근경색혈전용해</td>
          <td class="bar-chart-cell" data-bar="F14">
            <div class="bar-chart-fill" id="bar-F14"></div>
            <div class="bar-chart-text" id="text-F14">
              <input type="number" id="G14" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">요양병원</td>
          <td class="input-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="J17" placeholder="0" data-condition="greater-than-1"><span class="unit-cell">만원</span></td>
        </tr>
        
        <!-- 추가 행들 계속... -->
        <tr>
          <td rowspan="10" class="section-header" style="writing-mode: vertical-lr; text-align: center;">기타특약</td>
          <td class="label-cell">2대특정치료비</td>
          <td class="bar-chart-cell" data-bar="F15">
            <div class="bar-chart-fill" id="bar-F15"></div>
            <div class="bar-chart-text" id="text-F15">
              <input type="number" id="G15" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">간호간병통합</td>
          <td class="input-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="J18" placeholder="0" data-condition="greater-than-1"><span class="unit-cell">만원</span></td>
        </tr>
        <tr>
          <td class="label-cell">주요순환계(수술)</td>
          <td class="bar-chart-cell" data-bar="F16">
            <div class="bar-chart-fill" id="bar-F16"></div>
            <div class="bar-chart-text" id="text-F16">
              <input type="number" id="G16" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">일상생활배상책임</td>
          <td class="input-cell">-</td>
        </tr>
        <tr>
          <td class="label-cell">주요순환계(혈전제거)</td>
          <td class="bar-chart-cell calculated-cell" data-bar="F17">
            <div class="bar-chart-fill" id="bar-F17"></div>
            <div class="bar-chart-text" id="text-F17">
              <input type="number" id="G17" placeholder="0" readonly style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;color:#0066cc;">
            </div>
          </td>
          <td class="label-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="I21" placeholder="0" style="width:60px;" data-condition="greater-than-1"> <input type="number" id="J21" placeholder="0" style="width:60px;" data-condition="greater-than-1"></td>
        </tr>
        <tr>
          <td class="label-cell">주요순환계(혈전용해)</td>
          <td class="bar-chart-cell calculated-cell" data-bar="F18">
            <div class="bar-chart-fill" id="bar-F18"></div>
            <div class="bar-chart-text" id="text-F18">
              <input type="number" id="G18" placeholder="0" readonly style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;color:#0066cc;">
            </div>
          </td>
          <td class="label-cell">화재벌금</td>
          <td class="input-cell">-</td>
        </tr>
        <tr>
          <td class="label-cell">주요순환계(중환자실)</td>
          <td class="bar-chart-cell calculated-cell" data-bar="F19">
            <div class="bar-chart-fill" id="bar-F19"></div>
            <div class="bar-chart-text" id="text-F19">
              <input type="number" id="G19" placeholder="0" readonly style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;color:#0066cc;">
            </div>
          </td>
          <td class="label-cell conditional-cell" data-condition="greater-than-1"><input type="number" id="I24" placeholder="0" style="width:60px;" data-condition="greater-than-1"> <input type="number" id="J24" placeholder="0" style="width:60px;" data-condition="greater-than-1"></td>
        </tr>
        <tr>
          <td class="label-cell">혈전제거치료비</td>
          <td class="bar-chart-cell" data-bar="F20">
            <div class="bar-chart-fill" id="bar-F20"></div>
            <div class="bar-chart-text" id="text-F20">
              <input type="number" id="G20" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">-</td>
          <td class="input-cell">-</td>
        </tr>
        <tr>
          <td class="label-cell">1-5종수술비(3종)</td>
          <td class="bar-chart-cell" data-bar="F21">
            <div class="bar-chart-fill" id="bar-F21"></div>
            <div class="bar-chart-text" id="text-F21">
              <input type="number" id="G21" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">-</td>
          <td class="input-cell">-</td>
        </tr>
        <tr>
          <td class="label-cell">1-5종수술비(5종)</td>
          <td class="bar-chart-cell" data-bar="F22">
            <div class="bar-chart-fill" id="bar-F22"></div>
            <div class="bar-chart-text" id="text-F22">
              <input type="number" id="G22" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">-</td>
          <td class="input-cell">-</td>
        </tr>
        <tr>
          <td class="label-cell">124대질병수술비(특정10대)</td>
          <td class="bar-chart-cell" data-bar="F23">
            <div class="bar-chart-fill" id="bar-F23"></div>
            <div class="bar-chart-text" id="text-F23">
              <input type="number" id="G23" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">-</td>
          <td class="input-cell">-</td>
        </tr>
        <tr>
          <td class="label-cell">7대기관수술비(뇌/심) 관혈</td>
          <td class="bar-chart-cell" data-bar="F24">
            <div class="bar-chart-fill" id="bar-F24"></div>
            <div class="bar-chart-text" id="text-F24">
              <input type="number" id="G24" placeholder="0" style="background:transparent;border:none;width:100%;text-align:center;font-weight:600;">
            </div>
          </td>
          <td class="label-cell">-</td>
          <td class="input-cell">-</td>
        </tr>
      </table>
    </div>

    <!-- 버튼 영역 -->
    <div class="button-area">
      <button id="saveImageBtn">이미지로 저장하기</button>
      <button id="loadFromMenuBtn" class="secondary">불러오기</button>
      <button id="backToMenuBtn" class="secondary">뒤로가기</button>
      
      <div id="statusMessage" class="meta"></div>
    </div>
  </section>

  <!-- 불러오기 화면 -->
  <section id="loadScreen" class="screen" style="display:none;">
    <div class="app-title">저장된 보장분석</div>
    <div class="card">
      <h2 style="margin:0 0 1rem 0;">저장된 목록</h2>
      <div id="savedList">
        <!-- 저장된 항목들이 여기에 표시됩니다 -->
      </div>
      <button id="backToMenuFromLoadBtn" class="secondary" style="margin-top:20px;">뒤로가기</button>
    </div>
  </section>

<script>
let currentScreen = 'menu';
let savedData = JSON.parse(localStorage.getItem('insuranceAnalysisData')) || [];

// 화면 전환 함수
function hideAllScreens() {
  document.getElementById("menuScreen").style.display = "none";
  document.getElementById("inputScreen").style.display = "none";
  document.getElementById("loadScreen").style.display = "none";
}

function navigateToScreen(screen) {
  currentScreen = screen;
  hideAllScreens();
  
  switch(screen) {
    case 'menu':
      document.getElementById("menuScreen").style.display = "flex";
      break;
    case 'input':
      document.getElementById("inputScreen").style.display = "flex";
      setupFormCalculations();
      break;
    case 'load':
      document.getElementById("loadScreen").style.display = "flex";
      displaySavedList();
      break;
  }
}

// 홈으로 이동
function goHome() {
  navigateToScreen('menu');
}

// 계산 필드 설정 - 엑셀 수식 및 조건부 서식 구현
function setupFormCalculations() {
  // 모든 입력 필드에 이벤트 리스너 추가
  const allInputs = document.querySelectorAll('.excel-table input[type="number"]');
  allInputs.forEach(input => {
    input.addEventListener('input', function() {
      updateCalculatedFields();
      applyConditionalFormatting();
    });
    input.addEventListener('change', function() {
      updateCalculatedFields();
      applyConditionalFormatting();
    });
  });
  
  // 초

// 데이터 저장 및 이미지 생성
function saveData() {
  const customerName = document.getElementById('customerName').value.trim();
  
  if (!customerName) {
    showMessage('고객명을 입력해주세요.', 'error');
    return;
  }
  
  // 데이터 수집
  const data = {
    id: Date.now(),
    customerName: customerName,
    timestamp: new Date().toLocaleString('ko-KR'),
    values: {}
  };
  
  // 모든 입력 필드 값 저장
  const inputFields = [
    'C5', 'C6', 'C7', 'C8', 'C9', 'C10', 'C11', 'C12', 'C13', 'C14',
    'G5', 'G6', 'G7', 'G8', 'G9', 'G10', 'G11', 'G12', 'G13', 'G14', 
    'G15', 'G16', 'G17', 'G18', 'G19', 'G20', 'G21', 'G22', 'G23', 'G24',
    'J5', 'J6', 'J7', 'J8', 'J11', 'J12', 'J13', 'J16', 'J17', 'J18', 'I21', 'J21', 'I24', 'J24'
  ];
  
  inputFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      data.values[fieldId] = parseFloat(field.value) || 0;
    }
  });
  
  // 로컬스토리지에 저장
  const existingIndex = savedData.findIndex(item => item.customerName === customerName);
  if (existingIndex >= 0) {
    savedData[existingIndex] = data;
  } else {
    savedData.push(data);
  }
  
  localStorage.setItem('insuranceAnalysisData', JSON.stringify(savedData));
  
  showMessage('저장되었습니다!', 'success');
  
  // 엑셀과 동일한 이미지 생성
  generateExcelImage(data);
}

// 엑셀 인쇄 형태와 동일한 이미지 생성
function generateExcelImage(data) {
  // 현재 테이블을 복사하여 이미지용 테이블 생성
  const originalTable = document.getElementById('analysisTable');
  const clonedTable = originalTable.cloneNode(true);
  
  // 복사된 테이블에서 input을 텍스트로 변경
  const inputs = clonedTable.querySelectorAll('input');
  inputs.forEach(input => {
    const value = input.value || '0';
    const span = document.createElement('span');
    
    if (input.id === 'customerName') {
      span.textContent = value || '(고객명)';
      span.style.fontWeight = 'bold';
      span.style.fontSize = '16px';
    } else {
      span.textContent = value === '0' ? '-' : value;
      span.style.fontWeight = '600';
    }
    
    input.parentNode.replaceChild(span, input);
  });
  
  // 이미지 생성용 컨테이너 생성
  const imageContainer = document.createElement('div');
  imageContainer.style.cssText = `
    background: white;
    padding: 20px;
    font-family: 'Malgun Gothic', Arial, sans-serif;
    width: 800px;
    position: absolute;
    top: -9999px;
    left: -9999px;
  `;
  
  imageContainer.appendChild(clonedTable);
  document.body.appendChild(imageContainer);
  
  // html2canvas를 사용하여 이미지 생성 (CDN에서 로드)
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
  script.onload = function() {
    html2canvas(imageContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      useCORS: true,
      allowTaint: true
    }).then(canvas => {
      // 이미지 다운로드
      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${data.customerName}_보장분석_${new Date().toISOString().slice(0,10).replace(/-/g, '')}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage('이미지가 다운로드되었습니다!', 'success');
      }, 'image/png');
      
      // 임시 컨테이너 제거
      document.body.removeChild(imageContainer);
    }).catch(error => {
      console.error('이미지 생성 실패:', error);
      document.body.removeChild(imageContainer);
      showMessage('이미지 생성에 실패했습니다.', 'error');
    });
  };
  
  script.onerror = function() {
    // html2canvas 로드 실패시 Canvas API 사용
    document.body.removeChild(imageContainer);
    generateCanvasImage(data);
  };
  
  document.head.appendChild(script);
}

// Canvas API를 사용한 이미지 생성 (폴백)
function generateCanvasImage(data) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  canvas.width = 800;
  canvas.height = 1000;
  
  // 배경
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // 제목
  ctx.fillStyle = '#000';
  ctx.font = 'bold 20px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(`${data.customerName}님의 한 장 요약 보장분석`, canvas.width / 2, 40);
  
  // 간단한 테이블 형태로 그리기
  let y = 80;
  const leftCol = 50;
  const rightCol = 400;
  
  ctx.font = '14px Arial';
  ctx.textAlign = 'left';
  
  // 주요 데이터만 표시
  const importantFields = [
    { id: 'C5', label: '일반암진단비' },
    { id: 'C8', label: '암특정치료비' },
    { id: 'G5', label: '뇌혈관질환진단비' },
    { id: 'G6', label: '뇌졸중진단비' },
    { id: 'J5', label: '질병입원한도' },
    { id: 'J11', label: '형사합의금' }
  ];
  
  importantFields.forEach(field => {
    const value = data.values[field.id] || 0;
    if (value > 0) {
      ctx.fillText(field.label, leftCol, y);
      ctx.textAlign = 'right';
      ctx.fillText(`${value.toLocaleString()}만원`, rightCol, y);
      ctx.textAlign = 'left';
      y += 25;
    }
  });
  
  // 다운로드
  canvas.toBlob(function(blob) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${data.customerName}_보장분석_${new Date().toISOString().slice(0,10).replace(/-/g, '')}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 'image/png');
}

// 데이터 불러오기
function loadData(id) {
  const data = savedData.find(item => item.id === id);
  if (!data) {
    showMessage('데이터를 찾을 수 없습니다.', 'error');
    return;
  }
  
  // 고객명 설정
  document.getElementById('customerName').value = data.customerName;
  
  // 모든 필드 값 설정
  Object.keys(data.values).forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.value = data.values[fieldId];
    }
  });
  
  // 계산 필드 업데이트
  setupFormCalculations();
  const event = new Event('input');
  const g16 = document.getElementById('G16');
  if (g16) g16.dispatchEvent(event);
  
  navigateToScreen('input');
  showMessage(`${data.customerName}의 데이터를 불러왔습니다.`, 'success');
}

// 저장된 목록 표시
function displaySavedList() {
  const savedList = document.getElementById('savedList');
  
  if (savedData.length === 0) {
    savedList.innerHTML = '<div class="meta">저장된 보장분석이 없습니다.</div>';
    return;
  }
  
  savedList.innerHTML = savedData.map(item => `
    <div class="saved-item" onclick="loadData(${item.id})">
      <div class="saved-item-title">${item.customerName}님의 보장분석</div>
      <div class="saved-item-date">${item.timestamp}</div>
    </div>
  `).join('');
}

// 메시지 표시
function showMessage(message, type = 'info') {
  const statusMessage = document.getElementById('statusMessage');
  statusMessage.textContent = message;
  statusMessage.className = `meta ${type}`;
  
  setTimeout(() => {
    statusMessage.textContent = '';
    statusMessage.className = 'meta';
  }, 3000);
}

// 이벤트 리스너 설정
document.addEventListener('DOMContentLoaded', () => {
  // 메뉴 버튼들
  document.getElementById('inputMenuBtn').addEventListener('click', () => navigateToScreen('input'));
  document.getElementById('loadMenuBtn').addEventListener('click', () => navigateToScreen('load'));
  
  // 입력 화면 버튼들
  document.getElementById('saveImageBtn').addEventListener('click', saveData);
  document.getElementById('loadFromMenuBtn').addEventListener('click', () => navigateToScreen('load'));
  document.getElementById('backToMenuBtn').addEventListener('click', () => navigateToScreen('menu'));
  
  // 불러오기 화면 버튼들
  document.getElementById('backToMenuFromLoadBtn').addEventListener('click', () => navigateToScreen('menu'));
  
  // 초기 화면 설정
  navigateToScreen('menu');
});

</script>

</body>
</html>
