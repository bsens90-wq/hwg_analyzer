<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>보장분석 한 장 요약</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
  <style>
    :root{
      --hanwha:#ff6600;
      --hanwha-dark:#e65100;
      --hanwha-light:#fff3e0;
      --hanwha-accent:#ff8f00;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#333;
      --muted:#777;
      --border:#e0e0e0;
      --before-bg:#f5f5f5;
      --after-bg:#fff8f0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding-top: 20px;
      font-family: 'Noto Sans KR', Arial, system-ui, -apple-system, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    
    .screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem 1rem;
    }
    .app-title{
      font-size:28px;
      font-weight:700;
      color:var(--hanwha);
      margin-bottom:2rem;
      text-align:center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.1);
      padding:24px;
      border: 1px solid var(--border);
    }
    .card.wide{
      max-width:1400px;
    }
    h2{margin:0 0 .75rem 0; color: var(--hanwha);}
    h3 {
      margin: 1.5rem 0 1rem 0;
      color: var(--hanwha);
      font-size: 18px;
      font-weight: 700;
      border-bottom: 2px solid var(--hanwha);
      padding-bottom: 8px;
    }
    .section-notice {
      background: var(--hanwha-light);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      color: var(--hanwha-dark);
      border: 1px solid #ffcc80;
    }
    .row{margin-bottom:.75rem}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:14px;
      outline:none;
      background:#fff;
      transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--hanwha);
      box-shadow: 0 0 0 3px rgba(255,102,0,0.1);
    }
    button{
      width:100%;
      padding:14px;
      background:linear-gradient(135deg, var(--hanwha), var(--hanwha-accent));
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:16px;
      margin-bottom:8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255,102,0,0.3);
    }
    button:hover{
      background:linear-gradient(135deg, var(--hanwha-dark), var(--hanwha));
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255,102,0,0.4);
    }
    button.secondary{
      background:linear-gradient(135deg, #6c757d, #545b62);
      margin-bottom:0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button.secondary:hover{
      background:linear-gradient(135deg, #545b62, #6c757d);
    }
    button.small{
      width:auto;
      padding:6px 10px;
      font-size:12px;
      margin:2px;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:.25rem}
    .error{color:#d93025; font-size:14px; margin-top:.5rem}
    .success{color:#28a745; font-size:14px; margin-top:.5rem}
    
    /* 이미지 업로드/미리보기 */
    .image-upload-area {
      border: 2px dashed var(--hanwha);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      background: linear-gradient(135deg, #fff5f0, #fffaf5);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .image-upload-area:hover {
      border-color: var(--hanwha-dark);
      background: linear-gradient(135deg, #fff0e8, #fff5ed);
      transform: scale(1.02);
    }
    
    .image-upload-area.drag-over {
      border-color: var(--hanwha-dark);
      background: var(--hanwha-light);
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    /* 변경 전/후 테이블 스타일 */
    .input-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 1rem 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .input-table th,
    .input-table td {
      border: 1px solid var(--border);
      padding: 10px 12px;
      text-align: left;
      vertical-align: middle;
    }
    
    .input-table thead th {
      background: linear-gradient(135deg, var(--hanwha), var(--hanwha-accent));
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 12px;
      font-size: 14px;
    }
    
    .input-table tbody th {
      background: var(--bg);
      font-weight: 600;
      width: 40%;
      font-size: 13px;
      color: var(--text);
    }
    
    .input-table .before-column {
      background: var(--before-bg);
      width: 30%;
      position: relative;
    }
    
    .input-table .after-column {
      background: var(--after-bg);
      width: 30%;
      position: relative;
    }
    
    .input-table input {
      width: 100%;
      padding: 6px 8px;
      margin: 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      display: inline-block;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 12px;
    }
    
    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-modal:hover,
    .close-modal:focus {
      color: #000;
    }
    
    .standard-amount-input {
      width: 100px;
      padding: 5px;
      margin-left: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .section-header {
      background: linear-gradient(135deg, var(--hanwha), var(--hanwha-accent));
      color: white;
      font-weight: 700;
      text-align: center;
      font-size: 15px;
    }
    
    .section-header td {
      padding: 10px;
      border: none;
    }
    
    /* 간병인 라디오 버튼 스타일 */
    .radio-group {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }
    
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .radio-group input[type="radio"] {
      width: auto;
      margin: 0;
    }
    
    /* 저장된 데이터 목록 */
    .saved-item {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .saved-item:hover {
      background: var(--hanwha-light);
      border-color: var(--hanwha);
      transform: translateX(5px);
    }
    
    .saved-item-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .saved-item-date {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* 로딩 스피너 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--hanwha);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 반응형 */
    @media (max-width: 768px) {
      .card {
        max-width: 100%;
        margin: 0 10px;
      }
      
      .input-table th,
      .input-table td {
        padding: 6px 8px;
        font-size: 12px;
      }
      
      .input-table tbody th {
        font-size: 12px;
      }
      
      .input-table input {
        font-size: 12px;
      }
    }
    
    .hidden {
      display: none;
    }
    
    /* 숨겨진 출력용 컨테이너 */
    #hiddenPrintContainer {
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: 3900px;
    }
    
    /* 자동계산 표시 스타일 */
    .auto-calculated {
      background-color: #e8f5e8 !important;
      border: 1px solid #4caf50 !important;
    }
    
    .auto-calculated::after {
      content: "🔢";
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <!-- 메뉴 화면 -->
  <section id="menuScreen" class="screen">
    <div class="app-title">보장분석 한 장 요약</div>
    <div class="card">
      <h2 style="margin-bottom:1.5rem; text-align:center;">메뉴 선택</h2>
      
      <button id="inputMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">📝 입력하기</span>
        <span style="font-size:14px; opacity:0.9;">보장분석지 촬영/업로드</span>
      </button>
      
      <button id="loadMenuBtn" style="margin-bottom:1rem;">
        <span style="font-size:18px; display:block; margin-bottom:4px;">📂 불러오기</span>
        <span style="font-size:14px; opacity:0.9;">저장된 보장분석 목록에서 선택</span>
      </button>
      
      <div class="meta" style="margin-top:2rem; text-align:center; color: var(--muted); font-size: 12px;">
        Copyright 2025 하세봉 all rights reserved.
      </div>
    </div>
  </section>

  <!-- 입력 화면 -->
  <section id="inputScreen" class="screen hidden">
    <div class="app-title">보장금액 입력하기</div>
    <div class="card wide">
      <div class="row">
        <div class="image-upload-area" id="imageUploadArea">
          <div id="uploadText">
            📷 여기를 터치하여 이미지를 업로드하세요<br>
            <span style="font-size: 12px; color: var(--muted);">드래그 앤 드롭도 가능합니다</span>
          </div>
          <img id="imagePreview" class="image-preview hidden" alt="미리보기">
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
        </div>
      </div>
      
      <div class="row">
        <button id="ocrProcessBtn" disabled>🔍 자동 스캔하기</button>
        <div id="ocrStatus" class="hint"></div>
      </div>
      
      <!-- 고객 기본 정보 -->
      <div class="row">
        <h3>고객 기본 정보</h3>
        <table class="input-table">
          <tr>
            <th style="width: 30%;">고객명</th>
            <td style="width: 70%;"><input type="text" id="customerName" placeholder="고객명을 입력하세요"></td>
          </tr>
          <tr>
            <th style="width: 30%;">생년월일</th>
            <td style="width: 70%;"><input type="text" id="birthDate" placeholder="YY-MM-DD"></td>
          </tr>
        </table>
      </div>
      
      <!-- 담보 입력 테이블 (변경 전/후 통합) -->
      <div class="row">
        <h3>담보 항목별 보장금액</h3>
        <div style="text-align: right; margin-bottom: 10px;">
          <button id="standardAmountBtn" class="small" style="background: linear-gradient(135deg, #ff6600, #ff8f00); color: white; padding: 8px 16px; font-size: 13px; width: auto; margin: 0;">
            ⚙️ 표준금액 설정
          </button>
        </div>
        <div class="section-notice">
          ⚠️ OCR 인식 후 변경 전/후 값이 동일하게 세팅됩니다. 필요시 수동으로 수정해주세요.<br>
          🔢 주요순환계(수술) 입력 시 관련 항목들이 자동 계산됩니다.
        </div>
        <table class="input-table" id="coverageTable">
          <thead>
            <tr>
              <th>담보 항목</th>
              <th style="background: #f5f5f5; color: #333;">변경 전</th>
              <th style="background: var(--hanwha-light); color: #333;">변경 후</th>
            </tr>
          </thead>
          <tbody id="coverageTableBody">
            <!-- 담보 항목들이 여기에 동적으로 생성됩니다 -->
          </tbody>
        </table>
      </div>
      
      <!-- 간병인일당 -->
      <div class="row">
        <h3>간병인일당 설정</h3>
        <table class="input-table">
          <tr>
            <th>간병인일당 종류</th>
            <td colspan="2">
              <div class="radio-group">
                <label>
                  <input type="radio" name="caregiverOption" value="use" id="caregiverUse" checked>
                  사용
                </label>
                <label>
                  <input type="radio" name="caregiverOption" value="support" id="caregiverSupport">
                  지원
                </label>
              </div>
            </td>
          </tr>
        </table>
        <table class="input-table" id="caregiverDetailsTable" style="margin-top: -1px;">
          <thead>
            <tr>
              <th>간병인 항목</th>
              <th style="background: #f5f5f5; color: #333;">변경 전</th>
              <th style="background: var(--hanwha-light); color: #333;">변경 후</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>요양병원 외</th>
              <td class="before-column">
                <input type="text" id="nursingHospitalOut_before" placeholder="0" class="amount-input">
              </td>
              <td class="after-column">
                <input type="text" id="nursingHospitalOut_after" placeholder="0" class="amount-input">
              </td>
            </tr>
            <tr>
              <th>요양병원</th>
              <td class="before-column">
                <input type="text" id="nursingHospitalIn_before" placeholder="0" class="amount-input">
              </td>
              <td class="after-column">
                <input type="text" id="nursingHospitalIn_after" placeholder="0" class="amount-input">
              </td>
            </tr>
            <tr>
              <th>간호간병통합</th>
              <td class="before-column">
                <input type="text" id="nursingCareIntegrated_before" placeholder="0" class="amount-input">
              </td>
              <td class="after-column">
                <input type="text" id="nursingCareIntegrated_after" placeholder="0" class="amount-input">
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="row" style="margin-top: 2rem;">
        <button id="saveDataBtn">💾 이미지로 저장하기</button>
        <button id="backToMenuBtn" class="secondary">◀ 뒤로가기</button>
      </div>
    </div>
  </section>

  <!-- 불러오기 화면 -->
  <section id="loadScreen" class="screen hidden">
    <div class="app-title">저장된 보장분석 불러오기</div>
    <div class="card">
      <div class="row">
        <input type="text" id="searchInput" placeholder="🔍 고객명으로 검색...">
      </div>
      
      <div id="savedList">
        <!-- 저장된 항목들이 여기에 동적으로 추가됩니다 -->
      </div>
      
      <div class="row" style="margin-top: 2rem;">
        <button id="backToMenuFromLoadBtn" class="secondary">◀ 뒤로가기</button>
      </div>
    </div>
  </section>

  <!-- 숨겨진 출력용 컨테이너 -->
  <div id="hiddenPrintContainer"></div>

  <!-- 표준금액 설정 모달 -->
  <div id="standardAmountModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 style="color: var(--hanwha); margin-bottom: 1rem;">표준금액 설정</h2>
      <p style="font-size: 13px; color: var(--muted); margin-bottom: 1rem;">
        각 항목의 표준금액을 설정하면 진행률 바의 기준값이 변경됩니다.
      </p>
      <div id="standardAmountList" style="max-height: 400px; overflow-y: auto;">
        <!-- 표준금액 입력 필드들이 여기에 동적으로 생성됩니다 -->
      </div>
      <div style="margin-top: 1.5rem; text-align: center;">
        <button id="saveStandardAmountBtn" style="padding: 10px 20px; width: auto;">
          저장하기
        </button>
      </div>
    </div>
  </div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
// 전역 변수
let currentData = {};
let savedDataList = [];

// 모든 담보 항목 통합 정의
const ALL_COVERAGE_ITEMS = [
  // 암 관련 담보
  { key: 'generalCancer', name: '일반암진단비', standardAmount: 5000, category: 'cancer' },
  { key: 'totalCancer', name: '통합암진단비', standardAmount: 3000, category: 'cancer' },
    { key: 'metastasisCancer', name: '전이암진단비', standardAmount: 2000, category: 'cancer' },
  { key: 'cancerSpecificTreatment', name: '암치료비', standardAmount: 1000, category: 'cancer' },
  { key: 'cancerNonCoveredTreatment', name: '암치료비(비급여)', standardAmount: 3000, category: 'cancer' },
    { key: 'targetTherapy', name: '표적항암치료비', standardAmount: 3000, category: 'cancer' },
  { key: 'heavyIonTherapy', name: '중입자치료비', standardAmount: 5000, category: 'cancer' },
  { key: 'cancerSurgery', name: '암수술비', standardAmount: 500, category: 'cancer' },
  { key: 'daVinciSurgery', name: '다빈치수술비', standardAmount: 2000, category: 'cancer' },
  { key: 'surgery5Type', name: '1-5종수술비(5종)', standardAmount: 100, category: 'cancer' },
  
  // 2대 중대질환
  { key: 'cerebrovascularDiagnosis', name: '뇌혈관진단비', standardAmount: 3000, category: 'majorDisease' },
  { key: 'strokeDiagnosis', name: '뇌졸중진단비', standardAmount: 3000, category: 'majorDisease' },
  { key: 'ischemicHeartDiagnosis', name: '허혈성진단비', standardAmount: 2000, category: 'majorDisease' },
  { key: 'myocardialInfarctionDiagnosis', name: '심근경색진단비', standardAmount: 2000, category: 'majorDisease' },
  { key: 'cerebrovascularSurgery', name: '뇌혈관수술비', standardAmount: 1000, category: 'majorDisease' },
  { key: 'strokeSurgery', name: '뇌졸중수술비', standardAmount: 1000, category: 'majorDisease' },
  { key: 'ischemicHeartSurgery', name: '허혈성수술비', standardAmount: 1000, category: 'majorDisease' },
  { key: 'myocardialInfarctionSurgery', name: '심근경색수술비', standardAmount: 1000, category: 'majorDisease' },
  { key: 'strokeThrombolysis', name: '뇌졸중혈전용해', standardAmount: 1000, category: 'majorDisease' },
  { key: 'myocardialInfarctionThrombolysis', name: '심근경색혈전용해', standardAmount: 1000, category: 'majorDisease' },
  { key: 'twoMajorTreatment', name: '2대특정치료비', standardAmount: 1000, category: 'majorDisease' },
  { key: 'majorCirculatorySurgery', name: '주요순환계(수술)', standardAmount: 3000, category: 'majorDisease' },
  { key: 'majorCirculatoryThrombectomy', name: '주요순환계(혈전제거)', standardAmount: 3000, category: 'majorDisease' },
  { key: 'majorCirculatoryThrombolysis', name: '주요순환계(혈전용해)', standardAmount: 3000, category: 'majorDisease' },
  { key: 'majorCirculatoryICU', name: '주요순환계(중환자실)', standardAmount: 1500, category: 'majorDisease' },
  { key: 'thrombectomyTreatment', name: '혈전제거치료비', standardAmount: 3000, category: 'majorDisease' },
  { key: 'surgery3Type', name: '1-5종수술비(3종)', standardAmount: 300, category: 'majorDisease' },
  { key: 'surgery5Type2', name: '1-5종수술비(5종)', standardAmount: 100, category: 'majorDisease' },
  { key: 'disease124Surgery', name: '124대(특정10대)', standardAmount: 500, category: 'majorDisease' },
  { key: 'sevenOrganSurgery', name: '7대기관(뇌/심 관혈)', standardAmount: 2000, category: 'majorDisease' },
  
  // 5대 필수보험
  { key: 'diseaseHospitalization', name: '(실손)질병입원', standardAmount: 5000, category: 'essential' },
  { key: 'injuryHospitalization', name: '(실손)상해입원', standardAmount: 5000, category: 'essential' },
  { key: 'criminalSettlement', name: '형사합의금', standardAmount: 20000, category: 'essential' },
  { key: 'lawyerAppointment', name: '변호사선임비', standardAmount: 3000, category: 'essential' },
  { key: 'dailyLifeLiability', name: '일상생활배상책임', standardAmount: 10000, category: 'essential' },
  { key: 'fireFine', name: '화재벌금', standardAmount: 2000, category: 'essential' }
];

// DOM 로드 완료 시 초기화
document.addEventListener('DOMContentLoaded', function() {
  loadStandardAmounts();
  initializeApp();
  loadSavedData();
  setupEventListeners();
});

// 앱 초기화
function initializeApp() {
  showScreen('menu');
  createCoverageTable();
  addAmountFormatting();
  setupMajorCirculatoryAutoCalculation();
}

// 이벤트 리스너 설정
function setupEventListeners() {
  // 메뉴 버튼들
  document.getElementById('inputMenuBtn').addEventListener('click', () => showScreen('input'));
  document.getElementById('loadMenuBtn').addEventListener('click', () => {
    showScreen('load');
    displaySavedList();
  });
  
  // 뒤로가기 버튼들
  document.getElementById('backToMenuBtn').addEventListener('click', () => showScreen('menu'));
  document.getElementById('backToMenuFromLoadBtn').addEventListener('click', () => showScreen('menu'));
  
  // 이미지 업로드 관련
  const imageUploadArea = document.getElementById('imageUploadArea');
  const imageInput = document.getElementById('imageInput');
  
  imageUploadArea.addEventListener('click', () => imageInput.click());
  imageInput.addEventListener('change', handleImageUpload);
  
  // 드래그 앤 드롭
  imageUploadArea.addEventListener('dragover', handleDragOver);
  imageUploadArea.addEventListener('drop', handleDrop);
  imageUploadArea.addEventListener('dragenter', (e) => {
    e.preventDefault();
    imageUploadArea.classList.add('drag-over');
  });
  imageUploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    imageUploadArea.classList.remove('drag-over');
  });
  
  // OCR 처리 버튼
  document.getElementById('ocrProcessBtn').addEventListener('click', processOCR);
  
  // 저장 버튼
  document.getElementById('saveDataBtn').addEventListener('click', saveAndDownloadImage);
  
  // 검색 기능
  document.getElementById('searchInput').addEventListener('input', filterSavedList);
  
  // 간병인 라디오 버튼 이벤트
  document.querySelectorAll('input[name="caregiverOption"]').forEach(radio => {
    radio.addEventListener('change', handleCaregiverOptionChange);
  });
  
  // 표준금액 설정 버튼
  document.getElementById('standardAmountBtn').addEventListener('click', openStandardAmountModal);
  
  // 모달 닫기 버튼
  document.querySelector('.close-modal').addEventListener('click', closeStandardAmountModal);
  
  // 모달 외부 클릭 시 닫기
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('standardAmountModal');
    if (event.target === modal) {
      closeStandardAmountModal();
    }
  });
  
  // 표준금액 저장 버튼
  document.getElementById('saveStandardAmountBtn').addEventListener('click', saveStandardAmounts);
}

// 주요순환계 자동 계산 설정
function setupMajorCirculatoryAutoCalculation() {
  setTimeout(() => {
    const surgeryInputBefore = document.getElementById('majorCirculatorySurgery_before');
    const surgeryInputAfter = document.getElementById('majorCirculatorySurgery_after');
    
    if (surgeryInputBefore) {
      surgeryInputBefore.addEventListener('input', () => handleMajorCirculatoryCalculation('before'));
      surgeryInputBefore.addEventListener('blur', () => handleMajorCirculatoryCalculation('before'));
    }
    
    if (surgeryInputAfter) {
      surgeryInputAfter.addEventListener('input', () => handleMajorCirculatoryCalculation('after'));
      surgeryInputAfter.addEventListener('blur', () => handleMajorCirculatoryCalculation('after'));
    }
  }, 100);
}

// 숫자 추출 함수
function extractNumber(value) {
  if (!value) return 0;
  const numbers = value.toString().replace(/[^0-9]/g, '');
  return numbers ? parseInt(numbers) : 0;
}

// 포맷팅된 값으로 변환
function formatToDisplayValue(value) {
  if (!value || value === 0) return '';
  return value.toLocaleString() + '만원';
}

// 주요순환계 자동 계산 함수
function handleMajorCirculatoryCalculation(type) {
  const surgeryInput = document.getElementById('majorCirculatorySurgery_' + type);
  if (!surgeryInput) return;
  
  const surgeryValue = extractNumber(surgeryInput.value);
  
  // 관련 필드들
  const thrombectomyInput = document.getElementById('majorCirculatoryThrombectomy_' + type);
  const thrombolysisInput = document.getElementById('majorCirculatoryThrombolysis_' + type);
  const icuInput = document.getElementById('majorCirculatoryICU_' + type);
  
  if (surgeryValue > 0) {
    if (thrombectomyInput) {
      thrombectomyInput.value = formatToDisplayValue(surgeryValue);
      thrombectomyInput.classList.add('auto-calculated');
    }
    
    if (thrombolysisInput) {
      thrombolysisInput.value = formatToDisplayValue(surgeryValue);
      thrombolysisInput.classList.add('auto-calculated');
    }
    
    if (icuInput) {
      const icuValue = Math.floor(surgeryValue * 0.5);
      icuInput.value = formatToDisplayValue(icuValue);
      icuInput.classList.add('auto-calculated');
    }
  } else {
    if (thrombectomyInput) {
      thrombectomyInput.value = '';
      thrombectomyInput.classList.remove('auto-calculated');
    }
    if (thrombolysisInput) {
      thrombolysisInput.value = '';
      thrombolysisInput.classList.remove('auto-calculated');
    }
    if (icuInput) {
      icuInput.value = '';
      icuInput.classList.remove('auto-calculated');
    }
  }
}

// 표준금액 설정 모달 열기
function openStandardAmountModal() {
  const modal = document.getElementById('standardAmountModal');
  const list = document.getElementById('standardAmountList');
  
  const categories = {
    'cancer': '암 관련 담보',
    'majorDisease': '2대 중대질환',
    'essential': '5대 필수보험'
  };
  
  list.innerHTML = '';
  
  Object.entries(categories).forEach(([category, title]) => {
    const categoryDiv = document.createElement('div');
    categoryDiv.innerHTML = `<h3 style="color: var(--hanwha); font-size: 14px; margin: 1rem 0 0.5rem 0; border-bottom: 1px solid #ddd; padding-bottom: 5px;">${title}</h3>`;
    
    const items = ALL_COVERAGE_ITEMS.filter(item => item.category === category);
    items.forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin: 8px 0;';
      itemDiv.innerHTML = `
        <label style="font-size: 13px; flex: 1;">${item.name}</label>
        <input type="number" class="standard-amount-input" data-key="${item.key}" value="${item.standardAmount}" placeholder="0">
        <span style="font-size: 12px; color: var(--muted); margin-left: 5px;">만원</span>
      `;
      categoryDiv.appendChild(itemDiv);
    });
    
    list.appendChild(categoryDiv);
  });
  
  modal.style.display = 'block';
}

// 표준금액 설정 모달 닫기
function closeStandardAmountModal() {
  const modal = document.getElementById('standardAmountModal');
  modal.style.display = 'none';
}

// 표준금액 저장
function saveStandardAmounts() {
  const inputs = document.querySelectorAll('.standard-amount-input');
  
  inputs.forEach(input => {
    const key = input.dataset.key;
    const value = parseInt(input.value) || 0;
    
    const item = ALL_COVERAGE_ITEMS.find(item => item.key === key);
    if (item) {
      item.standardAmount = value;
    }
  });
  
  localStorage.setItem('standardAmounts', JSON.stringify(ALL_COVERAGE_ITEMS));
  
  alert('표준금액이 저장되었습니다.');
  closeStandardAmountModal();
}

// 저장된 표준금액 로드
function loadStandardAmounts() {
  const saved = localStorage.getItem('standardAmounts');
  if (saved) {
    const savedAmounts = JSON.parse(saved);
    savedAmounts.forEach(savedItem => {
      const item = ALL_COVERAGE_ITEMS.find(i => i.key === savedItem.key);
      if (item) {
        item.standardAmount = savedItem.standardAmount;
      }
    });
  }
}

// 담보 테이블 생성
function createCoverageTable() {
  const tbody = document.getElementById('coverageTableBody');
  tbody.innerHTML = '';
  
  ALL_COVERAGE_ITEMS.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <th>${item.name}</th>
      <td class="before-column" style="position: relative;">
        <input type="text" id="${item.key}_before" placeholder="0" class="amount-input">
      </td>
      <td class="after-column" style="position: relative;">
        <input type="text" id="${item.key}_after" placeholder="0" class="amount-input">
      </td>
    `;
    tbody.appendChild(row);
  });
  
  setupMajorCirculatoryAutoCalculation();
}

// 숫자 포맷팅 함수
function formatAmount(value) {
  const numbers = value.replace(/[^0-9]/g, '');
  if (!numbers) return '';
  
  const formatted = parseInt(numbers).toLocaleString();
  return formatted + '만원';
}

// 입력 필드 포맷팅 이벤트 추가
function addAmountFormatting() {
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('amount-input')) {
      const cursorPos = e.target.selectionStart;
      const numbers = e.target.value.replace(/[^0-9]/g, '');
      
      if (numbers) {
        const formatted = parseInt(numbers).toLocaleString() + '만원';
        e.target.value = formatted;
        
        const newCursorPos = formatted.length - 2;
        e.target.setSelectionRange(newCursorPos, newCursorPos);
      }
    }
  });
  
  document.addEventListener('blur', function(e) {
    if (e.target.classList.contains('amount-input')) {
      const numbers = e.target.value.replace(/[^0-9]/g, '');
      if (numbers) {
        e.target.value = parseInt(numbers).toLocaleString() + '만원';
      }
    }
  });
  
  document.addEventListener('focus', function(e) {
    if (e.target.classList.contains('amount-input') && !e.target.classList.contains('auto-calculated')) {
      const numbers = e.target.value.replace(/[^0-9]/g, '');
      if (numbers) {
        e.target.value = numbers;
        e.target.select();
      }
    }
  });
}

// 화면 전환
function showScreen(screenName) {
  const screens = ['menu', 'input', 'load'];
  screens.forEach(name => {
    document.getElementById(name + 'Screen').classList.toggle('hidden', name !== screenName);
  });
  
  if (screenName === 'input' && !currentData.customerName) {
    resetInputForm();
  }
}

// 홈으로 이동
function goHome() {
  showScreen('menu');
}

// 입력 폼 초기화
function resetInputForm() {
  document.getElementById('customerName').value = '';
  document.getElementById('birthDate').value = '';
  
  ALL_COVERAGE_ITEMS.forEach(item => {
    const beforeInput = document.getElementById(item.key + '_before');
    const afterInput = document.getElementById(item.key + '_after');
    if (beforeInput) {
      beforeInput.value = '';
      beforeInput.classList.remove('auto-calculated');
    }
    if (afterInput) {
      afterInput.value = '';
      afterInput.classList.remove('auto-calculated');
    }
  });
  
  ['nursingHospitalOut', 'nursingHospitalIn', 'nursingCareIntegrated'].forEach(id => {
    const beforeInput = document.getElementById(id + '_before');
    const afterInput = document.getElementById(id + '_after');
    if (beforeInput) beforeInput.value = '';
    if (afterInput) afterInput.value = '';
  });
  
  document.getElementById('caregiverUse').checked = true;
  handleCaregiverOptionChange();
  
  const imagePreview = document.getElementById('imagePreview');
  const uploadText = document.getElementById('uploadText');
  imagePreview.classList.add('hidden');
  uploadText.style.display = 'block';
  
  document.getElementById('ocrProcessBtn').disabled = true;
  document.getElementById('ocrStatus').textContent = '';
}

// 간병인 옵션 변경 처리
function handleCaregiverOptionChange() {
  const isUse = document.getElementById('caregiverUse').checked;
  const detailsTable = document.getElementById('caregiverDetailsTable');
  
  if (isUse) {
    detailsTable.style.display = 'table';
  } else {
    detailsTable.style.display = 'none';
    ['nursingHospitalOut', 'nursingHospitalIn', 'nursingCareIntegrated'].forEach(id => {
      const beforeInput = document.getElementById(id + '_before');
      const afterInput = document.getElementById(id + '_after');
      if (beforeInput) beforeInput.value = '';
      if (afterInput) afterInput.value = '';
    });
  }
}

// 이미지 업로드 처리
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (file && file.type.startsWith('image/')) {
    displayImagePreview(file);
  }
}

// 드래그 오버 처리
function handleDragOver(event) {
  event.preventDefault();
}

// 드롭 처리
function handleDrop(event) {
  event.preventDefault();
  document.getElementById('imageUploadArea').classList.remove('drag-over');
  
  const files = event.dataTransfer.files;
  if (files.length > 0 && files[0].type.startsWith('image/')) {
    displayImagePreview(files[0]);
  }
}

// 이미지 미리보기 표시
function displayImagePreview(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const imagePreview = document.getElementById('imagePreview');
    const uploadText = document.getElementById('uploadText');
    
    imagePreview.src = e.target.result;
    imagePreview.classList.remove('hidden');
    uploadText.style.display = 'none';
    
    document.getElementById('ocrProcessBtn').disabled = false;
    document.getElementById('ocrStatus').textContent = 'OCR 인식을 시작할 수 있습니다.';
  };
  reader.readAsDataURL(file);
}

// OCR 처리
async function processOCR() {
  const ocrBtn = document.getElementById('ocrProcessBtn');
  const ocrStatus = document.getElementById('ocrStatus');
  const imagePreview = document.getElementById('imagePreview');
  
  if (!imagePreview.src) {
    alert('먼저 이미지를 업로드해주세요.');
    return;
  }
  
  try {
    ocrBtn.disabled = true;
    ocrStatus.innerHTML = '<span class="loading"></span> OCR 인식 중... 잠시만 기다려주세요.';
    
    const base64Image = imagePreview.src.split(',')[1];
    
    const result = await callGoogleVisionAPI(base64Image);
    await parseOCRResult(result);
    
    ocrStatus.innerHTML = '<span class="success">✅ OCR 인식이 완료되었습니다. 결과를 확인하고 필요시 수정해주세요.</span>';
  } catch (error) {
    console.error('OCR 처리 오류:', error);
    ocrStatus.innerHTML = '<span class="error">❌ OCR 처리 중 오류가 발생했습니다: ' + error.message + '</span>';
  } finally {
    ocrBtn.disabled = false;
  }
}

// Google Vision API 호출
async function callGoogleVisionAPI(base64Image) {
  const API_KEY = 'AIzaSyDywqG3hrawe_KrgWVpj5Y34ySJE0xjGQM';
  
  const requestBody = {
    requests: [{
      image: {
        content: base64Image
      },
      features: [{
        type: 'DOCUMENT_TEXT_DETECTION',
        maxResults: 1
      }]
    }]
  };
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
    throw new Error(`API 호출 실패: ${response.status} - ${response.statusText}`);
  }
  
  return await response.json();
}

// OCR 결과 파싱
async function parseOCRResult(apiResult) {
  if (!apiResult || !apiResult.responses || !apiResult.responses[0]) {
    throw new Error('OCR 결과를 받아올 수 없습니다.');
  }

  const detectedText = apiResult.responses[0].fullTextAnnotation?.text || '';
  console.log('OCR 인식된 텍스트:', detectedText);

  if (!detectedText.trim()) {
    throw new Error('이미지에서 텍스트를 인식할 수 없습니다.');
  }

  extractCustomerInfo(detectedText);
  extractCoverageAmountsForBeforeAfter(detectedText);
}

// 고객 정보 추출
function extractCustomerInfo(text) {
  const namePatterns = [
    /([가-힣]{2,4})님의\s*한\s*장\s*요약\s*보장분석/,
    /^([가-힣]{2,4})님/m,
    /성명[:\s]*([가-힣]{2,4})/,
    /고객명[:\s]*([가-힣]{2,4})/
  ];

  for (const pattern of namePatterns) {
    const match = text.match(pattern);
    if (match) {
      document.getElementById('customerName').value = match[1];
      console.log(`고객명 추출 성공: ${match[1]}`);
      break;
    }
  }

  const birthPatterns = [
    /생년월일\s*(\d{2}-\d{1,2}-\d{1,2})/,
    /생년월일\s*(\d{4}-\d{1,2}-\d{1,2})/,
    /생년월일\s*(\d{2}\.\d{1,2}\.\d{1,2})/
  ];

  for (const pattern of birthPatterns) {
    const match = text.match(pattern);
    if (match) {
      let date = match[1];
      if (date.includes('.')) {
        date = date.replace(/\./g, '-');
      }
      if (date.length > 8) {
        const parts = date.split('-');
        if (parts[0].length === 4) {
          date = `${parts[0].slice(2)}-${parts[1]}-${parts[2]}`;
        }
      }
      document.getElementById('birthDate').value = date;
      console.log(`생년월일 추출 성공: ${date}`);
      break;
    }
  }
}

// 95% 정확도 목표 담보 금액 추출 (정교화 버전)
function extractCoverageAmountsForBeforeAfter(text) {
  console.log('95% 정확도 목표 OCR 담보 금액 추출 시작...');
  
  // 정교화된 매핑 테이블 (실제 이미지 텍스트와 코드 매핑)
  const coverageMappings = [
    // 암 섹션
    { imageText: '일반암', codeKey: 'generalCancer', section: '암' },
    { imageText: '통합암', codeKey: 'totalCancer', section: '암' },
    { imageText: '표적항암약물', codeKey: 'targetTherapy', section: '암' },
    
    // 2대 중대질환 섹션
    { imageText: '뇌혈관질환', codeKey: 'cerebrovascularDiagnosis', section: '2대중대질환' },
    { imageText: '뇌졸중', codeKey: 'strokeDiagnosis', section: '2대중대질환' },
    { imageText: '허혈성심질환', codeKey: 'ischemicHeartDiagnosis', section: '2대중대질환' },
    { imageText: '급성심근경색증', codeKey: 'myocardialInfarctionDiagnosis', section: '2대중대질환' },
    
    // 5대 필수보험 섹션
    { imageText: '질병입원 실손', codeKey: 'diseaseHospitalization', section: '5대필수보험' },
    { imageText: '상해입원실손', codeKey: 'injuryHospitalization', section: '5대필수보험' },
    { imageText: '간병인질병입원', codeKey: 'nursingHospitalOut', section: '5대필수보험' },
    { imageText: '형사합의지원금', codeKey: 'criminalSettlement', section: '5대필수보험' },
    { imageText: '변호사선임비용', codeKey: 'lawyerAppointment', section: '5대필수보험' },
    { imageText: '일상생활배상책임', codeKey: 'dailyLifeLiability', section: '5대필수보험' },
    { imageText: '화재벌금', codeKey: 'fireFine', section: '5대필수보험' }
  ];
  
  // 정교화된 텍스트 인식 및 값 추출
  coverageMappings.forEach(mapping => {
    const extractedValue = extractValueWithPrecision(text, mapping.imageText);
    
    if (extractedValue !== null && extractedValue >= 0) {
      console.log(`${mapping.section} - ${mapping.imageText}: ${extractedValue}만원 추출`);
      
      // 변경 전과 변경 후 모두에 값 설정
      const beforeInput = document.getElementById(mapping.codeKey + '_before');
      const afterInput = document.getElementById(mapping.codeKey + '_after');
      
      if (extractedValue === 0) {
        // 0값인 경우 빈 값으로 처리 (X 표시는 UI에서 자동 처리)
        if (beforeInput) beforeInput.value = '';
        if (afterInput) afterInput.value = '';
        console.log(`${mapping.codeKey}: 0값으로 인식 - 빈 값 설정`);
      } else {
        // 정상 값인 경우
        if (beforeInput) {
          beforeInput.value = extractedValue.toLocaleString() + '만원';
          console.log(`${mapping.codeKey}_before에 ${extractedValue}만원 설정`);
        }
        
        if (afterInput) {
          afterInput.value = extractedValue.toLocaleString() + '만원';
          console.log(`${mapping.codeKey}_after에 ${extractedValue}만원 설정`);
        }
      }
    } else {
      console.log(`${mapping.section} - ${mapping.imageText}: 값을 찾을 수 없음`);
    }
  });
  
  // OCR 완료 후 자동계산 트리거
  setTimeout(() => {
    handleMajorCirculatoryCalculation('before');
    handleMajorCirculatoryCalculation('after');
  }, 100);
}

// 95% 정확도 목표 정교화된 값 추출 함수
function extractValueWithPrecision(text, targetText) {
  console.log(`정교화된 추출 시작: "${targetText}"`);
  
  // 1단계: 텍스트를 라인별로 분리하고 정리
  const lines = text.split(/\r?\n/)
    .map(line => line.trim())
    .filter(line => line.length > 0);
  
  // 2단계: 타겟 텍스트가 포함된 라인들 찾기 (대소문자 무시, 공백 무시)
  const matchingLines = [];
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const normalizedLine = line.toLowerCase().replace(/\s+/g, '');
    const normalizedTarget = targetText.toLowerCase().replace(/\s+/g, '');
    
    // 정확한 매칭 또는 부분 매칭
    if (normalizedLine.includes(normalizedTarget)) {
      matchingLines.push({
        line: line,
        index: i,
        matchScore: calculateMatchScore(normalizedLine, normalizedTarget),
        allLines: lines // 전체 라인 배열 추가
      });
      console.log(`라인 매칭: "${line}" (점수: ${calculateMatchScore(normalizedLine, normalizedTarget)})`);
    }
  }
  
  // 매칭 점수가 높은 순으로 정렬
  matchingLines.sort((a, b) => b.matchScore - a.matchScore);
  
  // 3단계: 각 매칭된 라인에서 값 추출 시도
  for (const match of matchingLines) {
    const extractedValue = extractNumberFromLineAndNextLines(match.line, targetText, match.allLines, match.index);
    
    if (extractedValue !== null) {
      console.log(`값 추출 성공: ${extractedValue} (라인: "${match.line}")`);
      return extractedValue;
    }
  }
  
  console.log(`"${targetText}"에 대한 값 추출 실패`);
  return null;
}

  // 라인과 다음 라인들에서 숫자 추출 함수 (멀티라인 지원)
function extractNumberFromLineAndNextLines(line, targetText, allLines, currentIndex) {
  console.log(`멀티라인 숫자 추출 시도: "${line}", 타겟: "${targetText}"`);
  
  // 다른 담보 항목 키워드 목록 (현재 찾는 항목 제외)
  const otherCoverageKeywords = [
    '일반암', '통합암', '표적항암약물', '뇌혈관질환', '뇌졸중', 
    '허혈성심질환', '급성심근경색증', '질병입원 실손', '상해입원실손', 
    '형사합의지원금', '변호사선임비용', '간병인질병입원', '화재벌금', '일상생활배상책임'
  ].filter(keyword => keyword !== targetText); // 현재 타겟은 제외
  
  // 먼저 현재 라인에서 시도
  const currentLineResult = extractNumberFromSingleLine(line, targetText);
  if (currentLineResult !== null) {
    console.log(`현재 라인에서 추출 성공: ${currentLineResult}`);
    return currentLineResult;
  }
  
  // 현재 라인에서 실패했다면, 다음 라인들에서 숫자 찾기
  console.log(`현재 라인에서 실패, 다음 라인들 검사 시작...`);
  
  // 다음 최대 5개 라인까지 검사
  for (let i = 1; i <= 5 && currentIndex + i < allLines.length; i++) {
    const nextLine = allLines[currentIndex + i];
    console.log(`다음 라인 ${i} 검사: "${nextLine}"`);
    
    // "부족" 키워드가 있는 라인은 건너뛰기
    if (nextLine.includes('부족')) {
      console.log(`부족 키워드가 있는 라인 건너뛰기: "${nextLine}"`);
      continue;
    }
    
    // 다른 담보 항목이 나타나면 검사 중지
    const hasOtherCoverage = otherCoverageKeywords.some(keyword => {
      const normalizedLine = nextLine.toLowerCase().replace(/\s+/g, '');
      const normalizedKeyword = keyword.toLowerCase().replace(/\s+/g, '');
      return normalizedLine.includes(normalizedKeyword);
    });
    
    if (hasOtherCoverage) {
      console.log(`다른 담보 항목 발견으로 검사 중지: "${nextLine}"`);
      break; // 검사 중지
    }
    
    // 숫자 패턴 검사
    const numberResult = extractNumberFromText(nextLine);
    if (numberResult !== null) {
      console.log(`다음 라인 ${i}에서 숫자 추출 성공: ${numberResult}`);
      return numberResult;
    }
  }
  
  console.log('멀티라인 검사에서도 숫자 추출 실패 - 0값 반환');
  return 0; // 실패 시 0값 반환
}

// 단일 라인에서 숫자 추출 (기존 로직)
function extractNumberFromSingleLine(line, targetText) {
  const targetIndex = line.toLowerCase().indexOf(targetText.toLowerCase());
  if (targetIndex === -1) {
    return null;
  }
  
  const afterTarget = line.substring(targetIndex + targetText.length);
  return extractNumberFromText(afterTarget);
}

// 텍스트에서 숫자 추출 (공통 로직)
function extractNumberFromText(text) {
  console.log(`텍스트에서 숫자 추출: "${text}"`);
  
  // "부족" 키워드가 포함된 텍스트는 완전 배제
  if (text.includes('부족')) {
    console.log('부족 키워드 발견 - 해당 라인 숫자 무시');
    return null;
  }
  
  // 숫자 패턴들 (우선순위 순)
  const patterns = [
    // 분수 형태 처리 (X/Y만원, X/Y, X/Y,ZZZ만원 등)
    /(\d{1,3}(?:,\d{3})*)\s*\/\s*\d{1,3}(?:,\d{3})*(?:만원)?/,
    
    // 단순 숫자+만원 형태
    /(\d{1,3}(?:,\d{3})*)만원/,
    
    // 숫자만 있는 형태 (쉼표 포함)
    /(\d{1,3}(?:,\d{3})*)/
  ];
  
  for (const pattern of patterns) {
    const match = text.match(pattern);
    if (match) {
      const numberStr = match[1].replace(/,/g, '');
      const number = parseInt(numberStr);
      
      console.log(`패턴 매칭 성공: "${match[0]}" -> 숫자: ${number}`);
      
      // 0값 처리
      if (number === 0) {
        console.log('0값 인식 - 0 반환');
        return 0;
      }
      
      if (number > 0) {
        console.log(`정상 값 추출: ${number}`);
        return number;
      }
    }
  }
  
  // 0/ 패턴 특별 처리
  if (text.includes('0/') || text.trim().startsWith('0/')) {
    console.log('0/ 패턴 발견 - 0값 반환');
    return 0;
  }
  
  console.log('숫자 추출 실패');
  return null;
}

// 매칭 점수 계산 함수
function calculateMatchScore(line, target) {
  // 완전 일치 시 최고 점수
  if (line === target) return 100;
  
  // 포함 관계 점수 계산
  if (line.includes(target)) {
    return 90 - (line.length - target.length) * 0.1;
  }
  
  // 부분 일치 점수 계산
  let score = 0;
  const targetChars = target.split('');
  
  for (const char of targetChars) {
    if (line.includes(char)) {
      score += 1;
    }
  }
  
  return (score / targetChars.length) * 50;
}

// 라인에서 숫자 추출 함수 (로직 1-4 구현)
function extractNumberFromLine(line, targetText) {
  console.log(`라인에서 숫자 추출 시도: "${line}", 타겟: "${targetText}"`);
  
  // 로직 1: 텍스트와 숫자는 동일한 라인에 존재
  const targetIndex = line.toLowerCase().indexOf(targetText.toLowerCase());
  if (targetIndex === -1) {
    console.log('타겟 텍스트를 라인에서 찾을 수 없음');
    return null;
  }
  
  // 로직 2: 텍스트가 끝나는 시점 이후의 공백을 찾고, 공백 이후의 숫자 인식
  const afterTarget = line.substring(targetIndex + targetText.length);
  console.log(`타겟 이후 텍스트: "${afterTarget}"`);
  
  // 공백 이후 첫 번째 숫자 패턴들
  const patterns = [
    // 로직 3: 분수 형태 처리 (X/Y만원, X/Y, X/Y,ZZZ만원 등)
    /\s+(\d{1,3}(?:,\d{3})*)\s*\/\s*\d{1,3}(?:,\d{3})*(?:만원)?/,
    
    // 단순 숫자+만원 형태
    /\s+(\d{1,3}(?:,\d{3})*)만원/,
    
    // 숫자만 있는 형태
    /\s+(\d{1,3}(?:,\d{3})*)/,
    
    // 공백 없이 바로 붙어있는 경우
    /(\d{1,3}(?:,\d{3})*)\s*\/\s*\d{1,3}(?:,\d{3})*(?:만원)?/,
    /(\d{1,3}(?:,\d{3})*)만원/,
    /(\d{1,3}(?:,\d{3})*)/
  ];
  
  for (const pattern of patterns) {
    const match = afterTarget.match(pattern);
    if (match) {
      const numberStr = match[1].replace(/,/g, '');
      const number = parseInt(numberStr);
      
      console.log(`패턴 매칭 성공: "${match[0]}" -> 숫자: ${number}`);
      
      // 로직 4: 0인 경우 체크
      if (number === 0) {
        console.log('0값 인식 - 0 반환');
        return 0;
      }
      
      if (number > 0) {
        console.log(`정상 값 추출: ${number}`);
        return number;
      }
    }
  }
  
  // 특별한 경우: 라인 전체에서 0/ 패턴 확인 (0값 처리)
  if (afterTarget.includes('0/') || afterTarget.trim().startsWith('0/')) {
    console.log('0/ 패턴 발견 - 0값 반환');
    return 0;
  }
  
  console.log('숫자 추출 실패');
  return null;
}

// 유사한 텍스트 검색 및 숫자 추출 (필요시 보조 함수로 유지)
function findSimilarTextAndExtractNumber(lines, targetText) {
  const targetWords = targetText.toLowerCase().split(/\s+/);
  
  for (const line of lines) {
    const lineLower = line.toLowerCase();
    
    // 타겟 텍스트의 주요 단어들이 포함되어 있는지 확인
    const matchedWords = targetWords.filter(word => lineLower.includes(word));
    
    // 50% 이상의 단어가 매칭되면 유사한 것으로 판단
    if (matchedWords.length >= Math.ceil(targetWords.length * 0.5)) {
      console.log(`유사한 라인 발견: "${line}"`);
      
      // 숫자 추출 시도
      const numberMatch = line.match(/(\d{1,3}(?:,\d{3})*)/);
      if (numberMatch) {
        const number = parseInt(numberMatch[1].replace(/,/g, ''));
        if (number > 0) {
          console.log(`유사 텍스트에서 추출된 숫자: ${number}`);
          return number;
        }
      }
    }
  }
  
  return 0;
}

// 데이터 저장 및 이미지 다운로드
async function saveAndDownloadImage() {
  const customerName = document.getElementById('customerName').value.trim();
  
  if (!customerName) {
    alert('고객명을 입력해주세요.');
    return;
  }
  
  currentData = {
    customerName: customerName,
    birthDate: document.getElementById('birthDate').value.trim(),
    inputDate: new Date().toLocaleString('ko-KR'),
    coverages_before: {},
    coverages_after: {},
    caregiverOption: document.querySelector('input[name="caregiverOption"]:checked').value
  };
  
  const allFields = [
    ...ALL_COVERAGE_ITEMS,
    { key: 'nursingHospitalOut', name: '요양병원 외' },
    { key: 'nursingHospitalIn', name: '요양병원' },
    { key: 'nursingCareIntegrated', name: '간호간병통합' }
  ];
  
  allFields.forEach(item => {
    const beforeInput = document.getElementById(item.key + '_before');
    const afterInput = document.getElementById(item.key + '_after');
    
    if (beforeInput && beforeInput.value.trim()) {
      currentData.coverages_before[item.key] = {
        name: item.name,
        value: beforeInput.value.trim()
      };
    }
    
    if (afterInput && afterInput.value.trim()) {
      currentData.coverages_after[item.key] = {
        name: item.name,
        value: afterInput.value.trim()
      };
    }
  });
  
  saveDataToStorage(currentData);
  await generateAndDownloadImage(currentData);
  
  alert('이미지가 저장되었습니다!');
}

// 표준금액 대비 진행률 계산
function calculateProgressPercentage(currentValue, standardAmount) {
  if (!currentValue || currentValue == 0 || !standardAmount) return 0;
  return (parseInt(currentValue) / standardAmount) * 100;
}

// 이미지 생성 및 다운로드 (최적화된 크기)
async function generateAndDownloadImage(data) {
  const container = document.getElementById('hiddenPrintContainer');
  
  // HTML 내용 생성 (최적화된 크기 - 3500px x 2500px)
  container.innerHTML = `
   <div style="background: white; padding: 50px; width: auto; min-width: 5000px; height: auto; min-height: 2000px; font-family: 'Noto Sans KR', Arial, sans-serif; overflow: visible;">
      <style>
        .main-title {
          text-align: center;
          font-size: 140px;
          font-weight: 900;
          margin-bottom: 30px;
          color: white;
          padding: 25px 40px;
          background: linear-gradient(135deg, #ff6600, #ff8f00);
          border-radius: 20px;
          text-shadow: 0 3px 6px rgba(0,0,0,0.2);
          box-shadow: 0 8px 24px rgba(255,102,0,0.3);
        }
.print-container {
  display: flex;
  gap: 40px;
  height: calc(100% - 140px);
  flex-direction: column;
  align-items: stretch;  /* 이 줄 추가 */
}
        .main-sections-container {
          display: flex;
          gap: 40px;
          flex: 1;
        }
        .comparison-section {
          flex: 1;
          display: flex;
          flex-direction: column;
        }
        .section-header {
          text-align: center;
          font-size: 80px;
          font-weight: 800;
          margin-bottom: 25px;
          padding: 20px;
          border-radius: 16px;
          text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .before-header {
          color: #444;
          background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
          border: 3px solid #999;
        }
        .after-header {
          color: #1565C0;
          background: linear-gradient(135deg, #E8F4FD, #D1E7DD);
          border: 3px solid #1976D2;
        }
        .sections-container {
          display: flex;
          gap: 25px;
          justify-content: center;
          flex: 1;
        }
        .section {
          width: 800px;
          border-radius: 16px;
          padding: 20px;
          overflow-y: auto;
        }
        .before-sections .section {
          border: 3px solid #999;
          background: linear-gradient(135deg, #fafafa, #f5f5f5);
          box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .after-sections .section {
          border: 3px solid #1976D2;
          background: linear-gradient(135deg, #E8F5FF, #F0F9FF);
          box-shadow: 0 6px 18px rgba(25,118,210,0.25);
        }
        .before-sections .section-title {
          background: linear-gradient(135deg, #666, #888);
        }
        .after-sections .section-title {
          background: linear-gradient(135deg, #1565C0, #1976D2);
        }
        .section-title {
          text-align: center;
          font-weight: 800;
          font-size: 80px;
          margin-bottom: 15px;
          color: white;
          margin: -16px -16px 15px -16px;
          padding: 15px;
          border-radius: 12px 12px 0 0;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .subsection {
          margin-bottom: 12px;
          border: 2px solid #ddd;
          padding: 12px;
          border-radius: 12px;
          background: rgba(255,255,255,0.7);
        }
        .before-sections .subsection {
          background: rgba(248,248,248,0.9);
        }
        .after-sections .subsection {
          background: rgba(245,250,255,0.9);
        }
        .subsection-title {
          font-weight: 800;
          font-size: 60px;
          margin-bottom: 12px;
          text-align: center;
          background: white;
          padding: 10px;
          border: 2px solid #ddd;
          margin: -12px -12px 12px -12px;
          border-radius: 10px 10px 0 0;
          color: #333;
        }
        .coverage-item {
          margin-bottom: 4px;
          display: flex;
          flex-direction: column;
          padding: 3px 0;
        }
        .coverage-name {
          font-size: 40px;
          margin-bottom: 4px;
          font-weight: 600;
          line-height: 1.3;
        }
        .coverage-display {
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .progress-container {
          flex: 1;
          max-width: 500px;  /* 최대 너비 제한 */
         min-width: 20px;  /* 최소 너비 보장 */
          height: 20px;
          background: #e0e0e0;
          border-radius: 10px;
          overflow: hidden;
          margin-right: 4px;
        }
        .progress-bar {
          height: 100%;
          border-radius: 10px;
          transition: width 0.3s ease;
        }
        .progress-green { background: linear-gradient(90deg, #28a745, #34ce57); }
        .progress-yellow { background: linear-gradient(90deg, #ffc107, #ffdb4d); }
        .progress-red { background: linear-gradient(90deg, #dc3545, #e85d6d); }
        .coverage-value {
          font-size: 40px;
          font-weight: 700;
          white-space: nowrap;
          min-width: 140px;
          text-align: right;
        }
.examples-container {
  display: flex;
  gap: 40px;
  justify-content: flex-start;  /* center에서 flex-start로 변경 */
  height: auto;
  margin-top: 10px;  /* 30px에서 10px로 변경 */
  align-items: flex-start;
}
        .examples-row {
          display: flex;
          gap: 25px;
          justify-content: center;
          flex: 1;
        }
        .example-section {
          width: 800px;
          padding: 20px;
          border-radius: 15px;
        }
        .before-sections .example-section {
          border: 3px solid #999;
          background: rgba(248,248,248,0.9);
          box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .after-sections .example-section {
          border: 3px solid #1976D2;
          background: rgba(240,249,255,0.9);
          box-shadow: 0 6px 18px rgba(25,118,210,0.25);
        }
        .before-sections .example-title {
          background: linear-gradient(135deg, #666, #888);
        }
        .after-sections .example-title {
          background: linear-gradient(135deg, #1565C0, #1976D2);
        }
        .example-title {
          font-weight: 800;
          font-size: 80px;
          margin-bottom: 15px;
          text-align: center;
          padding: 12px;
          color: white;
          border-radius: 12px;
          margin: -16px -16px 15px -16px;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .example-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: 4px 0;
          padding: 4px 0;
          border-bottom: 2px dotted #ccc;
          white-space: nowrap;
          line-height: 1.4;
        }
        .example-name {
          flex: 1;
          font-size: 40px;
          overflow: hidden;
          text-overflow: ellipsis;
          font-weight: 600;
          color: #333;
        }
        .example-value {
          font-weight: 800;
          font-size: 40px;
          margin-left: 15px;
          color: #333;
          min-width: 200px;
          text-align: right;
        }
      </style>
      
      <div class="main-title">
        ${data.customerName}님의 한 장 요약 보장분석 (${data.birthDate ? data.birthDate.replace(/-/g, '') : 'yymmdd'})
      </div>
      
      <div class="print-container">
        <!-- 상단: 변경 전/후 주요 섹션들 -->
        <div class="main-sections-container">
          <!-- 변경 전 섹션 -->
          <div class="comparison-section">
            <div class="section-header before-header">변경 전 보장내용</div>
            <div class="before-sections">
              <div class="sections-container">
                <div class="section">
                  <div class="section-title">암</div>
                  ${generateCoverageItemsForPrint(data.coverages_before, ALL_COVERAGE_ITEMS.filter(i => i.category === 'cancer'), 'before')}
                </div>
                
                <div class="section">
                  <div class="section-title">2대 중대질환</div>
                  ${generateCoverageItemsForPrint(data.coverages_before, ALL_COVERAGE_ITEMS.filter(i => i.category === 'majorDisease'), 'before')}
                </div>
                
                <div class="section">
                  <div class="section-title">5대 필수 보험</div>
                  ${generateEssentialSectionForPrint(data.coverages_before, data.caregiverOption, 'before')}
                </div>
              </div>
            </div>
          </div>
          
          <!-- 변경 후 섹션 -->
          <div class="comparison-section">
            <div class="section-header after-header">변경 후 보장내용</div>
            <div class="after-sections">
              <div class="sections-container">
                <div class="section">
                  <div class="section-title">암</div>
                  ${generateCoverageItemsForPrint(data.coverages_after, ALL_COVERAGE_ITEMS.filter(i => i.category === 'cancer'), 'after')}
                </div>
                
                <div class="section">
                  <div class="section-title">2대 중대질환</div>
                  ${generateCoverageItemsForPrint(data.coverages_after, ALL_COVERAGE_ITEMS.filter(i => i.category === 'majorDisease'), 'after')}
                </div>
                
                <div class="section">
                  <div class="section-title">5대 필수 보험</div>
                  ${generateEssentialSectionForPrint(data.coverages_after, data.caregiverOption, 'after')}
                </div>
              </div>
            </div>
          </div>
        </div>
        
    <div class="examples-container">
  <!-- 변경 전 예시 섹션 -->
  <div class="comparison-section">
    <div class="before-sections">
      <div class="sections-container">  <!-- examples-row를 sections-container로 변경 -->
        ${generateExampleSectionsForPrint(data.coverages_before, 'before')}
      </div>
    </div>
  </div>
  
  <!-- 변경 후 예시 섹션 -->
  <div class="comparison-section">
    <div class="after-sections">
      <div class="sections-container">  <!-- examples-row를 sections-container로 변경 -->
        ${generateExampleSectionsForPrint(data.coverages_after, 'after')}
      </div>
    </div>
  </div>
</div>
  `;
  
  // html2canvas를 사용하여 이미지 생성
  try {
const canvas = await html2canvas(container.firstElementChild, {
  scale: 2,
  logging: false,
  useCORS: true,
  backgroundColor: '#ffffff',
  // width: 3500,  // 이 줄 제거
  // height: 3500  // 이 줄 제거
});
    
    // 캔버스를 이미지로 변환
    canvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `보장분석_${data.customerName}_${new Date().getTime()}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  } catch (error) {
    console.error('이미지 생성 오류:', error);
    alert('이미지 생성 중 오류가 발생했습니다.');
  }
  
  // 컨테이너 비우기
  container.innerHTML = '';
}

// 로컬 스토리지에 데이터 저장
function saveDataToStorage(data) {
  let savedData = JSON.parse(localStorage.getItem('ocrWarrantyData') || '[]');
  
  const existingIndex = savedData.findIndex(item => item.customerName === data.customerName);
  
  if (existingIndex >= 0) {
    savedData[existingIndex] = data;
  } else {
    savedData.push(data);
  }
  
  localStorage.setItem('ocrWarrantyData', JSON.stringify(savedData));
  savedDataList = savedData;
}

// 저장된 데이터 로드
function loadSavedData() {
  savedDataList = JSON.parse(localStorage.getItem('ocrWarrantyData') || '[]');
}

// 저장된 데이터 목록 표시
function displaySavedList() {
  const savedList = document.getElementById('savedList');
  
  if (savedDataList.length === 0) {
    savedList.innerHTML = '<div class="hint">저장된 보장분석지가 없습니다.</div>';
    return;
  }
  
  savedList.innerHTML = savedDataList.map(data => `
    <div class="saved-item" onclick="loadSavedItem('${data.customerName}')">
      <div class="saved-item-title">${data.customerName}</div>
      <div class="saved-item-date">${data.inputDate}</div>
    </div>
  `).join('');
}

// 저장된 항목 필터링
function filterSavedList() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const filteredList = savedDataList.filter(data => 
    data.customerName.toLowerCase().includes(searchTerm)
  );
  
  const savedList = document.getElementById('savedList');
  
  if (filteredList.length === 0) {
    savedList.innerHTML = '<div class="hint">검색 결과가 없습니다.</div>';
    return;
  }
  
  savedList.innerHTML = filteredList.map(data => `
    <div class="saved-item" onclick="loadSavedItem('${data.customerName}')">
      <div class="saved-item-title">${data.customerName}</div>
      <div class="saved-item-date">${data.inputDate}</div>
    </div>
  `).join('');
}

// 저장된 항목 로드하여 입력 화면에 표시
function loadSavedItem(customerName) {
  const data = savedDataList.find(item => item.customerName === customerName);
  if (!data) return;
  
  currentData = data;
  
  showScreen('input');
  loadCurrentDataToForm();
}

// 현재 데이터를 폼에 로드
function loadCurrentDataToForm() {
  if (!currentData.customerName) return;
  
  document.getElementById('customerName').value = currentData.customerName;
  document.getElementById('birthDate').value = currentData.birthDate || '';
  
  // 담보 데이터 로드 (변경 전/후)
  if (currentData.coverages_before) {
    Object.entries(currentData.coverages_before).forEach(([key, data]) => {
      const input = document.getElementById(key + '_before');
      if (input) {
        input.value = data.value || '';
      }
    });
  }
  
  if (currentData.coverages_after) {
    Object.entries(currentData.coverages_after).forEach(([key, data]) => {
      const input = document.getElementById(key + '_after');
      if (input) {
        input.value = data.value || '';
      }
    });
  }
  
  // 간병인 옵션 로드
  if (currentData.caregiverOption) {
    document.getElementById('caregiverUse').checked = currentData.caregiverOption === 'use';
    document.getElementById('caregiverSupport').checked = currentData.caregiverOption === 'support';
    handleCaregiverOptionChange();
  }
}

// 인쇄용 담보 항목 생성 (최적화된 크기)
function generateCoverageItemsForPrint(coverages, items, type) {
  return items.map(item => {
    const coverage = coverages[item.key];
    const value = coverage ? extractNumber(coverage.value) : 0;
    
    let displayValue = '';
    let valueColor = '#333'; 
    
    if (value === 0) {
      displayValue = '✗';
      valueColor = '#dc3545';
    } else {
      displayValue = value.toLocaleString() + '만원';
      valueColor = '#333';
    }
    
    let progressBarHtml = '';
    if (value === 0) {
      progressBarHtml = '<div class="progress-container"><div class="progress-bar" style="width: 0%; background: #e0e0e0;"></div></div>';
    } else {
      let barColor = '#dc3545';
      const percentage = calculateProgressPercentage(value, item.standardAmount);
      if (percentage >= 100) barColor = '#28a745';
      else if (percentage >= 30) barColor = '#ffc107';
      const width = Math.min(percentage, 100);
      progressBarHtml = `<div class="progress-container"><div class="progress-bar" style="width: ${width}%; background: ${barColor};"></div></div>`;
    }
    
    let shortName = item.name;
    if (shortName.length > 12) {
      shortName = shortName.replace('질환진단비', '진단').replace('질환수술비', '수술').replace('특정치료비', '치료');
    }
    
    return `
      <div class="coverage-item">
        <div class="coverage-name" style="color: ${value === 0 ? '#dc3545' : '#333'};">${shortName}</div>
        <div class="coverage-display">
          ${progressBarHtml}
          <span class="coverage-value" style="color: ${valueColor};">${displayValue}</span>
        </div>
      </div>
    `;
  }).join('');
}


  // 진행률 바와 금액만 표시하는 함수
function generateSimpleItemForPrint(coverages, key, type) {
  const coverage = coverages[key];
  const value = coverage ? extractNumber(coverage.value) : 0;
  
  let displayValue = '';
  let valueColor = '#333';
  
  if (value === 0) {
    displayValue = '✗';
    valueColor = '#dc3545';
  } else {
    displayValue = value.toLocaleString() + '만원';
    valueColor = '#333';
  }
  
  let progressBarHtml = '';
  if (value === 0) {
    progressBarHtml = '<div class="progress-container"><div class="progress-bar" style="width: 0%; background: #e0e0e0;"></div></div>';
  } else {
    const standardItem = ALL_COVERAGE_ITEMS.find(item => item.key === key) || { standardAmount: 1000 };
    const percentage = calculateProgressPercentage(value, standardItem.standardAmount);
    let barColor = '#dc3545';
    if (percentage >= 100) barColor = '#28a745';
    else if (percentage >= 30) barColor = '#ffc107';
    const width = Math.min(percentage, 100);
    progressBarHtml = `<div class="progress-container"><div class="progress-bar" style="width: ${width}%; background: ${barColor};"></div></div>`;
  }
  
  return `
    <div class="coverage-item">
      <div class="coverage-display">
        ${progressBarHtml}
        <span class="coverage-value" style="color: ${valueColor};">${displayValue}</span>
      </div>
    </div>
  `;
}

// 필수보험 개별 항목 생성 (최적화된 크기)
function generateEssentialItemForPrint(coverages, key, name, type) {
  const coverage = coverages[key];
  const value = coverage ? extractNumber(coverage.value) : 0;
  
  let displayValue = '';
  let valueColor = '#333';
  
  if (value === 0) {
    displayValue = '✗';
    valueColor = '#dc3545';
  } else {
    displayValue = value.toLocaleString() + '만원';
    valueColor = '#333';
  }
  
  let progressBarHtml = '';
  if (value === 0) {
    progressBarHtml = '<div class="progress-container"><div class="progress-bar" style="width: 0%; background: #e0e0e0;"></div></div>';
  } else {
    const standardItem = ALL_COVERAGE_ITEMS.find(item => item.key === key) || { standardAmount: 1000 };
    const percentage = calculateProgressPercentage(value, standardItem.standardAmount);
    let barColor = '#dc3545';
    if (percentage >= 100) barColor = '#28a745';
    else if (percentage >= 30) barColor = '#ffc107';
    const width = Math.min(percentage, 100);
    progressBarHtml = `<div class="progress-container"><div class="progress-bar" style="width: ${width}%; background: ${barColor};"></div></div>`;
  }
  
  return `
    <div class="coverage-item">
      <div class="coverage-name" style="color: ${value === 0 ? '#dc3545' : '#333'};">${name}</div>
      <div class="coverage-display">
        ${progressBarHtml}
        <span class="coverage-value" style="color: ${valueColor};">${displayValue}</span>
      </div>
    </div>
  `;
}

// 5대 필수보험 섹션 생성 (최적화된 크기)
function generateEssentialSectionForPrint(coverages, caregiverOption, type) {
  let html = '';
  
  html += `
    <div class="subsection">
      <div class="subsection-title">실손의료비</div>
      ${generateEssentialItemForPrint(coverages, 'diseaseHospitalization', '(실손)질병입원', type)}
      ${generateEssentialItemForPrint(coverages, 'injuryHospitalization', '(실손)상해입원', type)}
    </div>
  `;
  
  html += `
    <div class="subsection">
      <div class="subsection-title">운전자</div>
      ${generateEssentialItemForPrint(coverages, 'criminalSettlement', '형사합의금', type)}
      ${generateEssentialItemForPrint(coverages, 'lawyerAppointment', '변호사선임비', type)}
    </div>
  `;
  
  html += `
    <div class="subsection">
      <div class="subsection-title">간병인일당</div>`;
  
  if (caregiverOption === 'support') {
    html += `
      <div class="coverage-item">
        <div class="coverage-name">지원 선택</div>
        <div class="coverage-display">
          <div class="progress-container"><div class="progress-bar" style="width: 0%; background: #e0e0e0;"></div></div>
          <span class="coverage-value" style="color: #999;">-</span>
        </div>
      </div>`;
  } else {
    html += `
      ${generateEssentialItemForPrint(coverages, 'nursingHospitalOut', '요양병원 외', type)}
      ${generateEssentialItemForPrint(coverages, 'nursingHospitalIn', '요양병원', type)}
      ${generateEssentialItemForPrint(coverages, 'nursingCareIntegrated', '간호간병통합', type)}`;
  }
  
  html += `</div>`;
  
html += `
  <div class="subsection">
    <div class="subsection-title">일상생활배상책임</div>
    ${generateSimpleItemForPrint(coverages, 'dailyLifeLiability', type)}
  </div>
`;

html += `
  <div class="subsection">
    <div class="subsection-title">화재벌금</div>
    ${generateSimpleItemForPrint(coverages, 'fireFine', type)}
  </div>
`;
  
  return html;
}

// 예시 섹션 생성 (가로 배치로 수정)
function generateExampleSectionsForPrint(coverages, type) {
  return `
    <div class="example-section">
      <div class="example-title">일반암 예시</div>
      ${generateExampleItemForPrint('다빈치수술', calculateExample1(coverages))}
      ${generateExampleItemForPrint('1부위 전이+표적', calculateExample2(coverages))}
      ${generateExampleItemForPrint('중입자치료', calculateExample3(coverages))}
    </div>
    
    <div class="example-section">
      <div class="example-title">뇌경색 예시</div>
      ${generateExampleItemForPrint('스텐트', calculateStentExample(coverages))}
      ${generateExampleItemForPrint('스텐트+혈전용해', calculateStentThrombolysisExample(coverages))}
      ${generateExampleItemForPrint('혈전제거+용해+중환자', calculateComplexTreatmentExample(coverages))}
    </div>
    
    <div class="example-section">
      <div class="example-title">심근경색 예시</div>
      ${generateExampleItemForPrint('스텐트', calculateMyocardialStentExample(coverages))}
      ${generateExampleItemForPrint('스텐트+혈전용해', calculateMyocardialStentThrombolysisExample(coverages))}
      ${generateExampleItemForPrint('혈전제거+용해+중환자', calculateMyocardialComplexTreatmentExample(coverages))}
    </div>
  `;
}

// 인쇄용 예시 항목 생성 (최적화된 크기)
function generateExampleItemForPrint(name, value) {
  return `
    <div class="example-item">
      <div class="example-name">${name}</div>
      <div class="example-value">${value}만원</div>
    </div>
  `;
}

// 치료 보장 예시 계산 함수들
function calculateExample1(coverages) {
  const c5 = extractNumber(coverages.generalCancer?.value || 0);
  const c6 = extractNumber(coverages.totalCancer?.value || 0);
  const c8 = extractNumber(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = extractNumber(coverages.cancerNonCoveredTreatment?.value || 0);
  const c12 = extractNumber(coverages.cancerSurgery?.value || 0);
  const c13 = extractNumber(coverages.daVinciSurgery?.value || 0);
  const c14 = extractNumber(coverages.surgery5Type?.value || 0);
  
  return (c5 + c6 + c8 + c9 + c12 + c13 + c14).toLocaleString();
}

function calculateExample2(coverages) {
  const c5 = extractNumber(coverages.generalCancer?.value || 0);
  const c6 = extractNumber(coverages.totalCancer?.value || 0);
  const c7 = extractNumber(coverages.metastasisCancer?.value || 0);
  const c8 = extractNumber(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = extractNumber(coverages.cancerNonCoveredTreatment?.value || 0);
  const c10 = extractNumber(coverages.targetTherapy?.value || 0);
  
  return (c5 + c6 + c7 + c8 + c9 + c10).toLocaleString();
}

function calculateExample3(coverages) {
  const c5 = extractNumber(coverages.generalCancer?.value || 0);
  const c6 = extractNumber(coverages.totalCancer?.value || 0);
  const c8 = extractNumber(coverages.cancerSpecificTreatment?.value || 0);
  const c9 = extractNumber(coverages.cancerNonCoveredTreatment?.value || 0);
  const c11 = extractNumber(coverages.heavyIonTherapy?.value || 0);
  
  return (c5 + c6 + c8 + c9 + c11).toLocaleString();
}

function calculateStentExample(coverages) {
  const g5 = extractNumber(coverages.cerebrovascularDiagnosis?.value || 0);
  const g6 = extractNumber(coverages.strokeDiagnosis?.value || 0);
  const g15 = extractNumber(coverages.twoMajorTreatment?.value || 0);
  const g16 = extractNumber(coverages.majorCirculatorySurgery?.value || 0);
  const g9 = extractNumber(coverages.cerebrovascularSurgery?.value || 0);
  const g10 = extractNumber(coverages.strokeSurgery?.value || 0);
  const g21 = extractNumber(coverages.surgery3Type?.value || 0);
  const g23 = extractNumber(coverages.disease124Surgery?.value || 0);
  const g24 = extractNumber(coverages.sevenOrganSurgery?.value || 0);
  
  return (g5 + g6 + g15 + g16 + g9 + g10 + g21 + g23 + g24/2).toLocaleString();
}

function calculateStentThrombolysisExample(coverages) {
  const baseValue = parseFloat(calculateStentExample(coverages).replace(/,/g, ''));
  const g18 = extractNumber(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g13 = extractNumber(coverages.strokeThrombolysis?.value || 0);
  
  return (baseValue + g18 + g13).toLocaleString();
}

function calculateComplexTreatmentExample(coverages) {
  const g5 = extractNumber(coverages.cerebrovascularDiagnosis?.value || 0);
  const g6 = extractNumber(coverages.strokeDiagnosis?.value || 0);
  const g15 = extractNumber(coverages.twoMajorTreatment?.value || 0);
  const g17 = extractNumber(coverages.majorCirculatoryThrombectomy?.value || 0);
  const g9 = extractNumber(coverages.cerebrovascularSurgery?.value || 0);
  const g10 = extractNumber(coverages.strokeSurgery?.value || 0);
  const g21 = extractNumber(coverages.surgery3Type?.value || 0);
  const g23 = extractNumber(coverages.disease124Surgery?.value || 0);
  const g24 = extractNumber(coverages.sevenOrganSurgery?.value || 0);
  const g18 = extractNumber(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g13 = extractNumber(coverages.strokeThrombolysis?.value || 0);
  const g19 = extractNumber(coverages.majorCirculatoryICU?.value || 0);
  const g20 = extractNumber(coverages.thrombectomyTreatment?.value || 0);
  
  return (g5 + g6 + g15 + g17 + g9 + g10 + g21 + g23 + g24/2 + g18 + g13 + g19 + g20).toLocaleString();
}

function calculateMyocardialStentExample(coverages) {
  const g7 = extractNumber(coverages.ischemicHeartDiagnosis?.value || 0);
  const g8 = extractNumber(coverages.myocardialInfarctionDiagnosis?.value || 0);
  const g15 = extractNumber(coverages.twoMajorTreatment?.value || 0);
  const g16 = extractNumber(coverages.majorCirculatorySurgery?.value || 0);
  const g11 = extractNumber(coverages.ischemicHeartSurgery?.value || 0);
  const g12 = extractNumber(coverages.myocardialInfarctionSurgery?.value || 0);
  const g21 = extractNumber(coverages.surgery3Type?.value || 0);
  const g23 = extractNumber(coverages.disease124Surgery?.value || 0);
  const g24 = extractNumber(coverages.sevenOrganSurgery?.value || 0);
  
  return (g7 + g8 + g15 + g16 + g11 + g12 + g21 + g23 + g24/2).toLocaleString();
}

function calculateMyocardialStentThrombolysisExample(coverages) {
  const baseValue = parseFloat(calculateMyocardialStentExample(coverages).replace(/,/g, ''));
  const g18 = extractNumber(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g14 = extractNumber(coverages.myocardialInfarctionThrombolysis?.value || 0);
  
  return (baseValue + g18 + g14).toLocaleString();
}

function calculateMyocardialComplexTreatmentExample(coverages) {
  const g7 = extractNumber(coverages.ischemicHeartDiagnosis?.value || 0);
  const g8 = extractNumber(coverages.myocardialInfarctionDiagnosis?.value || 0);
  const g15 = extractNumber(coverages.twoMajorTreatment?.value || 0);
  const g17 = extractNumber(coverages.majorCirculatoryThrombectomy?.value || 0);
  const g11 = extractNumber(coverages.ischemicHeartSurgery?.value || 0);
  const g12 = extractNumber(coverages.myocardialInfarctionSurgery?.value || 0);
  const g21 = extractNumber(coverages.surgery3Type?.value || 0);
  const g23 = extractNumber(coverages.disease124Surgery?.value || 0);
  const g24 = extractNumber(coverages.sevenOrganSurgery?.value || 0);
  const g18 = extractNumber(coverages.majorCirculatoryThrombolysis?.value || 0);
  const g14 = extractNumber(coverages.myocardialInfarctionThrombolysis?.value || 0);
  const g19 = extractNumber(coverages.majorCirculatoryICU?.value || 0);
  const g20 = extractNumber(coverages.thrombectomyTreatment?.value || 0);
  
  return (g7 + g8 + g15 + g17 + g11 + g12 + g21 + g23 + g24/2 + g18 + g14 + g19 + g20).toLocaleString();
}
</script>

</body>
</html>
