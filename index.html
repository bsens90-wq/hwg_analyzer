<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ì¥ë¶„ì„ì§€</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-steps {
            display: flex;
            background: #f8f9fa;
            padding: 10px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-step {
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
        }

        .nav-step.active {
            background: #c62828;
            color: white;
        }

        .nav-step:not(.active) {
            background: white;
            border: 1px solid #ddd;
        }

        /* í—¤ë” */
        .header {
            padding: 20px;
            border-bottom: 2px solid #eee;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .info-row {
            display: flex;
            gap: 30px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            gap: 5px;
        }

        /* ì—…ë¡œë“œ ì„¹ì…˜ */
        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            position: relative;
        }

        .upload-area:hover {
            border-color: #c62828;
            background: #fafafa;
        }

        .upload-area.processing {
            border-color: #2196F3;
            background: #f0f8ff;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: #c62828;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        .upload-btn:hover {
            background: #a52525;
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-info {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            display: none;
        }

        .progress-info.show {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #2196F3;
            transition: width 0.3s;
            border-radius: 5px;
        }

        .uploaded-image {
            max-width: 300px;
            max-height: 200px;
            margin: 20px auto;
            display: none;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            padding: 20px;
        }

        .sections-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .section {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background: white;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #4caf50 0deg, #4caf50 var(--score-deg), #e0e0e0 var(--score-deg), #e0e0e0 360deg);
        }

        .score-circle span {
            position: relative;
            z-index: 1;
            background: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 14px;
        }

        .item {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .item-amounts {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .amount-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
            font-size: 12px;
        }

        .amount-display {
            font-size: 13px;
            color: #666;
        }

        .shortage {
            color: #c62828;
            font-weight: bold;
            font-size: 12px;
        }

        .sufficient {
            color: #4caf50;
            font-weight: bold;
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }

        /* ìƒí™œë³´ì¥ ìŠ¤íƒ€ì¼ */
        .lifestyle-section {
            grid-column: 1 / -1;
        }

        .lifestyle-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .lifestyle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .status-o { background: #4caf50; }
        .status-triangle { background: #ff9800; }
        .status-x { background: #f44336; }

        /* ê²°ê³¼ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ */
        .action-buttons {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
            background: #f9f9f9;
        }

        .generate-btn {
            background: #2196F3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 0 10px;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* ìˆ¨ê²¨ì§„ ì¶œë ¥ìš© ìº”ë²„ìŠ¤ */
        .output-canvas {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }

        /* ì›ë³¸ ìŠ¤íƒ€ì¼ì˜ ë³´ì¥ë¶„ì„ì§€ */
        .original-layout {
            width: 1200px;
            height: 800px;
            background: white;
            font-family: 'Malgun Gothic', sans-serif;
            position: relative;
            box-sizing: border-box;
            padding: 20px;
        }

        .original-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .original-nav-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #666;
            border: 1px solid #ddd;
        }

        .original-nav-item.active {
            background: #c62828;
            color: white;
            border-color: #c62828;
        }

        .original-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: left;
        }

        .original-legend {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 11px;
        }

        .original-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .original-legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .original-info {
            display: flex;
            gap: 20px;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .original-main {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            height: 500px;
        }

        .original-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .original-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .original-section-title {
            font-size: 16px;
            font-weight: bold;
        }

        .original-score {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
            position: relative;
        }

        .original-items {
            flex: 1;
            overflow-y: auto;
        }

        .original-item {
            margin-bottom: 8px;
            font-size: 10px;
            line-height: 1.3;
        }

        .original-item-name {
            font-weight: bold;
            margin-bottom: 3px;
            color: #333;
        }

        .original-item-amount {
            color: #666;
        }

        .original-shortage {
            color: #c62828;
            font-weight: bold;
        }

        .original-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin-top: 2px;
            overflow: hidden;
        }

        .original-bar-fill {
            height: 100%;
        }

        .original-lifestyle {
            grid-column: 1 / -1;
            height: 120px;
        }

        .original-lifestyle-items {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            height: 80px;
        }

        .original-lifestyle-item {
            font-size: 9px;
            text-align: center;
            padding: 5px;
            border-radius: 4px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .original-status {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
            margin: 0 auto;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .sections-container {
                grid-template-columns: 1fr;
            }
            
            .info-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-steps {
                overflow-x: auto;
                justify-content: flex-start;
                padding: 10px;
            }
        }

        .edit-mode {
            background: #fff3cd !important;
            border: 1px solid #ffc107 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="nav-steps">
            <div class="nav-step">1. ì»¨ì„¤íŒ… ê°€ì´ë“œ</div>
            <div class="nav-step active">2. ê°„í¸ë¶„ì„</div>
            <div class="nav-step">3. ê³„ì•½ìƒì„¸</div>
            <div class="nav-step">4. ì£¼ìš”ë³´ì¥</div>
            <div class="nav-step">5. ì˜ˆìƒë³´í—˜ê¸ˆ ì¡°íšŒ</div>
            <div class="nav-step">6. ì»¨ì„¤íŒ… ê²°ê³¼</div>
            <div class="nav-step">7. ì „/í›„ë¹„êµ</div>
        </div>

        <!-- í—¤ë” -->
        <div class="header">
            <div class="title" id="title">ê³ ê°ë‹˜ì˜ í•œ ì¥ ìš”ì•½ ë³´ì¥ë¶„ì„</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span>100% ì´ìƒ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>80% ì´ìƒ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f44336;"></div>
                    <span>30% ë¯¸ë§Œ</span>
                </div>
            </div>
            <div class="info-row" id="info-row">
                <div class="info-item">
                    <span>ìƒë…„ì›”ì¼</span>
                    <span id="birth-date">-</span>
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ìƒë ¹ì¼</span>
                    <span id="age-date">-</span>
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ì†í•´ë³´í—˜</span>
                    <span id="damage-insurance">-</span>ê±´
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ìƒëª…ë³´í—˜</span>
                    <span id="life-insurance">-</span>ê±´
                </div>
                <div class="info-item">
                    <span>/</span>
                    <span>ì›”ë‚©ë³´í—˜ë£Œ í•©ê³„</span>
                    <span id="monthly-premium">-</span>ì›
                </div>
            </div>
        </div>

        <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="upload-section">
            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(event)">
                <div id="upload-content">
                    <h3>ë³´ì¥ë¶„ì„ì§€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
                    <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ì—…ë¡œë“œ</p>
                    <button class="upload-btn" type="button" id="upload-btn">íŒŒì¼ ì„ íƒ</button>
                    <button class="upload-btn" type="button" onclick="loadSampleData()" style="background: #4CAF50; margin-left: 10px;">ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ</button>
                </div>
                <img id="uploaded-image" class="uploaded-image" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€">
            </div>
            
            <div class="progress-info" id="progress-info">
                <div id="progress-text">ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progress-bar"></div>
                </div>
                <div id="progress-details"></div>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <div class="sections-container" id="sections-container">
                <!-- ê°€ì¡±ë³´ì¥ -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ê°€ì¡±ë³´ì¥</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="family-score">-ì </span>
                        </div>
                    </div>
                    <div id="family-items">
                        <div class="item">
                            <div class="item-name">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                        </div>
                    </div>
                </div>

                <!-- í°ë³‘ë³´ì¥ -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">í°ë³‘ë³´ì¥</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="disease-score">-ì </span>
                        </div>
                    </div>
                    <div id="disease-items">
                        <div class="item">
                            <div class="item-name">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                        </div>
                    </div>
                </div>

                <!-- ì˜ë£Œë³´ì¥ -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ì˜ë£Œë³´ì¥</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="medical-score">-ì </span>
                        </div>
                    </div>
                    <div id="medical-items">
                        <div class="item">
                            <div class="item-name">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                        </div>
                    </div>
                </div>

                <!-- ê°„ë³‘ë³´ì¥ -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">ê°„ë³‘ë³´ì¥</div>
                        <div class="score-circle" style="--score-deg: 0deg;">
                            <span id="care-score">-ì </span>
                        </div>
                    </div>
                    <div id="care-items">
                        <div class="item">
                            <div class="item-name">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                        </div>
                    </div>
                </div>

                <!-- ìƒí™œë³´ì¥ -->
                <div class="section lifestyle-section">
                    <div class="section-header">
                        <div class="section-title">ìƒí™œë³´ì¥</div>
                        <div style="font-size: 12px; color: #666;">
                            <span style="color: #4caf50;">â—</span> ì ì •
                            <span style="color: #ff9800; margin-left: 10px;">â–²</span> ë¶€ì¡±
                            <span style="color: #f44336; margin-left: 10px;">âœ•</span> ë¯¸ë³´ì¥
                        </div>
                    </div>
                    <div class="lifestyle-items" id="lifestyle-items">
                        <div class="lifestyle-item">
                            <div>ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
        <div class="action-buttons">
            <button class="generate-btn" onclick="generateOriginalLayout()">
                ğŸ“Š ì›ë³¸ í˜•íƒœ ë³´ì¥ë¶„ì„ì§€ ìƒì„±
            </button>
            <button class="generate-btn" onclick="downloadAsImage()">
                ğŸ’¾ ì´ë¯¸ì§€ë¡œ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
    </div>

    <!-- ìˆ¨ê²¨ì§„ ì›ë³¸ ë ˆì´ì•„ì›ƒ -->
    <div id="original-layout" class="original-layout output-canvas">
        <!-- ì›ë³¸ í˜•íƒœì˜ ë³´ì¥ë¶„ì„ì§€ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>

    <script>
        let currentData = {
            personal: {
                name: "ê³ ê°",
                birthDate: "",
                ageDate: "",
                damageInsurance: 0,
                lifeInsurance: 0,
                monthlyPremium: 0
            },
            sections: {
                family: { score: 0, items: [] },
                disease: { score: 0, items: [] },
                medical: { score: 0, items: [] },
                care: { score: 0, items: [] }
            },
            lifestyle: []
        };

        let isProcessing = false;

        // ì´ˆê¸°í™”
        function init() {
            updatePersonalInfo();
            renderEmptySections();
            renderEmptyLifestyle();
        }

        // ë¹ˆ ì„¹ì…˜ ë Œë”ë§
        function renderEmptySections() {
            const sections = ['family', 'disease', 'medical', 'care'];
            sections.forEach(sectionKey => {
                const scoreElement = document.getElementById(`${sectionKey}-score`);
                scoreElement.textContent = '-ì ';
                updateScoreCircle(scoreElement.parentElement, 0);
            });
        }

        // ë¹ˆ ìƒí™œë³´ì¥ ë Œë”ë§
        function renderEmptyLifestyle() {
            const container = document.getElementById('lifestyle-items');
            container.innerHTML = '<div class="lifestyle-item"><div>ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div></div>';
        }

        // ê°œì¸ì •ë³´ ì—…ë°ì´íŠ¸
        function updatePersonalInfo() {
            document.getElementById('title').textContent = `${currentData.personal.name}ë‹˜ì˜ í•œ ì¥ ìš”ì•½ ë³´ì¥ë¶„ì„`;
            document.getElementById('birth-date').textContent = currentData.personal.birthDate || '-';
            document.getElementById('age-date').textContent = currentData.personal.ageDate || '-';
            document.getElementById('damage-insurance').textContent = currentData.personal.damageInsurance || '-';
            document.getElementById('life-insurance').textContent = currentData.personal.lifeInsurance || '-';
            document.getElementById('monthly-premium').textContent = currentData.personal.monthlyPremium ? 
                currentData.personal.monthlyPremium.toLocaleString() : '-';
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleFileUpload(event) {
            if (isProcessing) return;
            
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            isProcessing = true;
            const uploadBtn = document.getElementById('upload-btn');
            const uploadArea = document.getElementById('upload-area');
            const progressInfo = document.getElementById('progress-info');
            const uploadedImage = document.getElementById('uploaded-image');

            // UI ìƒíƒœ ë³€ê²½
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
            uploadArea.classList.add('processing');
            progressInfo.classList.add('show');

            try {
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                const imageUrl = URL.createObjectURL(file);
                uploadedImage.src = imageUrl;
                uploadedImage.style.display = 'block';

                // OCR ì²˜ë¦¬
                await performOCR(file);

            } catch (error) {
                console.error('OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                
                // ì˜¤ë¥˜ ì‹œ UI ë³µì›
                uploadedImage.style.display = 'none';
                progressInfo.classList.remove('show');
                
            } finally {
                isProcessing = false;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ë‹¤ë¥¸ íŒŒì¼ ì„ íƒ';
                uploadArea.classList.remove('processing');
            }
        }

        // OCR ìˆ˜í–‰ - ê°œì„ ëœ ë²„ì „
        async function performOCR(file) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressDetails = document.getElementById('progress-details');

            try {
                progressText.textContent = 'OCR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                progressBar.style.width = '5%';

                // Tesseract.jsê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (typeof Tesseract === 'undefined') {
                    throw new Error('Tesseract.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                progressText.textContent = 'OCR ì›Œì»¤ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                progressBar.style.width = '10%';

                // Worker ìƒì„± ì‹œ ë” ëª…í™•í•œ ì˜µì…˜ ì„¤ì •
                const worker = await Tesseract.createWorker(['kor', 'eng'], 1, {
                    corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@4/tesseract-core-simd.wasm.js',
                    workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/worker.min.js',
                    langPath: 'https://tessdata.projectnaptha.com/4.0.0_best',
                    logger: (m) => {
                        console.log('Tesseract ë¡œê·¸:', m);
                        
                        if (m.status === 'loading tesseract core') {
                            progressText.textContent = 'OCR ì—”ì§„ì„ ë¡œë”©í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                            progressBar.style.width = '15%';
                        } else if (m.status === 'initializing tesseract') {
                            progressText.textContent = 'OCR ì—”ì§„ì„ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                            progressBar.style.width = '20%';
                        } else if (m.status === 'loading language traineddata') {
                            progressText.textContent = 'í•œê¸€ ì–¸ì–´ ëª¨ë¸ì„ ë¡œë”©í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                            progressBar.style.width = '25%';
                            progressDetails.textContent = 'ì²˜ìŒ ì‹¤í–‰ ì‹œ ì–¸ì–´ ëª¨ë¸ ë‹¤ìš´ë¡œë“œë¡œ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                        } else if (m.status === 'initializing api') {
                            progressText.textContent = 'OCR APIë¥¼ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                            progressBar.style.width = '30%';
                        } else if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 60) + 30; // 30-90%
                            progressBar.style.width = progress + '%';
                            progressText.textContent = 'ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                            progressDetails.textContent = `ì§„í–‰ë¥ : ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                progressText.textContent = 'ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                
                // ì´ë¯¸ì§€ ì „ì²˜ë¦¬ë¥¼ ìœ„í•œ ìº”ë²„ìŠ¤ ìƒì„±
                const processedImage = await preprocessImage(file);
                
                // OCR ì‹¤í–‰
                const { data: { text, confidence } } = await worker.recognize(processedImage);
                
                console.log('OCR ê²°ê³¼:', text);
                console.log('ì‹ ë¢°ë„:', confidence);
                
                progressBar.style.width = '95%';
                progressText.textContent = 'ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                progressDetails.textContent = 'í…ìŠ¤íŠ¸ íŒŒì‹± ì¤‘...';

                // OCR ê²°ê³¼ íŒŒì‹±
                await parseOCRResult(text);

                progressBar.style.width = '100%';
                progressText.textContent = 'ì™„ë£Œ! ë³´ì¥ë¶„ì„ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.';
                progressDetails.textContent = `ì¸ì‹ ì‹ ë¢°ë„: ${Math.round(confidence)}%`;

                await worker.terminate();

                // 3ì´ˆ í›„ ì§„í–‰ë¥  ì •ë³´ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    document.getElementById('progress-info').classList.remove('show');
                }, 4000);

            } catch (error) {
                console.error('OCR ìƒì„¸ ì˜¤ë¥˜:', error);
                
                progressText.textContent = 'OCR ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                progressDetails.textContent = 'ìˆ˜ë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”.';
                
                // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì±„ìš°ê¸°
                fillDefaultItems();
                updatePersonalInfo();
                renderSections();
                renderLifestyle();
                
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë” ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ í‘œì‹œ
                setTimeout(() => {
                    alert('ì´ë¯¸ì§€ ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nê°€ëŠ¥í•œ í•´ê²°ë°©ë²•:\n1. ë” ì„ ëª…í•˜ê³  ê³ í™”ì§ˆì˜ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”\n2. ì´ë¯¸ì§€ì˜ í…ìŠ¤íŠ¸ê°€ ìˆ˜í‰ìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”\n3. ìˆ˜ë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                    document.getElementById('progress-info').classList.remove('show');
                }, 2000);
                
                throw error;
            }
        }

        // ì´ë¯¸ì§€ ì „ì²˜ë¦¬ í•¨ìˆ˜
        async function preprocessImage(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (ìµœëŒ€ 1920x1080ìœ¼ë¡œ ì œí•œ)
                    const maxWidth = 1920;
                    const maxHeight = 1080;
                    let { width, height } = img;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ëŒ€ë¹„ ë° ë°ê¸° ì¡°ì •ìœ¼ë¡œ OCR ì •í™•ë„ í–¥ìƒ
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        // RGB ê°’ ì¡°ì • (ëŒ€ë¹„ ì¦ê°€)
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        const factor = 1.2; // ëŒ€ë¹„ ì¡°ì • íŒ©í„°
                        
                        data[i] = Math.min(255, Math.max(0, (data[i] - avg) * factor + avg));
                        data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - avg) * factor + avg));
                        data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - avg) * factor + avg));
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                    canvas.toBlob(resolve, 'image/png', 0.95);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // OCR ê²°ê³¼ íŒŒì‹±
        function parseOCRResult(text) {
            console.log('OCR ê²°ê³¼:', text);
            
            // í•œê¸€ í…ìŠ¤íŠ¸ ì •ë¦¬
            const cleanText = text.replace(/[^\w\sê°€-í£(),.:/%-]/g, ' ')
                                 .replace(/\s+/g, ' ')
                                 .trim();

            // ì´ë¦„ ì¶”ì¶œ (íŒ¨í„´: "OOOë‹˜ì˜" ë˜ëŠ” "OOO ë‹˜ì˜")
            const nameMatch = cleanText.match(/([ê°€-í£]{2,4})\s?ë‹˜ì˜/);
            if (nameMatch) {
                currentData.personal.name = nameMatch[1];
            }

            // ìƒë…„ì›”ì¼ ì¶”ì¶œ (íŒ¨í„´: YY-MM-DD)
            const birthMatch = cleanText.match(/(\d{2}-\d{2}-\d{2})/);
            if (birthMatch) {
                currentData.personal.birthDate = birthMatch[1];
            }

            // ì›”ë‚©ë³´í—˜ë£Œ ì¶”ì¶œ (íŒ¨í„´: ìˆ«ì,ìˆ«ìì›)
            const premiumMatch = cleanText.match(/ì›”ë‚©ë³´í—˜ë£Œ[^0-9]*([0-9,]+)ì›/);
            if (premiumMatch) {
                currentData.personal.monthlyPremium = parseInt(premiumMatch[1].replace(/,/g, ''));
            }

            // ì†í•´ë³´í—˜/ìƒëª…ë³´í—˜ ê±´ìˆ˜ ì¶”ì¶œ
            const damageMatch = cleanText.match(/ì†í•´ë³´í—˜[^0-9]*(\d+)ê±´/);
            if (damageMatch) {
                currentData.personal.damageInsurance = parseInt(damageMatch[1]);
            }

            const lifeMatch = cleanText.match(/ìƒëª…ë³´í—˜[^0-9]*(\d+)ê±´/);
            if (lifeMatch) {
                currentData.personal.lifeInsurance = parseInt(lifeMatch[1]);
            }

            // ì ìˆ˜ ì¶”ì¶œ (íŒ¨í„´: ìˆ«ìì )
            const familyScoreMatch = cleanText.match(/ê°€ì¡±ë³´ì¥[^0-9]*(\d+)ì /);
            if (familyScoreMatch) {
                currentData.sections.family.score = parseInt(familyScoreMatch[1]);
            }

            const diseaseScoreMatch = cleanText.match(/í°ë³‘ë³´ì¥[^0-9]*(\d+)ì /);
            if (diseaseScoreMatch) {
                currentData.sections.disease.score = parseInt(diseaseScoreMatch[1]);
            }

            const medicalScoreMatch = cleanText.match(/ì˜ë£Œë³´ì¥[^0-9]*(\d+)ì /);
            if (medicalScoreMatch) {
                currentData.sections.medical.score = parseInt(medicalScoreMatch[1]);
            }

            const careScoreMatch = cleanText.match(/ê°„ë³‘ë³´ì¥[^0-9]*(\d+)ì /);
            if (careScoreMatch) {
                currentData.sections.care.score = parseInt(careScoreMatch[1]);
            }

            // ë³´ì¥ í•­ëª©ë“¤ íŒŒì‹± (ê¸°ë³¸ íŒ¨í„´ ë§¤ì¹­)
            parseInsuranceItems(cleanText);

            // UI ì—…ë°ì´íŠ¸
            updatePersonalInfo();
            renderSections();
            renderLifestyle();
        }

        // ë³´í—˜ í•­ëª© íŒŒì‹±
        function parseInsuranceItems(text) {
            // ê°€ì¡±ë³´ì¥ í•­ëª©ë“¤
            const familyItems = [
                { name: "ì§ˆë³‘ì‚¬ë§", pattern: /ì§ˆë³‘ì‚¬ë§[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ìƒí•´ì‚¬ë§", pattern: /ìƒí•´ì‚¬ë§[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ì§ˆë³‘í›„ìœ ", pattern: /ì§ˆë³‘í›„ìœ [^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ìƒí•´í›„ìœ ", pattern: /ìƒí•´í›„ìœ [^0-9]*(\d+)[^0-9]*(\d+)/ }
            ];

            // í°ë³‘ë³´ì¥ í•­ëª©ë“¤
            const diseaseItems = [
                { name: "ìœ ì‚¬ì•”", pattern: /ìœ ì‚¬ì•”[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ì¼ë°˜ì•”", pattern: /ì¼ë°˜ì•”[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ë‡Œí˜ˆê´€ì§ˆí™˜", pattern: /ë‡Œí˜ˆê´€ì§ˆí™˜[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ì‹¬ì¥ì§ˆí™˜", pattern: /ì‹¬ì¥ì§ˆí™˜[^0-9]*(\d+)[^0-9]*(\d+)/ }
            ];

            // ì˜ë£Œë³´ì¥ í•­ëª©ë“¤
            const medicalItems = [
                { name: "ì‹¤ì†ë³´í—˜", pattern: /ì‹¤ì†[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ì…ì›ë¹„", pattern: /ì…ì›[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ìˆ˜ìˆ ë¹„", pattern: /ìˆ˜ìˆ [^0-9]*(\d+)[^0-9]*(\d+)/ }
            ];

            // ê°„ë³‘ë³´ì¥ í•­ëª©ë“¤
            const careItems = [
                { name: "ì¹˜ë§¤ë³´ì¥", pattern: /ì¹˜ë§¤[^0-9]*(\d+)[^0-9]*(\d+)/ },
                { name: "ì¥ê¸°ìš”ì–‘", pattern: /ì¥ê¸°ìš”ì–‘[^0-9]*(\d+)[^0-9]*(\d+)/ }
            ];

            // ê° ì„¹ì…˜ë³„ ì•„ì´í…œ íŒŒì‹±
            currentData.sections.family.items = parseSection(text, familyItems);
            currentData.sections.disease.items = parseSection(text, diseaseItems);
            currentData.sections.medical.items = parseSection(text, medicalItems);
            currentData.sections.care.items = parseSection(text, careItems);

            // ê¸°ë³¸ê°’ìœ¼ë¡œ ì±„ìš°ê¸° (OCRì—ì„œ ì¸ì‹ë˜ì§€ ì•Šì€ ê²½ìš°)
            fillDefaultItems();
        }

        // ì„¹ì…˜ë³„ ì•„ì´í…œ íŒŒì‹±
        function parseSection(text, itemPatterns) {
            const items = [];
            
            itemPatterns.forEach(item => {
                const match = text.match(item.pattern);
                if (match) {
                    items.push({
                        name: item.name,
                        current: parseInt(match[1]) || 0,
                        target: parseInt(match[2]) || 0
                    });
                }
            });

            return items;
        }

        // ê¸°ë³¸ ì•„ì´í…œìœ¼ë¡œ ì±„ìš°ê¸°
        function fillDefaultItems() {
            if (currentData.sections.family.items.length === 0) {
                currentData.sections.family.items = [
                    { name: "ì§ˆë³‘ì‚¬ë§", current: 0, target: 10000 },
                    { name: "ìƒí•´ì‚¬ë§", current: 0, target: 20000 },
                    { name: "ì§ˆë³‘í›„ìœ (3%)", current: 0, target: 3000 },
                    { name: "ìƒí•´í›„ìœ (3%)", current: 0, target: 10000 }
                ];
            }

            if (currentData.sections.disease.items.length === 0) {
                currentData.sections.disease.items = [
                    { name: "ìœ ì‚¬ì•”", current: 0, target: 1000 },
                    { name: "ì¼ë°˜ì•”", current: 0, target: 7000 },
                    { name: "ë‡Œí˜ˆê´€ì§ˆí™˜", current: 0, target: 2000 },
                    { name: "ì‹¬ì¥ì§ˆí™˜", current: 0, target: 3000 }
                ];
            }

            if (currentData.sections.medical.items.length === 0) {
                currentData.sections.medical.items = [
                    { name: "ì§ˆë³‘ì…ì› ì‹¤ì†", current: 0, target: 5000 },
                    { name: "ìƒí•´ì…ì› ì‹¤ì†", current: 0, target: 5000 },
                    { name: "ì§ˆë³‘ì…ì›(1ì¼)", current: 0, target: 3 },
                    { name: "ìˆ˜ìˆ ë¹„", current: 0, target: 50 }
                ];
            }

            if (currentData.sections.care.items.length === 0) {
                currentData.sections.care.items = [
                    { name: "ê²½ì¦ì¹˜ë§¤", current: 0, target: 2000 },
                    { name: "ì¤‘ì¦ì¹˜ë§¤", current: 0, target: 4000 },
                    { name: "ì¥ê¸°ìš”ì–‘", current: 0, target: 2000 }
                ];
            }

            // ìƒí™œë³´ì¥ ê¸°ë³¸ê°’
            if (currentData.lifestyle.length === 0) {
                currentData.lifestyle = [
                    { name: "ëŒ€ì¸ë°°ìƒì±…ì„", amount: 0, status: "âœ•" },
                    { name: "ë³€í˜¸ì‚¬ì„ ì„ë¹„ìš©", amount: 0, status: "âœ•" },
                    { name: "ìš´ì „ìë²Œê¸ˆ", amount: 0, status: "âœ•" },
                    { name: "ì¼ìƒìƒí™œë°°ìƒì±…ì„", amount: 0, status: "âœ•" }
                ];
            }
        }

        // ì„¹ì…˜ ë Œë”ë§
        function renderSections() {
            const sections = ['family', 'disease', 'medical', 'care'];
            
            sections.forEach((sectionKey) => {
                const section = currentData.sections[sectionKey];
                const container = document.getElementById(`${sectionKey}-items`);
                const scoreElement = document.getElementById(`${sectionKey}-score`);
                
                // ì ìˆ˜ ì—…ë°ì´íŠ¸
                scoreElement.textContent = `${section.score}ì `;
                updateScoreCircle(scoreElement.parentElement, section.score);
                
                // ì•„ì´í…œ ë Œë”ë§
                container.innerHTML = '';
                if (section.items.length > 0) {
                    section.items.forEach((item, itemIndex) => {
                        const itemElement = createItemElement(item, sectionKey, itemIndex);
                        container.appendChild(itemElement);
                    });
                } else {
                    container.innerHTML = '<div class="item"><div class="item-name">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';
                }
            });
        }

        // ì•„ì´í…œ ìš”ì†Œ ìƒì„±
        function createItemElement(item, sectionKey, itemIndex) {
            const div = document.createElement('div');
            div.className = 'item';
            
            const shortage = Math.max(0, item.target - item.current);
            const percentage = item.target > 0 ? Math.min(100, (item.current / item.target) * 100) : 0;
            
            let progressColor = '#f44336'; // 30% ë¯¸ë§Œ
            if (percentage >= 100) progressColor = '#4caf50'; // 100% ì´ìƒ
            else if (percentage >= 80) progressColor = '#ff9800'; // 80% ì´ìƒ
            
            div.innerHTML = `
                <div class="item-name">${item.name}</div>
                <div class="item-amounts">
                    <input type="number" class="amount-input" value="${item.current}" 
                           onchange="updateAmount('${sectionKey}', ${itemIndex}, 'current', this.value)">
                    <span class="amount-display">ë§Œì› /</span>
                    <input type="number" class="amount-input" value="${item.target}" 
                           onchange="updateAmount('${sectionKey}', ${itemIndex}, 'target', this.value)">
                    <span class="amount-display">ë§Œì›</span>
                    ${shortage > 0 ? `<span class="shortage">(${shortage.toLocaleString()}ë§Œì› ë¶€ì¡±)</span>` : 
                      item.current >= item.target ? `<span class="sufficient">ì¶©ì¡±</span>` : ''}
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(100, percentage)}%; background: ${progressColor};"></div>
                </div>
            `;
            
            return div;
        }

        // ì ìˆ˜ ì›í˜• ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
        function updateScoreCircle(element, score) {
            const degrees = (score / 100) * 360;
            element.style.setProperty('--score-deg', `${degrees}deg`);
        }

        // ìƒí™œë³´ì¥ ë Œë”ë§
        function renderLifestyle() {
            const container = document.getElementById('lifestyle-items');
            
            if (currentData.lifestyle.length === 0) {
                container.innerHTML = '<div class="lifestyle-item"><div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';
                return;
            }

            container.innerHTML = '';
            currentData.lifestyle.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'lifestyle-item';
                
                const statusClass = item.status === 'â—' ? 'status-o' : 
                                   item.status === 'â–²' ? 'status-triangle' : 'status-x';
                
                div.innerHTML = `
                    <div>
                        <strong>${item.name}</strong>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">
                            <input type="number" class="amount-input" value="${item.amount}" 
                                   onchange="updateLifestyle(${index}, 'amount', this.value)">ë§Œì›
                        </div>
                    </div>
                    <div class="status-indicator ${statusClass}" onclick="toggleStatus(${index})">${item.status}</div>
                `;
                
                container.appendChild(div);
            });
        }

        // ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        function updateAmount(sectionKey, itemIndex, field, value) {
            const numValue = parseInt(value) || 0;
            currentData.sections[sectionKey].items[itemIndex][field] = numValue;
            
            // ì ìˆ˜ ì¬ê³„ì‚°
            const section = currentData.sections[sectionKey];
            const totalPercentage = section.items.reduce((sum, item) => {
                const percentage = item.target > 0 ? (item.current / item.target) * 100 : 0;
                return sum + Math.min(100, percentage);
            }, 0);
            section.score = Math.round(totalPercentage / section.items.length);
            
            renderSections();
        }

        // ìƒí™œë³´ì¥ ì—…ë°ì´íŠ¸
        function updateLifestyle(index, field, value) {
            currentData.lifestyle[index][field] = field === 'amount' ? (parseInt(value) || 0) : value;
            renderLifestyle();
        }

        // ìƒíƒœ í† ê¸€
        function toggleStatus(index) {
            const statuses = ['â—', 'â–²', 'âœ•'];
            const currentStatus = currentData.lifestyle[index].status;
            const currentIndex = statuses.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statuses.length;
            currentData.lifestyle[index].status = statuses[nextIndex];
            renderLifestyle();
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.querySelector('.upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                uploadArea.style.borderColor = '#c62828';
                uploadArea.style.background = '#fafafa';
            }
            
            function unhighlight(e) {
                uploadArea.style.borderColor = '#ccc';
                uploadArea.style.background = 'white';
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    document.getElementById('file-input').files = files;
                    handleFileUpload({ target: { files: files } });
                }
            }
        });

        // ì›ë³¸ ë ˆì´ì•„ì›ƒ ìƒì„±
        function generateOriginalLayout() {
            const container = document.getElementById('original-layout');
            container.innerHTML = '';

            // ë„¤ë¹„ê²Œì´ì…˜
            const nav = document.createElement('div');
            nav.className = 'original-nav';
            nav.innerHTML = `
                <div class="original-nav-item">1. ì»¨ì„¤íŒ… ê°€ì´ë“œ</div>
                <div class="original-nav-item active">2. ê°„í¸ë¶„ì„</div>
                <div class="original-nav-item">3. ê³„ì•½ìƒì„¸</div>
                <div class="original-nav-item">4. ì£¼ìš”ë³´ì¥</div>
                <div class="original-nav-item">5. ì˜ˆìƒë³´í—˜ê¸ˆ ì¡°íšŒ</div>
                <div class="original-nav-item">6. ì»¨ì„¤íŒ… ê²°ê³¼</div>
                <div class="original-nav-item">7. ì „/í›„ë¹„êµ</div>
            `;
            container.appendChild(nav);

            // ì œëª©
            const title = document.createElement('div');
            title.className = 'original-title';
            title.textContent = `${currentData.personal.name}ë‹˜ì˜ í•œ ì¥ ìš”ì•½ ë³´ì¥ë¶„ì„`;
            container.appendChild(title);

            // ë²”ë¡€
            const legend = document.createElement('div');
            legend.className = 'original-legend';
            legend.innerHTML = `
                <div class="original-legend-item">
                    <div class="original-legend-color" style="background: #4caf50;"></div>
                    <span>100% ì´ìƒ</span>
                </div>
                <div class="original-legend-item">
                    <div class="original-legend-color" style="background: #ff9800;"></div>
                    <span>80% ì´ìƒ</span>
                </div>
                <div class="original-legend-item">
                    <div class="original-legend-color" style="background: #f44336;"></div>
                    <span>30% ë¯¸ë§Œ</span>
                </div>
            `;
            container.appendChild(legend);

            // ê°œì¸ì •ë³´
            const info = document.createElement('div');
            info.className = 'original-info';
            info.innerHTML = `
                <span>ìƒë…„ì›”ì¼ ${currentData.personal.birthDate || '-'}</span>
                <span>/ ì†í•´ë³´í—˜ ${currentData.personal.damageInsurance || '-'}ê±´</span>
                <span>/ ìƒëª…ë³´í—˜ ${currentData.personal.lifeInsurance || '-'}ê±´</span>
                <span>/ ì›”ë‚©ë³´í—˜ë£Œ í•©ê³„ ${currentData.personal.monthlyPremium ? 
                    currentData.personal.monthlyPremium.toLocaleString() : '-'}ì›</span>
            `;
            container.appendChild(info);

            // ë©”ì¸ ì„¹ì…˜ë“¤
            const main = document.createElement('div');
            main.className = 'original-main';

            // 4ê°œ ì£¼ìš” ì„¹ì…˜ ìƒì„±
            const sections = [
                { key: 'family', title: 'ê°€ì¡±ë³´ì¥' },
                { key: 'disease', title: 'í°ë³‘ë³´ì¥' },
                { key: 'medical', title: 'ì˜ë£Œë³´ì¥' },
                { key: 'care', title: 'ê°„ë³‘ë³´ì¥' }
            ];

            sections.forEach(sectionInfo => {
                const section = document.createElement('div');
                section.className = 'original-section';

                const sectionData = currentData.sections[sectionInfo.key];
                
                // í—¤ë”
                const header = document.createElement('div');
                header.className = 'original-section-header';
                
                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'original-section-title';
                sectionTitle.textContent = sectionInfo.title;
                
                const score = document.createElement('div');
                score.className = 'original-score';
                score.textContent = `${sectionData.score}ì `;
                
                // ì ìˆ˜ì— ë”°ë¥¸ ë°°ê²½ìƒ‰
                let bgColor = '#f44336'; // 30% ë¯¸ë§Œ
                if (sectionData.score >= 100) bgColor = '#4caf50'; // 100% ì´ìƒ
                else if (sectionData.score >= 80) bgColor = '#ff9800'; // 80% ì´ìƒ
                score.style.background = bgColor;
                
                header.appendChild(sectionTitle);
                header.appendChild(score);
                section.appendChild(header);

                // ì•„ì´í…œë“¤
                const items = document.createElement('div');
                items.className = 'original-items';
                
                sectionData.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'original-item';
                    
                    const shortage = Math.max(0, item.target - item.current);
                    const percentage = item.target > 0 ? Math.min(100, (item.current / item.target) * 100) : 0;
                    
                    let barColor = '#f44336';
                    if (percentage >= 100) barColor = '#4caf50';
                    else if (percentage >= 80) barColor = '#ff9800';
                    
                    itemDiv.innerHTML = `
                        <div class="original-item-name">${item.name}</div>
                        <div class="original-item-amount">
                            ${item.current.toLocaleString()}ë§Œì› / ${item.target.toLocaleString()}ë§Œì›
                            ${shortage > 0 ? `<span class="original-shortage">(${shortage.toLocaleString()}ë§Œì› ë¶€ì¡±)</span>` : ''}
                        </div>
                        <div class="original-bar">
                            <div class="original-bar-fill" style="width: ${Math.min(100, percentage)}%; background: ${barColor};"></div>
                        </div>
                    `;
                    
                    items.appendChild(itemDiv);
                });
                
                section.appendChild(items);
                main.appendChild(section);
            });

            // ìƒí™œë³´ì¥ ì„¹ì…˜
            const lifestyleSection = document.createElement('div');
            lifestyleSection.className = 'original-section original-lifestyle';
            
            const lifestyleHeader = document.createElement('div');
            lifestyleHeader.className = 'original-section-header';
            lifestyleHeader.innerHTML = `
                <div class="original-section-title">ìƒí™œë³´ì¥</div>
                <div style="font-size: 10px; color: #666;">
                    <span style="color: #4caf50;">â—</span> ì ì •
                    <span style="color: #ff9800; margin-left: 8px;">â–²</span> ë¶€ì¡±
                    <span style="color: #f44336; margin-left: 8px;">âœ•</span> ë¯¸ë³´ì¥
                </div>
            `;
            lifestyleSection.appendChild(lifestyleHeader);

            const lifestyleItems = document.createElement('div');
            lifestyleItems.className = 'original-lifestyle-items';
            
            currentData.lifestyle.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'original-lifestyle-item';
                
                const status = document.createElement('div');
                status.className = 'original-status';
                
                if (item.status === 'â—') {
                    status.style.background = '#4caf50';
                    status.textContent = 'â—';
                } else if (item.status === 'â–²') {
                    status.style.background = '#ff9800';
                    status.textContent = 'â–²';
                } else {
                    status.style.background = '#f44336';
                    status.textContent = 'âœ•';
                }
                
                itemDiv.innerHTML = `
                    <div style="flex: 1; font-weight: bold; margin-bottom: 3px;">${item.name}</div>
                    <div style="font-size: 8px; color: #666; margin-bottom: 3px;">${item.amount.toLocaleString()}ë§Œì›</div>
                `;
                itemDiv.appendChild(status);
                
                lifestyleItems.appendChild(itemDiv);
            });
            
            lifestyleSection.appendChild(lifestyleItems);
            main.appendChild(lifestyleSection);
            
            container.appendChild(main);

            // í™”ë©´ì— ì ì‹œ í‘œì‹œ
            container.style.position = 'fixed';
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';
            container.style.zIndex = '1000';
            container.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
            container.style.border = '1px solid #ddd';

            // 3ì´ˆ í›„ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.top = '-9999px';
                container.style.transform = 'none';
                container.style.zIndex = 'auto';
            }, 3000);
        }

        // ì´ë¯¸ì§€ë¡œ ë‹¤ìš´ë¡œë“œ
        function downloadAsImage() {
            const element = document.getElementById('original-layout');
            
            // ì›ë³¸ ë ˆì´ì•„ì›ƒì´ ì—†ìœ¼ë©´ ë¨¼ì € ìƒì„±
            if (!element.innerHTML.trim()) {
                generateOriginalLayout();
                // ìƒì„± í›„ ì ì‹œ ê¸°ë‹¤ë¦° ë‹¤ìŒ ë‹¤ìš´ë¡œë“œ
                setTimeout(() => {
                    captureAndDownload();
                }, 100);
            } else {
                captureAndDownload();
            }
        }

        function captureAndDownload() {
            // html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œ
            if (!window.html2canvas) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = () => {
                    performCapture();
                };
                document.head.appendChild(script);
            } else {
                performCapture();
            }
        }

        function performCapture() {
            const element = document.getElementById('original-layout');
            
            // ì„ì‹œë¡œ í™”ë©´ì— í‘œì‹œ
            element.style.position = 'fixed';
            element.style.left = '0';
            element.style.top = '0';
            element.style.zIndex = '-1';
            
            html2canvas(element, {
                width: 1200,
                height: 800,
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                // ë‹¤ì‹œ ìˆ¨ê¸°ê¸°
                element.style.position = 'absolute';
                element.style.left = '-9999px';
                element.style.top = '-9999px';
                element.style.zIndex = 'auto';
                
                // ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                link.download = `${currentData.personal.name}_ë³´ì¥ë¶„ì„ì§€_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(error => {
                console.error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', error);
                alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                
                // ì—ëŸ¬ ì‹œì—ë„ ìš”ì†Œ ìˆ¨ê¸°ê¸°
                element.style.position = 'absolute';
                element.style.left = '-9999px';
                element.style.top = '-9999px';
                element.style.zIndex = 'auto';
            });
        }

        // ì´ˆê¸°í™” ì‹¤í–‰
        init();
    </script>
</body>
</html>
